// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`The file post repository gets all posts 1`] = `
[
  {
    "category": "react",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/ReactJS_category.png",
    "date": "",
    "description": "Los desarrolladores llamamos arquitectura al conjunto de patrones de desarrollo que permiten definir unas pautas a seguir en nuestro software en cuanto a l√≠mites y restricciones.",
    "id": "arquitectura-hexagonal-frontend",
    "markdownBody": "Existen multiples definiciones para el t√©rmino **arquitectura** dependiendo del contexto en el que se trate y de la vertiente del desarrollo de la que se provenga, por lo que es muy complicado llegar a un consenso y a una definici√≥n √∫nica que sea v√°lida para todos los casos. As√≠ pues, ci√±√©ndonos al desarrollo de software en *frontend*, bajo un punto de vista personal la definici√≥n es la siguiente:

> Los desarrolladores llamamos **arquitectura** al conjunto de patrones de desarrollo que permiten definir unas pautas a seguir en nuestro software en cuanto a l√≠mites y restricciones.
Es la gu√≠a que debemos seguir con la finalidad de ordenar nuestro c√≥digo y hacer que las distintas partes de la aplicaci√≥n se comuniquen entre s√≠. 

Existe una gran cantidad de opciones a la hora de decantarnos por una arquitectura u otra. 
Cada una de ellas tendr√° sus propias ventajas e inconvenientes. Incluso una vez escojamos cu√°l es la mejor que se adapta a nuestro caso, no tiene por qu√© implementarse de igual forma en los distintos proyectos.

Sin embargo, aunque el abanico de patrones es casi infinito, la gran mayor√≠a mantienen atributos de calidad comunes, tales como: escalabilidad, responsabilidad √∫nica, desacoplamiento, mantenibilidad, etc.; por lo que, de manera general, es de vital importancia entender los conceptos y por qu√© se ha adoptado dicha soluci√≥n, m√°s que la teor√≠a en s√≠.

Uno de los patrones de dise√±o de arquitectura de *software* m√°s utilizados es el de la **Arquitectura Hexagonal** (*Hexagonal Architecture*), tambi√©n conocida como arquitectura de **Puertos y Adaptadores** (*Ports and Adapters*), dada a conocer por *[Alistair Cockburn](https://en.wikipedia.org/wiki/Alistair_Cockburn)*.

La finalidad principal de este patr√≥n es dividir nuestra aplicaci√≥n en distintas capas, permitiendo su evoluci√≥n de manera aislada y responsabilizando a cada entidad de una funcionalidad √∫nica.

## ¬øPor qu√© se le llama hexagonal?

La idea de representar esta arquitectura con un hex√°gono es debido a la facilidad que presenta el asociar el concepto te√≥rico con el concepto visual, puesto que dentro de dicho hex√°gono es donde se encuentra nuestro c√≥digo base, llamado **dominio**, y cada uno de sus laterales es una interacci√≥n hacia un servicio externo, por ejemplo: servicios *http* de terceros, bases de datos, servicio de mensajer√≠a o renderizaci√≥n.

![hexagon](https://gist.githubusercontent.com/adrian-afergon/52d0f1cc95d7dcf3bcf33b98a4c688dd/raw/b20666a3be59156ab2fc26ee7b3c7816cf125b6c/hexagon.png)

La comunicaci√≥n del **dominio** con el resto de actores se realiza en una capa denominada **infraestructura**, donde se encuentra la implementaci√≥n espec√≠fica para cada una de estas tecnolog√≠as.

![hexagon - infrastructure](https://gist.githubusercontent.com/adrian-afergon/52d0f1cc95d7dcf3bcf33b98a4c688dd/raw/b20666a3be59156ab2fc26ee7b3c7816cf125b6c/infrastructure.png)

Una de las preguntas m√°s frecuentes entre los profesionales que ven por primera vez esta arquitectura, es: *"¬øa qu√© se debe la figura hexagonal?"* El uso del hex√°gono no es m√°s que una mera representaci√≥n te√≥rica. El n√∫mero de servicios con los que podemos integrarnos es infinito y pueden ser tantos como necesitemos. En el lado opuesto tenemos el caso m√°s simple donde s√≥lo hay dos interacciones con el dominio de la aplicaci√≥n y, obviamente, esta situaci√≥n no puede representarse con una figura poligonal.

## Mismo concepto distintos nombres

Como hemos comentado previamente, este patr√≥n recibe tambi√©n el nombre de **puertos y adaptadores** (*Ports and Adapters*). Este nombre viene de una separaci√≥n dentro de la capa de infraestructura, donde tendremos dos subcapas:

- **Puerto**: Es la interfaz que deber√°n implementar las distintas variantes de nuestro c√≥digo para abstraerse de la tecnolog√≠a. En ella se ha de definir la firma de los m√©todos que existir√°n.
- **Adaptador**: Es la implementaci√≥n de la interfaz, en ella se generar√° el c√≥digo espec√≠fico para consumir una tecnolog√≠a en concreto. Esta nunca se usar√° de forma directa en la aplicaci√≥n, m√°s all√° de la declaraci√≥n, ya que su uso se realizar√° a trav√©s del tipo del **puerto**. 

As√≠ pues, nuestro dominio realizar√° llamadas a la subcapa que se corresponde con el **puerto**, quedando desacoplado de la tecnolog√≠a, mientras que √©ste, a su vez, consumir√° el **adaptador**.

De esta manera, en caso de realizar un cambio tecnol√≥gico, s√≥lo se ver√° afectada la capa externa (adaptador).

Dado que el concepto de **puertos y adaptadores** est√° muy ligado a la programaci√≥n orientada a objetos y por lo tanto al uso de interfaces, es probable que la implementaci√≥n de este patr√≥n en lenguajes de programaci√≥n funcional difiera ligeramente del concepto inicial.

De hecho han surgido m√∫ltiples patrones que *"iteran"* sobre √©ste, como la *Arquitectura Cebolla* (*Onion Architecture*) o la *Arquitectura Limpia* (*Clean Architecture*). Sin embargo, la premisa es la misma para todas ellas: dividir nuestra aplicaci√≥n en capas, separando el **dominio** de la **infraestructura**.

## ¬øC√≥mo afecta en la mantenibilidad?

El hecho de tener nuestro c√≥digo dividido en capas, donde cada una de ellas tienen una responsabilidad √∫nica, ayuda a que evolucione de forma distinta, sin repercusi√≥n en las dem√°s.

Por otra parte, con esta segmentaci√≥n tambi√©n conseguimos una mayor cohesi√≥n, donde cada capa tendr√° una responsabilidad bien definida y √∫nica dentro del contexto de nuestro software. 

Finalmente, debemos tener en cuenta que no todas las personas que se incorporan por primera vez a un equipo conocen estos t√©rminos o est√°n familiarizadas con dichos conceptos, por lo que es responsabilidad de los equipos ser lo suficientemente gen√©ricos y definir una estructura lo suficientemente robusta para que la carencia de dichos conocimientos no suponga una carga adicional al desarrollo.

## ¬øC√≥mo afecta en el frontend?

En la actualidad hay una serie de carencias respecto al uso de metodolog√≠as a la hora de crear aplicaciones. La facilidad y la velocidad proporcionadas por las actuales herramientas han hecho que dejemos a un lado el trabajo de an√°lisis e implementaci√≥n de arquitecturas conocidas y sobradamente contrastadas.

No obstante, aunque estas arquitecturas puedan parecer m√°s propias de otros tiempos donde los lenguajes de programaci√≥n no evolucionaban a un ritmo tan vertiginoso como hoy en d√≠a, dichas arquitecturas han sido planteadas, y en algunos casos adaptadas, para que sigan proporcionando la escalabilidad necesaria para las aplicaciones actuales.

### Marco hist√≥rico

Hace aproximadamente dos d√©cadas las aplicaciones de escritorio eran la herramienta principal en cuanto a software. En ellas, el grueso del c√≥digo de la aplicaci√≥n se encontraba instalado en librer√≠as, dentro de la propia m√°quina, y el nivel de acoplamiento era elevado entre la vista y comportamiento de la misma.

Con la finalidad de continuar escalando las aplicaciones y llegar a un software con mayor mantenibilidad y unas base de datos centralizadas (no en un entorno local), muchas de estas operaciones se llevaron al servidor. Esto ocasion√≥ que las aplicaciones de escritorio quedasen relegadas a meras interacciones de usuario que no requer√≠an de acceso, persistencia o datos remotos. De necesitarlo, las aplicaciones tendr√≠an la responsabilidad de hacer estas llamadas a trav√©s de la red a los servicios desplegados en servidores externos. Es aqu√≠ donde empezamos a ver la primera distinci√≥n entre *frontend* y *backend*.

En los siguientes a√±os surgi√≥ el *boom* de la web. Muchas de las aplicaciones de escritorio saltaron al marco del navegador, donde las limitaciones tecnol√≥gicas eran notorias y la publicaci√≥n del \`html\` bien era est√°tica o ten√≠a que generarse de forma din√°mica en el servidor. Sin embargo, con el paso del tiempo \`JavaScript\` comenz√≥ a dotar de mayores posibilidades a los navegadores.  

### Actualidad

La parte visual siempre se hab√≠a limitado a la representaci√≥n de datos y nunca hab√≠a necesitado mayor funcionalidad hasta hoy. Con las necesidades actuales, las aplicaciones **frontend** tienen mayores requisitos que los existentes hace a√±os, por ejemplo: gestionan el estado de la aplicaci√≥n, seguridad, asincron√≠a, animaciones basadas en interacciones, integraciones con servicios de terceros, etc.

Es por este crecimiento que nos vemos en la necesidad de comenzar a aplicar patrones en estas aplicaciones, que se han desvinculado en su totalidad del contexto inicial.

### Consecuencia

Como bien hemos dicho, la finalidad del *frontend* es en su mayor√≠a visualizar datos. A pesar de esta percepci√≥n, **no es** el **dominio** de nuestra aplicaci√≥n, sino que pertenece a las capas exteriores de la arquitectura implementada.

Los casos de uso de la aplicaci√≥n si pertenecen al **dominio** y no son relativos a c√≥mo se deben visualizar. Por ejemplo: *"Dentro de una cesta de la compra que no podemos a√±adir m√°s de 5 productos de un mismo tipo."*

La petici√≥n de datos al *backend* pertenece a la capa de **infraestructura**, ya que es algo que escapa de la responsabilidad de nuestra aplicaci√≥n, aunque seamos nosotros quienes gestionemos el backend (esta es otra aplicaci√≥n y por lo tanto las necesidades de arquitectura ser√°n independientes). Por ejemplo el esquema de datos en el **backend** puede cambiar en cualquier momento y no queremos propagar esos cambios por toda nuestra aplicaci√≥n **frontend**.

Por otro lado, la gesti√≥n de los datos de la sesi√≥n (*local*, *session*, *cookies*) es otro ejemplo de c√≥digo que pertenece a la capa de **infraestructura**, porque si bien tenemos que lidiar con ella, no pertenece al **dominio** de nuestra aplicaci√≥n.

## Y con las librer√≠as de frontend ¬øqu√© sucede?

En la actualidad existe una cantidad ingente de librer√≠as para renderizaci√≥n: *Angular*, *React*, *Vue*, *Stencil*, *Polymer*, *Svelte*, *Ember*, etc.; pero debemos comprender cu√°l es su finalidad, y que por tanto, **NO DEBEN** entrar en el **dominio** de nuestra aplicaci√≥n sino que deben ser relegadas a la **infraestructura**.

Todas estas herramientas tienden a evolucionar r√°pidamente en el tiempo y por lo tanto debemos hacer que nuestra aplicaci√≥n sea lo m√°s resiliente posible. ¬øC√≥mo podemos hacer esto? Una de las estrategias m√°s usuales pero a la vez menos conocidas es la de envolver dichas librer√≠as en funcionalidades creadas expresamente para tal fin. A esta estrategia se la conoce com√∫nmente como *wrapping* y su objetivo principal es aislar a nuestro c√≥digo de los efectos secundarios que las librer√≠as de terceros podr√≠an tener.

El *wrapping*  es una buena pr√°ctica pero cuando la utilicemos deber√° ser consumida a trav√©s de un **adaptador**, como ya hemos dicho previamente, con la finalidad de reducir el acoplamiento. No obstante &mdash; y esto es una opini√≥n personal &mdash; el hecho de envolver estas herramientas mencionadas en una implementaci√≥n nos har√° incurrir en una sobre-ingenier√≠a que nos acarrear√° un mayor mantenimiento y una penalizaci√≥n de tiempo que, en la mayor√≠a de los casos, el equipo no podr√° afrontar, por lo que debemos valorar cu√°ndo aplicar esta t√©cnica de forma eficiente.

Como argumento al por qu√© no envolver este tipo de librer√≠as, podemos afirmar que la comunicaci√≥n entre la vista (**infraestructura**) y el **dominio** es unidireccional, es decir, son un punto de entrada a nuestra aplicaci√≥n para el usuario, pero nunca ser√°n consumidos por el **dominio**.

Una vez comprendido esto, tenemos que asumir que las herramientas que se acoplan de forma extrema a estas librer√≠as de *frontend*, por ejemplo *Redux*, deben ser gestionadas de forma conjunta a nivel de **infraestructura**.

## Ejemplo

A continuaci√≥n veremos un caso de uso donde intentaremos plasmar todos estos conceptos sobre una cesta de la compra.
Primero desglosaremos las entidades que entran en juego, las cuales tendremos que recuperar de un servicio de terceros v√≠a *http*:
- Producto 
- Cesta

Por otro lado estas entidades deber√°n mostrarse al usuario, de manera que pueda interactuar con ellas, por ejemplo: ver los productos y a√±adirlos a la cesta.

Finalmente a√±adiremos reglas de negocio, como por ejemplo, evitar a√±adir dos veces el mismo elemento a la cesta.

### Directorios

En el siguiente [repositorio](https://github.com/adrian-afergon/hexagonal-arch-example/tree/step-0/start) podemos encontrar un ejemplo de c√≥mo organizar los directorios, tanto para una aplicaci√≥n \`React\`, como para una hecha en \`Vue\`:

![folders](https://gist.githubusercontent.com/adrian-afergon/52d0f1cc95d7dcf3bcf33b98a4c688dd/raw/b20666a3be59156ab2fc26ee7b3c7816cf125b6c/folders.png)

En ambos casos hemos creado dos directorios: \`infrastructure\` y \`domain\` y hemos movido los componentes visuales dentro del primero.

### Dominio

A continuaci√≥n definiremos los *modelos de dominio* \`Product\` y \`Basket\` que utilizar√° nuestra aplicaci√≥n. Este paso es exactamente el mismo para las dos aplicaciones:

\`\`\`typescript
// /src/domain/models/Product.ts
export type ProductId = string

export type Product = {
  id: ProductId
  title: string
  price: number
}
\`\`\`

\`\`\`typescript
// /src/domain/models/Basket.ts
import { Product } from './Product'

export type BasketId = string

export type Basket = {
  id: BasketId
  items: Product[]
}
\`\`\`

Ahora definiremos una funcionalidad que permita a√±adir un \`Product\` a un \`Basket\`, teniendo en cuenta que el mismo producto no puede estar repetido en la cesta.

Dependiendo del patr√≥n de dise√±o por el que nos decantemos, la implementaci√≥n de esta funcionalidad ser√° distinta. Para este caso optaremos por el m√°s sencillo, un modulo, \`service\` que maneja los datos:

\`\`\`typescript
// /src/domain/services/Basket.service.ts
import * as uuid from 'uuid'
import { Product } from '../models/Product'
import { Basket } from '../models/Basket'

const hasProduct = (basket: Basket, product: Product) => 
  basket.items.find((item) => item.id === product.id)

const createBasket = (product: Product) => ({
  id: uuid.v4(),
  items: [product]
})

const increaseBasket = (basket: Basket, product: Product) : Basket => ({
  ...basket,
  items: [...basket.items, product]
})

const addProductToBasket = (product: Product, basket?: Basket|null): Basket =>
  basket
    ? hasProduct(basket, product)
        ? basket
        : increaseBasket(basket, product)
    : createBasket(product)

export const basketService = {
  addProductToBasket
}
\`\`\`
- *[GitHub - Creaci√≥n de los modelos](https://github.com/adrian-afergon/hexagonal-arch-example/tree/step-1/models)*
- *[GitHub - Creaci√≥n del servicio](https://github.com/adrian-afergon/hexagonal-arch-example/tree/step-2/services)*

### Acceso a datos

Por otro lado, necesitaremos recuperar el listado de productos. Como bien hemos indicado, realizaremos una petici√≥n \`http\`. Sin embargo ¬øqu√© ocurrir√≠a si en lugar de esta petici√≥n, necesit√°semos hacerla v√≠a \`GraphQL\`? Tendr√≠amos que cambiar gran parte de nuestro c√≥digo. Incluso vayamos a una decisi√≥n m√°s trivial, ¬ørealizaremos dichas peticiones usando \`xhr\`, \`fetch\` o \`axios\`?

El llevar esta decisi√≥n a nuestra capa de **infraestructura** ser√° la opci√≥n m√°s acertada. A su vez este objeto ser√° consumido por una entidad \`repository\`.

> Hemos a√±adido un servicio \`api-example\` al proyecto de forma que tengamos un *backend* de pruebas.

En primer lugar definiremos la estructura del dato devuelto por la *API*. Este tipo de datos se les denomina \`Data Transfer Object (DTO)\`:

\`\`\`typescript
// /src/infrastructure/http/dto/ProductDTO.ts
export interface ProductDTO {
  product_id: string,
  title: string,
  description: string,
  price: string
}
\`\`\`

Ahora crearemos una envoltura a la librer√≠a \`fetch\` del navegador para los m√©todos \`http\`:
\`\`\`typescript
// /src/infrastructure/http/http.ts
const headers = {
  'Content-Type': 'application/json'
}

const get = async <T>(url: string) => {
  const response = await fetch(url, {
    method: 'GET',
    headers
  })
  return await response.json() as T
}

const post = async <T>(url: string, body: any) => {
  const response = await fetch(url, {
    method: 'POST',
    headers,
    body
  })
  return await response.json() as T
}

const put = async <T>(url: string, body: any) => {
  const response = await fetch(url, {
    method: 'PUT',
    headers,
    body
  })
  return await response.json() as T
}

const _delete = async <T>(url: string) => {
  const response = await fetch(url, {
    method: 'DELETE',
    headers
  })
  return await response.json() as T
}

export const http = {
  get,
  post,
  put,
  delete: _delete
}
\`\`\`

Por √∫ltimo crearemos nuestro \`repository\` en el directorio \`infrastructure\`. La finalidad de esta capa es hacer la petici√≥n y transformar el dato devuelto por el servidor a un *modelo de dominio* definido en nuestra aplicaci√≥n:

\`\`\`typescript
// /src/infrastructure/repositories/product.repository.ts

import { http } from '../../infrastructure/http/http'
import { ProductDTO } from '../../infrastructure/dto/ProductDTO'
import { Product } from '../models/Product'

export const productRepository = {
  getProducts: async () => {
    const products = await http.get<ProductDTO[]>('http://localhost:3001/products')
    // we can extract this transform to a function inside this file to be reused by different methods
    return products.map((productDto): Product => ({
      id: productDto.product_id,
      title: productDto.title,
      price: Number(productDto.price)
    }))
  }
}
\`\`\`

[GitHub - Acceso a datos](https://github.com/adrian-afergon/hexagonal-arch-example/tree/step-3/repositories)

### Vista

Ahora bien, la **vista** y la capa de **acceso a datos** se encuentran en infraestructura. Sin embargo, no deben comunicarse directamente; deber√°n comunicarse haciendo uso de la capa de **dominio**. Por ello, crearemos un nuevo servicio que se encargue de consumir nuestro \`repository\` y dar disponibilidad de estos datos al resto de la aplicaci√≥n:

\`\`\`typescript
// src/domain/services/Product.service.ts

import { productRepository } from '../../infrastructure/repositories/product.repository'

export const productService = {
  getProducts: () => {
    return productRepository.getProducts()
  }
}
\`\`\`

> Una buena pr√°ctica en este punto podr√≠a ser: en lugar de exportar un objeto, definir una funci√≥n a trav√©s de la cual podamos pasar variables como par√°metros y devolver como resultado de la llamada al m√©todo el objeto anteriormente definido. Sin embargo, no queremos elevar la complejidad de la aplicaci√≥n en este punto. 

Ahora que hemos definido como recuperar los datos y la funcionalidad necesaria para a√±adir elementos a nuestra cesta, vamos a visualizar el listado de productos en la aplicaci√≥n. Bien trabajes en \`React\` o en \`Vue\`, debes percatarte que el c√≥digo hasta ahora ha sido el mismo para ambas plataformas, por lo que la llamada al m√©todo desde nuestro componente ser√° la misma (salvando las distancias por la especificidad del ciclo de vida de cada una):

\`\`\`typescript
// React
// src/infrastructure/components/ProductList.tsx
import * as React from 'react'
import { Product } from '../../domain/models/Product'
import { productService } from '../../domain/services/Product.service'

export const ProductList: React.FC = () => {
  const [products, setProducts] = React.useState<Product[]>([])

  React.useEffect(() => {
    productService.getProducts().then(setProducts)
  }, [])

  return (
    <ul>
      {products.map((product) => <li key={product.id}>{product.title}</li>)}
    </ul>
  )
}
\`\`\`
\`\`\`vue
<!-- 
 Vue 
 src/infrastructure/components/ProductList.vue
-->
<template>
  <ul>
    <li v-for="product in products " :key="product.id"> {{ product.title }}</li>
  </ul>
</template>

<script lang="ts">
import { defineComponent } from 'vue'
import { productService } from '@/domain/services/Product.service'
import { Product } from '@/domain/models/Product'

type DataProps = {
  products: Product[];
}

export default defineComponent({
  name: 'ProductList',
  data (): DataProps {
    return {
      products: []
    }
  },
  mounted () {
    productService.getProducts().then(response => (this.products = response))
  }
})
</script>
\`\`\`
La gesti√≥n del estado de los elementos en la cesta es un punto interesante. Aun as√≠, es algo relativo al c√≥mo se visualizan los datos en la interfaz, por lo que nos centraremos en el caso m√°s simple que es gestionarlo a nivel del componente ra√≠z y que este se actualice mediante eventos.

Definimos el estado inicial en el padre y una funci√≥n que actualice el estado de la cesta:

\`\`\`typescript
// React
// /src/App.tsx
import React from 'react'
import { ProductList } from './ProductList'
import { Basket } from '../../domain/models/Basket'
import { Product } from '../../domain/models/Product'
import { basketService } from '../../domain/services/Basket.service'

type AppProps = {
  msg: string
}

const App: React.FC<AppProps> = ({ msg }) => {
  const [basket, setBasket] = React.useState<Basket|null>(null)

  const handleAddToCart = (product: Product) => {
    setBasket(basketService.addProductToBasket(product, basket))
  }

  return (
    <div className="App">
      <h1>{msg}</h1>
      <ProductList onSelectProduct={handleAddToCart}/>
      { basket && <p>Items on basket: {basket.items.length}</p>}
    </div>
  )
}

export default App
\`\`\`
\`\`\`vue
<!--
Vue
/src/App.vue
-->
<template>
  <Main msg="Welcome to Your Vue.js + TypeScript App"/>
  <ProductList :on-select-product="handleAddToCart"/>
  <p v-if="basket">Items on basket: {{basket.items.length}}</p>
</template>

<script lang="ts">
import { defineComponent } from 'vue'
import Main from './infrastructure/components/Main.vue'
import ProductList from '@/infrastructure/components/ProductList.vue'
import { Product } from '@/domain/models/Product'
import { basketService } from '@/domain/services/Basket.service'
import { Basket } from '@/domain/models/Basket'

type DataProps = {
  basket: Basket|null;
}

export default defineComponent({
  name: 'App',
  components: {
    Main,
    ProductList
  },
  methods: {
    handleAddToCart (product: Product) {
      this.basket = basketService.addProductToBasket(product, this.basket)
    }
  },
  data (): DataProps {
    return {
      basket: null
    }
  },
  mounted () {
    this.basket = null
  }
})
</script>
\`\`\`

Emitimos el evento a los hijos de forma que llamen a la funci√≥n manejadora con el producto seleccionado:

\`\`\`typescript
// React
// /src/infrastructure/components/ProductList.tsx
import * as React from 'react'
import { Product } from '../../domain/models/Product'
import { productService } from '../../domain/services/Product.service'

type ProductListProps = {
  onSelectProduct: (product: Product) => void
}

export const ProductList: React.FC<ProductListProps> = ({ onSelectProduct }) => {
  const [products, setProducts] = React.useState<Product[]>([])

  React.useEffect(() => {
    productService.getProducts().then(setProducts)
  }, [])

  return (
    <ul>
      {products.map((product) => <li key={product.id}>
        <button onClick={() => { onSelectProduct(product) }}>{product.title}</button>
      </li>)}
    </ul>
  )
}
\`\`\`
\`\`\`vue
<!--
Vue
/src/infrastructure/components/ProductList.vue
-->
<template>
  <ul>
    <li v-for="product in products " :key="product.id">
      <button @click="() => { onSelectProduct(product) }">{{ product.title }}</button>
    </li>
  </ul>
</template>

<script lang="ts">
import { defineComponent } from 'vue'
import { productService } from '@/domain/services/Product.service'
import { Product } from '@/domain/models/Product'

type DataProps = {
  products: Product[];
}

export default defineComponent({
  name: 'ProductList',
  props: {
    onSelectProduct: { type: Function }
  },
  data (): DataProps {
    return {
      products: []
    }
  },
  mounted () {
    productService.getProducts().then(response => (this.products = response))
  }
})
</script>
\`\`\`

[GitHub - Vista](https://github.com/adrian-afergon/hexagonal-arch-example/tree/step-4/view)
[GitHub - Events](https://github.com/adrian-afergon/hexagonal-arch-example/tree/step-5/events)

### Librer√≠as de terceros

Si prestamos atenci√≥n al c√≥digo anterior, vemos que todo nuestro c√≥digo est√° desacoplado de la tecnolog√≠a que usamos. Nuestra capa de **dominio** es capaz ser usada tanto por \`Vue\` como por \`React\`, teniendo una implementaci√≥n \`http\` que nos podr√≠a llegar a abstraer de si estamos aplicando \`SSR\` o funcionamos sobre una \`SPA\`.

Sin embargo ¬øqu√© ocurrir√≠a si tuvi√©semos que utilizar una librer√≠a de terceros? Lo cierto es que si prestamos atenci√≥n al \`basket.service.ts\`, tenemos una dependencia con la librer√≠a \`uuid\` (la cual hemos dejado aposta). Esta librer√≠a se encarga de generar \`ids\` de forma aleatoria para el carrito en *frontend*, pero a su vez nos limita a la hora de ejecutarse en *backend*, o en su defecto, nos puede obligar a modificar nuestra capa de **dominio** por una actualizaci√≥n de la misma.

Por ello, la soluci√≥n a aplicar deber√≠a ser la seguida con la integraci√≥n que hemos hecho para \`http\`.

\`\`\`typescript
// /src/infrastructure/uid/uid
import * as uuid from 'uuid'

export const generateUid = (): string => uuid.v4()
\`\`\`

\`\`\`typescript
// /src/domain/service/Basket.service.ts
const createBasket = (product: Product) => ({
  id: generateUid(),
  items: [product]
})
\`\`\`

Este simple cambio nos permitir√° que a futuro podamos cambiar a una \`v5\` sin necesidad de actualizar el c√≥digo del **dominio** en m√∫ltiples puntos, pues es dentro de la funci√≥n \`generateUid\` el √∫nico punto donde tendremos que aplicar el cambio.

## Conclusi√≥n

Como hemos tratado varias veces a lo largo de esta publicaci√≥n, el aplicar la arquitectura adecuada en *frontend* nos permitir√° mejorar la mantenibilidad del c√≥digo. Si se poseen los conocimientos adecuados, el uso tecnol√≥gico ser√° menos cr√≠tico y por tanto, podemos a√±adir un mayor valor al **dominio**.

Pensemos en la velocidad a la que evoluciona el software. En los √∫ltimos 20 a√±os la forma de programar ha cambiado enormemente, los desarrolladores hemos tenido que aprender nuevas tecnolog√≠as y adaptarnos, pero el negocio se ha mantenido constante.

Por √∫ltimo, aclaremos que este patr√≥n se puede combinar con otros conceptos, como pueden ser *DDD*, *Functional Programing*, *OOP*, etc. No obstante, la intenci√≥n de este ejemplo es transmitir unas nociones b√°sicas y ser capaz de llegar a cualquier persona interesada, de la manera m√°s sencilla posible.

Espero que estos conceptos te sean de ayuda en tu d√≠a a d√≠a, que desde un punto cr√≠tico te ayuden a evaluar tus proyectos de software y optar por √©ste u otros patrones de desarrollo que mejoren la calidad de tu trabajo; y que mitiguen los problemas diarios en lo que a software y decisiones de negocio se refiere.

Ante cualquier pregunta, no dudes ponerte en contacto conmigo a trav√©s de [mi web](https://adrianferrera.com/) o la de [software crafters](https://softwarecrafters.io/) para m√°s documentaci√≥n de esta √≠ndole.
Puedes encontrarme en redes sociales:

- [Twitter](https://twitter.com/AdrianFerrera91)
- [Linkedin](https://www.linkedin.com/in/afergon/)
- [Youtube](https://www.youtube.com/channel/UCiLWrFqdr20VGV9ZISqaJeg)",
    "slug": "arquitectura-hexagonal-frontend",
    "tags": [
      "react",
    ],
    "title": "Arquitectura Hexagonal en el FrontEnd",
    "userPicture": "",
    "username": "Adri√°n Ferrera",
  },
  {
    "category": "javascript",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/JS_category.png",
    "date": "",
    "description": "La programaci√≥n funcional es un paradigma de programaci√≥n basado en la composici√≥n de funciones matem√°ticas.",
    "id": "introduccion-programacion-funcional-javascript",
    "markdownBody": "La **programaci√≥n funcional** es una forma de entender nuestro software como una serie de *funciones matem√°ticas* en las que, dadas unas *entradas* determinadas, siempre obtenemos las mismas *salidas*.

Aunque est√© "de moda", este paradigma existe desde antes que la *orientaci√≥n a objetos*, y est√° basado en el *c√°lculo lambda*. Sin embargo, hasta hace relativamente poco permanec√≠a en el √°mbito acad√©mico y cient√≠fico.

En el caso de **JavaScript**, aunque no es un lenguaje funcional puro (ya que implementa caracter√≠sticas imperativas), su flexibilidad y dinamismo nos permiten adoptar un enfoque funcional y m√©todos como *map*, *filter* y *reduce* nos son de gran ayuda.

Los beneficios de la FP sobre nuestro c√≥digo son:

- Es mucho m√°s f√°cil de testear.
- Se reduce la complejidad, al enfocarse en qu√© vamos a hacer, y no c√≥mo lo haremos.
- El c√≥digo es m√°s modular, y por lo tanto, m√°s sencillo de entender.
- Tambi√©n es m√°s confiable, al tener la seguridad de que no cambiaremos el valor de ning√∫n recurso compartido.

## Algunos conceptos de la programaci√≥n funcional

### Par√°metros y argumentos

Los **argumentos** son los valores con los que llamamos a las funciones, mientras que los **par√°metros** son las variables nombradas que reciben estos valores dentro de nuestra funci√≥n:

\`\`\`javascript
const double = x => x * 2; // x es el par√°metro de nuestra funci√≥n

double(2); // 2 es el argumento con el que llamamos a nuestra funci√≥n
\`\`\`

### Aridad

La **aridad** de una funci√≥n hace referencia al n√∫mero de *par√°metros* que tiene. As√≠ pues, una funci√≥n de *aridad 1* (o unaria) tiene 1 par√°metro, una unidad de *aridad 2* (o binaria) tiene 2 par√°metros y as√≠ sucesivamente (por cierto, a la de *aridad 3* se le llama ternaria).

En **JavaScript**, es posible llamar a una funci√≥n con m√°s *argumentos* de los *par√°metros* que soporta. Simplemente ser√°n ignorados.

\`\`\`javascript
const double = x => x * 2;

console.log(double(2, 5)); // double(2); // 4;
\`\`\`

### Funciones puras

Una **funci√≥n** es **pura** cuando:

- Su salida depende s√≥lamente de los *par√°metros* recibidos (es **determinista**), por lo que una llamada a la funci√≥n se podr√≠a sustituir por el valor que devuelve sin que el funcionamiento de la aplicaci√≥n se viese alterado (**transparencia referencial**).
- Los *par√°metros* no son modificados y no se producen **efectos colaterales**. Imaginemos que varias partes de la aplicaci√≥n apuntasen a la misma referencia que ha recibido nuestra funci√≥n como argumento y que esta referencia original fuese alterada...


En el caso de **JavaScript**, esto tiene especial importancia, porque tanto los *arrays* como los *objetos* (tambi√©n las funciones) se copian por referencia y no por valor. Veamos un ejemplo de un *efecto colateral*.

\`\`\`javascript
// Queremos crear un objeto igual a objA, pero con "prop2" igual a  "newVal2"

const objA = {
  prop1: 'val1',
  prop2: 'val2',
};

const objB = objA;
objB.prop2 = 'newVal2';

console.log(objB); // { prop1: 'val1', prop2: 'newVal2' } ‚úÖ Tenemos nuestro nuevo objeto, pero...
console.log(objA); // { prop1: 'val1', prop2: 'newVal2' } ‚ùå hemos modificado el objeto original

console.log(objA === objB); // true ‚ùå
\`\`\`

Si queremos obtener un nuevo objecto, tan solo tenemos que hacer una destructuraci√≥n del objeto, a√±adiendo las claves que queremos modificar, o bien usar \`Object.assign\`:

\`\`\`javascript
const objA = {
  prop1: 'val1',
  prop2: 'val2',
};

const objB = { ...objA, prop2: 'newVal2');
// o
const objB = Object.assign({}, objA, { prop2: 'newVal2' });

console.log(objB); // { prop1: 'val1', prop2: 'newVal2' } ‚úÖ
console.log(objA); // { prop1: 'val1', prop2: 'val2' } ‚úÖ

console.log(objA === objB); // false ‚úÖ
\`\`\`

Debemos llevar cuidado con m√©todos como \`reverse\`, \`splice\`, etc, ya que mutan el array original. Una soluci√≥n ser√≠a buscar un m√©todo alternativo o bien crear un nuevo array antes de llamar a esos m√©todos:

\`\`\`javascript
const options = ['a', 'b', 'c', 'd'];

// en vez de splice(1, 2);
const filteredOptions = options.filter(option => option !== 'b' && option !== 'c'); 

const reversedOptions = [...options].reverse();
\`\`\`

Algunas librer√≠as, como React, basan su filosof√≠a en el concepto de *immutabilidad*, ya que los componentes son renderizados solo cuando alguna de las propiedades cambia.

En el caso anterior de efecto colateral,  como \`objA\` es igual a \`objB\`, si se pasase ese objeto como propiedad, podr√≠a suceder que el componente no fuese capaz de detectar esos cambios, y reflejase un estado desactualizado.

Con repecto a la transparencia referencial, imaginemos esta funci√≥n:

\`\`\`javascript
const runAtFive = () => {
	if ((new Date()).getHours() === 17) {
		externalFunction();
	}
};
\`\`\`

Si quisieramos testearla correctamente, necesitar√≠amos hacer un mock del objeto \`Date\` (o ejecutar el test solo a las 17h ü§£), adem√°s de tener que observar \`externalFunction\`.

Una aproximaci√≥n m√°s correcta ser√≠a pasar como argumento la hora actual, as√≠ como el callback que queremos ejecutar.
El retorno ser√≠a el resultado de ejecutar el callback, o \`false\` en caso contrario, lo que hace a nuestra funci√≥n mucho m√°s sencilla de testear.

\`\`\`javascript
const runAtFive = (hour, cb) => hour === 17 && cb();
\`\`\`

Algunos autores consideran que la utilizaci√≥n de constantes dentro de las funciones no viola los principios anteriormente descritos. Por ejemplo:

\`\`\`javascript
const SITE_NAME = 'Software Crafters';

const getFullTitle = (sectionTitle) => \`\${sectionTitle} | \${SITE_NAME}\`;
\`\`\`

En este caso, \`getFullTitle\` producir√≠a siempre el mismo resultado para una determinada entrada y, adem√°s, si en la funci√≥n reemplaz√°semos el uso de \`SITE_NAME\` por su valor, el resultado de la funci√≥n permanecer√≠a inalterable.

### Funciones de Alto Orden (Higher Order Functions)

Las funciones de alto orden son aquellas que se env√≠an como argumento a otra funci√≥n, o bien son devueltas como resultado de la ejecuci√≥n de otra funci√≥n.

\`\`\`javascript
const double = x => x * 2;
[1,2,3,4,5].map(double); // double actuar√≠a como HOF (Higher Order Function);

// add devuelve una HOF
const add = (x) => {
  if (typeof x === 'number') {
    return y => x + y;
  }
  return y => \`\${x}\${y}\`;
}

const addFive = add(5); HOF: y => 5 + y;
console.log(addFive(3)); // 8
console.log(addFive(12)); // 17
\`\`\`

Dado que, como veremos m√°s adelante, una de las caracter√≠sticas principales de la programaci√≥n funcional es la composici√≥n de funciones, este concepto nos resulta realmente √∫til.

### Forma declarativa

Tal y como la propia palabra expresa, cuando programamos de forma declarativa estamos haciendo uso de un alto nivel de abstracci√≥n, para decirle al lenguaje (o librer√≠a) qu√© es lo que queremos obtener, en vez de decirle c√≥mo debe obtenerlo.

En el ejemplo anterior, podemos escribir en forma declarativa:

\`\`\`javascript
[1,2,3,4,5].map(double);
\`\`\`

o bien en forma imperativa:

\`\`\`javascript
let arr = [];
for(i=0; i<5; i++) {
  arr.push((i + 1) * 2);
}
\`\`\`

Ejemplos de lenguajes y librer√≠as declarativas podr√≠an ser GraphQL y React:

\`\`\`javascript
export const USERS_QUERY = gql\`
  query usersQuery {
    users {
      edges {
        node {
          id
          title
          description
          categories
        }
      }
    }  
  }
\`;


const { data, loading, error } = useQuery(USERS_QUERY);
return (
  <div>
    {data.map(({ id, title }) => <div key={id}>{title}</div>)}
  </div>
)
\`\`\`

### Recursividad

La recursividad se da cuando una funci√≥n se llama a si misma, y es esencial cuando queremos trabajar de forma funcional con estructuras de datos.

\`\`\`javascript
const concatenateAll = (target, source) => {
  if (Array.isArray(source)) {
    return source.reduce(concatenateAll, target);
  }
  if (typeof source === 'object') {
    return Object.values(source).reduce(concatenateAll, target);
  }
  return \`\${target}#\${source}\`;
};

const data = {
  name: 'Jos√© Manuel',
  surname: 'Lucas',
  pet: {
    type: 'dog',
    name: 'Hustle',
  },
  hobbies: ['travelling', 'music', 'mountain biking'],
};

console.log(concatenateAll('', data)); // #Jos√© Manuel#Lucas#dog#Hustle#travelling#music#mountain biking
\`\`\`

### Composici√≥n de funciones

Imaginemos estas dos funciones:

\`\`\`javascript
const add3 = x => x + 3;
const double = x => x * 2;
\`\`\`

Podr√≠amos decir que \`double(add3(2))\` es el resultado de componer "double" y "add3" sobre "2".

- Se calcula el resultado de aplicar la funci√≥n "add3" a "2".
- Se calcula el resultado de aplicar la funci√≥n "double" al resultado anterior.

Dado que podemos predecir el resultado de "add3" y de "double" por separado bas√°ndonos en su argumento, podr√≠amos predecir de igual manera el resultado de la composici√≥n de las dos funciones.

Para facilitar la escritura de las composiciones de nuestras funciones, se suele hacer uso de las utilidades \`compose\` y \`pipe\`. Inclu√≠das en librer√≠as como [ramda](https://ramdajs.com/) o [lodash/fp](https://github.com/lodash/lodash/wiki/FP-Guide), si bien es cierto que la implementaci√≥n b√°sica es muy sencilla:

\`\`\`javascript
const compose = (...fns) => x => fns.reduceRight((acc, fn) => fn(acc), x);
const pipe = (...fns) => x => fns.reduce((acc, fn) => fn(acc), x);
\`\`\`

La diferencia es el orden en el que se pasan las funciones:

- **Compose**: Derecha a izquierda. M√°s cercano a la notaci√≥n matem√°tica.
- **Pipe**: Izquierda a derecha, m√°s cercano al orden de evaluaci√≥n.

\`\`\`javascript
console.log(pipe(add3, double)(2)); // 10 ‚úÖ
console.log(compose(add3, double)(2)); // 7‚ùå
console.log(compose(double, add3)(2)); // 10 ‚úÖ
\`\`\`

### Estilo t√°cito o "point free"

Consiste en omitir los argumentos en aquellos casos donde es posible y hace que nuestra composici√≥n de funciones quede mucho m√°s limpia.

Comparemos el ejemplo anterior con un ejemplo sin aplicar el estilo t√°cito:

\`\`\`javascript
pipe(add3, double)(2);

//vs

pipe(
  x => add3(x),
  x => double(x),
)(2);
\`\`\`

### Currificaci√≥n

La currificaci√≥n (estricamente hablando) consiste en transformar una funci√≥n con x par√°metros en una secuencia de x funciones con un solo argumento.

\`\`\`javascript
const sum3 = (a, b, c) => a + b + c;
const curriedSum3 = curry(sum3);

console.log(sum3(2, 4, 3)); // 9
console.log(curriedSum3(2)(4)(3)); // 9
\`\`\`


Una implementaci√≥n sencilla podr√≠a ser:

\`\`\`javascript
const curry = (fn, arity = fn.length) => {
  const nextCurried = prevArgs => nextArg => {
    const args = [...prevArgs, nextArg];
    return args.length >= arity ? fn(...args) : nextCurried(args);
  };
  return nextCurried([]);
}
\`\`\`

Sin embargo, en librer√≠as como ramda, la utilidad curry permite llamar a la funci√≥n en cualquiera de sus formas, y no s√≥lo argumento a argumento:

\`\`\`javascript
import { curry } from 'ramda'; 

const sum3 = (a, b, c) => a + b + c;
const curriedSum3 = curry(sum3);

sum3(2, 4, 3);
sum3(2)(4)(3);
sum3(2, 4)(3);
sum3(2)(4, 3);
\`\`\`

### Aplicaci√≥n parcial

La aplicaci√≥n parcial es una t√©cnica similar a la currificaci√≥n, solo que en este caso producimos una funci√≥n con una aridad que no necesariamente es 1, simplemente es menor que la funci√≥n original:

\`\`\`javascript
const operation = (a, b, c) => a + b - c;

const partialedOp = partial(operation, [2]);
console.log(partialedOp(4, 3)); // 3

// o

const partialedOp = partial(operation, [2, 4]);
console.log(partialedOp(3)); // 3
\`\`\`

La implementaci√≥n podr√≠a ser algo as√≠:

\`\`\`javascript
const partial = (fn, predefArgs) => (...args) => fn(... predefArgs, ...args);
\`\`\`

Tambi√©n es posible la aplicaci√≥n parcial desde la derecha, es decir, pasar los √∫ltimos argumentos y despu√©s los primeros:

\`\`\`javascript
const operation = (a, b, c) => a + b - c;

const partialedOp = partialRight(operation, [3]);
console.log(partialedOp(2, 4)); // 3

// o

const partialedOp = partialRight(operation, [4, 3]);
console.log(partialedOp(2)); // 3
\`\`\`

## Aislando los efectos colaterales

Si nuestras aplicaciones no pudiesen manejar efectos colaterales bajo ning√∫n concepto no podr√≠an hacer uso de:

- Estado compartido
- Eventos
- Peticiones a una API
- Input del usuario
- Lecturas de tiempo
- Escritura o lectura en disco
- Generaci√≥n de hashes o de n√∫meros aleatorios
- etc

Al aplicar un enfoque funcional a nuestro c√≥digo, el objetivo debe ser aislar todos esos efectos colaterales, no sustituirlos por completo.

Esto se podr√≠a resolver mediante una inyecci√≥n simple de dependencias...

\`\`\`javascript
/**
 * C√ìDIGO PURO
 */
const updateKey = (key, fn) => (obj) => ({
	...obj,
	[key]: fn(obj[key]),
});

const applyPrizeDecrease = updateKey('prize', currentPrize => currentPrize * 0.95);
const applyExpiryDecrease = updateKey('expiry', currentExpiry => currentExpiry > 0 ? currentExpiry - 1 : 0);

const updateItem = pipe(
	applyPrizeDecrease,
	applyExpiryDecrease,
);
const updateData = currentData => currentData.map(getUpdatedItem);

/**
 * C√ìDIGO IMPURO
 */
(async () => {
	// Usamos un array vac√≠o como salvaguarda, en caso de que la API responda con un valor "falsy"
	let data = await APIService.get('/endpoint') || [];
	setTimeout(() => {
		data = updateData(data);
	}, 86400000);
})();
\`\`\`

Imaginemos que queremos obtener el breakpoint actual en base a la anchura de nuestra pantalla. Tan s√≥lo deber√≠amos aislar nuestros *side effects* (obtener el objeto window) e inyectarlo como dependencia en nuestras funciones puras, que se encargan de extraer la anchura de la pantalla, y de transformarla en un string con el valor del breakpoint.

\`\`\`javascript
/**
 * C√ìDIGO PURO
 **/
const getWidth = x => x.screen.width;
const getBreakpoint = (x) => {
  if (x > 1200) {
    return 'desktop';
  }
  if (x > 600) {
    return 'tablet';
  }
  return 'mobile';
}

const getBreakpointFromWidth = pipe(getWidth, getBreakpoint);

/**
 * C√ìDIGO IMPURO
 **/
 console.log(getBreakpointFromWidth(width));

\`\`\`

Otra opci√≥n ser√≠a usar un **functor**, que es una funci√≥n que se encarga de transformar una categor√≠a en otra.

Un ejemplo sencillo ser√≠a el functor \`Array\`, que con el m√©todo map nos permite transformar cada uno de sus elementos de una categor√≠a a otra (por ejemplo de \`number\` a \`string\`, mediante la funci√≥n \`getFeelFromTemp \`).

\`\`\`javascript
const getFeelFromTemp = temp => (temp > 22 ? 'hot' : 'cold');

const temps = [24, 19, 13, 32];
const feels = temps.map(getFeelFromTemp);
console.log(feels); // ['hot', 'cold', 'cold', 'hot']
\`\`\`

Para el prop√≥sito que nos ocupa, crearemos un functor *effect*, que se encargar√° de mantener nuestro c√≥digo puro mientras lo "mapeamos", hasta que lo lancemos con "run".

\`\`\`javascript
/**
 * C√ìDIGO PURO
 */
class Effect {
  static of(f) {
    return new Effect(f);
  }
  
  constructor(f) {
    this.f = f;
  }
  
  map(g) {
    return Effect.of(x => g(this.f(x)));
  }
  
  run() {
    return this.f();
  }
}

const getWindow = () => window;
const getWidth = x => x.screen.width;
const getBreakpoint = (x) => {
  if (x > 1200) {
    return 'desktop';
  }
  if (x > 600) {
    return 'tablet';
  }
  return 'mobile';
}

const breakpointEffect = Effect.of(getWindow).map(getWidth).map(getBreakpoint);

/**
 * C√ìDIGO IMPURO
 */
console.log(breakpointEffect.run(100));
\`\`\`


## Bibliograf√≠a

- [Funcional Light JavaScript - Kyle Sympson](https://github.com/getify/Functional-Light-JS)
- [Professor Frisby's Mostly Adequate Guide to Funcional Programming - Brian Lonsdorf](https://mostly-adequate.gitbooks.io/mostly-adequate-guide/)
- [JavaScript Array Methods: Mutating vs. Non-Mutating](https://lorenstewart.me/2017/01/22/javascript-array-methods-mutating-vs-non-mutating/)
- [How to deal with dirty side effects in your pure functonal JavaScript](https://jrsinclair.com/articles/2018/how-to-deal-with-dirty-side-effects-in-your-pure-functional-javascript/)",
    "slug": "introduccion-programacion-funcional-javascript",
    "tags": [
      "javascript",
    ],
    "title": "Programaci√≥n funcional en JavaScript. Introducci√≥n",
    "userPicture": "",
    "username": "Jose Manuel Lucas",
  },
  {
    "category": "blockchain",
    "cover": "https://swcrafters.fra1.digitaloceanspaces.com/Categories/bitcoin_category.png",
    "date": "",
    "description": "Los √°rboles de Merkle fueron desarrollados en 1979 por Ralph Merkle, el padre de la criptograf√≠a asim√©trica y de las funciones hash.",
    "id": "merkle-trees-typescript-tdd",
    "markdownBody": "Hace un tiempo que estoy estudiando sistemas **Blockchain** en general y en particular el c√≥digo de **Bitcoin**. Durante este proceso me he topado con los conocidos como √°rboles de Merkle, o **Merkle Trees** en ingl√©s. Estos √°rboles son un elemento fundamental en el algoritmo de **validaci√≥n de transacciones** de Bitcoin, formando parte a su vez del famoso **mecanismo de consenso**. Esta estructura es una pieza criptogr√°fica muy interesante de implementar desde un punto de vista did√°ctico, ya que se interconectan conceptos de **criptograf√≠a** con **estructuras jer√°rquicas de datos**. La idea de este art√≠culo es realizar una implementaci√≥n aplicando un enfoque h√≠brido, interconectando conceptos de **POO** con elementos **programaci√≥n funcional** como **inmutabilidad**, **recursividad** y **high order functions**, todo ello aplicando **TDD** y **buenas pr√°cticas**. As√≠ que independientemente de que te interese el mundo Blockchain o no, te invito que sigas el art√≠culo hasta el final.

Los √°rboles de Merkle no son un concepto nuevo, fueron desarrollados y patentados en 1979 por **Ralph Merkle**, el padre de la **criptograf√≠a asim√©trica** y de las **funciones hash**. En esencia un √°rbol de Merkle, tambieÃÅn conocido como un aÃÅrbol hash binario, es una estructura de datos jer√°rquica, en concreto un **√°rbol binario balanceado y completo** en el que cada uno de los elementos viene representado por un hash criptogr√°fico. Se usa para resumir y verificar de manera eficiente la integridad de grandes conjuntos de datos. Recuerda, un √°rbol es binario cuando tiene cero, uno o dos nodos hijos, y adem√°s es balanceado cuando las alturas de los dos sub√°rboles de todos sus nodos no difiere en m√°s de uno. Por otro lado, un √°rbol binario completo es aquel en el que todos los niveles (excepto el m√°s profundo) est√°n completamente llenos de nodos. El nivel m√°s profundo puede llenarse parcialmente, pero todos los nodos deben generarse transversalmente desde la izquierda hasta la derecha y sin que se formen espacios entre ellos. 

![Tipos de √°rboles binarios](https://swcrafters.fra1.digitaloceanspaces.com/Posts/merkle-tree-typescript/Arboles%20Binarios%20Balanceados.png)

## Aplicaciones

Los √°rboles de Merkle tienen m√∫ltiples utilidades. En Bitcoin, por ejemplo, se usan  para resumir todas las transacciones de un bloque concreto mediante una huella digital conocida como ra√≠z de Merkle o Merkle root. Mediante esta ra√≠z y un subconjunto del √°rbol conocido como Merkle path se puede verificar si un dato concreto (en el caso de Bitcoin, una transacci√≥n) se encuentra dentro de un bloque sin tener que disponer del √°rbol entero o de toda la colecci√≥n de datos, en los siguientes p√°rrafos veremos como implementar esto con TypeScript. Los √°rboles de Merkle, adem√°s de usarse en tecnolog√≠as blockchain, tienen otras aplicaciones, como pueden ser:

* **Bases de datos**: Apache Cassandra y otros sistemas NoSQL los usan para mantener la integridad de sus datos sin sacrificar rendimiento.
* **Sistemas de control de versiones** como Git, Mercurial y Subversion. 
* Tambi√©n los podemos encontrar en **sistemas de ficheros** distribuidos. Desarrollos como Ceph, BTRFS, ZFS e IPFS; usan estos √°rboles de hash con el fin de verificar y mantener la integridad de la informaci√≥n.
* Sin lugar a dudas, el mayor uso de los √°rboles de Merkle es hacer seguros los bloques de datos recibidos de otros nodos en **redes P2P**, como por ejemplo BitTorrent. Ya que verifican que los fragmentos de diferentes archivos son recibidos sin haber sido alterados. 

## El algoritmo

El √°rbol de merkle se construye de abajo hacia arriba, es decir, desde las hojas hasta la ra√≠z, y de forma transversal, de izquierda a derecha. Para ello se ejecuta una funci√≥n de hash en pares de nodos recursivamente hasta que solo queda un √∫nico hash, este √∫ltimo se le conoce como ra√≠z de Merkle. En nuestra implementaci√≥n usaremos como funci√≥n de hash el algoritmo SHA-256, para ello nos apoyaremos en la librer√≠a crypto-js. En Bitcoin tambi√©n se usa este algoritmo, con la diferencia de que se aplica doblemente, es decir, se genera un hash a partir del hash anterior. Nosotros para simplificar, s√≥lo lo aplicaremos una vez.

Veamos un ejemplo, imagina que tenemos una con una colecci√≥n que contiene los siguientes cuatro elementos:  ‚ÄòA‚Äô, ‚ÄòB‚Äô, ‚ÄòC‚Äô y ‚ÄòD‚Äô. A cada uno de estos elementos se le aplica la funci√≥n hash, cuyos hashes resultantes (HA, HB, HC, y HD) forman las hojas del √°rbol. Es importante tener en cuenta que la colecci√≥n de elementos en s√≠ misma no se almacena en el √°rbol de merkle. A continuaci√≥n, los pares de hojas consecutivas se concatenan y se les vuelve a aplicar la funci√≥n hash, de esta manera se obtiene el siguiente nivel de nodos, en este caso HAB y HCD. En el siguiente paso, se aplica la funci√≥n hash en estos dos √∫ltimos nodos obteniendo as√≠ la ra√≠z de Merkle (HABCD):

![Merkle Tree](https://swcrafters.fra1.digitaloceanspaces.com/Posts/merkle-tree-typescript/Merkle%20Tree%20nodos%20pares.png)

¬øQu√© pasar√≠a en el caso de tener un n√∫mero impar de hojas o de nodos intermedios? En ese caso lo que se har√≠a es calcular el hash del elemento concatenado consigo mismo, de esta manera mantendremos constantemente los nodos con un n√∫mero par de elementos. Por ejemplo, si en lugar de la colecci√≥n anterior tuvi√©ramos A, B y C, tendremos como primer nivel de nodos padre HAB y HCC y como ra√≠z de Merkle HABCC: 

![Merkle Tree](https://swcrafters.fra1.digitaloceanspaces.com/Posts/merkle-tree-typescript/Merkle%20Tree%20Nodos%20Impares.png)

## ¬øC√≥mo lo vamos a implementar?

Para la implementaci√≥n del algoritmo vamos aplicar un estilo h√≠brido donde combinaremos algunos elementos de orientaci√≥n a objetos, como clases y value objects, con algunos elementos de programaci√≥n funcional como inmutabilidad, recursividad y las funciones de alto nivel map, filter y reduce; adem√°s nos pondremos algunas restricciones que me gusta aplicar en mi dia a dia, como evitar el uso de bucles y de bloques else.  

Los √°rboles en general se pueden representar de m√∫ltiples formas, en nuestro caso  lo vamos a hacer mediante una matrix de  bidimensional en la que cada uno de las filas se corresponde con un nivel del √°rbol, como veremos implementarlo a trav√©s de una matriz simplifica la representaci√≥n y la generaci√≥n. La matriz la vamos a construir como si de una pila se tratase, apilando las filas. Donde la primera fila insertada contendr√° el nodo de hojas y el √∫ltimo la ra√≠z de Merkle. Esta estructura la vamos a definir como una matriz de hashes de solo lectura para evitar mutar su contenido, adem√°s la vamos a encapsular dentro de un tipo rico en comportamiento e inmutable, un value object. Para representarlo vamos a utilizar una clase, cuyos m√©todos est√°ticos contendr√°n toda la l√≥gica necesaria para construir la estructura e instanciar el objeto. Y, por otro lado, los m√©todos de instancia expondr√°n la API m√≠nima necesaria para poder realizar la prueba de inclusi√≥n. 

## Generando el Merkle Tree con TDD

Vamos a implementar la soluci√≥n al algoritmo aplicando TDD. Empezamos por el primer test, en el que comprobaremos que se genera un √°rbol de hash binario para una colecci√≥n dada de elementos. Tratar de resolver directamente este test puede ser un paso demasiado grande. Lo que vamos a hacer es ir a√±adiendo aserciones intermedias que nos permitan dar peque√±os pasos hasta la soluci√≥n. Luego decidiremos si las dejamos en el test o simplemente las eliminamos. Comenzamos por una aserci√≥n que eval√∫a si las hojas se est√°n generando correctamente para la colecci√≥n dada. Para generar los hashes nos podemos apoyar en cualquier generador online de SHA256. Recuerda las funciones hash son deterministas, es decir, para una misma entrada siempre se obtiene la misma salida. 

\`\`\`javascript
describe('The Merkle Tree', () => {
	it('generates a binary hash tree from a given collection with an even number of elements', () => {
		const merkelTree = MerkleTree.createTree(['a', 'b', 'c', 'd']);

		expect(merkelTree.getLeaves()).toEqual([
			'ca978112ca1bbdcafac231b39a23dc4da786eff8147c4e72b9807785afee48bb',
			'3e23e8160039594a33894f6564e1b1348bbd7a0088d42c4acb73eeaed59c009d',
			'2e7d2c03a9507ae265ecf5b5356885a53393a2029d241394997265a1a25aefc6',
			'18ac3e7343f016890c510e93f935261169d9e3f565436429830faf0934f4f8e4',
		]);
	});
});
\`\`\`

La funci√≥n sha256 de crypto-js la vamos a esconder detr√°s de nuestra propia funci√≥n hash, en una especie de wrapper, para en el caso de querer reemplazar el tipo de hash o la librer√≠a en s√≠ misma s√≥lo haya que cambiarla en un punto. 

\`\`\`javascript
import { SHA256 } from 'crypto-js';

export function hash(value: string) {
	return SHA256(value).toString();
}
\`\`\`

A continuaci√≥n creamos la clase MerkleTree, en la cual vamos a encapsular la matriz de nodos, esta estructura la vamos a definir como privada y adem√°s de tipo ReadonlyArray, esto nos proteger√° de mutar la matriz ya que no nos permitir√° usar los t√≠picos m√©todos como push, unshift o shift que mutan el contenido del array. Para la creaci√≥n definimos un m√©todo de factor√≠a donde transformaremos la colecci√≥n de datos en el tipo que espera el constructor. Para hacer que el test pase implementamos el m√©todo getLeaves, que nos devolver√° un array con todas las hojas del √°rbol de manera transversal.

\`\`\`javascript
export class MerkleTree {
	private constructor(private readonly nodeMatrix: ReadonlyArray<ReadonlyArray<string>>) {}

	static create(elements: string[]) {
		const leafNode = elements.map((e) => hash(e));
		return new MerkleTree([leafNode]);
	}

	getLeaves() {
		return this.nodeMatrix[this.nodeMatrix.length - 1];
	}
}
\`\`\`

El siguiente paso m√°s sencillo es construir el primer nivel de nodos padres, esto lo representamos en otra colecci√≥n apilada sobre la anterior. Como hemos mencionado, los nodos padres se generan a partir de concatenar en pares los nodos hijos y aplicar la funci√≥n hash. Para evitar el ruido que introducen los hashes en los tests vamos a utilizar directamente la funcion hash que encapsulamos en el apartado anterior.


\`\`\`javascript
describe('The Merkle Tree', () => {
	it('generates a binary hash tree from a given collection with an even number of elements', () => {
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd']);

		expect(merkelTree.getLeaves()).toEqual([hash('a'), hash('b'), hash('c'), hash('d')]);
		expect(merkelTree.getNodesByLevel(0).length).toBe(2);
    const expectedABHash = hash(hash('a') + hash('b'));
		const expectedCDHash = hash(hash('c') + hash('d'));
		expect(merkelTree.getNodesByLevel(0)).toEqual([expectedABHash, expectedCDHash]);
	});
});
\`\`\`

Escribimos el c√≥digo m√≠nimo para que pase el test, para ello calculamos directamente los nodos padres e implementamos el m√©todo getNodesByLevel. 

\`\`\`javascript
export class MerkleTree {
	private constructor(private readonly nodeMatrix: ReadonlyArray<ReadonlyArray<string>>) {}

	static create(elements: string[]) {
		const leafNode = elements.map((e) => hash(e));
		const parentNodes = [hash(leafNode[0] + leafNode[1]), hash(leafNode[2] + leafNode[3])];
		const nodes = [parentNodes].concat([leafNode]);
		return new MerkleTree(nodes);
	}

	getNodesByLevel(level: number) {
		return this.nodeMatrix[level];
	}

	getLeaves() {
		return this.nodeMatrix[this.nodeMatrix.length - 1];
	}
}
\`\`\`

Este m√©todo nos devuelve los nodos para un nivel particular del √°rbol, por ahora este solo tiene dos niveles, cero y uno. El nivel cero representa en este momento los padres y el nivel 1 los nodos hoja:

\`\`\`javascript
[
	['62af5c3cb8da3e4f25061e829ebeea5c7513c54949115b1acc225930a90154da',
	'd3a0f1c792ccf7f1708d5422696263e35755a86917ea76ef9242bd4a8cf4891a',],
	['ca978112ca1bbdcafac231b39a23dc4da786eff8147c4e72b9807785afee48bb',
	'3e23e8160039594a33894f6564e1b1348bbd7a0088d42c4acb73eeaed59c009d',
	'2e7d2c03a9507ae265ecf5b5356885a53393a2029d241394997265a1a25aefc6',
	'18ac3e7343f016890c510e93f935261169d9e3f565436429830faf0934f4f8e4',]
]
\`\`\`

Antes de continuar vamos a refactorizar un poco el c√≥digo, podemos extraer dos m√©todos est√°ticos privados, uno para generar el hash de un nodo padre en particular a partir de un √≠ndice y otro para generar el conjunto de todos los nodos. Para refactorizar adecuadamente te aconsejo que trates de usar el refactor autom√°tico de tu IDE y que siempre mantengas los tests en verde.

\`\`\`javascript
export class MerkleTree {
	private constructor(private readonly nodeMatrix: ReadonlyArray<ReadonlyArray<string>>) {}

	static create(elements: string[]) {
		const leafNode = elements.map((e) => hash(e));
		const nodes = generateParentNodes(leafNode);
		return new MerkleTree(nodes);
	}

	private static generateParentNodes(leafNode: string[]) {
		const parentNode =  [this.generateParentHashNode(0, leafNode), this.generateParentHashNode(2, leafNode)]
		const nodes = [parentNodes].concat([leafNode]);
		return nodes;
	}

	private static generateParentHashNode(index: number, node: string[]) {
		return hash(node[index] + node[index + 1]);
	}

	getNodesByLevel(level: number) {
		return this.nodeMatrix[level];
	}

	getLeaves() {
		return this.nodeMatrix[this.nodeMatrix.length - 1];
	}
}
\`\`\`

Antes de continuar podemos refactorizar un poco m√°s, se me ocurre que podr√≠amos generar el nivel de nodos padres sin tener que hardcodear el √≠ndice, de esta manera continuamos generalizando y adem√°s eliminamos esa duplicidad. Para ello debemos pasarle a la funci√≥n generateParentHashNode solamente √≠ndices pares, siempre y cuando estos sean estrictamente menor que la longitud total del nodo. Vamos a implementar esta parte primero de forma imperativa y luego con un estilo m√°s funcional:

\`\`\`javascript
private static generateParentNodes(leafNode: string[]) {
		const nodes = [];
		nodes.push(leafNode)
		for (let i = 0; i < leafNode.length; i++) {
			if (i % 2 == 0) {
				nodes.push(this.generateParentHashNode(i, leafNode));
			}
		}
		return nodes;
	}
\`\`\`

Una alternativa funcional podr√≠a ser proyectar un array de √≠ndices pares, haciendo uso de una funci√≥n que genere un array a partir de un rango. La funci√≥n range suele formar parte de la librer√≠a est√°ndar en la mayor√≠a de lenguajes modernos, aunque en javascript no hay una implementaci√≥n per se. T√≠picamente se suele hacer uso de lodash o alguna otra librer√≠a de utilidades, pero personalmente prefiero construirme este tipo de elementos para minimizar el uso y actualizaci√≥n de librer√≠as de terceros. Una implementaci√≥n v√°lida para este prop√≥sito podr√≠a ser la siguiente:

\`\`\`javascript
function range(from:number, length:number, steps = 1): number[] {
	return Array.from({ length: length }, (_, i) => (i + from) * steps);
}
\`\`\`

Con esta pieza ya podemos reemplazar el bucle por una alternativa declarativa. Donde el rango empezaria en cero, el n√∫mero de elementos ser√≠a la mitad del n√∫mero de hojas y los pasos ser√≠an dos:

\`\`\`javascript
private static generateParentNodes(leafNode: string[]) {
		const length = Math.round(leafNode.length / 2);
		const parentNode = range(0, length, 2).map((i) => this.generateParentHashNode(i, leafNode));
		return  [parentNode].concat([leafNode]);
	}
\`\`\`

## Merkle Root
Nuestro √°rbol de Merkle aun no esta completo, por ahora solo estamos generando las hojas y el primer nivel de padres. Para completar el √°rbol tenemos que ser capaces de generar n n√∫mero de nodos padres hasta llegar a obtener un nivel con un solo hash, la ra√≠z de Merkle. Esta pieza es clave, ya que, junto con el Merkle Path, nos permitir√° verificar si un determinado dato se encuentra ha formado parte del √°rbol sin tener que reconstruirlo entero. 

Continuamos desarrollando nuestro primer test, vamos a√±adir una aserci√≥n que eval√∫a que estamos generando la raiz de merkle. Tambi√©n tenemos que modificar la aserci√≥n anterior ya que ahora los nodos padres intermedios tienen que estar en el nivel 1 en lugar del cero: 

\`\`\`javascript
describe('The Merkle Tree', () => {
	it('generates a binary hash tree from a given collection with an even number of elements', () => {
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd']);

    const expectedHashedLeaves = [hash('a'), hash('b'), hash('c'), hash('d')];
		const expectedABHash = hash(hash('a') + hash('b'));
		const expectedCDHash = hash(hash('c') + hash('d'));
		const expectedLevelOneHashedNodes = [expectedABHash, expectedCDHash];
		const expectedMerkleRoot = hash(expectedABHash + expectedCDHash);
		expect(merkelTree.getLeaves()).toEqual(expectedHashedLeaves);
		expect(merkelTree.getNodesByLevel(1).length).toBe(2);
		expect(merkelTree.getNodesByLevel(1)).toEqual(expectedLevelOneHashedNodes);
		expect(merkelTree.getNodesByLevel(0).length).toBe(1);
		expect(merkelTree.getMerkleRoot()).toBe(expectedMerkleRoot);
	});
});
\`\`\`

Para resolver esto vamos a utilizar un enfoque parecido al anterior. Lo implementaremos de primero de forma imperativa y luego veremos c√≥mo resolverlo de forma recursiva. El paso m√°s peque√±o para hacer que el test pase es utilizar un bucle while que genere y concatene los nodos padres hasta que el nodo root solo contenga un elemento:

\`\`\`javascript
	private static generateParentNodes(leafNode: string[]) {
		let nodes = [leafNode].concat([]);
		while (nodes[0].length > 1) {
			const length = Math.round(nodes[0].length / 2);
			const parentNode = range(0, length, 2).map((i) => this.generateParentHashNode(i, nodes[0]));
			nodes = [parentNode].concat(nodes);
		}
		return nodes;
	}
\`\`\`

Una vez tenemos el test en verde vamos a refactorizar aplicando un enfoque recursivo. El primer paso para transformar el bucle a una funci√≥n recursiva es representar el acumulador como un par√°metro de la funci√≥n. A continuaci√≥n debemos especificar la condici√≥n de salida de la funci√≥n recursiva, la cual la ya definimos en el bucle while anterior:

\`\`\`javascript
private static generateParentNodes(leafNode: string[], nodes = [leafNode].concat([])) {
		if (nodes[0].length > 1) {
			const length = Math.round(nodes[0].length / 2);
			const parentNode = range(0, length, 2).map((i) => this.generateParentHashNode(i, nodes[0]));
			return this.generateParentNodes(leafNode, [parentNode].concat(nodes));
		}
		return nodes;
	}
\`\`\`

Como norma general a la hora de escribir funciones recursivas debemos tratar de dise√±arlas con recursividad final, para aprovechar la optimizaci√≥n por recursi√≥n en cola (tail call optimization) que nos ofrecen los diferentes int√©rpretes y compiladores de los lenguajes modernos. Por cierto, en JavaScript se propuso en ES6, pero actualmente solamente Safari le da soporte. En su momento el V8 engine de Chrome tambi√©n lo soport√≥ pero por el momento no est√° de vuelta, as√≠ que ojo con los desbordamientos de pila en NodeJS. Aunque esta optimizaci√≥n no aplique en nuestro caso, vamos a refactorizar para dejar la funci√≥n con recursividad final, ya que nos va a quedar un c√≥digo m√°s elegante, de paso aprovechamos para a√±adir algunas variables explicativas:

\`\`\`javascript
	private static generateParentNodes(leafNode: string[], nodes = [leafNode].concat([])) {
		const rootNode = nodes[0];
		const isValidMerkleRoot = rootNode.length <= 1;
		if (isValidMerkleRoot) {
			return nodes;
		}
		const length = Math.round(rootNode.length / 2);
		const parentNode = range(0, length, 2)
			.map((i) => this.generateParentHashNode(i, rootNode));
		return this.generateParentNodes(leafNode, [parentNode].concat(nodes));
	}
\`\`\`

Ahora que hemos completado el test que genera el √°rbol de merkle para nodos pares podemos afrontar el caso de los nodos impares. En ese caso lo que ocurre es que nos queda un hash que no tiene pareja con la que concatenarlo. Como vimos en la definici√≥n del algoritmo, cuando se da esta situaci√≥n el nodo padre se obtiene mediante la concatenaci√≥n del hash hijo consigo mismo y aplicando al resultado la funci√≥n de hash. Vamos a crear un test partiendo del anterior, en este caso vamos a tener un elemento m√°s, por lo tanto en el nodo que contiene las hojas tendremos cinco hashes, en el siguiente tendremos tres, luego dos y finalmente la ra√≠z:

\`\`\`javascript
it('generates a binary hash tree from a given collection with an odd number of elements', () => {
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd', 'e']);

  	const expectedHashedLeaves = [hash('a'), hash('b'), hash('c'), hash('d'), hash('e')];
		const expectedABHash = hash(hash('a') + hash('b'));
		const expectedCDHash = hash(hash('c') + hash('d'));
		const expectedEEHash = hash(hash('e') + hash('e'));
		const expectedLevelTwoHashedNodes = [expectedABHash, expectedCDHash, expectedEEHash];
		const expectedABCDHash = hash(expectedABHash + expectedCDHash);
		const expectedEEEEHash = hash(expectedEEHash + expectedEEHash);
		const expectedLevelOneHashedNodes = [expectedABCDHash, expectedEEEEHash];
		const expectedMerkleRoot = hash(expectedABCDHash + expectedEEEEHash);
		expect(merkelTree.getLeaves()).toEqual(expectedHashedLeaves);
		expect(merkelTree.getNodesByLevel(2).length).toBe(3);
		expect(merkelTree.getNodesByLevel(2)).toEqual(expectedLevelTwoHashedNodes);
		expect(merkelTree.getNodesByLevel(1).length).toBe(2);
		expect(merkelTree.getNodesByLevel(1)).toEqual(expectedLevelOneHashedNodes);
		expect(merkelTree.getNodesByLevel(0).length).toBe(1);
		expect(merkelTree.getMerkleRoot()).toBe(expectedMerkleRoot);
	});
\`\`\`

La implementaci√≥n de esta parte es trivial, tan solo debemos a√±adir una condici√≥n a la funci√≥n generateParentHasNode que eval√∫e si hay un par de hashes para un nodo y un √≠ndice determinados, en caso afirmativo crea un hash con la concatenaci√≥n de los dos nodos y si no genera un hash del nodo concatenado consigo mismo:

\`\`\`javascript
	private static generateParentHashNode(index: number, node: string[]) {
		const hasCoupleOfHashes = index < node.length - 1;
		return hasCoupleOfHashes 
			? hash(node[index] + node[index + 1]) 
			: hash(node[index] + node[index]);
	}
\`\`\`

## Merkle Path

Para demostrar que un dato espec√≠fico est√° incluido en un √°rbol de merkle necesitamos obtener lo que se conoce como Merkle Path o camino de Merkle. En esencia, se trata de una colecci√≥n que contiene todos aquellos nodos necesarios para reconstruir la ra√≠z de Merkle. Por ejemplo, si queremos obtener el camino de Merkle para el hash del elemento ‚ÄòA‚Äô, utilizado en el ejemplo del primer test, solo nos har√≠an falta los hashes HB y HCD. Es decir, solo necesitamos un nodo por cada nivel del √°rbol, por lo tanto la altura del √°rbol va a coincidir con el n√∫mero de hashes que necesitamos que incluya el Merkle Path:

![Merkle Path](https://swcrafters.fra1.digitaloceanspaces.com/Posts/merkle-tree-typescript/Merkle%20Path.png)

Ahora que sabemos lo que es un Merkle Path, vamos a implementar una serie de pruebas que cubran algunos casos de uso. Empezar con un test sencillo, en el que se genera un array vac√≠o en el caso de que el hash de un elemento dado no se encuentre entre las hojas del √°rbol:

\`\`\`javascript
it('does not create the merkle path for a given element that does not exist in the leaves of the tree', () => {
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd']);
		
    const merklePath = merkelTree.generateMerklePath('e');

		expect(merklePath).toEqual([]);
});
\`\`\`

Este caso es muy sencillo de implementar, solo tenemos que evaluar el hash del elemento y comprobar que existe entre las hojas:

\`\`\`javascript
	generateMerklePath(element): string[] {
		const leafHash = hash(element);
		const leafLevel = this.nodeMatrix.length - 1;
		const leafIndex = this.getNodesByLevel(leafLevel).findIndex((e) => e == leafHash);
		if (leafIndex <= -1) {
			return [];
		}
	}
\`\`\`

El siguiente caso que vamos a implementar es ‚Äògenera un camino de merkle para un elemento dado que existe en un conjunto par de hojas‚Äô. Este caso de uso es un poco m√°s complejo, as√≠ que iremos construyendo el test en dos pasos. En esta primera iteraci√≥n solo obtendremos el primer hash del Merkle path:

\`\`\`javascript
it('generates the merkle path for a given element that exists in a set of even leaves', () => {
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd']);
		
    const merklePath = merkelTree.generateMerklePath('a');

		const expectedLeafHash = hash('b');
		expect(merklePath).toEqual([expectedLeafHash]);
});
\`\`\`

Para pasar de rojo a verde, podemos implementar una funci√≥n que devuelva el nodo vecino. Obteniendo el nodo de la derecha o de la izquierda dependiendo si el √≠ndice es par o impar, respectivamente:

\`\`\`javascript
	generateMerklePath(element): string[] {
		const leafHash = hash(element);
		const leafLevel = this.nodeMatrix.length - 1;
		const leafIndex = this.getNodesByLevel(leafLevel).findIndex((e) => e == leafHash);
		if (leafIndex <= -1) {
			return [];
		}
		const merklePath = [];
		merklePath.push(this.getNeighbourBy(leafIndex, leafLevel));
		return merklePath;

	}

	private getNeighbourBy(index: number, level) {
		if (index % 2 == 0) {
			return this.nodeMatrix[level][index + 1];
		}
		return this.nodeMatrix[level][index - 1];
	}
\`\`\`

Con el test pasando le a√±adimos a la aserci√≥n el hash que esperamos del siguiente nivel,  es decir, el que corresponde al hash de los elementos C y D:

\`\`\`javascript
	it('generates the merkle path for a given element that exists in a set of even leaves', () => {
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd']);
		
    const merklePath = merkelTree.generateMerklePath('a');

		const expectedLeafHash = hash('b');
		const expectedLevelOneHash = hash(hash('c') + hash('d'));
		expect(merklePath).toEqual([expectedLeafHash, expectedLevelOneHash]);
	});
\`\`\`

Esta parte la vamos a implementar primero con un enfoque imperativo y luego la pasaremos a un enfoque recursivo como hicimos anteriormente. Podemos utilizar un bucle while para ir acumulando los nodos necesarios mientras el nivel sea estrictamente mayor que cero. Necesitaremos ir decrementando el nivel y recalculando el √≠ndice: 

\`\`\`javascript
	generateMerklePath(element): string[] {
		const leafHash = hash(element);
		let leafLevel = this.nodeMatrix.length - 1;
		let leafIndex = this.getNodesByLevel(leafLevel).findIndex((e) => e == leafHash);
		if (leafIndex <= -1) {
			return [];
		}
		const merklePath = [];
		while (leafLevel > 0) {
			merklePath.push(this.getNeighbourBy(leafIndex, leafLevel));
			leafLevel--;
			leafIndex = Math.round(leafIndex / 2);
		}
		return merklePath;
	}
\`\`\`

Con el test pasando hacemos un peque√±o refactor en el que extraemos un m√©todo para facilitarnos la tarea de convertir el bucle a una funci√≥n recursiva:

\`\`\`javascript
	generateMerklePath(element): string[] {
		const leafHash = hash(element);
		const leafLevel = this.nodeMatrix.length - 1;
		const leafIndex = this.getNodesByLevel(leafLevel).findIndex((e) => e == leafHash);
		if (leafIndex <= -1) {
			return [];
		}
		return this.buildMerklePath( leafLevel,leafIndex);
	}

	private buildMerklePath( level: number, index: number) {
		const merklePath = [];
		while (level > 0) {
			merklePath.push(this.getNeighbourBy(index, level));
			level--;
			index = Math.round(index / 2);
		}
		return merklePath;
	}
\`\`\`

Una vez extra√≠do el m√©todo buildMerklePatch generar una funci√≥n recursiva a partir del c√≥digo que tenemos es pr√°cticamente trivial. Igual que hicimos con anterioridad, movemos el acumulador a la lista de par√°metros de la funci√≥n y sustituimos el while por una cl√°usula de guarda en la que directamente devolvemos la llamada recursiva:

\`\`\`javascript
	generateMerklePath(element): string[] {
		const leafHash = hash(element);
		const leafLevel = this.nodeMatrix.length - 1;
		const leafIndex = this.getNodesByLevel(leafLevel).findIndex((e) => e == leafHash);
		if (leafIndex <= -1) {
			return [];
		}
		return this.buildMerklePath(leafLevel, leafIndex);
	}

	private buildMerklePath(level: number, index: number, merklePath = []) {
		if (level > 0) {
			return this.buildMerklePath(
				level - 1,
				Math.round(index / 2),
				merklePath.concat(this.getNeighbourBy(index, level))
			);
		}
		return merklePath;
	}
\`\`\`

Podr√≠amos darle una vuelta m√°s al refactor invirtiendo la condici√≥n para hacer recursi√≥n en cola y reemplazar la estructura condicional por un ternario:

\`\`\`javascript
	private buildMerklePath(level: number, index: number, merklePath = []) {
		return level <= 0
			? merklePath
			: this.buildMerklePath(
                level - 1, 
                Math.round(index / 2), 
                merklePath.concat(this.getNeighbourBy(index, level))
            );
	}
\`\`\`

A continuaci√≥n podemos a√±adir algunos tests m√°s para comprobar que estamos cubriendo correctamente las diferentes casu√≠sticas. Tambi√©n se han eliminado algunas aserciones que eran redundantes. Nuestra suite completa quedar√≠a tal que as√≠:

\`\`\`javascript
import { MerkleTree } from '../core/MerkleTree';
import { hash } from '../core/utils/Crypto';

describe('The Merkle Tree', () => {
	it('creates a binary hash tree from a given collection with an even number of elements', () => {
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd']);

		const expectedHashedLeaves = [hash('a'), hash('b'), hash('c'), hash('d')];
		const expectedABHash = hash(hash('a') + hash('b'));
		const expectedCDHash = hash(hash('c') + hash('d'));
		const expectedLevelOneHashedNodes = [expectedABHash, expectedCDHash];
		const expectedMerkleRoot = hash(expectedABHash + expectedCDHash);
		expect(merkelTree.getLeaves()).toEqual(expectedHashedLeaves);
		expect(merkelTree.getNodesByLevel(1)).toEqual(expectedLevelOneHashedNodes);
		expect(merkelTree.getMerkleRoot()).toBe(expectedMerkleRoot);
	});

	it('creates a binary hash tree from a given collection with an odd number of elements', () => {
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd', 'e']);

		const expectedHashedLeaves = [hash('a'), hash('b'), hash('c'), hash('d'), hash('e')];
		const expectedABHash = hash(hash('a') + hash('b'));
		const expectedCDHash = hash(hash('c') + hash('d'));
		const expectedEEHash = hash(hash('e') + hash('e'));
		const expectedLevelTwoHashedNodes = [expectedABHash, expectedCDHash, expectedEEHash];
		const expectedABCDHash = hash(expectedABHash + expectedCDHash);
		const expectedEEEEHash = hash(expectedEEHash + expectedEEHash);
		const expectedLevelOneHashedNodes = [expectedABCDHash, expectedEEEEHash];
		const expectedMerkleRoot = hash(expectedABCDHash + expectedEEEEHash);
		expect(merkelTree.getLeaves()).toEqual(expectedHashedLeaves);
		expect(merkelTree.getNodesByLevel(2)).toEqual(expectedLevelTwoHashedNodes);
		expect(merkelTree.getNodesByLevel(1)).toEqual(expectedLevelOneHashedNodes);
		expect(merkelTree.getMerkleRoot()).toBe(expectedMerkleRoot);
	});

	it('does not create the merkle path for a given element that does not exist in the leaves of the tree', () =>{
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd']);

		const merklePath = merkelTree.generateMerklePath('e');

		expect(merklePath).toEqual([]);
	});

	it('generates the merkle path for a given element that exists in a set of even leaves', () => {
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd']);

		const merklePath = merkelTree.generateMerklePath('a');

		const expectedLeafHash = hash('b');
		const expectedLevelOneHash = hash(hash('c') + hash('d'));
		expect(merklePath).toEqual([expectedLeafHash, expectedLevelOneHash]);
	});

	it('generates the merkle path for a given element in an intermediate position of a set of even leaves', () =>{
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd']);

		const merklePath = merkelTree.generateMerklePath('c');

		const expectedLeafHash = hash('d');
		const expectedLevelOneHash = hash(hash('a') + hash('b'));
		expect(merklePath).toEqual([expectedLeafHash, expectedLevelOneHash]);
	});

	it('generates the merkle path for a given element that exists in a set of odd leaves', () => {
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd', 'e']);

		const merklePath = merkelTree.generateMerklePath('a');

		const expectedLeafHash = hash('b');
		const expectedLevelTwoHash = hash(hash('c') + hash('d'));
		const expectedEEHash = hash(hash('e') + hash('e'));
		const expectedLevelOneHash = hash(expectedEEHash + expectedEEHash);
		expect(merklePath).toEqual([expectedLeafHash, expectedLevelTwoHash, expectedLevelOneHash]);
	});
});
\`\`\`

Todas las pruebas pasan correctamente. Con esto podemos dar por completada la implementaci√≥n de la clase Merkle Tree. 

\`\`\`javascript
import { hash } from './utils/Crypto';
import { range } from './utils/Array';

export class MerkleTree {
	private constructor(private readonly nodeMatrix: ReadonlyArray<ReadonlyArray<string>>) {}

	static create(elements: string[]) {
		const leafNode = elements.map((e) => hash(e));
		const nodes = this.generateParentNodes(leafNode);
		return new MerkleTree(nodes);
	}

	private static generateParentNodes(leafNode: string[], nodes = [leafNode].concat([])) {
		const rootNode = nodes[0];
		const isValidMerkleRoot = rootNode.length <= 1;
		if (isValidMerkleRoot) {
			return nodes;
		}
		const length = Math.round(rootNode.length / 2);
		const parentNode = range(0, length, 2).map((i) => this.generateParentHashNode(i, rootNode));
		return this.generateParentNodes(leafNode, [parentNode].concat(nodes));
	}

	private static generateParentHashNode(index: number, node: string[]) {
		const hasCoupleOfHashes = index < node.length - 1;
		return hasCoupleOfHashes ? hash(node[index] + node[index + 1]) : hash(node[index] + node[index]);
	}

	generateMerklePath(element): string[] {
		const leafHash = hash(element);
		const leafLevel = this.nodeMatrix.length - 1;
		const leafIndex = this.getNodesByLevel(leafLevel).findIndex((e) => e == leafHash);
		if (leafIndex <= -1) {
			return [];
		}
		return this.buildMerklePath(leafLevel, leafIndex);
	}

	private buildMerklePath(level: number, index: number, merklePath = []) {
		return level <= 0
			? merklePath
			: this.buildMerklePath(
                level - 1, 
                Math.round(index / 2), 
                merklePath.concat(this.getNeighbourBy(index, level))
            );
	}

	private getNeighbourBy(index: number, level: number) {
		if (index % 2 == 0) {
			return this.getNodesByLevel(level)[index + 1];
		}
		return this.getNodesByLevel(level)[index - 1];
	}

	getMerkleRoot() {
		return this.getNodesByLevel(0)[0];
	}

	getNodesByLevel(level: number) {
		return this.nodeMatrix[level];
	}

	getLeaves() {
		return this.nodeMatrix[this.nodeMatrix.length - 1];
	}
}
\`\`\`



## Prueba de inclusi√≥n

La prueba de inclusi√≥n, o Merkle proof of inclusion, es un algoritmo que verifica que un elemento concreto se encuentra en un conjunto de datos a partir de un Merkle Path y un Merkle Root. En Bitcoin, todos los nodos ligeros (aquellos que no contienen la Blockchain entera) como por ejemplo podr√≠a ser una wallet, son capaces de validar si una transacci√≥n est√° incluida o no en un bloque con tan solo una mil√©sima parte de los datos, gracias al Merkle Root, al Merkle Path y al algoritmo de prueba de inclusi√≥n.

Para implementar este algoritmo vamos a construir un peque√±o servicio de dominio que recibe en el constructor un Merkle root y un Merkle Path y expone un m√©todo que verifica la inclusi√≥n de un elemento concreto. Como venimos haciendo hasta ahora vamos a construir primero el test y luego la implementaci√≥n:

\`\`\`javascript
describe('The Merkle proof of inclusion', () => {
	it('verifies that a element and a given merkle path generates the expected Merkle root for a tree with even nodes', () => {
		const element = 'a';
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd']);
		const proofOfInclusion = ProofOfInclusion.create(
			merkelTree.getMerkleRoot(),
			merkelTree.generateMerklePath(element)
		);

		expect(proofOfInclusion.verify(element)).toBeTruthy();
	});
});
\`\`\`

La implementaci√≥n del m√©todo de verificaci√≥n es bastante simple, en esencia lo que tenemos que hacer es generar el hash del dato recibido por par√°metro. Dicho hash lo concatenamos con el merkle path y a continuaci√≥n reducimos el array generado aplicando la funci√≥n de hash el resultado de concatenar el hash previo con el actual. Finalmente se compara el resultado con la ra√≠z de Merkle dada:

\`\`\`javascript
export class ProofOfInclusion {
	private constructor(private readonly merkleRoot: string, private readonly merklePath: ReadonlyArray<string>) {}

	static create(merkleRoot: string, merklePath: ReadonlyArray<string>) {
		return new ProofOfInclusion(merkleRoot, merklePath);
	}

	verify(element: string) {
		const hashedElement = hash(element);
		const newMerkleRoot = [hashedElement]
			.concat(this.merklePath)
			.reduce((previousHash, currentHash) => hash(previousHash + currentHash));
		return newMerkleRoot === this.merkleRoot;
	}
}
\`\`\`

Para terminar vamos a a√±adir algunas pruebas m√°s a la suite, por ejemplo podemos comprobar si un elemento existente en un √°rbol de merkle con nodos impares lo verifica correctamente y tambi√©n podemos a√±adir otro test que eval√∫e el caso contrario, es decir que no verifique la prueba de inclusi√≥n si el elemento no existe:

\`\`\`javascript
import { ProofOfInclusion } from '../core/ProofOfInclusion';
import { MerkleTree } from '../core/MerkleTree';

describe('The Merkle proof of inclusion', () => {
	it('verifies that a given element and a merkle path generate the expected Merkle root for a tree with even nodes', () => {
		const element = 'a';
		const merkelTree = MerkleTree.create([element, 'b', 'c', 'd']);
		const proofOfInclusion = ProofOfInclusion.create(
			merkelTree.getMerkleRoot(),
			merkelTree.generateMerklePath(element)
		);

		expect(proofOfInclusion.verify(element)).toBeTruthy();
	});

	it('verifies that a given element and a merkle path generate the expected Merkle root for a tree with odd nodes', () => {
		const element = 'a';
		const merkelTree = MerkleTree.create([element, 'b', 'c', 'd', 'e']);
		const proofOfInclusion = ProofOfInclusion.create(
			merkelTree.getMerkleRoot(),
			merkelTree.generateMerklePath(element)
		);

		expect(proofOfInclusion.verify(element)).toBeTruthy();
	});

	it('does not verify the inclusion of a data that does not exist', () => {
		const element = 'x';
		const merkelTree = MerkleTree.create(['a', 'b', 'c', 'd']);
		const proofOfInclusion = ProofOfInclusion.create(
      merkelTree.getMerkleRoot(), 
      merkelTree.generateMerklePath('a')
    );

		expect(proofOfInclusion.verify(element)).toBeFalsy();
	});
});
\`\`\`

Con esto damos por finalizada nuestra implementaci√≥n del √°rbol de Merkle y la prueba de inclusi√≥n. Puedes acceder al repositorio completo [desde aqu√≠](https://github.com/softwarecrafters-io/merkle-tree-typescript). Si el art√≠culo te ha gustado o te ha aportado alg√∫n detalle de valor, te agradeceria mucho que lo compartieras en tus redes sociales. 

",
    "slug": "merkle-trees-typescript-tdd",
    "tags": [
      "blockchain",
    ],
    "title": "Merkle Trees y prueba de inclusi√≥n con TypeScript y TDD",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "typescript",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/TS_category.png",
    "date": "",
    "description": "Un patr√≥n de dise√±o es un conjunto de recomendaciones que podemos aplicar para resolver problemas de dise√±o comunes. Creacionales y estructurales ",
    "id": "patrones-diseno-creacionales-estructurales",
    "markdownBody": "Aunque lo sepamos, creo que lo correcto es que empecemos por el principio: *¬øqu√© es un patr√≥n de dise√±o?* La definici√≥n seg√∫n Wikipedia es:

> Los patrones de dise√±o son unas **t√©cnicas para resolver problemas comunes en el desarrollo de software** y otros √°mbitos referentes al dise√±o de interacci√≥n o interfaces.
> Un patr√≥n de dise√±o resulta ser una **soluci√≥n a un problema de dise√±o**. Para que una soluci√≥n sea considerada un patr√≥n debe poseer ciertas caracter√≠sticas. Una de ellas es que **debe haber comprobado su efectividad** resolviendo problemas similares en ocasiones anteriores. Otra es que **debe ser reutilizable**, lo que significa que es aplicable a diferentes problemas de dise√±o en distintas circunstancias.

Efectivamente, un patr√≥n de dise√±o no es m√°s que una especie de receta o recomendaciones que podemos aplicar sobre nuestro c√≥digo para resolver problemas de dise√±o comunes, incrementando adem√°s la calidad de √©ste, haci√©ndolo m√°s mantenible, desacoplado y tolerante a cambios. Estas recetas podemos reutilizarlas gracias a que ya han sido probadas anteriormente en situaciones similares por gente que sabe mucho m√°s que nosotros, por lo que su efectividad est√° m√°s que demostrada.

Los patrones de dise√±o son uno de los aspectos m√°s importantes de las **bases del desarrollo de software**, que siempre han estado (y estar√°n) ah√≠, independientemente de los frameworks y librer√≠as que han ido saliendo al mercado, por lo que es casi obligatorio conocerlos.

Pero cuidado, no dejan de ser una herramienta m√°s que tenemos disponible para desarrollar, por lo que deberemos conocer correctamente la motivaci√≥n de cada uno de ellos, para saber cuando merece la pena aplicarlos sobre nuestros dise√±os, **evitando la sobreingenier√≠a**.

A lo largo del art√≠culo, veremos varios de estos **patrones aplicados sobre ejemplos reales** dentro de una aplicaci√≥n *Angular* en la que trabajamos durante 2 a√±os, implementada con *TypeScript*. De esta forma, evitaremos repasar cada patr√≥n s√≥lo desde el punto de vista te√≥rico, por lo que os resultar√° m√°s f√°cil saber si se ajusta a vuestras necesidades o no.

Antes de meternos de lleno con cada patr√≥n, cabe destacar que se suelen agrupar en distintas categor√≠as:
* **Patrones creacionales:** Solucionan problemas de creaci√≥n de instancias de objetos.
* **Patrones estructurales:** Solucionan problemas de composici√≥n y agregaci√≥n de objetos.
* **Patrones de comportamiento:** Solucionan problemas surgidos sobre las responsabilidades e interacciones entre objetos.
* **Patrones de UI:** Solucionan problemas espec√≠ficos sobre la capa de presentaci√≥n de la aplicaci√≥n.

En este primer art√≠culo nos centraremos en los patrones creacionales y estructurales.

## Patrones creacionales
### Factory method
Nuestro objetivo antes de aplicar este patr√≥n, es crear instancias de un objeto cualquiera *ConcreteProduct*, que puede implementar una interfaz *Product* en caso de que necesitemos instanciar distintos tipos de objetos con una estructura similar:
\`\`\`javascript
interface Product {
  // Contract members
}

class ConcreteProduct1 implements Product {
  // Contract members implemented
}
\`\`\`
El patr√≥n *factory method* nos permite **encapsular** la l√≥gica de creaci√≥n de ese objeto dentro de las subclases *ConcreteCreators*, descargando de dependencias al cliente que las consume:
\`\`\`javascript
abstract class Creator {
  public abstract factoryMethod(): Product;
}

class ConcreteCreator extends Creator {
  factoryMethod(): Product {
    return new ConcreteProduct1();
  }
}

export class Client {
  createProduct(): Product {
    const creator: Creator = new ConcreteCreator();
    return creator.factoryMethod();
  }
}
\`\`\`
Como pod√©is ver en el c√≥digo, *ConcreteCreator* extiende la clase abstracta *Creator* para que podamos asegurarnos de que todas las subclases encargadas de crear las instancias de los distintos tipos de objetos, devuelven un objeto de tipo *Product* y adem√°s tienen su correspondiente *factory method* con la misma firma. Adem√°s, podemos a√±adir en esa clase abstracta, m√°s m√©todos que tengan que ver con la manipulaci√≥n de los productos.

Adem√°s, este patr√≥n favorece la **extensibilidad** siguiendo el [principio de open-close](https://es.wikipedia.org/wiki/Principio_de_abierto/cerrado): podemos a√±adir un nuevo *ConcreteProduct* con solo cumplir la interfaz, sin tener que modificar los productos existentes. Incluso tenemos la **versatilidad** de intercambiar facilmente un *ConcreteCreator* por otro.

Otra ventaja de este patr√≥n, es que si los objetos *Product* tienen alguna dependencia externa, podemos proporcion√°rselas mediante su constructor y esta l√≥gica estar√° encapsulada tambi√©n. De tal forma que si en el futuro var√≠a alguna de estas dependencias, el punto de colisi√≥n en el c√≥digo es mucho menor, s√≥lo tendremos que modificar la dependencia en la instanciaci√≥n desde su *ConcreteProduct*, en vez de tener que revisar todos los *Client*.

Una vez recordada la teor√≠a del patr√≥n, vamos a ver c√≥mo lo aplicamos nosotros en el proyecto.

Para el entorno de *Producci√≥n*, nos surgi√≥ la necesidad de guardar una traza de los eventos y errores que iban sucediendo durante la ejecuci√≥n de la aplicaci√≥n en una plataforma *cloud* como es [Application Insights](https://docs.microsoft.com/es-es/azure/azure-monitor/app/app-insights-overview). Sin embargo, para el entorno de *Desarrollo*, quer√≠amos que esos eventos y errores aparecieran en la consola del navegador.

Para ello, definimos la interfaz *Logger* con el m√©todo *log* que usaremos para registrar estos eventos y errores. Dicha interfaz la implementan *AppInsightsLogger* que registra la informaci√≥n en la nube y un hipot√©tico *ConsoleLogger* que no hace falta implementarlo puesto que el objeto *console* del navegador ya cumple con esa interfaz. 
\`\`\`javascript
interface Logger {
    log(message: string): void;
}

class AppInsightsLogger implements Logger {
    log(message: string): void {
        (<any>window).appInsights.trackTrace({ message });
    }
}
\`\`\`
Para crear cada uno de los *loggers* tenemos dos clases *AppInsightsLoggerCreator* y *ConsoleLoggerCreator* que pueden ser instanciadas desde cualquier punto de la aplicaci√≥n, **sin necesidad de conocer c√≥mo deben crearse dichos objetos**, √∫nicamente invocando al *factory method* *getLogger*:
\`\`\`javascript
class ConsoleLoggerCreator
    extends AbstractLoggerCreator {

    protected createLogger(): Logger {
        return console;
    }
}

class AppInsightsLoggerCreator
    extends AbstractLoggerCreator {

    protected createLogger(): Logger {
        return new AppInsightsLogger();
    }
}
\`\`\`
N√≥tese que ambos *LoggerCreators* extienden la clase abstracta *AbstractLoggerCreator* para evitar que ciertos puntos de la aplicaci√≥n dependan de un tipo concreto, favoreciendo implementar un **c√≥digo m√°s gen√©rico y sin duplicidades**. Adem√°s, nos permite a√±adir en dicha clase m√°s m√©todos que tengan que ver con la manipulaci√≥n de loggers.
\`\`\`javascript
abstract class AbstractLoggerCreator {
    protected abstract createLogger(): Logger;

    public getLogger(): Logger {
        return this.createLogger();
    }
    // More possible methods about loggers manipulation
}
\`\`\`
En vez de invocar directamente al *factory method* desde el cliente, implementamos una clase intermedia *LoggerCreator* que era la encargada de llamar a este m√©todo dependiendo del entorno en el que nos encontr√°bamos:
\`\`\`javascript
class LoggerCreator {
    public static getLogger(environment): Logger {
        const dictionary = {
            ['DEV']: () => new ConsoleLoggerCreator(),
            ['PROD']: () => new AppInsightsLoggerCreator()
        };
        return dictionary[environment]().getLogger();
    }
}

export class Client {
    constructor(private appConfig: { environment: string }) { }

    main() {
        LoggerCreator.getLogger(this.appConfig.environment).log('a message to log');
    }
}
\`\`\`

### Factory method (with params)
Partimos del objetivo de instanciar tres tipos de objetos diferentes pero con una interfaz com√∫n a implementar:
\`\`\`javascript
interface Product {
  // Contract members
}

class ConcreteProduct1 implements Product {
  // Contract members implemented
}

class ConcreteProduct2 implements Product {
  // Contract members implemented
}

class ConcreteProduct3 implements Product {
  // Contract members implemented
}
\`\`\`
Este patr√≥n no deja de ser una variaci√≥n sobre el patr√≥n *factory method* original, cuya principal diferencia es que **un mismo factory method** de un *ConcreteCreator* puede ser **utilizado para crear estos tres tipos de objetos diferentes**, s√≥lamente pasando por par√°metro distintos valores.
\`\`\`javascript
interface Creator {
  factoryMethod(param: 1 | 2 | 3): Product;
}

class ConcreteCreator implements Creator {
  factoryMethod(param: 1 | 2 | 3): Product {
    const dictionary = {
      1: ConcreteProduct1,
      2: ConcreteProduct2,
      3: ConcreteProduct3
    }
    const ConcreteProduct = dictionary[param];
    return new ConcreteProduct();
  }
}

export class Client {
  createProduct(): Product {
    const creator = new ConcreteCreator();
    return creator.factoryMethod(1);
  }
}
\`\`\`
En nuestro caso, ten√≠amos una aplicaci√≥n basada en formularios, donde los usuarios de cada equipo introduc√≠an la informaci√≥n necesaria. Esa informaci√≥n deb√≠a ser corregida y validada campo a campo, formulario a formulario por un jefe de equipo. 

Esta funcionalidad de modificaci√≥n y validaci√≥n del valor de cada campo se centraliz√≥ en un √∫nico componente, puesto que lo √∫nico que cambiaba era el tipo de datos que recib√≠a y su forma de representaci√≥n. De esta forma, tenemos:
\`\`\`javascript
@Component({ selector: 'fm-creator-component', template: '' })
export class FactoryMethodCreatorComponent implements OnInit {
    @Input() mode: ComponentModes;
    @Input() data: Array<any>;

    constructor(
        private componentFactoryResolver: ComponentFactoryResolver,
        public viewContainerRef: ViewContainerRef
    ) { }

    ngOnInit() {
        const componentToInstance = ComponentFactory.getComponentByMode(this.mode);
        const componentFactory =
            this.componentFactoryResolver.resolveComponentFactory(componentToInstance);

        this.viewContainerRef.clear();

        const componentInstance =
            this.viewContainerRef.createComponent(componentFactory).instance;
        componentInstance.data = this.data;
    }
}
\`\`\`
Un componente *FactoryMethodCreatorComponent* que es el que se encarga de actuar como *creator* y que no tiene una representaci√≥n propia, sino que es un mero contenedor que dentro de √©l renderiza el componente concreto en base al par√°metro *mode* que le llega por par√°metro como *Input*. Como v√©is, en nuestro caso no hay un *factory method* que se llame de forma expl√≠cita, ya que la "magia" transcurre dentro del m√©todo *ngOnInit*.

Por tanto, con esto ya √©ramos capaces de renderizar en una vista, de forma distinta, una serie de datos con el **componente *creator* y el par√°metro como √∫nicas dependencias**. Como se ve en el ejemplo, podemos representar los mismos datos con una caja de texto, un *dropdown* o un *textarea*, usando el mismo componente *creator* y pas√°ndole valores distintos de *mode*.
\`\`\`javascript
@Component({ selector: 'fm-textarea-component', templateUrl: './textarea.component.html' })
export class FactoryMethodTextAreaComponent implements IComponent {
    @Input() data: Array<any>;
}
@Component({ selector: 'fm-text-component', templateUrl: './text.component.html' })
export class FactoryMethodTextComponent implements IComponent {
    @Input() data: Array<any>;
}
@Component({ selector: 'fm-select-component', templateUrl: './select.component.html' })
export class FactoryMethodSelectComponent implements IComponent {
    @Input() data: Array<any>;
}
\`\`\`
Adicionalmente, definimos una interfaz *IComponent* para obligar a que los componentes ligados a las distintas representaciones tengan al menos la misma propiedad *Input* donde recibir los datos a representar. 

Esta relaci√≥n entre el modo y el tipo de componente a renderizar, la definimos en un diccionario que posteriormente encapsulamos en una factor√≠a que es consultada por el componente *creator*: 
\`\`\`javascript
export class ComponentFactory {
    static getComponentByMode(mode: ComponentModes) {
        const dictionary = {
            [ComponentModes.Text]: FactoryMethodTextComponent,
            [ComponentModes.TextArea]: FactoryMethodTextAreaComponent,
            [ComponentModes.Select]: FactoryMethodSelectComponent
        };
        return dictionary[mode];
    }
}
\`\`\`

## Singleton
Este es sin duda uno de los patrones que m√°s hemos utilizado todos en nuestros proyectos. Su caracter√≠stica principal es que nos permite **crear una instancia √∫nica** de un objeto determinado, consiguiendo as√≠ un punto centralizado al que podemos acceder desde cualquier punto de nuestro sistema.

As√≠, desde el punto de vista te√≥rico, tendremos nuestra clase *Singleton* que crear√° y devolver√° mediante el m√©todo *build* una instancia de s√≠ misma la primera vez que se llame y reutilizar√° y devolver√° esa misma instancia en el resto de llamadas sucesivas:
\`\`\`javascript
class Singleton {
    private static instance: Singleton;
    private constructor() { }
    static build(): Singleton {
        Singleton.instance = Singleton.instance || new Singleton();
        return Singleton.instance;
    }
}

export class Client {
    getInstance(): Singleton {
        const instance = Singleton.build();
        return instance;
    }
}
\`\`\`
Con esto conseguimos tambi√©n **evitar la creaci√≥n de intancias innecesarias**. Hay que tener especial cuidado a la hora de acceder a esa instancia *Singleton* desde distintos puntos, puesto que si lo hacemos sin un orden establecido, obtendremos valores y resultados no esperados.

En nuestro proyecto real, ten√≠amos una parte de generaci√≥n de informes, donde se utilizaban una serie de templates HTML en los que se representaban una serie de datos almacenados en *data sources*. Todo esto gracias a la librer√≠a [Stimulsoft JS](https://www.stimulsoft.com/en/get-started/reports-js). 

Para obtener esos templates HTML, ten√≠amos que hacer llamadas a una API externa. Para ello, creamos un agente intermedio que era el que realizaba las llamadas HTTP necesarias:
\`\`\`javascript
class ReportTemplatesAgent {
    constructor(
        private baseUrl: string,
        private applicationId: string
    ) { }

    getReporTemplates(): Promise<Array<ReportTemplate>> {
        return fetch(
            new Request(\`\${this.baseUrl}/get-all-report-templates\`)
        ).then(response => response.json());
    }
}
\`\`\`
El problema, es que antes de ejecutar esas llamadas HTTP, necesit√°bamos configurar la URL de la API al iniciar la aplicaci√≥n SPA. Para ello, implementamos una factor√≠a *ReportTemplatesAgentFactory* que es la que crea el objeto *ReportTemplatesAgent*. Como el inicio de nuestra aplicaci√≥n y la obtenci√≥n de las templates HTML se realizan en momentos distintos, esta instancia se crea en forma de *Singleton*:
\`\`\`javascript
class ReportTemplatesAgentFactory {
    private static instance: ReportTemplatesAgent;
    private static config: { baseUrl: string, applicationId: string };

    static use(baseUrl: string, applicationId: string) {
        this.config = { baseUrl, applicationId };
    }

    static build(): ReportTemplatesAgent {
        if (!this.config) {
            throw new Error('You should configure the factory before using it.')
        }
        this.instance = this.instance || new ReportTemplatesAgent(
            this.config.baseUrl,
            this.config.applicationId
        );
        return this.instance;
    }
}

export class Client {
    initializeApp(): void {
        ReportTemplatesAgentFactory.use(
            'https://my-base-url', 'my-app-id');
    }

    async generateReports(): Promise<void> {
        const reportTemplates =
            await ReportTemplatesAgentFactory
                .build().getReporTemplates();
        // Apply datasource over the report templates.
    }
}
\`\`\`

## Patrones estructurales
### Adapter
El patr√≥n *Adapter* o adaptador, nos sirve exactamente para lo que su propio nombre indica: para adaptar **una interfaz** espec√≠fica, haci√©ndola compatible con otra, cuando a priori no lo son. Lo de **una interfaz** lo resalto de nuevo para cuando m√°s adelante veamos el patr√≥n *Facade*, puesto que es una de las principales diferencias entre ellos. 

Desde el punto de vista te√≥rico, partimos de la interfaz *Adaptee* que queremos adaptar, y de la interfaz *Target* a la que queremos adaptarla:
\`\`\`javascript
class Adaptee {
    oldMethod(): void { }
}
interface Target {
    requiredMethod(): void;
}
\`\`\`
Finalmente, definimos la clase *Adapter* que implementa la interfaz *Target* y recibir√° en su constructor un objeto de la interfaz a adaptar (*Adaptee*). De esta forma, el m√©todo de la nueva interfaz que implementa, llamar√° por debajo al m√©todo no adaptado y lograremos nuestro objetivo:
\`\`\`javascript
class Adapter implements Target {
    constructor(private adapteeObject: Adaptee) { }

    requiredMethod(): void {
        this.adapteeObject.oldMethod();
    }
}
export class Client {
    static main(): void {
        const a_compatible_object = new CompatibleObject();
        const a_non_compatible_object = new Adaptee();
        const adapter = new Adapter(a_non_compatible_object);

        a_compatible_object.requiredMethod();
        adapter.requiredMethod();
    }
}
\`\`\`
En nuestro caso, utilizamos este patr√≥n para encapsular ciertos componentes que sab√≠amos que iban a ser muy cambiantes debido a la indefinici√≥n inicial que ten√≠amos del producto. Con ello, **proteger√≠amos al resto del sistema de dichos cambios**.

Por ejemplo, implementamos un componente personalizado *tooltip* que adaptaba los eventos y propiedades de la librer√≠a de terceros *ng2-tooltip-directive*. En este ejemplo, podemos ver como adaptamos el evento *shown* disparado por la directiva de *Angular* *tooltip* a un *Output* personalizado:
\`\`\`html
<i [tooltip]="text" (events)="handleTooltipEvents($event)" class="material-icons">info</i>
\`\`\`
\`\`\`javascript
@Component({
    selector: 'fa-tooltip',
    templateUrl: './tooltip-adapter.component.html'
})
export class TooltipAdapterComponent {
    @Input() text: string;
    @Output() shown: EventEmitter<void> = new EventEmitter<void>();

    handleTooltipEvents(event: { type: string, position: DOMRect }) {
        if (event.type === 'shown') {
            this.shown.emit();
        }
    }
}
\`\`\`
Si examinamos c√≥mo debemos consumir dicho componente desde las vistas de la aplicaci√≥n:
\`\`\`html
<div class="container">
    <span>One text</span>
    <fa-tooltip class="tooltip" text="one tooltip" (shown)="tooltipWasShown()"></fa-tooltip>
    <span>Another text</span>
    <fa-tooltip class="tooltip" text="another tooltip" (shown)="tooltipWasShown()"></fa-tooltip>
</div>
\`\`\`
Podemos observar que cualquier cambio en la librer√≠a de terceros, **s√≥lo afectar√°** a nuestro componente personalizado, puesto que la dependencia est√° centralizada en √©l. 

Este caso espec√≠fico de la encapsulaci√≥n del *tooltip* result√≥ ser una buen√≠sima decisi√≥n, puesto que pasados unos meses despu√©s del inicio del proyecto, cambiaron los requisitos de negocio respecto al *tooltip*, y no tuvimos m√°s que cambiar la librer√≠a por otra y adaptar nuestro componente, el resto del sistema permaneci√≥ inalterado.

## Facade
Este patr√≥n es f√°cilmente confundible con el patr√≥n *Adapter* anterior, de hecho, nosotros mismos los hemos confundido a la hora de identificarlos, ¬°no teng√°is miedo a equivocaros!. A continuaci√≥n, voy a intentar aclarar la diferencia entre ambos.

Nuestra principal motivaci√≥n para este patr√≥n es crear una interfaz (que actuar√° como *fachada*) para **simplificar la interacci√≥n y comunicaci√≥n con otros subsistemas**. Imaginemos que tenemos tres subsistemas con tres m√©todos distintos:
\`\`\`javascript
class Part1 {
    method1(): void {
        console.log("method 1 (Part 1)");
    }
}

class Part2 {
    method2(): void {
        console.log("method 2 (Part 2)");
    }
}

class Part3 {
    method3(): void {
        console.log("method 3 (Part 3)");
    }
}
\`\`\`
Estos m√©todos de cada subsistema, deben ser llamados siempre en un orden concreto. Podemos simplificar las llamadas ordenadas de cada m√©todo y centralizarlas en una clase *Facade*:
\`\`\`javascript
class Facade {
    private part1: Part1 = new Part1();
    private part2: Part2 = new Part2();
    private part3: Part3 = new Part3();

    operation1(): void {
        this.part1.method1();
        this.part2.method2();
    }

    operation2(): void {
        this.part1.method1();
        this.part3.method3();
    }
}
\`\`\`
Con ello, adem√°s de simplificar las llamadas a los m√©todos, logramos **encapsular los subsistemas** y los clientes o consumidores no depender√°n de ellos. Por tanto, podr√≠amos cambiar la implementaci√≥n interna de cada subsistema o incluso cambiar la *fachada* siempre que se cumpla la misma interfaz:
\`\`\`javascript
export class Client {
    callOperations(): void {
        const facade = new Facade();
        facade.operation1();
        facade.operation2();
    }
}
\`\`\`
Y aqu√≠ podemos ver la **principal diferencia** respecto al patr√≥n *Adapter*. El patr√≥n *Adapter* adapta una interfaz para hacerla compatible con otra, el *Facade* crea y expone una interfaz simplificada para comunicarse con otras interfaces o subsistemas m√°s complejos.

En nuestro proyecto, volviendo al ejemplo de los informes, para obtener sus templates HTML, deb√≠amos utilizar diferentes tipos de servicios. Nuestra aplicaci√≥n ten√≠a dos posibles modos de ejecuci√≥n: como una SPA convencional en un navegador web y como una aplicaci√≥n de escritorio distribuida con [Electron](https://www.electronjs.org/).

En el caso en que estemos ejecutando la aplicaci√≥n con *Electron*, los templates HTML deb√≠amos obtenerlos desde los *assets* embebidos en la propia instalaci√≥n de la aplicaci√≥n. Por tanto, para este proceso, ten√≠amos tres servicios implicados: un servicio para obtener el HTML de los *assets* (*Electron*), otro para obtenerlo en la versi√≥n web desde la API y otro para comprobar si estamos en el navegador web o en el escritorio.

Estos servicios podemos verlos a continuaci√≥n:
\`\`\`javascript
export class AppModeService {
    isOffline(): boolean {
        return !!window.navigator.userAgent.match(/Electron/);
    }
}
export class AssetsService {
    getJsonFromFile(fileName: string): Promise<any> {
        return fetch(new Request(\`./my-assets-path/\${fileName}.json\`))
            .then(response => response.json());
    }
}
export class ReportsService {
    async getAll(): Promise<IReport[]> {
        const reports = await fetch(
            new Request('http://my-reports-rest-api/reports'))
            .then(response => response.json());

        return reports.map((report, index) =>
            ({
                id: index,
                template: 'a-html-report-template',
                name: report.name
            }));
    }
}
\`\`\`
Toda esta l√≥gica para obtener los templates, la simplificamos creando un *ReportsAgentFacade* que actuaba como *fachada*, exponiendo √∫nicamente el m√©todo *loadReports* para cargar los informes al inicio de la aplicaci√≥n y otro m√©todo *getReport* para obtener un informe espec√≠fico y generarlo en otro punto de la aplicaci√≥n:
\`\`\`javascript
export class ReportsAgentFacade {
    private reportsService = new ReportsService();
    private assetsService = new AssetsService();
    private appModeService = new AppModeService();

    async loadReports(): Promise<IReport[]> {
        let reports: IReport[] = [];
        if (this.appModeService.isOffline()) {
            reports = await this.assetsService.getJsonFromFile('reports');
            localStorage.setItem('reports', JSON.stringify(reports));
        } else {
            reports = await this.reportsService.getAll();
        }
        return reports;
    }

    async getReport(reportId: number): Promise<IReport> {
        let reports: IReport[] = [];
        if (this.appModeService.isOffline()) {
            reports = JSON.parse(localStorage.getItem('reports'));
        } else {
            reports = await this.reportsService.getAll();
        }
        return reports.find(r => r.id === reportId);
    }
}
\`\`\`

### Flyweight
El √∫ltimo de los patrones estructurales que veremos en este art√≠culo, promueve solucionar problemas de rendimiento gracias a la **reducci√≥n del n√∫mero de instancias** almacenadas en la memoria de un sistema. Se basa en, dada una lista de instancias de un tipo de objeto, agruparlas en base a sus propiedades intr√≠nsecas (cuyos valores pueden ser repetidos entre varias instancias) para poder reutilizarlas, y que todas las propiedades extr√≠nsecas (cuyos valores son espec√≠ficos para cada instancia) sean proporcionadas al objeto en el momento en que se ejecutan sus m√©todos.

Para entenderlo mejor, vamos a ver un caso te√≥rico/pr√°ctico: imaginemos que estamos trabajando con objetos de tipo coche y queremos optimizar nuestro sistema reduciendo el n√∫mero de instancias que creamos de √©stos. Para ello, primero debemos identificar las **propiedades intr√≠nsecas**, las propiedades cuyos valores pueden ser repetidos en varias de las instancias del objeto. Para nuestro caso, estas propiedades podr√≠an ser la marca y el color de cada coche, puesto que dos coches pueden coincidir en marca o color.

Despu√©s, identificaremos las **propiedades extr√≠nsecas**, las propiedades cuyos valores son particulares de cada instancia. En nuestro caso, podr√≠a ser el kilometraje de cada veh√≠culo. 

Una vez identificadas ambos tipos de propiedades, definimos una interfaz *Flyweight* que cumplir√°n todas las instancias que almacenemos de cada veh√≠culo, y donde se definir√°n todas las operaciones que necesitemos que se ejecuten sobre ellos, pasando por par√°metro las propiedades extr√≠nsecas si fueran necesarias para dichas operaciones. Esta interfaz es implementada por cada instancia *ConcreteFlyweight* espec√≠fica de cada coche:
\`\`\`javascript
interface Flyweight {
    operation(extrinsicState);
}

class ConcreteFlyweight implements Flyweight {
    operation(extrinsicState) { }
}
\`\`\`
Estos objetos *ConcreteFlyweight* ser√°n creados a partir de una factor√≠a *FlyweightFactory*, que ser√° la encargada de almacenar la instancia de cada *flyweight* en un diccionario interno indexado por las propiedades intr√≠nsecas como clave. De este modo, la primera vez que recibamos unos valores espec√≠ficos de las propiedades intr√≠nsecas, se crear√° la instancia y se almacenar√° en el diccionario. La pr√≥xima vez que se reciban los mismos valores, se evitar√° la creaci√≥n de una nueva instancia y se recuperar√° la que contenga el diccionario:
\`\`\`javascript
class FlyweightFactory {
    private flyweights: { [key: string]: Flyweight };

    getFlyWeight(intrinsicState): Flyweight {
        const key = this.getKey(intrinsicState);
        if (!this.flyweights[key]) {
            const newFlyweight = new ConcreteFlyweight();
            this.flyweights[key] = newFlyweight;
            return newFlyweight;
        } else {
            return this.flyweights[key];
        }
    }

    private getKey(intrinsicState): string {
        return \`\${intrinsicState.model}-\${intrinsicState.color}\`;
    }
}

export class Client {
    run() {
        const factory = new FlyweightFactory();
        const car1 = factory.getFlyWeight({ model: 'BMW', color: 'red' });
        const car2 = factory.getFlyWeight({ model: 'BMW', color: 'red' });
        const car3 = factory.getFlyWeight({ model: 'Toyota', color: 'white' });
        car1.operation({ km: 1000 });
        car2.operation({ km: 200 });
        car3.operation({ km: 3500 });
    }
}
\`\`\`
En nuestro proyecto real, reinterpretamos este patr√≥n para solucionar un problema de rendimiento importante con el que nos encontramos. Ten√≠amos el t√≠pico componente modal para mostrar informaci√≥n al usuario. El problema es que este modal estaba referenciado (e instanciado por tanto) en cada componente que lo mostraba. Aplicando nuestro *flyweight* particular, identificamos que la propiedad intr√≠nseca de nuestro objeto componente, era el propio modal, en todas las instancias eran iguales, con la excepci√≥n del texto que mostr√°bamos en cada momento (nuestra propiedad extr√≠nseca).

Por tanto, definimos un componente *FlyweightDialogComponent*:
\`\`\`javascript
@Component({
    selector: 'fly-dialog',
    templateUrl: 'dialog.component.html',
    styleUrls: ['./dialog.component.css']
})
export class FlyweightDialogComponent {
    text = '';
    visible = false;
    show(text: string) { this.text = text; this.visible = true; }
    close() { this.visible = false; }
}
\`\`\`
Que estar√° centralizado como **una instancia √∫nica** en un componente principal de la aplicaci√≥n (en nuestro caso era el componente *app*):
\`\`\`javascript
@Component({
    selector: 'flyweight',
    templateUrl: './real-world.component.html',
    styleUrls: ['./real-world.component.css']
})
export class FlyweightRealWorldComponent {
    @ViewChild('dialog', { static: false }) dialog: FlyweightDialogComponent;
    showFlyweightDialog(extrinsicInfoText: string) {
        this.dialog.show(extrinsicInfoText);
    }
}
\`\`\`
\`\`\`html
<h3>Flyweight implementation:</h3>
<fly-refactored-info infoText="first info" (showDialog)=showFlyweightDialog($event)></fly-refactored-info>
<fly-refactored-info infoText="second info" (showDialog)=showFlyweightDialog($event)></fly-refactored-info>
<fly-dialog #dialog></fly-dialog>
\`\`\`
Cada vez que se referencie al di√°logo modal, se ejecutar√° al m√©todo de *show* de la instancia √∫nica, proporcion√°ndole el texto que debe mostrar en ese momento.


# A√∫n hay mas...
Este ha sido el primer art√≠culo de la serie de patrones de dise√±o en TypeScript en el mundo real. Nos hemos centrado en los patrones creacionales y estructurales. En el siguiente post hablaremos sobre algunos [patrones de UI y de comportamiento](/typescript/patrones-diseno-comportamiento-ui).

Si quieres seguir profundizando en todos los patrones que hemos utilizado en nuestra aplicaci√≥n pod√©is consultar la [charla](https://www.youtube.com/watch?v=ZlhKj32KlfI) que impartimos en la JSDay Canarias 2019 y su [repositorio de c√≥digo](https://github.com/cbastos/jsdaycan2019-typescript-patterns) correspondiente con ejemplos.

Adem√°s, no puedo dejar de recomendar el libro que m√°s me ha servido de ayuda y que mejor explica la mayor√≠a de patrones: **Head First Design Patterns** de *Eric Freeman*, *Elisabeth Freeman*, *Kathy Sierra* y *Bert Bates*.

Espero que os haya resultado √∫til el art√≠culo, y cualquier duda/pregunta/sugerencia pod√©is encontrarme en twitter como [@ivanirega](https://twitter.com/ivanirega). Y recuerda: *"Donde hay patr√≥n, no manda marinero"* üòâ",
    "slug": "patrones-diseno-creacionales-estructurales",
    "tags": [
      "typescript",
    ],
    "title": "Patrones de dise√±o con TypeScript en el mundo real: creacionales y estructurales",
    "userPicture": "",
    "username": "Iv√°n Reinoso",
  },
  {
    "category": "devops",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/docker_category.png",
    "date": "",
    "description": "*Dockerizar* un proyecto Nodejs es bastante sencillo, en este art√≠culo veremos el paso a paso y comentaremos buenas pr√°cticas a tener en cuenta.",
    "id": "docker-nodejs-buenas-practicas",
    "markdownBody": "**Docker** nos permite ejecutar de forma aislada, aunque esto realmente es un truco, ya que **Docker** lo que hace es usar tecnolog√≠as como \`Cgroups\` (permite poner l√≠mites de recursos a procesos por ejemplo de memoria, CPU, etc) y \`namespaces\` (permite definir qu√© es lo que puede ver cada proceso) para que parezca que se ejecuta todo en una maquina independiente.

Una de las ventajas de **Docker** es la rapidez en comparaci√≥n con una VM, podemos disponer de un sistema Ubuntu en cuesti√≥n de segundos.

En **Docker** disponemos de diferentes herramientas que podemos utilizar:

- **Docker Engine:** Herramienta para gestionar las im√°genes, contenedores, red, etc.
- **docker-compose:** Se trata de una forma de conectar diferentes contenedores, hablaremos de √©l m√°s adelante.
- **Docker Hub:** Es como GitHub, una plataforma en la que podemos crear, administrar y subir nuestras im√°genes.

*Dockerizar* un proyecto **Node.js** es bastante sencillo, en este art√≠culo veremos el paso a paso y comentaremos buenas pr√°cticas a tener en cuenta.

Para este art√≠culo he creado un repositorio en el que podr√°s comprobar y descargarte los diferentes ejemplos, en enlace para cada uno lo encontrar√°s junto a üë©‚Äçüíª.

Tras esta breve intro vamos al lio!

## Step 1: *Dockerizando* un API Node.js simple

Lo primero es crear un fichero \`Dockerfile\` en la ra√≠z del proyecto, en este fichero vamos a indicar los mismos pasos que realizamos nosotros para construir nuestra API de forma manual, de modo que **Docker** sea capaz de hacerlo autom√°ticamente.

‚ö†Ô∏è esto lo que podemos encontrar en varios art√≠culos de *dockerizaci√≥n* de un proyecto **Node.js**.

\`\`\`docker
FROM node  
WORKDIR /usr/src/app

COPY . .
RUN npm install

EXPOSE 3000
CMD ["node", "server.js"]
\`\`\`

### üëå **Good practice:** version

Lo mejor a la hora de crear nuestro \`Dockerfile\`, desde otra imagen, es indicar **siempre** la versi√≥n que queremos utilizar, de modo que nos aseguramos que √©sta es compatible con nuestra API.

\`\`\`docker
# ‚ùå
FROM node   

# üëå
FROM node:14.4.0
\`\`\`

### üëå **Good practice: .**dockerignore

Solo debemos copiar lo necesario para desplegar nuestro proyecto. Con el \`Dockerfile\` anterior podemos observar lo siguiente:

Si a√±adimos un fichero a nuestra carpeta \`node_modules\` podemos comprobar que √©ste se copiar√° tambi√©n en nuestro contenedor, por ejemplo \`testFile.txt\`.
![Art%20culo%20Docker%20Node%20Good%20Practice%20d7dd96e770794a808ff07e6c97dd664b/Screenshot_2020-06-13_at_13.55.44.png](https://swcrafters.fra1.digitaloceanspaces.com/Posts/docker-nodejs-buenas-practicas/Screenshot_2020-06-13_at_13.55.44.png)

\`\`\`bash
# Construimos la imagen
‚ûú  docker build -t node-test .

# Arrancamos la imagen
‚ûú  docker run node-test

# Contenedores
‚ûú  docker ps
CONTAINER ID        IMAGE          COMMAND                  CREATED             STATUS              PORTS              NAMES
6418ce58579f        node-test      "docker-entrypoint.s‚Ä¶"   5 seconds ago       Up 5 seconds        3000/tcp           brave_mahavira

# Accedemos al contenedor
‚ûú  docker exec -it 641 bash

# Comprobamos 
root@6418ce58579f:/usr/src/app# cd node_modules/
root@6418ce58579f:/usr/src/app/node_modules# ls
\`\`\`

![Art%20culo%20Docker%20Node%20Good%20Practice%20d7dd96e770794a808ff07e6c97dd664b/Screenshot_2020-06-13_at_14.03.10.png](https://swcrafters.fra1.digitaloceanspaces.com/Posts/docker-nodejs-buenas-practicas/Screenshot_2020-06-13_at_14.03.10.png)

De igual modo revisando el contenedor podemos ver que en el \`WORKDIR\` del mismo se han copiado algunos ficheros y directorios como: \`.git\` \`.gitignore\` \`.idea\`, que no son necesarios.

\`\`\`bash
root@6418ce58579f:/usr/src/app# ls -la
\`\`\`

![Art%20culo%20Docker%20Node%20Good%20Practice%20d7dd96e770794a808ff07e6c97dd664b/Screenshot_2020-06-13_at_14.18.13.png](https://swcrafters.fra1.digitaloceanspaces.com/Posts/docker-nodejs-buenas-practicas/Screenshot_2020-06-13_at_14.18.13.png)

\`.dockerignore\` se comporta igual que el \`.gitignore\`. Esto ayuda a que las im√°genes que creamos sean m√°s ligeras y seguras.

![Art%20culo%20Docker%20Node%20Good%20Practice%20d7dd96e770794a808ff07e6c97dd664b/Screenshot_2020-06-13_at_14.35.54.png](https://swcrafters.fra1.digitaloceanspaces.com/Posts/docker-nodejs-buenas-practicas/Screenshot_2020-06-13_at_14.35.54.png)

### üëå **Good practice:** order and layers

Es de vital importancia tener en cuenta como **Docker** genera las capas, y el orden en que estas se ejecutan.

Usando el ejemplo anterior vamos hacer una comparativa de dos \`Dockerfiles\`. 

\`\`\`docker
FROM node:14.4.0
WORKDIR /usr/src/app

# ‚ùå 
COPY . .

EXPOSE 3000
CMD ["node", "server.js"]
\`\`\`

En √©ste tenemos **5 capas** (5 sentencias), y cada vez que modifiquemos algo en nuestro proyecto tanto el \`COPY\` como las siguientes sentencias se volver√°n a ejecutar (**Docker** no puede cachear estas capas, ya que han cambiado).

![Art%20culo%20Docker%20Node%20Good%20Practice%20d7dd96e770794a808ff07e6c97dd664b/Screenshot_2020-06-13_at_14.57.00.png](https://swcrafters.fra1.digitaloceanspaces.com/Posts/docker-nodejs-buenas-practicas/Screenshot_2020-06-13_at_14.57.00.png)

En el siguiente \`Dockerfile\` tenemos **7 capas** (7 sentencias) que al disponerlas en el orden que se indica, nos aseguramos de no ejecutar sentencias ya cacheadas innecesariamente.

\`\`\`docker
FROM node14.4.0
WORKDIR /usr/src/app

# üëå
COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 3000
CMD ["node", "server.js"]
\`\`\`

Aunque modifiquemos nuestro c√≥digo, siempre que no modifiquemos algunos de los \`package*.json\`, no se ejecutar√°, ni la copia de los mismos, ni el correspondiente \`npm install\`.

Ahorr√°ndonos mucho tiempo de construcci√≥n.

![Art%20culo%20Docker%20Node%20Good%20Practice%20d7dd96e770794a808ff07e6c97dd664b/Screenshot_2020-06-13_at_14.59.47.png](https://swcrafters.fra1.digitaloceanspaces.com/Posts/docker-nodejs-buenas-practicas/Screenshot_2020-06-13_at_14.59.47.png)

![Art%20culo%20Docker%20Node%20Good%20Practice%20d7dd96e770794a808ff07e6c97dd664b/Screenshot_2020-06-13_at_15.00.09.png](https://swcrafters.fra1.digitaloceanspaces.com/Posts/docker-nodejs-buenas-practicas/Screenshot_2020-06-13_at_15.00.09.png)

Una vez tengamos el \`Dockerfile\` lo ejecutamos de la siguiente manera:

\`\`\`bash
‚ûú  docker run -p 3001:3000 node-test
\`\`\`

üë©‚Äçüíª[https://github.com/yodra/movies-api](https://github.com/yodra/movies-api)

## Step 2: Usando Multistage

En el proceso de desarrollo existen diferentes fases para obtener el c√≥digo que finalmente se desplegar√° en producci√≥n. **Docker** proporciona multistage, que permite poder ejecutar cada fase en diferentes contenedores. 

A modo de ejemplo hemos implementado la misma API de Movies en TypeScript que necesita ser transpilada antes de correr en producci√≥n.

Por lo que ahora tendr√≠amos el siguiente \`Dockerfile\`:

\`\`\`docker
FROM node:14.4.0 as trasnpiledApi
WORKDIR /usr/src/app

COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

# Deploy
FROM node:14.4.0
WORKDIR /usr/src/app

COPY package*.json ./
RUN npm install --production

COPY --from=trasnpiledApi /usr/src/app/dist .

EXPOSE 3000
CMD ["node", "server.js"]
\`\`\`

### üëå **Good practice: Multistage**

Separando fases como compilaci√≥n, transpilaci√≥n, empaquetado... nuestras im√°genes de producci√≥n ser√°n m√°s ligeras y seguras.

üë©‚Äçüíª [https://github.com/yodra/movies-api/tree/multistage](https://github.com/yodra/movies-api/tree/multistage)

## Step 3: A√±adimos docker-compose

Ya tenemos *dockerizada* la API y solo nos queda conectarla con una base de datos, para conectar diferentes contenedores entre si utilizamos \`docker-compose\`. √âste es un fichero de configuraci√≥n \`.yml\` que se encargar√° de orquestar como se arrancaran cada uno de los contenedores que necesitamos adem√°s de conectarlos entre si.

En este fichero especificamos cada uno de los servicios con los que contaremos y las dependencias entre ellos.

\`\`\`yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - 3000:3000
    depends_on:
      - database
  database:
    image: mongo:3.6.18-xenial
    expose:
      - 27017
    volumes:
      - mongodata:/data/db
volumes:
  mongodata:
\`\`\`

### üëå **Good practice: identical as production**

Esto nos permite disponer de la misma configuraci√≥n en los diferentes entornos. Trabajar en un entorno igual que el de producci√≥n nos permite adelantarnos a posibles errores.

üë©‚Äçüíª[https://github.com/yodra/movies-api/tree/docker-compose](https://github.com/yodra/movies-api/tree/docker-compose)

### Resumen de comandos

Aqu√≠ algunos de los comandos que podemos necesitar a la hora de trabajar con \`docker-compose\`.

![Art%20culo%20Docker%20Node%20Good%20Practice%20d7dd96e770794a808ff07e6c97dd664b/Screenshot_2020-06-21_at_11.56.26.png](https://swcrafters.fra1.digitaloceanspaces.com/Posts/docker-nodejs-buenas-practicas/Screenshot_2020-06-21_at_11.56.26.png)

**Docker** es una herramienta que facilita el desarrollo y todos deber√≠amos aplicar en nuestros proyectos, a modo de gu√≠a he creado una chuleta, la cual incluye un resumen de lo comentado en este art√≠culo, que puedes encontrar en mi web [https://yodralopez.dev/](https://yodralopez.dev/)",
    "slug": "docker-nodejs-buenas-practicas",
    "tags": [
      "devops",
    ],
    "title": "Docker + NodeJS + Buenas Pr√°cticas",
    "userPicture": "",
    "username": "Yodra L√≥pez",
  },
  {
    "category": "react",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/ReactJS_category.png",
    "date": "",
    "description": "¬øTDD en el FrontEnd? En este post veremos como aplicarlo con React y TypeScript.",
    "id": "tdd-react-typescript",
    "markdownBody": "En los √∫ltimos a√±os ha habido un auge en la comunidad referente al inter√©s por el [codigo limpio](/javascript/clean-code-javascript), el tener unos buenos 
tests para nuestras aplicaciones y una preocupaci√≥n por buscar la forma correcta o m√°s viable de llevar a cabo estas tareas.

Lo cierto es que no existe una forma que podamos replicar de forma autom√°tica en cada proyecto y que nos de un resultado
de calidad por igual, por ejemplo: En un proyecto podemos tener una mayor cantidad de tests *e2e* y que esto nos aporte un 
mayor valor que en otros, ya que se carece de apenas l√≥gica y la aplicaci√≥n se basa en meras interacciones del usuario;
mientras que en otro caso, nos puede aportar mayor relevancia el tener unos tests unitarios
m√°s granulares debido a la reutilizaci√≥n de componentes.

No te preocupes, lo importante no es decantarse por unos u otros, sino dejar que la propia aplicaci√≥n defina cual es la 
mejor soluci√≥n para si misma de forma iterativa. Para ello, [el desarrollo dirigido por test (Test Driven Development, TDD)](/javascript/tdd-test-driven-development) 
es la mejor herramienta que he adoptado en mi d√≠a a d√≠a y que me permite tener un buen balance en mis desarrollos.

Cabe destacar que en base a mi experiencia, [TypeScript](/typescript/typescript-tutorial-javascript-introduccion) es clave en el mantenimiento de los proyectos. Nunca sabemos que grado de 
conocimiento o nivel de rigurosidad en el desarrollo tendr√° la persona que pueda acabar en el proyecto que empezamos, por lo que, el poder apoyarnos en los tipos para definir un esqueleto s√≥lido para nuestros componentes y ser capaz de prevenir los errores m√°s b√°sicos sin tener que a√±adir pruebas para estos, es sin duda una gran herramienta que debemos tener en cuenta. A dem√°s, al ser un lenguaje tipado la mayor√≠a de editores/IDEs tienen soporte para aplicar refactors de forma autom√°tica.

## Pero... ¬øEn frontend?

Muchos desarrolladores (entre los cuales me inclu√≠a) piensan que hay dos posibles enfoques: Si quieres comprobar la 
interfaz de tu aplicaci√≥n, utiliza tests e2e. Sin embargo, si lo que deseas es verificar que tu c√≥digo cumple con lo
esperado, utiliza tests unitarios.

Este enfoque no es para nada negativo, pero nos limita mucho a la hora de definir una buena arquitectura. Como comentan 
desarrolladores como *Martin Fowler* o *Robert C. Martin*, un c√≥digo que no puede ser probado, no es la mejor implementaci√≥n
del mismo. Por otro lado, a√±adir una funcionalidad espec√≠fica a nuestro c√≥digo para que pueda ser comprobado, sin 
aportar nada de valor, tampoco es una buena opci√≥n. ¬øEntonces?

Recordemos que el desarrollo dirigido por test tiene como finalidad definir una funcionalidad, mientras que los 
tests generados para ello ser√°n un "da√±o colateral" (si preferimos llamarlo as√≠) de decantarnos por esta metodolog√≠a.

Sin ir m√°s lejos, [React](/react/tutorial-react-js-introduccion) es una librer√≠a mediante la cual podremos realizar interfaces (tanto web, m√≥viles como de escritorio)
y hacer que haga llamadas a nuestro c√≥digo javascript para que este a su vez se desarrolle como se requiera: llamar a una API,
persistir en local storage, emitir una acci√≥n de callback... etc. As√≠ pues, podemos aplicar esta metodolog√≠a con total normalidad.

## ¬øC√≥mo empezamos?

Para ponernos manos a la obra, lo primero es que tengamos claro qu√© funcionalidad vamos a desarrollar, o por lo menos,
cual es el flujo a seguir por el usuario, es decir: necesitamos tener claro cual va a ser el caso de uso que vamos a implementar.

Es muy importante que pensemos en ello desde el punto de vista de la persona que va a utilizar la aplicaci√≥n, y no desde
el punto de vista del programador. Pensemos que es la capa m√°s cercana al usuario, cuanto m√°s cercana sea la definici√≥n de este a como interactuar√° el usuario final, tendr√° un mayor nivel de abstracci√≥n y por tanto requerir√° menos mantenimiento. Dicho de otra forma:
El c√≥digo es susceptible de cambiar, la forma en la que el usuario interact√∫a con la aplicaci√≥n no (ya que ser√≠a otra funcionalidad distinta). 
Si no queremos invertir tiempo en editar tests de algo que ya estaba funcionando, porque hemos cambiado nuestro c√≥digo, lo mejor ser√°, acercarnos lo m√°s posible a lo que menos deber√≠a de cambiar.

Para este ejemplo buscaremos dos casos de uso lo suficientemente simples y que podamos representar de forma sencilla:
- El usuario visitar√° nuestra web y recibir√° un cat√°logo de productos.
- El usuario seleccionar√° uno de los productos que tiene en pantalla y podr√° a√±adirlo al carrito.

Daremos por sentado que hemos creado una aplicaci√≥n \`React\` y que hemos configurado \`jest\` en el proyecto. Es independiente
si hemos utilizado \`create-react-app\`, \`create-next-app\`, si lo hemos creado a mano, o si hemos utilizado otra herramienta.

## e2e tests

En primer lugar definiremos los tests e2e. Estos nos permitir√°n simular de forma exacta como va a operar el usuario con 
la web. 

Existen muchas herramientas para simular esta interacci√≥n, sin embargo, las m√°s utilizadas hoy en d√≠a son:
- Cypress
- Puppeteer
- Nightwatch 

En este caso utilizaremos \`cypress\` junto con \`jest\` para ello.

Nos dirigiremos a nuestra aplicaci√≥n \`React\` (da igual si la hemos creado con CRA, Next o con otra soluci√≥n a medida) e instalaremos la dependencia:

\`\`\`
npm i -D cypress
\`\`\`

Una vez instalado, debemos arrancar nuestra aplicaci√≥n y ejecutar cypress para comprobar que todo funciona de forma correcta:

\`\`\`
npx start
npx cypress open
\`\`\`

> Puedes profundizar un poco m√°s en esta √°rea visitando la [documentaci√≥n oficial](https://docs.cypress.io/guides/getting-started/installing-cypress.html).

Una vez hayamos ejecutado cypress por primera vez, podremos proceder a crear los tests, para ello crearemos un fichero 
\`products-catalog.spec.js\` en el directorio \`cypress/integration\`

Y definiremos el siguiente bloque:

\`\`\`javascript
describe('Product Catalog', () => {

  it('shows the catalog', () => {
    cy.visit('/');
    cy.contains('.products > li');
  });
});
\`\`\`

En este caso lo que haremos es navegar a la ra√≠z de nuestra aplicaci√≥n y verificar que somos capaces de encontrar un 
listado de productos.

Como handicap, pensemos... ¬øEs el usuario capaz de visualizar el √°rbol DOM? La respuesta es **no**, por lo tanto el 
haber utilizado este tipo de enfoque, va a hacer nuestro test muy fr√°gil. Si por cuestiones de dise√±o, cambiase el
nombre de la clase \`css\`, o peor a√∫n, si no se utilizase un \`li\`, nuestro test se romper√≠a y tendr√≠amos que dedicar 
tiempo a arreglarlo.

As√≠ pues, pensemos ¬øQu√© es lo que representa a un producto que indiscutiblemente va a ver el usuario?
A priori se me ocurre que el t√≠tulo. As√≠ pues lo que podemos hacer es buscar por dicho campo.  

\`\`\`javascript
describe('Product Catalogue', () => {

  it('shows the catalog', () => {
    const productTitles = ['Clean Code', 'Clean Architecture', 'Spider-man: Life Story', 'Mastering React']
    cy.visit('/');
    productTitles.map( title => {
      cy.contains(title);
    });
  });
});
\`\`\`

Vale, es muy buena idea... salvo por otro peque√±o detalle. ¬øDe donde vienen los datos? ¬øPodemos garantizar que la fuente
de datos no va a cambiar? Por desgracia no. As√≠ que tenemos dos opciones:

- Lanzar los tests e2e, levantando nuestra API con una base de datos espec√≠fica para pruebas. Esto nos dar√≠a un mayor nivel de seguridad, pero tendr√≠amos que invertir mucho tiempo en lo que a configuraci√≥n se refiere.

- Interceptar la llamada \`http\` y sobrescribir la llamada con unos valores predefinidos, a los que com√∫nmente se les denomina
[\`fixtures\`](https://en.wikipedia.org/wiki/Test_fixture#Software).

Por suerte, este √∫ltimo m√©todo es m√°s sencillo y ya \`cypress\` nos da herramientas para ello, pero vayamos por partes:

En primer lugar debemos crear un fichero \`json\` en el directorio \`cypress/fixtures/catalog/products.json\`:
\`\`\`json
{
  "products": [
    { "title": "Clean Code", "price": 20 },
    { "title": "Clean Architecture", "price": 20 },
    { "title": "Spider-man: Life Story", "price": 20 },
    { "title": "Mastering React", "price": 20 }
  ]
}
\`\`\`

A continuaci√≥n en nuestro test, tendremos que definir el endpoint que vamos a consumir:
\`\`\`javascript
const productsEndpoint = {
  method: 'GET',
  url: 'http://localhost:4000/products',
};
\`\`\`

Luego definiremos que para cada test, debe de iniciar un servidor de escucha:
\`\`\`javascript
beforeEach(() => {
  cy.server();
});
\`\`\`


Y por √∫ltimo tendremos que interceptar la petici√≥n:

\`\`\`javascript
cy.route({...productsEndpoint, response: 'fixture:catalog/products', status: 200 });
\`\`\`

Por lo tanto, el resultado de nuestro test ser√≠a el siguiente:

\`\`\`javascript
import { products } from '../fixtures/catalog/products.json'

describe('Product Catalogue', () => {

  const productsEndpoint = {
    method: 'GET',
    url: 'http://localhost:4000/products',
  };

  beforeEach(() => {
    cy.server();
  });

  it('shows the catalog', () => {
    cy.route({...productsEndpoint, response: 'fixture:catalog/products', status: 200 });

    cy.visit('/');
    products.map( ({title}) => {
      cy.contains(title);
    })
  });
})
\`\`\`

> Estos tests, se pasar√°n en rojo (red) la mayor parte del tiempo, hasta que completemos el desarrollo en su totalidad,
as√≠ que si te es m√°s c√≥modo, puedes marcarlos como \`skipped\` y lanzarlos cada cierto tiempo.

[Github code](https://github.com/adrian-afergon/software-crafters-tdd-react/blob/feature/e2e-tests/e2e/cypress/integration/index.spec.js)

Ahora que ya tenemos nuestro primer test **e2e**, podremos comenzar a implementar nuestra aplicaci√≥n.

## Unit tests

Ahora bien, una vez hemos definido cual es el caso de uso y cual es la funcionalidad que queremos realizar, pasemos a 
los tests unitarios. En este caso puede haber cierta colisi√≥n de intereses, ya que a priori nuestro caso de uso puede 
parecer el mismo, pero su finalidad es completamente distinta:

Mientras que el test e2e nos permite identificar cuando se cumplen las expectativas del cliente; el test unitario nos va
a ayudar a definir una arquitectura que se va a caracterizar por ser modular.

### Instalaci√≥n
En el siguiente ejemplo vamos a hacer uso de \`testing-library/react\` para montar nuestros componentes y de 
\`testing-library/jest-dom\` para conseguir unas aserciones m√°s humanas.

Para ello ejecutaremos el siguiente comando:

\`\`\`
npm i --save-dev test-library/jest-dom testing-library/react
\`\`\`

Una vez se haya completado la instalaci√≥n podemos proceder a crear nuestro primer test \`Home.spec.js\`

> Personalmente, al tratarse de test unitarios suelo preferir crearlos en el mismo directorio en el que voy a crear el 
componente

### Primer test - Visualizar datos

El test deber√° tener la siguente estructura:
\`\`\`ts
import * as React from 'react';

describe('Home Container', () => {
  it('shows a list of products', () => {
    // ... no code yet
    expect(foundProducts.length).toBe(products.length)
  });
});
\`\`\`

Pero... un segundo, ¬øhemos definido un \`expect\`? ¬øY la definici√≥n de variables? Es aqu√≠ donde empieza a surgir la magia.

Empezando por este punto entendemos que, el n√∫mero de productos encontrados debe ser igual a uno previamente definido 
en el test y que de alguna forma tendremos que pas√°rselo al componente, pero ¬øc√≥mo? Es a partir de este punto donde 
empezamos a definir arquitectura.

Debemos ser pr√°cticos, no vale buscar soluciones complicadas, debemos dar solvencia al test en el menor tiempo posible. 
Una vez demos con la soluci√≥n e implementemos la funcionalidad podremos valorar si realmente puede interesar el complicar 
la soluci√≥n, entendiendo por complicar el hacer nuestra soluci√≥n gen√©rica a varios casos, en lugar de espec√≠fica a este caso en concreto.

Para poder recuperar el listado de productos a nuestro componente, que ser√°n devueltos por la API, lo que podemos hacer 
es pasarle a trav√©s de propiedades el m√©todo encargado de recuperar dicha informaci√≥n. A esto se le conoce como *inyecci√≥n
de dependencias*. 

Por lo tanto, crearemos un objeto *mock*, el cual devuelva una promesa con nuestros datos:

\`\`\`ts
  it('shows a list of products', () => {
    // Define a data source
    const products: Product[] = [buildProduct({}), buildProduct({})];
    const productsRepository = {
      getProducts: jest.fn(() => Promise.resolve(products))
    };
    const view = render(<Home productsRepository={productsRepository}/>);
    // ... no code yet
    expect(foundProducts.length).toBe(products.length);
  });
\`\`\`

Como podr√°s observar, hacemos uso de un \`buildProduct\` para definir nuestros valores y no a√±adir informaci√≥n irrelevante al test (Puedes leer m√°s a cerca del patr√≥n builder [aqu√≠](https://medium.com/lean-mind/make-more-human-readeable-test-14d4230898c)). 
As√≠ pues ya solo nos quedar√≠a buscar a nivel visual la representaci√≥n de dichos datos. Una de las ventajas de \`testing-library\`
es que nos da unos selectores muy cercanos a la capa de usuario, por lo que como ya comentamos anteriormente, dar√° una 
mayor longevidad a nuestros tests:

\`\`\`ts
  it('shows a list of products', async () => {
    // Define a data source
    const products: Product[] = [
      buildProduct({handle: 'handle-1', title:'title 1'}),
      buildProduct({handle: 'handle-2', title:'title 2'})
    ];
    const productsRepository = {
      getProducts: jest.fn(() => Promise.resolve(products))
    };
    const view = render(<Home productsRepository={productsRepository}/>);
    // Search in async way all the product titles at the screen
    const foundProducts = await Promise.all(products.map((product) => view.findByText(product.title)));
    expect(foundProducts.length).toBe(products.length);
  });
\`\`\`

Quiz√°s en este proceso te hayan surgido dudas, o incluso durante la definici√≥n de entidades, como por ejemplo 
¬øqu√© ocurrir√≠a si en lugar de una promesa resuelta, nos devolviese una promesa rechazada? ¬øY si me devuelve un listado vac√≠o?
El pararnos a pensar en definir un caso de uso, nos ayuda a prestar mayor atenci√≥n a nuestro c√≥digo y dar con casos l√≠mite
m√°s comunes de lo que esperar√≠as. 

Recordemos que hacer varias implementaciones al mismo tiempo, no es la mejor de las ideas; As√≠ pues, a medida que vamos
definiendo un test, podemos anotar el resto de casos para contemplarlos a posteriori.

\`\`\`ts
  // what happen when request fails?
  // what happen when list is empty?  

  it('shows a list of products', async () => {
    // irrelevant for now
  });
\`\`\`
Ahora bien, dado el test, ya hemos asumido ciertas cosas, como que nuestro componente va a recibir un objeto con un m√©todo
que recuperar√° los productos y que por tanto, tendremos que iterar por ellos para visualizarlos. Por el momento, es obligatorio
ejecutar el test y verificar que falla (red). Hecho esto, podemos generar el c√≥digo del componente en el propio fichero de test: 

\`\`\`ts
interface HomeProps {
  productsRepository: ProductsRepository;
}

export const Home: React.FC<HomeProps> = ({ productsRepository }) => {
  const [products, setProducts] = React.useState<Product[]>([]);
  React.useEffect(() => {
    productsRepository.getProducts().then(setProducts);
  }, []);
  return (
    <section>
      {products.map(product => <article key={product.handle}>{product.title}</article>)}
    </section>
  );
};
\`\`\`

Al ejecutar nuevamente el test, vemos como ahora funciona correctamente (green), por lo que es el momento de **hacer commit**
y plantearnos si aplica alg√∫n refactor. En este caso, es el momento de mover nuestro componente al fichero \`Home.jsx\`.

A este proceso se le conoce como **RGR, Red - Green - Refactor**. Solo vamos a modificar c√≥digo cuando 
nos encontremos en **Green**. Plantear nuevos casos, o refactorizar c√≥digo en **Red** solo nos llevar√° a aumentar la 
complegidad de la aplicaci√≥n e incurrir en errores.

[Github code](https://github.com/adrian-afergon/software-crafters-tdd-react/blob/feature/shown-products/src/components/Home/Home.spec.tsx)

### Casos l√≠mite - Lista vac√≠a

Prosigamos con los otros dos casos. ¬øQu√© ocurre cuando nuestro listado de productos est√° vac√≠o? A priori lo m√°s sensato es
darle feedback al usuario de que la lista est√° vac√≠a:

\`\`\`ts
  // what happen when request fails?
  // what happen when list is empty?  

  it('shows a list of products', async () => {
    // completed
  });

  it('shows a message when list is empty', () => {
    // Not implemented yet
    expect(view.queryByText(emptyMessage)).toBeInTheDocument();
  });
\`\`\`

Siguiendo el proceso anterior, podemos darnos cuenta que el mensaje va a ser algo compartido entre el componente y el test,
pero recordemos, ahora no es momento de hacer estos cambios, estamos en **red**.

En esta ocasi√≥n cambiaremos el valor que nos devuelve nuestro \`productsRepository\` por un listado vac√≠o, y definiremos una variable\`emptyMessage\`:

\`\`\`ts
  it('shows a message when list is empty', async () => {
    // Define a data source
    const products: Product[] = [];
    const productsRepository = {
      getProducts: jest.fn(() => Promise.resolve(products))
    };
    const emptyMessage = 'No products were found';
    const view = render(<Home productsRepository={productsRepository}/>);

    expect(await view.findByText(emptyMessage)).toBeInTheDocument();
  });
\`\`\`

Lanzamos nuestro test y vemos que efectivamente falla. Actualicemos el componente:

\`\`\`ts
interface HomeProps {
  productsRepository: ProductsRepository;
}

export const Home: React.FC<HomeProps> = ({ productsRepository }) => {
  const [products, setProducts] = React.useState<Product[]>([]);
  React.useEffect(() => {
    productsRepository.getProducts().then(setProducts);
  }, []);
  return (
    <section>
      { products && products.length > 0
        ? products.map(product => <article key={product.handle}>{product.title}</article>)
        : <p>No products were found</p>
      }
    </section>
  );
};
\`\`\`

Estamos en **Green** ahora, podr√≠amos aplicar varios refactors como podr√≠a ser:
- Exponer una constante desde el componente con el mensaje de *"No products were found"*.
- Refactorizar nuestro test para mover la definici√≥n del servicio a un \`builder\` y que el test sea m√°s legible.
- Mejorar la legibilidad de la condici√≥n para mostrar el mensaje

Estos cambios quedar√≠an de la siguiente forma:

\`\`\`ts
  // what happen when request fails?

  const buildProductRepository = (products: Product[]): ProductsRepository => ({
    getProducts: jest.fn(() => Promise.resolve(products))
  });

  it('shows a list of products', async () => {
    // Define a data source
    const products: Product[] = [
      buildProduct({handle: 'handle-1', title:'title 1'}),
      buildProduct({handle: 'handle-2', title:'title 2'})
    ];
    const productsRepository: ProductsRepository = buildProductRepository(products);
    const view = render(<Home productsRepository={productsRepository}/>);
    // Search in async way all the product titles at the screen
    const foundProducts = await Promise.all(products.map((product) => view.findByText(product.title)));
    expect(foundProducts.length).toBe(products.length);
  });

  it('shows a message when list is empty', async () => {
    // Define a data source
    const products: Product[] = [];
    const productsRepository: ProductsRepository = buildProductRepository(products);
    const view = render(<Home productsRepository={productsRepository}/>);

    expect(await view.findByText(HomeText.emptyMessage)).toBeInTheDocument();
  });

\`\`\`

Y nuestro componente:

\`\`\`ts
export enum HomeText {
  emptyMessage = 'No products were found'
}

interface HomeProps {
  productsRepository: ProductsRepository;
}

export const Home: React.FC<HomeProps> = ({ productsRepository }) => {
  const [products, setProducts] = React.useState<Product[]>([]);
  React.useEffect(() => {
    productsRepository.getProducts().then(setProducts);
  }, []);

  const hasProducts = () => products && products.length > 0;

  return (
    <section>
      { hasProducts()
        ? products.map(product => <article key={product.handle}>{product.title}</article>)
        : <p>{HomeText.emptyMessage}</p>
      }
    </section>
  );
};
\`\`\`

[Github code](https://github.com/adrian-afergon/software-crafters-tdd-react/blob/feature/empty-list/src/components/Home/Home.spec.tsx)

### Casos l√≠mite - Excepciones

Para finalizar, vamos a manejar el caso de error. Lo m√°s c√≥modo ser√≠a que cambi√°semos nuestro \`Promise.resolve\`, por un 
\`Promise.rejected\`, sin embargo, si hacemos este cambio en el builder, romperemos los tests anteriores. Esto nos da a
entender que hemos tomado la decisi√≥n de aplicar un refactor a nuestro c√≥digo, sin tener la informaci√≥n suficiente para hacerlo.

Sin embargo, aprovecharemos la situaci√≥n para dar con la mejor forma de solucionar este caso, eso si, primero el test en cuesti√≥n:
\`\`\`ts
  it('shows a error when products can not be retrieved', async () => {
    // Define a data source
    const error = new Error('irrelevant error');
    const productsRepository: ProductsRepository = {
      getProducts: jest.fn(() => Promise.reject(error))
    };
    const view = render(<Home productsRepository={productsRepository}/>);

    expect(await view.findByText(error.message)).toBeInTheDocument();
  });
\`\`\`

Ahora, vemos fallar el test y pasamos a actualizar nuestro componente con la nueva funcionalidad:

\`\`\`ts
const Home = ({ productsRepository }) => {
  const [products, setProducts] = React.useState<Product[]>([]);
  const [error, setError] = React.useState<Error|null>(null);
  React.useEffect(() => {
    productsRepository.getProducts()
      .then(setProducts)
      .catch(setError);
  }, []);
  return (
    <section>
      { error && <p>{error.message}</p> }
      { hasProducts()
        ? products.map(product => <article key={product.handle}>{product.title}</article>)
        : <p>{HomeText.emptyMessage}</p>
      }
    </section>
  );
};
\`\`\`

Estupendo, ahora todo funciona correctamente, es el momento de refactorizar nuestro \`builder\` sin romper nuestros tests.
La forma m√°s f√°cil para ello es cambiar el par√°metro de entrada por el siguiente:

\`\`\`ts
  const buildProductRepository = (promise: Promise<Product[]>) => ({
    getProducts: jest.fn(() => promise)
  });
\`\`\`

Y por tanto en la definici√≥n de los \`productsRepository\` de cada test:

\`\`\`ts
  it('shows a list of products', async () => {
    const products: Product[] = [
      buildProduct({handle: 'handle-1', title:'title 1'}),
      buildProduct({handle: 'handle-2', title:'title 2'})
    ];
    const productsRepository: ProductsRepository = buildProductRepository(Promise.resolve(products));
    // ...
  });

  it('shows a message when list is empty', () => {
    const products: Product[] = [];
    const productsRepository: ProductsRepository = buildProductRepository(Promise.resolve(products));
    // ...
  });

  it('shows a error when products can not be retrieved', () => {
    const error = new Error('irrelevant error');
    const productsRepository: ProductsRepository = buildProductRepository(Promise.reject(error));
    // ...
  });
\`\`\`

Ahora bien, este √∫ltimo paso nos ha permitido cerrar el ciclo del componente y poder pasar a otros componentes.
Estos componentes, no tienen por qu√© contener ning√∫n test si se tratan de componentes meramente representacionales y
carentes de l√≥gica, tengamos presente que las propias funcionalidades de \`React\` ya est√°n verificadas por su equipo, y
que nosotros solo nos debemos preocupar de nuestra l√≥gica.

A dem√°s, el haber empezado por el componente m√°s alto en el √°rbol DOM, nos permite que estos componentes que envuelve se
verifique su visualizaci√≥n desde nuestro test principal.

[Github Code](https://github.com/adrian-afergon/software-crafters-tdd-react/blob/feature/handle-exceptions/src/components/Home/Home.spec.tsx)

## Cambios de arquitectura

Para no extendernos demasiado, vamos a dar por sentado que hemos definido el componente \`ProductCard\`:
\`\`\`ts
interface ProductCardProps {
  product: Product;
  onClick?: (handle: string) => void;
}

export const ProductCard: React.FC<ProductCardProps> = ({ product, onClick}) => (
  <div>
    <h3>{product.title}</h3>
    <p>
      Price:
      <span>{product.price}</span>
    </p>
    {
      onClick &&
      <button type="button" onClick={() => { onClick(product.handle); }}>Add to cart</button>
    }
  </div>
);
\`\`\`

Con el siguiente test:

\`\`\`ts
  it('calls with product identifier when is clicked', () => {
    const product = buildProduct({ handle: 'irrelevant-handle' });
    const clickMock = jest.fn();
    const view = render(<ProductCard product={product} onClick={clickMock} />);

    const button = view.getByRole('button');
    fireEvent.click(button);
    expect(clickMock).toHaveBeenCalledWith(product.handle);
  });
\`\`\`
Y que por tanto este componente se utiliza en nuestro \`Home\`:

\`\`\`ts
export const Home: React.FC<HomeProps> = ({ productsRepository }) => {
  const [products, setProducts] = React.useState<Product[]>([]);
  const [error, setError] = React.useState<Error|null>(null);
  React.useEffect(() => {
    productsRepository.getProducts()
      .then(setProducts)
      .catch(setError);
  }, []);

  const hasProducts = () => products && products.length > 0;

  return (
    <section>
      { error && <p>{error.message}</p> }
      { hasProducts()
        ? products.map(product =>
          <article key={product.handle}>
            <ProductCard product={product} />
          </article>)
        : <p>{HomeText.emptyMessage}</p>
      }
    </section>
  );
};
\`\`\`

Ahora bien, somos conscientes de que nuestro \`ProductCard\` tiene un evento de click asociado, y que al ser usado desde \`Home\`,
este debe a√±adirlo al carrito. Este carrito no tiene nada que ver con la forma en la que recuperamos nuestros productos, sino que es otra nueva entidad que entra en juego.

Para ser consistentes, hemos hecho el test correspondiente para verificar que el comportamiento se cumple:

\`\`\`ts
  it('add item to cart', async () => {
    const firstProduct: Product = buildProduct({handle: 'first-product'});
    const secondProduct: Product = buildProduct({handle: 'second-product'});
    const productsRepository = buildProductRepository(Promise.resolve([firstProduct, secondProduct]));
    const cartRepository = {
      addItem: jest.fn(),
    };

    const view = render(<Home productsRepository={productsRepository} cartRepository={cartRepository} />);

    const [, item] = await view.findAllByRole('button');
    fireEvent.click(item);

    expect(cartRepository.addItem).toHaveBeenCalledWith(secondProduct.handle);
  });
\`\`\`

Y tras ver que falla, hemos actualizado el componente:

\`\`\`ts
export const Home: React.FC<HomeProps> = ({ productsRepository, cartRepository }) => {
  const [products, setProducts] = React.useState<Product[]>([]);
  const [error, setError] = React.useState<Error|null>(null);
  React.useEffect(() => {
    productsRepository.getProducts()
      .then(setProducts)
      .catch(setError);
  }, []);

  const hasProducts = () => products && products.length > 0;

  return (
    <section>
      { error && <p>{error.message}</p> }
      { hasProducts()
        ? products.map(product =>
          <article key={product.handle}>
            <ProductCard
              product={product}
              onClick={cartRepository.addItem}
            />
          </article>)
        : <p>{HomeText.emptyMessage}</p>
      }
    </section>
  );
};
\`\`\`

Ahora bien, tenemos nuestras dependencias y aparentemente nuestros componentes funcionan, pero tendremos que utilizar unos \`repository\` reales.
Para ello simplemente crearemos dichas entidades que ser√°n las encargadas de hacer el fetch a la API real, y definiremos esas constantes como valor por defecto a el componente:

\`\`\`typescript
export const cartRepository: CartRepository = {
  addItem: (handle) => fetch('http://localhost:4000/cart', {
      method: 'PUT',
      body: JSON.stringify({ handle })
  }).then(response => response.json())
};

export const productsRepository: ProductRepository = {
  getProducts: () => 
    fetch('http://localhost:4000/products')
      .then(response => response.json())
      .then(data => data.products)
}
\`\`\`

Y el componente:

\`\`\`ts
import { productsRepository as productsRepositoryInstance, ProductsRepository } from '../../repositories/ProductsRepository';
import { cartRepository as cartRepositoryInstance, CartRepository } from '../../repositories/CartRepository';

interface HomeProps {
  productsRepository?: ProductsRepository;
  cartRepository?: CartRepository;
}

export const Home: React.FC<HomeProps> = ({
  productsRepository = productsRepositoryInstance,
  cartRepository = cartRepositoryInstance,
}) => {
  // ...
}
\`\`\`

Ahora bien, ¬øpor qu√© no hemos hecho test de nuestros objetos? Realmente no es necesario, ya que √∫nicamente act√∫an de proxy a la librer√≠a de fetch.
Sin embargo, en caso de que tuvi√©ramos l√≥gica propia, como pudiese ser la transformaci√≥n de la respuesta a una estructura propia, si podr√≠a ser de inter√©s llevar a cabo dicha validaci√≥n.

[Github Code](https://github.com/adrian-afergon/software-crafters-tdd-react/tree/feature/change-architecture/src)

### Nota final

Te habr√°s dado cuenta que los test e2e no pasan, ya que no es capaz de interceptar la petici√≥n http. Esto se debe a que \`cypress\` solo es capaz de interceptar peticiones \`xhr\`, y el \`fetch\` que estamos utilizando en nuestros \`repository\` no utiliza este tipo de solicitud. Cypress comenzar√° a dar soporte a partir de la versi√≥n \`4.9.0\`.

Para que funcione correctamente tendremos que aplicar el siguiente \`workaround\`: 

\`\`\`ts
/e2e/cypress/support/index.js

import './commands';

let polyfill;

before(() => {
  const polyfillUrl = 'https://unpkg.com/whatwg-fetch@3.0.0/dist/fetch.umd.js';
  cy.request(polyfillUrl).then(response => {
    polyfill = response.body;
  });
});

Cypress.on('window:before:load', win => {
  delete win.fetch;
  win.eval(polyfill);
});
\`\`\`

O como otra opci√≥n, podemos cambiar nuestros \`repository\` para que utilicen \`xhr\` y **demostrar que nuestra arquitectura 
se encuentra totalmente desacoplada** entre la vista y el acceso a datos.

[Github Code](https://github.com/adrian-afergon/software-crafters-tdd-react/blob/feature/e2e-workaround/e2e/cypress/support/index.js)

## Conclusi√≥n

Como hemos visto, los tests nos ayudan a tomar decisiones sobre nuestro c√≥digo, a descubrir casos de uso que no nos hayamos planteado inicialmente y por supuesto a verificar de forma autom√°tica que nuestro c√≥digo funciona.

Sin embargo, esto no quiere decir que tengamos que ir a un extremo de que cada l√≠nea de c√≥digo debe ser comprobada, principalmente porque en muchos casos carecer√° de sentido o porque esto llevar√° un tiempo adicional para aprender como comprobar cada cosa en la forma correcta, frente a lo que nos aporta esa comprobaci√≥n.

Usar TDD como herramienta de desarrollo te abre un mundo de posibilidades como desarrollador, aprender√°s como funcionan las tecnolog√≠as, entender√°s el por qu√© muchas tecnolog√≠as funcionan de una determinada forma, a dem√°s que te permitir√° aprender a tomar decisiones t√©cnicas y crecer profesionalmente.

Espero que este art√≠culo te sirva de ayuda y te incentive a comenzar a dar tus primeros pasos en esta metodolog√≠a de desarrollo.
Puedes visitar el repositorio p√∫blico en [github](https://github.com/adrian-afergon/software-crafters-tdd-react) para ver el resultado final. 

Ante cualquier duda, o simplemente por el placer de debatir sobre este tema, puedes contactar conmigo a trav√©s de my 
twitter [@AdrianFerrera91](https://twitter.com/AdrianFerrera91), o a trav√©s de mi [p√°gina web](https://adrianferrera.com/) donde tambi√©n podr√°s encontrar otros muchos art√≠culos referentes al tema.",
    "slug": "tdd-react-typescript",
    "tags": [
      "react",
    ],
    "title": "TDD en React con TypeScript",
    "userPicture": "",
    "username": "Adri√°n Ferrera",
  },
  {
    "category": "javascript",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/JS_category.png",
    "date": "",
    "description": "Clean code o c√≥digo limpio en espa√±ol, es un t√©rmino al que ya hac√≠an referencia desarrolladores de la talla de Ward Cunningham o Kent Beck",
    "id": "clean-code-javascript",
    "markdownBody": "
<blockquote>
    <strong>"Programar es el arte de decirle a otro humano lo que quieres que el ordenador haga."</strong><strong> -- </strong><a href="https://es.wikipedia.org/wiki/Donald_Knuth"><strong>Donald Knuth</strong></a>
</blockquote>

<p>En los &uacute;ltimos a&ntilde;os, JavaScript se ha convertido en uno de los lenguajes m&aacute;s utilizados del mundo. Su principal ventaja, y a la vez su mayor debilidad, es su versatilidad. Esa gran versatilidad ha derivado en algunas malas pr&aacute;cticas que se han ido extendiendo en la comunidad, a&uacute;n as&iacute;, Javascript se encuentra en infraestructuras cr&iacute;ticas de <a href="https://stackshare.io/javascript">empresas muy importantes</a> (Facebook, Netflix o Uber lo utilizan), en las cuales limitar los costes derivados del mantenimiento del <em>software</em> se vuelve esencial.</p>
<p>El coste total de un producto <em>software</em> viene dado por la suma de los costes de desarrollo y de mantenimiento, siendo este &uacute;ltimo mucho m&aacute;s elevado que el coste del propio desarrollo inicial. A su vez, como expone Kent Beck en su libro <a href="https://amzn.to/2BHRU8P"><em>Implementation Patterns</em></a><em>, </em>el coste de mantenimiento viene dado por la suma de los costes de <strong>entender el c&oacute;digo</strong>, <strong>cambiarlo</strong>, <strong>testearlo</strong> y <strong>desplegarlo</strong>. </p>
<img class="align-center" style="width: 75%" src="https://res.cloudinary.com/software-crafters/image/upload/v1551009219/posts/clean_code_javascript/Esquema_costes_Kent_Beck.png" alt="costes-software"/>
<small class="align-center">Esquema de f&oacute;rmula de costes de Kent Beck</small>
<p>La idea de este art&iacute;culo es tratar de minimizar el coste relacionado con la parte de entender el c&oacute;digo, para ello&nbsp;tratar&eacute; de sintetizar y ampliar algunos de los conceptos relacionados con esto que exponen <a href="https://twitter.com/unclebobmartin">Robert C. Martin</a>, <a href="https://twitter.com/KentBeck">Kent Beck</a>, <a href="https://twitter.com/WardCunningham">Ward Cunningham</a> y otros autores aplic&aacute;ndolos a JavaScript. </p>

<h2>&iquest;Qu&eacute; es Clean Code?</h2>
<p><em>Clean code</em> o c&oacute;digo limpio en espa&ntilde;ol, es un t&eacute;rmino al que ya hac&iacute;an referencia desarrolladores de la talla de Ward Cunningham o Kent Beck, aunque no se populariz&oacute; hasta que Robert C. Martin, tambi&eacute;n conocido como <em>Uncle Bob</em>, public&oacute; su libro &ldquo;<a href="https://amzn.to/2TUywwB"><em>Clean Code: A Handbook of Agile Software Craftsmanship</em></a>&rdquo; en 2008. </p>
<p>El libro, aunque sea bastante dogm&aacute;tico y quiz&aacute;s demasiado focalizado en la programaci&oacute;n orientada a objetos, se ha convertido en un cl&aacute;sico que no debe faltar en la estanter&iacute;a de ning&uacute;n desarrollador que se precie, aunque sea para criticarlo. &nbsp;</p>
<img class="align-center" style="width: 75%" src="https://res.cloudinary.com/software-crafters/image/upload/v1549281084/posts/clean_code_javascript/cleancode_wtf.jpg" alt="clean-code"/>
<small class="align-center">Vi&ntilde;eta de <a href="https://www.osnews.com/comics/">osnews.com/comics/</a> sobre la calidad del c&oacute;digo </small>
<p>Existen muchas definiciones para el t&eacute;rmino clean code, pero yo personalmente me quedo con la de mi amigo Carlos Bl&eacute;, ya que adem&aacute;s casa muy bien con el objetivo del art&iacute;culo.</p>
<blockquote><strong>"C&oacute;digo</strong><strong> limpio es aquel que se ha escrito con la intenci&oacute;n de que otra persona (o t&uacute; mismo en el futuro) lo entienda." -- </strong><a href="https://twitter.com/carlosble"><strong>Carlos Bl&eacute;</strong></a></blockquote>
<p>Los desarrolladores solemos escribir c&oacute;digo sin la intenci&oacute;n expl&iacute;cita de que vaya a ser entendido por otra persona, ya que la mayor&iacute;a de las veces nos centramos simplemente en implementar una soluci&oacute;n que funcione y que resuelva el problema. </p>
<p>Tratar de entender el c&oacute;digo de un tercero o incluso el que escribimos nosotros mismos hace tan solo unas semanas, se puede volver una tarea realmente dif&iacute;cil. Es por ello que hacer un esfuerzo extra para que nuestra soluci&oacute;n sea legible e intuitiva es la base para reducir los costes de mantenimiento del <em>software</em> que producimos.</p>
<p>A continuaci&oacute;n veremos algunas de las secciones del libro de Uncle Bob que m&aacute;s relacionadas est&aacute;n con la legibilidad del c&oacute;digo. Si conoces el libro o lo has le&iacute;do, podr&aacute;s observar que he a&ntilde;adido algunos conceptos y descartado otros, adem&aacute;s de incluir ejemplos sencillos aplicados a JavaScript. </p>
<h2>Variables y nombres</h2>
<blockquote><strong>&ldquo;Nuestro c&oacute;digo tiene que ser simple y directo, deber&iacute;a leerse con la misma facilidad que un texto bien escrito&rdquo; -- <a href="https://es.wikipedia.org/wiki/Grady_Booch" target="_blank">Grady Booch</a></strong></blockquote>
<p>Nuestro c&oacute;digo deber&iacute;a poder leerse con la misma facilidad con la que leemos un texto bien escrito, es por ello que <strong>escoger buenos nombres</strong> es fundamental. Los nombres de variables, m&eacute;todos y clases deben seleccionarse con cuidado para que den expresividad y significado a nuestro c&oacute;digo. </p>
<img class="align-center" style="width: 75%" src="https://res.cloudinary.com/software-crafters/image/upload/v1549360879/posts/clean_code_javascript/hardest-problem-naming.jpg" alt="costes-software"/>
<small class="align-center">Vi&ntilde;eta de Commit Strip sobre el nombrado de variables.</small>
<p>A continuaci&oacute;n veremos algunas pautas y ejemplos para tratar de mejorar a la hora de escoger buenos nombres:</p>
<h3><strong>Nombres pronunciables y expresivos</strong></h3>
<p>Los nombres, imprescindiblemente en ingl&eacute;s, deben ser pronunciables. Esto quiere decir que no deben ser abreviaturas ni llevar guion bajo o medio, priorizando el estilo <em>CamelCase</em>. Por otro lado, debemos intentar no ahorrarnos caracteres en los nombres, la idea es que sean lo m&aacute;s expresivos posible.</p>
<pre class="language-javascript"><code>//bad
const yyyymmdstr = moment().format('YYYY/MM/DD');

//better
const currentDate = moment().format('YYYY/MM/DD');
</code></pre>

<h3>Uso correcto de var, let y const</h3>
<p>Debemos evitar a toda costa el uso de <em>var</em>, ya que define las variables con alcance global. Esto no ocurre con las variables definidas con let y const, ya que se definen para un &aacute;mbito en concreto. </p>
<p>La diferencia entre <em>let</em> y <em>const</em> radica en que a esta &uacute;ltima no se le puede reasignar su valor (aunque s&iacute; modificarlo). Es por ello que usar const en variables a las que no tengamos pensado cambiar su valor puede ayudarnos a mejorar la intencionalidad de nuestro c&oacute;digo.</p>
<pre class="language-javascript"><code>// old school JavaScript
var variable = 5;
{
  console.log('variable); // 5
  var variable = 10;
}

console.log(variable); // 10
variable = variable*2;
console.log(variable); // 20

// modern JavaScript (let)
let variable = 5;

{
   console.log(variable); // error
   let variable = 10;
}

console.log(variable); // 5
variable = variable*2;
console.log(variable); // 10

// modern JavaScript (const)
const variable = 5;
variable = variable*2; // error
console.log(variable); // doesn't get here
</code></pre>

<h3><strong>Evitar que los nombres contengan informaci&oacute;n t&eacute;cnica </strong></h3>
<p>Si estamos construyendo un <em>software</em> de tipo vertical (orientado a negocio), debemos intentar que los nombres no contengan informaci&oacute;n t&eacute;cnica en ellos, es decir, evitar incluir informaci&oacute;n relacionada con la tecnolog&iacute;a, como el tipo de dato o la <a href="https://es.wikipedia.org/wiki/Notaci%C3%B3n_h%C3%BAngara">notaci&oacute;n h&uacute;ngara,</a> el tipo de clase, etc. Esto s&iacute; se admite en desarrollo de <em>software</em> horizontal o librer&iacute;as de prop&oacute;sito general.</p>
<pre class="language-javascript"><code>//bad
class AbstractUser(){...}

//better
class User(){...}
</code></pre>

<h3><strong>L&eacute;xico coherente</strong></h3>
<p>Debemos usar el mismo vocabulario para hacer referencia al mismo concepto, no debemos usar en algunos lados <em>User</em>, en otro <em>Client</em> y en otro <em>Customer</em>, a no ser que representen claramente conceptos diferentes. </p>
<pre class="language-javascript"><code>//bad
getUserInfo();
getClientData();
getCustomerRecord();

//better
getUser()
</code></pre>

<h3><strong>Usa el nombre adecuado seg√∫n el tipo de dato</strong></h3>
<p><strong>Arrays</strong></p>
<p>Los arrays son una lista iterable de elementos, generalmente del mismo tipo. Es por ello que pluralizar el nombre de la variable puede ser una buena idea:</p>

<pre class="language-javascript"><code>//bad
const fruit = ['manzana', 'platano', 'fresa'];
// regular
const fruitList = ['manzana', 'platano', 'fresa'];
// good
const fruits = ['manzana', 'platano', 'fresa'];
// better
const fruitNames = ['manzana', 'platano', 'fresa'];
</code></pre>

<p><strong>Booleanos</strong></p>
<p>Los booleanos solo pueden tener 2 valores, verdadero o falso. Dado esto, el uso de prefijos como "is", "has" y "can" ayudar√° inferir el tipo de variable, mejorando as√≠ la legibilidad de nuestro c√≥digo.</p>


<pre class="language-javascript"><code>//bad
const open = true;
const write = true;
const fruit = true;

// good
const isOpen = true;
const canWrite = true;
const hasFruit = true;
</code></pre>

<p><strong>N√∫meros</strong></p>
<p>Para los n√∫meros es interesante escoger palabras que describan n√∫meros, como ‚Äúmin‚Äù, ‚Äúmax‚Äù, ‚Äútotal‚Äù:</p>


<pre class="language-javascript"><code>//bad
const fruits = 3;

//better
const maxFruits = 5;
const minFruits = 1;
const totalFruits = 3;
</code></pre>


<p><strong>Funciones</strong></p>
<p>Los nombres de las funciones deben representar acciones, por ello que deben construirse usando el verbo que representa la acci√≥n seguido de un sustantivo. Estos deben de ser descriptivos y, a su vez, concisos. Esto quiere decir que el nombre de la funci√≥n debe expresar lo que hace, pero tambi√©n debe de abstraerse de la implementaci√≥n de la funci√≥n.</p>
<pre class="language-javascript"><code>//bad
createUserIfNotExists()
updateUserIfNotEmpty()
sendEmailIfFieldsValid()

//better
createUser(...)
updateUser(...)
sendEmail()
</code></pre>

<p>En el caso de las funciones de acceso, modificaci√≥n o predicado, el nombre debe el prefijo get, set, e is, respectivamente. [i]</p>

<pre class="language-javascript"><code>
getUser()
setUser(...)
isValidUser()
</code></pre>

<p><strong>Clases</strong></p>
<p>Las clases y los objetos deben tener nombres formados por un sustantivo o frases de sustantivo como User, UserProfile, Account, AdressParser. Debemos evitar nombres como Manager, Processor, Data o Info.</p>
<p>Hay que ser cuidadosos a la hora de escoger estos nombres, ya que son el paso previo a la hora de definir la responsabilidad de la clase. Si escogemos nombres demasiado gen√©ricos tendemos a crear clases con m√∫ltiples responsabilidades.</p>
",
    "slug": "clean-code-javascript",
    "tags": [
      "javascript",
    ],
    "title": "Clean Code aplicado a Javascript",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "typescript",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/TS_category.png",
    "date": "",
    "description": "TypeScript es un lenguaje que extiende JavaScript para dotarlo de tipado est√°tico.",
    "id": "introduccion-typescript-react",
    "markdownBody": "[TypeScript](https://www.typescriptlang.org/) es un lenguaje que extiende JavaScript para dotarlo de un *tipado est√°tico*. Esto quiere decir que la comprobaci√≥n y verificaci√≥n de los tipos se realiza en tiempo de *compilaci√≥n* (cuando se convierte de TS a JS) en vez de en tiempo de *ejecuci√≥n* (cuando el motor de JS interpreta el c√≥digo).

Una de las caracter√≠sticas principales de JavaScript es su dinamismo. Una variable se puede asignar a cualquier tipo, sin necesidad de declararlo previamente.

Este c√≥digo, aunque engorroso e in√∫til, ser√≠a perfectamente v√°lido en JS:

\`\`\`js
let return;

function cb(value) {
  return = value;
}
\`\`\`

Sin embargo, el compilador de TS necesita conocer previamente qu√© tipo de valores vamos a asignar a esta variable, de tal forma que se pueda operar con ella con seguridad (por ejemplo evitando que se puedan sumar un *string* y un *number*, dando lugar a resultados impredecibles).

\`\`\`typescript
// la forma de declarar el tipado es a√±adiendo
// dos puntos ":" junto a la declaraci√≥n
let return: number;

function cb(value: number) {
  return = value;
}
\`\`\`

Dada la filosof√≠a modular y orientada a componentes de React, TypeScript se convierte en el aliado perfecto, asegurando la perfecta cohesi√≥n de todos los elementos de nuestra arquitectura.

## Instalando y configurando el entorno de trabajo

Tal y como cuando trabajamos con JavaScript, la forma m√°s sencilla de configurar el entorno de desarrollo para un proyecto basado en React es usando [create-react-app](https://create-react-app.dev/), con la salvedad de que le pasaremos el par√°metro adecuado para configurar nuestra **template** en modo **typescript**:

\`\`\`sh
# yarn
yarn create react-app miproyecto --template typescript

# npx
npx create-react-app miproyecto --template typescript
\`\`\`

Una opci√≥n siempre interesante es configurar eslint con el est√°ndar de preferencia, por ejemplo el de [AirBnB](https://www.npmjs.com/package/eslint-config-airbnb-typescript).

## Conceptos b√°sicos

### Variables

En TypeScript todas las variables est√°n designadas dentro de un √°mbito (scope), por lo que s√≥lo se puede usar **let** o **const**. Esta √∫ltima adem√°s impide su reasignaci√≥n. M√°s sobre el concepto de hoisting: [https://developer.mozilla.org/es/docs/Glossary/Hoisting](https://developer.mozilla.org/es/docs/Glossary/Hoisting).

Cuando declaramos una constante (mediante el uso de **const**) usualmente no necesitamos declarar el tipo, puesto que este se *infiere* autom√°ticamente. Es decir, al declarar un valor, que no se puede reasignar, el compilador es capaz de "adivinar" cu√°l es el tipo adecuado para ese valor.

\`\`\`typescript
const myStr = 'a'; // el tipo ser√≠a 'a', que es un subconjunto de 'string'
const myNumber = 5; // el tipo ser√≠a 5, que es un subconjunto de 'number'
\`\`\`

En el caso de una variable (definida con **let**), tambi√©n se producir√≠a esta inferencia. Sin embargo, puesto que si que se puede reasignar, el tipo ser√≠a menos restrictivo que en el caso anterior.

\`\`\`typescript
let myStr = 'a'; // el tipo ser√≠a 'string'
let myNumber = 5; // el tipo ser√≠a 'number'

myStr = 'b'; // el tipo sigue siendo 'string'
myNumber = 6; // el tipo sigue siendo 'number'
\`\`\`

Llegados a este punto nos preguntamos: *¬øQu√© pasar√≠a si necesitasemos reasignar cualquiera de las variables y asignarles el valor \`null\`?*

Adem√°s de un valor, \`null\` tambi√©n es un tipo, y el compilador se "quejar√≠a", puesto que no hemos previsto que nuestra variable pueda almacenar ese tipo de valor. Es por esto que la inferencia por s√≠ sola no ser√≠a suficiente, y tenemos que "echar un cable" a nuestro int√©rprete declarando un tipo menos restrictivo para nuestra variable:

\`\`\`typescript
let myStr: string | null = 'a'; // esto se llama "Union Type" y nos permite aplicar un operador "OR" a nuestros tipos

myStr = 'b'; // podr√≠amos seguir asignando un string a nuestra variable

myStr = null; // pero tambi√©n podr√≠amos declararla como "null"
\`\`\`

Los tipos b√°sicos m√°s usados son:

- \`null\`
- \`undefined\`
- \`number\`
- \`string\`
- \`boolean\`
- \`void\`

### Arrays

Cuando declaramos un tipo Array en TypeScript, debemos declarar qu√© tipos diferentes puede almacenar en sus posiciones. La forma m√°s sencilla de hacer esto es mediante la palabra reservada \`Array\`, pasando los \`gen√©ricos\` (luego veremos qu√© son) entre "menor que" y "mayor que":

\`\`\`typescript
let myArr: Array<string | number>;

myArr.push('a');
myArr.push(2);
\`\`\`

Otra forma equivalente de hacer lo mismo es declarando el tipo del item (que en este caso coincidir√≠a con el gen√©rico anterior) y a√±adiendo al final unos \`corchetes\` \`[]\`. Como el tipo de cada item es un **Union Type**, debemos recordar englobarlo entre par√©ntesis para que los corchetes afecten a cada uno de los tipos. 

\`\`\`typescript
let myArr: (string | number)[];

myArr.push('a');
myArr.push(2);
\`\`\`

Uno de los problemas m√°s comunes en JS es la *mutabilidad*. Cuando le asignamos un array, un objeto o una funci√≥n a una variable, en realidad lo que hacemos es hacer que apunte hacia una referencia, que es compartida cuando se copia a otra variable. Si modificamos cualquiera de las dos variables, la referencia original se ver√° afectada.

\`\`\`js
const a = ['uno'];
const b = a;
b.push('dos'); // ahora, tanto "a" como "b" valen ['uno', 'dos'];
\`\`\`

Para evitar este problema han surgido multitud de soluciones. Desde envolver nuestro array con \`Object.freeze\` hasta el uso de librer√≠as como [Immutable](https://immutable-js.github.io/immutable-js/).

En TypeScript, la immutabilidad en los arrays est√° asegurada gracias al uso de \`ReadonlyArray\`, incluso en estructuras de datos encadenadas (objetos dentro de arrays):

\`\`\`typescript
const myArr: ReadonlyArray<number | string> = ['a', 2];

// si intent√°semos hacer un "push" a "myArr" el compilador nos devolver√≠a un error, porque no se puede mutar
\`\`\`

Obviamente podr√≠amos generar un nuevo array usando datos del primero sin problemas, puesto que no habr√≠amos mutado el array original:

\`\`\`typescript
const myArr: ReadonlyArray<number | string> = ['a', 2];

const myDerivedArr = [...myArr, 'b', 3];
\`\`\`

Otra posibilidad para declarar nuestro array es hacerlo por medio de las *const assertions*:

\`\`\`typescript
const roles = ['can_read', 'can_write'] as const;
\`\`\`

Con esto, estamos declarando nuestro array como \`Readonly\` autom√°ticamente, y adem√°s, hacemos que el tipo del array coincida con su valor, en vez de con su primitiva. Esta ser√≠a la declaraci√≥n del mismo array declarado sin y con *const assertion*:

\`\`\`typescript
declare const noConstRoles: string[];
declare const roles: readonly ["can_read", "can_write"];
\`\`\`

### Objetos

Podemos declarar un objeto en Typescript de varias formas. La m√°s sencilla es declarar un \`type\` que contenga cada una de las propiedades del objeto:

\`\`\`typescript
type Person = {
  name: string,
  email: string,
  age: number,
};

let person: Person;

person = {
  name: 'Bruce Wayne',
  email: 'bruce@wayneindustries.com',
  age: 57,
}
\`\`\`

Otra opci√≥n bastante similar es declarar el tipo de nuestro objeto por medio de una \`interface\`:

\`\`\`typescript
interface Person {
  name: string;
  email: string;
  age: number;
};

let person: Person;

person = {
  name: 'Bruce Wayne',
  email: 'bruce@wayneindustries.com',
  age: 57
}
\`\`\`

Merece la pena rese√±ar que es posible generar un tipo para un objeto a partir de otros dos tipos existentes por medio de un *Intersection type*. Funcionar√≠a tanto con \`types\` como con \`interfaces\`:

\`\`\`type
interface Profile {
  name: string;
  age: number;
}

interface Contact {
  email: string;
}

type Person = Profile & Contact;

let person: Person;

person = {
  name: 'Bruce Wayne',
  email: 'bruce@wayneindustries.com',
  age: 57
}
\`\`\`

Una de las preguntas que se nos pueden venir a la cabeza es: "¬øQu√© pasa si alguna de las propiedades es opcionales?". Para ello tan solo tenemos que a√±adir una interrogaci√≥n \`?\` detr√°s del nombre de la propiedad:

\`\`\`typescript
type Person = {
  name: string,
  email: string,
  age?: number,
};

let person: Person;

person = {
  name: 'Bruce Wayne',
  email: 'bruce@wayneindustries.com',
  age: 57,
}

person = {
  name: 'Jordi Hurtado',
  email: 'jordi.hurtado@rtve.es',
}

\`\`\`

Otra posibilidad de definir nuestro objeto es mediante el uso de \`Record\`. Este recibe dos gen√©ricos, el primero define el tipo para las claves, y el segundo el tipo para los valores.

\`\`\`typescript
type Messages = Record<string, string>;

let messages: Messages = {
  success: 'La operaci√≥n se ha completado con √©xito',
  notFound: 'No se ha encontrado',
  error: 'Error general',
};
\`\`\`

Como en el caso de los arrays, tambi√©n podemos inferir el tipo de un objeto si lo declaramos con una *const assertion*:

\`\`\`typescript
const config = {
  apiURL: 'http://0.0.0.0:9000',
  apiVersion: 'v2',
  publicKey: 'pl3as3d0nthackm3'
} as const;
\`\`\`

...y este ser√≠a el tipo correspondiente generado:

\`\`\`typescript
declare const config: {
    readonly apiURL: "http://0.0.0.0:9000";
    readonly apiVersion: "v2";
    readonly publicKey: "pl3as3d0nthackm3";
};
\`\`\`

### Funciones

En muchos casos, tan solo necesitamos tipar los argumentos recibidos. El tipo de respuesta ser√° inferido autom√°ticamente.

\`\`\`typescript
function double(x: number) {
  return x * 2;
}
\`\`\`

Ocurre lo mismo para las *arrow functions*:

\`\`\`typescript
const double = (x: number) => x * 2;
\`\`\`

Podemos extraer el tipado de una funci√≥n tanto a un \`type\`:

\`\`\`typescript
type ChangeNumber = (x: number) => number;
\`\`\`

como a una interface

\`\`\`typescript
interface ChangeNumber {
    (x: number): number
}

const double: ChangeNumber = function(x) {
    return x * 2;
}
\`\`\`

### \`any\` y \`unknown\`

Cuando usamos el valor \`any\`, permitimos que se asigne o se reciba cualquier tipo de valor. Sin embargo, esto es peligroso, porque podr√≠amos ejecutar cualquier c√≥digo problem√°tico sin que el compilador nos advierta:

- Incrementar un *array* como si fuera un num√©rico
- Acceder a una posici√≥n de un array cuando en realidad el valor es un num√©rico

\`unknown\` es bastante similar, pero en este caso el compilador nos obliga a realizar las comprobaciones necesarias antes de ejecutar cualquier acci√≥n que solo est√© disponible para un tipo concreto:

\`\`\`typescript
const stringify = (value: unknown): string => {
  if (value instanceof Date) {
    return value.toISOString();
  }
  if (Array.isArray(value) || typeof value === 'object') {
    return JSON.stringify(value);
  }
  if (typeof value === 'number') {
    return value.toLocaleString();
  }
  return String(value);
}
\`\`\`

### Gen√©ricos

Ya hemos visto anteriormente c√≥mo usar gen√©ricos para definir los tipos que se pod√≠an almacenar en un array, por ejemplo \`ReadonlyArray<string\`.

Otro de los usos m√°s comunes es para definir el tipo de un argumento cuando no lo conocemos previamente. Imaginemos la siguiente funci√≥n en JavaScript:

\`\`\`js
const castArray = (x) => Array.isArray(x) ? x : [x];

castArray(1); // [1]
castArray([1]); // [1]
castArray('b'); // ['b']
castArray({ name: 'Bruce Wayne' }); // [{ name: 'Bruce Wayne' }]
\`\`\`

Si quisieramos convertir esta funci√≥n a TypeScript tendr√≠amos que declarar el argumento como \`unknown\` o bien crear un *Union Type* a partir de todos los posibles. Sin embargo, a√∫n as√≠, se perder√≠a la inferencia, puesto que la respuesta tambi√©n ser√≠a un array de cualquiera de esos tipos, en vez de especificar el concreto para cada caso. Para solucionar este problema podemos hacer uso de los gen√©ricos.

En el siguiente ejemplo, declaramos un argumento que puede ser un array que a su vez incluya cualquier tipo, o bien un elemento individual de cualquier tipo. En el primer caso devuelve el propio array, mientras que en el segundo lo envuelve en un array. En los dos casos, el tipo devuelto es el mismo.

\`\`\`typescript
function castArray<T>(x: T | T[]): T[] {
  return Array.isArray(x) ? x : [x];
}
\`\`\`

### @types

Habr√° muchas ocasiones en las que tengamos que trabajar con una librer√≠a externa. Aqu√≠ pueden pasar 3 cosas:

- Que la librer√≠a est√© escrita en TS, o que incluya un fichero de definiciones de tipos.
- Que la librer√≠a no incluya ese fichero de forma nativa, pero que est√© disponible de forma externa.
- Que la librer√≠a no soporte TS

En el primer caso, no necesitaremos hacer nada m√°s para interactuar con la librer√≠a. En la mayor parte de las ocasiones no cubiertas por el primer caso, alguien se ha tomado la molestia de crear este fichero de definiciones en el repositiorio de [definitelytyped](https://definitelytyped.org/).

Este es el caso de **react-router-dom**. Si queremos trabajar con esta librer√≠a en nuestro proyecto, tan solo debemos instalar la definici√≥n de tipos al mismo tiempo que la librer√≠a:

\`\`\`sh
yarn add react-router-dom @types/react-router-dom
\`\`\`

Y ya estar√≠an incorporados los tipos de react-router-dom de forma autom√°tica en nuestro proyecto.

## Componentes

En el caso de los componentes m√°s simples (aquellos que no esperan ninguna propiedad), el compilador es capaz de inferir autom√°ticamente el tipo devuelto (\`JSX.Element\`):

\`\`\`typescript
import React from 'react';

const MyComponent = () => (
    <div>Simple Component</div>
)

export default MyComponent;
\`\`\`

En caso contrario, debemos hacer uso del tipo \`FC\` o \`FunctionalComponent\`. Este tipo recibe un gen√©rico correspondiente a las props:

\`\`\`typescript
import React, { FC, ReactNode, SyntheticEvent } from 'react';

interface Props {
  onClick: (e: SyntheticEvent) => void;
  children: ReactNode;
}

const MyButton: FC<Props> = ({ onClick, children }) => (
    <button type="button" onClick={onClick}>{children}</button>
)

export default MyButton;
\`\`\`

Como habr√°s observado, aqu√≠ estamos utilizado otros dos tipos nuevos:

- **ReactNode**: Cualquier tipo de valor que React pueda renderizar (\`ReactElement\`, \`string\`, \`number\`, \`Fragment\`, \`null\`...)
- **SyntheticEvent**: Una instancia del contenedor que usa React para manejar los eventos

La declaraci√≥n de \`children\` es opcional al usar el tipo \`FC\` puesto que ya la incluye. En el caso de los componentes cuya √∫nica propiedad es \`children\` podemos omitir el uso del gen√©rico:

\`\`\`typescript
import React, { FC } from 'react';

const MyComponent: FC = ({ children }) => (
    <div>{children}</div>
)

export default MyComponent;
\`\`\`

En cualquier momento podemos marcar una propiedad como opcional, as√≠ como pasarle un valor por defecto:

\`\`\`typescript
import React, { FC } from 'react';

type Props = {
  id: string;
  tabIndex: number;
  role?: string;
  hidden?: boolean;
}

const MyComponent: FC<Props> = ({ children, id, tabIndex, role, hidden = false }) => (
    <div id={id} tabIndex={tabIndex} role={role} hidden={hidden}>{children}</div>
)

export default MyComponent;
\`\`\`

### types + prop-types

Cuando estamos desarrollando una librer√≠a usando TS, no debemos olvidar que puede ser consumida en un proyecto de JS, por lo que siempre es buena idea incluir la validaci√≥n de tipos din√°mica (en tiempo de ejecuci√≥n) con prop-types.

Para evitar tener que hacer esto a mano podemos usar la utilidad \`InferProps\` de la propia librer√≠a *prop-types*. No obstante, debemos recordar que TS proporciona mucha m√°s informaci√≥n en algunos casos (especialmente para funciones), por lo que siempre es buena idea combinarlo con nuestra propia declaraci√≥n de tipos por medio de un *Intersection Type*:

\`\`\`typescript
import React, { FC, SyntheticEvent, ButtonHTMLAttributes } from 'react';
import PropTypes, { InferProps } from 'prop-types';

const propTypes = {
  onClick: PropTypes.func.isRequired,
  children: PropTypes.node.isRequired,
  type: PropTypes.oneOf(['button', 'submit', 'reset']),
};

export type Props = InferProps<typeof propTypes> & {
  onClick: (e: SyntheticEvent) => void,
  type: ButtonHTMLAttributes<HTMLButtonElement>['type']
};

const Button: FC<Props> = ({ children, onClick, type }) => (
  <button type={type} onClick={onClick}>
    {children}
  </button>
);

Button.defaultProps = {
  type: 'button',
};

export default Button;
\`\`\`

Aqu√≠, b√°sicamente estamos infiriendo las props a partir del tipo de nuestras prop-types, pero lo extendemos:

- Mejoramos el tipado de *onClick*, para proveer del tipo del argumento (un \`SyntheticEvent\`) y del retorno
- Mejoramos el tipado para el atributo \`type\`, recogi√©ndolo de forma autom√°tica a partir de las propiedades que puede recibir un bot√≥n

Por otro lado, mi buen amigo [Iv√°n Trujillo me recomend√≥ un plugin de Babel](https://twitter.com/Ivanbtrujillo/status/1314280593807609857) que extrae los \`prop-types\` a partir de nuestro tipado.

## TypeScript + CSS

Sea cual sea la soluci√≥n que elijamos para aplicar estilos a nuestra aplicaci√≥n, podemos estar seguros de que tiene soporte de TS, bien de forma nativa, o bien a partir del repo de \`@types\`.

### Estilos en l√≠nea

Podemos usar el tipo \`CSSProperties\` que incorpora *React* para asegurarnos que las propiedades declaradas son v√°lidas.

Si escribi√©semos cualquier propiedad no reconocida por CSS, el compilador emitir√≠a un error:

\`\`\`typescript
import React, { FC, CSSProperties } from 'react';

const styles: CSSProperties = {
  backgroundColor: 'red',
  color: 'white',
  padding: '20px',
};

const MyComponent: FC = ({ children }) => <div style={styles}>{children}</div>;

export default MyComponent;
\`\`\`

### Clases CSS

El caso de pasar el nombre de **una clase CSS** como propiedad es todav√≠a m√°s sencillo, puesto que no deja de ser un simple string:

\`\`\`typescript
import React, { FC } from 'react';

type Props = {
  className: 'string'
};

const MyComponent: FC<Props> = ({ children, className }) => <div className={className}>{children}</div>;

export default MyComponent;
\`\`\`

### CSS-in-JS

Pong√°monos en el caso de que usamos una librer√≠a de *CSS-in-JS* como [emotion](https://emotion.sh/) con una soluci√≥n para definir nuestros tokens de dise√±o en forma de tema, como [emotion theming](https://emotion.sh/docs/theming).

Una de las mayores ventajas que nos aporta aqu√≠ TS es la comprobaci√≥n de tipos a la hora de acceder a nuestro tema desde los componentes, de tal forma que nos aseguremos que no accedemos a una propiedad inexistente.

Lo primero que deber√≠amos hacer es declarar nuestro tema, y exponerlo por contexto al resto de componentes por medio de un \`ThemeProvider\`:

\`\`\`typescript
import React, { FC } from 'react';
import { ThemeProvider } from 'emotion-theming';

import theme from '../theme';

const AppStyles: FC = ({ children }) => (
  <ThemeProvider theme={theme}>
    {children}
  </ThemeProvider>
);

export default AppStyles;
\`\`\`

A continuaci√≥n, generamos nuestra propia versi√≥n de la utilidad \`styled\`, para inyectarle el tipado de nuestro tema:


\`\`\`typescript
import styled, { CreateStyled } from '@emotion/styled';

import theme from './theme';

export default styled as CreateStyled<typeof theme>;
\`\`\`

A partir de este momento, cualquier componente declarado con nuestra versi√≥n de \`styled\` tendr√° acceso a una propiedad "theme" de forma autom√°tica, que se corresponder√° con el tema declarado anteriormente, y ser√° capaz de avisarnos sobre las propiedades a las que estamos accediendo de forma incorrecta. Si adem√°s declaramos el tipo del tema con una \`const assertion\`, tendremos acceso en tiempo real al valor de la propiedad a la que accedemos.

\`\`\`typescript
import React, { FC } from 'react';

import styled from '../../styled';

const SWrapper = styled.section\`
  padding: 20px 40px;
  background-color: \${(props) => props.theme.colors.muted};
  max-width: 600px;
  margin: 40px auto;
  box-shadow: 0 5px 12px rgba(0,0,0,0.25);
  border-radius: 6px;
\`;

const STitle = styled.h1\`
  font-family: \${(props) => props.theme.fonts.heading};
  font-size: \${(props) => props.theme.fontSizes[6]}px;
  margin: 0 0 32px;
\`;

const SImage = styled.img\`
  display: block;
  width: 100%;
\`;

type Props = {
  title: string,
  imageSrc: string
};

const Intro: FC<Props> = ({ title, imageSrc }) => (
  <SWrapper>
    <STitle>{title}</STitle>
    <SImage src={imageSrc} alt="" />
  </SWrapper>
);

export default Intro;
\`\`\`
## React Hooks
### useState

En los casos m√°s simples (cuando almacenamos en el estado datos del mismo tipo definido con el valor inicial) no necesitamos hacer ninguna declaraci√≥n especial de nuestro hook:

\`\`\`typescript
import { useState } from 'react';

const useCounter = () => {
  const [value, setValue] = useState(0);
  const increment = () => setValue(prevState => prevState + 1);
  const decrement = () => setValue(prevState => prevState + 1);
  return {
    value,
    increment,
    decrement,
  };
};

export default useCounter;
\`\`\`

La cosa cambia cuando queremos almacenar estados algo m√°s complejos, como el de un usuario, donde el valor depende de si est√° logueado o no:

En el primer caso, la propiedad "isLogged" tiene que ser \`false\`, y no puede existir ninguna propiedad adicional.

\`\`\`typescript
type UnloggedUser = {
  isLogged: false
};
\`\`\`

En el segundo caso, la propiedad "isLogged" tiene que ser \`true\`, y adem√°s tiene que tener una propiedad "email" que definimos como \`string\`.

\`\`\`typescript
type LoggedUser = {
  isLogged: true,
  email: string,
}
\`\`\`

Podr√≠amos expresar el tipo de nuestro \`User\` usando un \`Union Type\` sobre los dos tipos definidos anteriormente:

\`\`\`typescript
type User = UnloggedUser | LoggedUser;
\`\`\`

...y ya solo nos faltar√≠a usarlo como gen√©rico para definir nuestro \`useState\`:

\`\`\`typescript
const INITIAL_STATE = {
  isLogged: false,
} as const;

const useUser = () => {
  const [user, setUser] = useState<User>(INITIAL_STATE);

  const login = (email: string) => {
    setUser({
      isLogged: true,
      email,
    });
  };

  const logout = () => {
    setUser(INITIAL_STATE);
  };

  return {
    user,
    login,
    logout,
  };
};

export default useUser;
\`\`\`

### useReducer

Otra forma de escribir el ejemplo anterior ser√≠a mediante el uso de reducers. En este caso, a√±adir√≠amos los tipos para los *action types*, as√≠ como para las propias acciones.

Posteriormente, tipar√≠amos el *reducer* usando el \`State\` y las \`Actions\` previamente definidas.

\`\`\`typescript
import { useReducer } from 'react';

const INITIAL_STATE = {
  isLogged: false,
} as const;

type UnloggedState = typeof INITIAL_STATE;

type LoggedState = {
  isLogged: true,
  email: string,
}

type State = UnloggedState | LoggedState;

const ACTION_TYPES = {
  login: 'login',
  logout: 'logout',
} as const;

type ActionTypes = typeof ACTION_TYPES;

type LoginAction = {
  type: ActionTypes['login'],
  payload: string,
};

type LogoutAction = {
  type: ActionTypes['logout'],
};

type Action = LoginAction | LogoutAction;

const reducer = (state: State, action: Action) => {
  switch(action.type) {
    case ACTION_TYPES.login:
      return { isLogged: true, email: action.payload };
    case ACTION_TYPES.logout:
      return INITIAL_STATE;
    default:
      return state;
  }
}

const useUser = () => {
  const [state, dispatch] = useReducer(reducer, INITIAL_STATE);

  const login = (email: string) => dispatch({
    type: ACTION_TYPES.login,
    payload: email,
  });

  const logout = () => dispatch({
    type: ACTION_TYPES.logout,
  });

  return {
    state,
    login,
    logout,
  }
};

export default useUser;
\`\`\`

En el caso de que us√°semos [Redux](https://react-redux.js.org/), el procedimiento ser√≠a el mismo, con la salvedad de que tambi√©n podr√≠amos exportar el tipo de los *reducers* combinados. Para ello, podemos hacer uso de la utilidad \`ReturnType\`, que como su propio nombre indica, recoge el tipo del valor devuelto por una funci√≥n.

\`\`\`typescript
import { combineReducers } from 'react-redux';

import chatReducer from './chat';
import userReducer from './user';

const rootReducer = combineReducers({
  chat: chatReducer,
  user: userReducer,
});

export type RootReducer = ReturnType<typeof rootReducer>;

export default rootReducer;
\`\`\`

### useContext

Imaginemos ahora que queremos compatir el estado anterior con muchos componentes, pero sin tener que hacer el llamado *prop drilling*, es decir, pasar las propiedades de padre a hijo en distintos niveles.

Para ello podemos hacer uso del [API de contexto de React](https://es.reactjs.org/docs/context.html). Lo que haremos ser√° reemplazar nuestro hook \`useReducer\` para que devuelva el contexto que almacena el valor devuelto por el hook que hac√≠a uso del reducer, que ahora llamaremos \`useUserState\` para distinguirlo.

Lo primero que deber√≠amos hacer es crear el tipo para nuestro contexto. Como no conocemos su valor de antemano, simplemente le asignaremos un objeto vac√≠o y forzaremos el tipo asignado por medio del operador \`as\`.

\`\`\`typescript
import { createContext } from 'react';

import useUserState from './useUserState';

const UserContext = createContext({} as ReturnType<typeof useUserState>);

export default UserContext;
\`\`\`

Ahora crearemos un \`Provider\`, cuya misi√≥n ser√° ejercer de "host" para el hook que almacena el estado, y pasar el valor por contexto a todos sus descendientes:

\`\`\`typescript
import React, { FC } from 'react';

import useUserState from './useUserState';
import UserContext from './UserContext';

const UserProvider: FC = ({ children }) => {
  const value = useUserState();
  return <UserContext.Provider value={value}>{children}</UserContext.Provider>;
};

export default UserProvider;
\`\`\`

Por √∫ltimo, tan solo tendr√≠amos que crear nuestro hook para facilitar la exportaci√≥n del contexto del usuario:

\`\`\`typescript
import { useContext } from 'react';

import UserContext from './UserContext';

const useUser = () => useContext(UserContext);

\`\`\`",
    "slug": "introduccion-typescript-react",
    "tags": [
      "typescript",
    ],
    "title": "Introducci√≥n a TypeScript con ReactJS",
    "userPicture": "",
    "username": "Jose Manuel Lucas",
  },
  {
    "category": "typescript",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/TS_category.png",
    "date": "",
    "description": "Un patr√≥n de dise√±o es un conjunto de recomendaciones que podemos aplicar para resolver problemas de dise√±o comunes. Comportamiento y UI",
    "id": "patrones-diseno-comportamiento-ui",
    "markdownBody": "Este art√≠culo es la continuaci√≥n del post [Patrones de con TypeScript en el mundo real: creacionales y estructurales](/typescript/patrones-diseno-creacionales-estructurales), en ese post defin√≠a el concepto de patr√≥n de dise√±o y profundizaba en algunos patrones creacionales y estructurales.

En este segundo art√≠culo nos centraremos en los patrones de comportamiento y de UI.

## Patrones de comportamiento

### Strategy

La motivaci√≥n principal del patr√≥n *Strategy* es tener la posibilidad de ejecutar distintas implementaciones para una misma funcionalidad de forma din√°mica. De esta forma, imaginemos que tenemos que ejecutar una funcionalidad espec√≠fica representada por un m√©todo *strategicMethod*:

\`\`\`ts
interface Strategy {
    strategicMethod(): void;
}
\`\`\`

Y dicha funcionalidad puede ser ejecutada de dos maneras (estrategias) diferentes:

\`\`\`ts
class ConcreteStrategyA implements Strategy {
    public strategicMethod(): void {
        console.log('Strategy A');
    }
}

class ConcreteStrategyB implements Strategy {
    public strategicMethod(): void {
        console.log('Strategy B');
    }
}
\`\`\`

Definimos una clase *Context* que conoce la implementaci√≥n o estrategia que debe ejecutarse en cada momento para acometer la funcionalidad:

\`\`\`ts
class Context {
    private strategy: Strategy;

    constructor(strategy: Strategy) {
        this.strategy = strategy;
    }

    setStrategy(strategy: Strategy) {
        this.strategy = strategy;
    }

    performStrategicMethod(): void {
        this.strategy.strategicMethod();
    }
}
\`\`\`

Con ella, podemos desde el cliente **variar din√°micamente la estrategia a ejecutar**. Adem√°s, delegamos la implementaci√≥n interna de cada comportamiento o estrategia a las subclases *ConcreteStrategy*. El punto negativo de este patr√≥n, es que el cliente necesita conocer y referenciar las clases de cada una de las estrategias.

\`\`\`ts
export class Client {
    run(): void {
        const context = new Context(new ConcreteStrategyA());
        context.performStrategicMethod();

        context.setStrategy(new ConcreteStrategyB());
        context.performStrategicMethod();
    }
}
\`\`\`

En nuestro caso particular, registr√°bamos cada cambio en cada campo de cada formulario y lo almacen√°bamos en el estado centralizado de la aplicaci√≥n. Utilizamos el patr√≥n *Strategy* en el componente que ten√≠a que representar este historial de cambios, ya que necesit√°bamos una representaci√≥n diferente dependiendo del tipo de dato modificado.

Definimos por ello un formateador por cada posible tipo de dato que hubiera que representar:

\`\`\`ts
export interface FieldFormatter<T> {
    format(field: Field<T>): string;
}
export class BooleanFormatter implements FieldFormatter<boolean> {

    format(field: Field<boolean>): string {
        return field.value ? 'True' : 'False';
    }
}
export class StringFormatter implements FieldFormatter<string> {

    format(field: Field<string>): string {
        return field.value;
    }
}
\`\`\`

Y en el componente visual, utilizamos un servicio de *Angular*, que a trav√©s de una factor√≠a, obten√≠a el formateador adecuado en base al tipo de dato de cada registro:

\`\`\`ts
@Injectable()
export class FieldFormatterService {
    private formattersDictionary: { [key: number]: FieldFormatter<any> };

    constructor() {
        this.formattersDictionary =
            FieldTypeFormatsFactory.buildFormattersDictionary();
    }

    format(field: Field<any>): string {
        const typeFormatter = this.formattersDictionary[field.type];
        return typeFormatter !== undefined && typeFormatter.format(field);
    }
}
    
export class FieldTypeFormatsFactory {

    static buildFormattersDictionary(
    ): { [key: number]: FieldFormatter<any> } {
        return {
            [FieldTypes.String]: new StringFormatter(),
            [FieldTypes.Boolean]: new BooleanFormatter()
        };
    }
}

@Component({
    selector: 'strategy',
    templateUrl: './real-world.component.html'
})
export class StrategyRealWorldComponent implements OnInit {
    fieldsFormatted: Array<string>;

    constructor(private fieldFormatter: FieldFormatterService) { }

    ngOnInit() {
        const fields: Array<Field<any>> = [
            { type: FieldTypes.Boolean, value: true },
            { type: FieldTypes.String, value: 'a field value' }
        ]
        this.fieldsFormatted = fields.map(f => this.fieldFormatter.format(f));
    }
}
\`\`\`

Como pod√©is ver en el ejemplo, casi siempre que aplicamos el patr√≥n *Strategy*, se elige la estrategia o implementaci√≥n a ejecutar en base a alg√∫n tipo de condici√≥n o par√°metro. En nuestro caso, como hemos dicho, fue el tipo de dato.

### Observer

Este patr√≥n seguramente es de los m√°s utilizados despu√©s del *Singleton*. La motivaci√≥n principal es **desacoplar la comunicaci√≥n entre distintos objetos**. Desde el punto de vista te√≥rico, empezamos definiendo los *Observers*:

\`\`\`ts
interface Observer {
    update(): void;
}

class ConcreteObserver implements Observer {
    update(): void { }
}
\`\`\`

Por otro lado, tendremos los objetos *Subjects*, que ser√°n los encargados de tener una referencia directa a los *observers* para poder comunicarse con ellos:

\`\`\`ts
interface Subject {
    registerObserver(observer: Observer);
    unregisterObserver(observer: Observer);
    notifyObservers();
}

class ConcreteSubject implements Subject {
    observers: Array<Observer>;

    registerObserver(observer: Observer) {
        this.observers.push(observer);
    }

    unregisterObserver(observer: Observer) {
        // Find and remove observer from the collection.
    }

    notifyObservers() {
        this.observers.forEach(o => o.update());
    }
}
\`\`\`

Desde el cliente o cualquier punto del sistema, podremos crear los *observers* y suscribirlos a cada *subject* espec√≠fico, de forma que podr√°n comunicarse con ellos y notificarles en cualquier momento mediante el m√©todo *notifyObservers*:

\`\`\`ts
export class Client {
    run() {
        const subject = new ConcreteSubject();
        const observer1 = new ConcreteObserver();
        const observer2 = new ConcreteObserver();

        subject.registerObserver(observer1);
        subject.registerObserver(observer2);

        subject.notifyObservers();
    }
}
\`\`\`

Como pod√©is observar, con este patr√≥n logramos **desacoplar totalmente** a los *observers*, ya que no conocen ni tienen ninguna referencia a ning√∫n *subject*. Adem√°s, no estamos atados a un orden concreto de notificaci√≥n entre observers.

En nuestro caso particular, ten√≠amos un estado centralizado implementado con *Redux* y deb√≠amos notificar a cada uno de los componentes visuales cuando una propiedad del estado se ve√≠a modificada. Esta notificaci√≥n la implementamos mediante el patr√≥n *observer*, donde cada *observer* era cada uno de los componentes a los que se deb√≠a notificar:

\`\`\`ts
@Component({
    selector: 'observer1',
    templateUrl: './observer1.component.html'
})
export class Observer1Component {
    public productNames: Array<string> = [];
    private model: Order;

    @Input() set order(orderFromState: Order) {
        this.model = orderFromState;
        this.buildFormattedOrderList();
    }
    get order() { return this.model; }

    constructor(private connector: ConnectorService) {
        this.connector.registerObserver(this);
    }

    private buildFormattedOrderList(): void {
        this.productNames = this.model.productList.map(p => p.name);
    }

    addNewProduct() {
        this.connector.updateState(
            addNewProductStateAction(this.model)
        );
    }
}
\`\`\`

El *subject* o encargado de llevar a cabo dicha notificaci√≥n, era un servicio de *Angular* al que bautizamos como *connector*:

\`\`\`ts
@Injectable()
export class ConnectorService {
    private currentState: Order;
    private observers = [];

    constructor(private store: Store) {
        this.currentState = this.store.state;
    }

    registerObserver(component) {
        this.observers.push(component);
        this.notifyObserver(component);
    }

    updateState(newState: Order) {
        if (this.isStateChanged(newState)) {
            this.currentState = newState;
            this.notifyObservers();
        }
    }

    private notifyObservers() {
        this.observers.forEach(o => this.notifyObserver(o));
    }

    private notifyObserver(observer) {
        observer.order = this.currentState;
    }

    private isStateChanged(newState: Order): boolean {
        return this.currentState.id !== newState.id;
    }
}
\`\`\`

Este servicio llevaba el registro de cada componente a notificar (que se autoregistraban en sus correspondientes constructores llamando al m√©todo *registerObserver*) y se suscrib√≠a √©l mismo a la *store* de *Redux* para saber cuando se modificaba cualquier propiedad y poder notificar a cada uno de los componentes.

## Patrones de UI

### Page-Object

Este √∫ltimo patr√≥n que revisaremos en el art√≠culo de hoy, no encajaba en ninguna de las categor√≠as comunes, ya que su motivaci√≥n es muy espec√≠fica y est√° muy ligada a la parte de UI. La motivaci√≥n es crear una abstracci√≥n de una vista en forma de objeto, de forma que **se desacoplan los consumidores de la propia vista**.

En nuestro caso, estos consumidores eran nuestros tests de componentes UI de *Angular*. Lo que hicimos es, en vez de acceder directamente al c√≥digo HTML de cada componente desde el c√≥digo de los tests, creamos un *PageObject* del componente:

\`\`\`ts
export class ProductListPageObject {
    getProductId(): number {
        const productId = this.getHTMLElementByClass('id')[0].textContent;
        return parseInt(productId);
    }

    getProductName(): string {
        const productName = this.getHTMLElementByClass('name')[0].textContent;
        return productName;
    }

    openDetail(): void {
        const viewDetailButton = this.getHTMLElementByClass('view-detail')[0];
        viewDetailButton.click();
    }

    private getHTMLElementByClass(className: string): Array<HTMLElement> {
        return [new HTMLElement()];
    }
}
\`\`\`

Que expone m√©todos *get* para obtener valores de la vista y alg√∫n m√©todo como *openDetail* para hacer *click* e interactuar sobre elementos de √©sta:

\`\`\`html
<ul>
    <li class="id">1</li>
    <li class="name">A product</li>
    <li><a href="#" class="view-detail">View Detail</a></li>
</ul>
<ul>
    <li class="id">2</li>
    <li class="name">Another product</li>
    <li><a href="#" class="view-detail">View Detail</a></li>
</ul>
\`\`\`

As√≠, tendremos el c√≥digo de nuestros tests totalmente desacoplado de la vista (adem√°s de ser mucho **m√°s legible y mantenible**). En el caso en que cambie el HTML del componente (que suele ser muy habitual), s√≥lo habr√° que adaptar la clase *PageObject*, pero el c√≥digo de nuestros tests quedar√° intacto, lo que conllevar√° que el mantenimiento de √©stos sea mucho m√°s f√°cil y no se acabar√°n abandonando.

\`\`\`ts
export class TestClient {
    private pageObject = new ProductListPageObject();**

    is_a_valid_product_id(): boolean {
        const productId** = this.pageObject.getProductId();
        return productId > 0;
    }

    is_a_valid_product_name(): boolean {
        const productName = this.pageObject.getProductName();
        return productName.length < 255;
    }

    is_a_product_detail_visible(): boolean {
        this.pageObject.openDetail();
        // ...
        return false;
    }
}
\`\`\`

# Y a√∫n hay mas...

Estos han sido s√≥lo algunos de los patrones que usamos en nuestra aplicaci√≥n, si quer√©is conocer todos los que llegamos a aplicar, pod√©is consultar la [charla](https://www.youtube.com/watch?v=ZlhKj32KlfI) que impartimos en la JSDay Canarias 2019 y su [repositorio de c√≥digo](https://github.com/cbastos/jsdaycan2019-typescript-patterns) correspondiente con ejemplos.

Adem√°s, no puedo dejar de recomendar el libro que m√°s me ha servido de ayuda y que mejor explica la mayor√≠a de patrones (para mi gusto): **Head First Design Patterns** de *Eric Freeman*, *Elisabeth Freeman*, *Kathy Sierra* y *Bert Bates*.

Espero que os haya resultado √∫til el art√≠culo, y cualquier duda/pregunta/sugerencia pod√©is encontrarme en twitter como [@ivanirega](https://twitter.com/ivanirega). Y recordad: *"Donde hay patr√≥n, no manda marinero"* üòâ",
    "slug": "patrones-diseno-comportamiento-ui",
    "tags": [
      "typescript",
    ],
    "title": "Patrones de dise√±o con TypeScript en el mundo real: comportamiento y UI",
    "userPicture": "",
    "username": "Iv√°n Reinoso",
  },
  {
    "category": "vuejs",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/vuejs_category.png",
    "date": "",
    "description": "Vuex es librer√≠a oficial de Vue para la administraci√≥n del estado de la aplicaci√≥n, veremos como tiparla con TypeScript.",
    "id": "aumenta-productividad-vuex-typescript",
    "markdownBody": "Cuando trabajamos con librer√≠as de terceros a veces tenemos que lidiar con un tipado d√©bil. Es el caso de la librer√≠a oficial de Vue para la administraci√≥n del estado de la aplicaci√≥n: **Vuex**

A pesar de ser una librer√≠a muy utilizada en multitud de proyectos, la definici√≥n de su API respecto a los tipos deja mucho que desear: poco soporte de tipos gen√©ricos y muchos tipos \`any\` por todo el c√≥digo.

Esto conlleva a que cuando quieres utilizarla en tu desarrollo no tengas soporte del intellisense (autocompletado, definici√≥n de propiedades y m√©todos, etc...) ni seguridad de tipos. En resumen, es como si tuvi√©ramos desactivado el soporte de TypeScript en ese c√≥digo y fu√©ramos a ciegas.

![Sample getters with errors](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/aumenta-productividad-vuex-typescript/getters-without-types.gif)

Pues bien, la buena noticia es que podemos "vitaminar" el tipado de Vuex mediante una serie de interfaces gen√©ricas y el uso del estilo de objeto que soporta las mutaciones y acciones de Vuex. En este art√≠culo aportar√© una soluci√≥n sencilla que nos permitir√° tener un punto de partida sobre c√≥mo ayudarnos con TypeScript para completar las carencias de Vuex.

## Conociendo el entorno

Como ejemplo de este art√≠culo, trabajaremos sobre una aplicaci√≥n t√≠pica de carrito de la compra.

Tendremos que manejar mediante Vuex las siguientes caracter√≠sticas:

- Estado ra√≠z de la aplicaci√≥n: \`loading\` y \`snackbar\`.
- Dos m√≥dulos sin espacio de nombres: \`products\` y \`cart\` (aunque s√≥lo veremos el c√≥digo del primero).

Una de las primeras tareas que hacemos cuando desarrollamos con una librer√≠a de terceros que expone tipos de TypeScript es, precisamente, ver los tipos que expone para ser usada. As√≠ que vamos a vamos a ver los tipos principales que expone Vuex:

> Se ha omitido c√≥digo de la definici√≥n para evitar ruido (¬∑¬∑¬∑)

_vuex/types/index.d.ts_

\`\`\`ts

export declare class Store<S> {
  constructor(options: StoreOptions<S>);

  readonly state: S;
  readonly getters: any;

  dispatch: Dispatch;
  commit: Commit;

  ¬∑¬∑¬∑
}
\`\`\`

Como vemos, tenemos la declaraci√≥n de una clase \`Store\` que admite un tipo gen√©rico llamado \`S\`.

> Los tipos gen√©ricos en TypeScript nos permiten definir estructuras reutilizables aplicando un determinado tipo de dato en varios puntos de nuestro c√≥digo.

En este caso, el gen√©rico \`S\` que le pasamos a \`Store\` ser√° el que definir√° la propiedad de s√≥lo lectura \`state\` y que ser√° el estado de nuestra aplicaci√≥n. Por ahora, no tenemos que hacer nada especial, tan s√≥lo definir una interface que contendr√° nuestro estado ra√≠z.

_./src/store/root.models.ts_

\`\`\`ts

export interface RootState {
  loading: boolean;
  snackbar: Snackbar;
}

interface Snackbar {
  message: string;
  isActive: boolean;
  type?: "success" | "info" | "error";
}

export type SetSnackbar = Pick<Snackbar, "message" | "type">;
\`\`\`

Para definir el tipo \`Snackbar\` hemos utilizado un tipo literal de string. De esta forma le decimos que la propiedad \`type\` s√≥lo podr√° contener como valores posibles "success", "info" o "error".

Y para el tipo a exportar \`SetSnackbar\` utilizamos el tipo de utilidad de TypeScript \`Pick<T,K>\`. Este tipo gen√©rico crea un nuevo tipo con las propiedades de \`T\` referidas en \`K\`. En nuestro caso, crearemos un tipo nuevo con las propiedades \`message\` y \`type\` de la interface \`Snackbar\`. Pod√≠amos haber usado \`Omit\` pero lo veremos en otro caso m√°s adelante.

Ahora s√≥lo nos falta crear un objeto que utilizaremos para setear el estado inicial de nuestro estado ra√≠z.

_./src/store/root.models.ts_

\`\`\`ts
¬∑¬∑¬∑

export const initialRootState: RootState = {
  loading: false,
  snackbar: {
    message: "",
    isActive: false,
    type: undefined,
  },
};
\`\`\`

Vamos a alimentar nuestro store con este estado ra√≠z y utilizaremos la interface creada \`RootState\` para tipar el objeto _store_:

_./src/store/index.ts_

\`\`\`ts
import { RootState, initialRootState } from "./root.models";
¬∑¬∑¬∑

export const store = new Vuex.Store<RootState>({
  state: initialRootState,
});
\`\`\`

## Mutations

Lo primero que haremos ser√° analizar los **tipos que expone Vuex** para las mutaciones.

_vuex/types/index.d.ts_

\`\`\`ts
¬∑¬∑¬∑

export interface MutationTree<S> {
  [key: string]: Mutation<S>;
}

export type Mutation<S> = (state: S, payload?: any) => any;
\`\`\`

Para empezar, \`MutationTree\` es un tipo gen√©rico que permite pasarle la interface del estado (\`RootState\` en nuestro caso).

Cada propiedad en un objeto creado conmgom el tipo \`MutationTree\` tendr√° como valor una funci√≥n de tipo \`Mutation<S>\`. Esta √∫ltima interface viene a definirse como una funci√≥n que admite dos par√°metros de entrada: \`state\` con el tipado del estado ra√≠z (\`RootState\`) y un \`payload\` con un tipo \`any\`.

**¬øQu√© consecuencias nos trae manejar valores definidos con el tipo \`any\`?**

Pues b√°sicamente le estamos diciendo a TypeScript que queremos deshabilitar la verificaci√≥n de tipos y esto no es nada √≥ptimo para nosotros.

Normalmente el tipo \`any\` se utiliza cuando no conocemos el tipo de variables con el que vamos a trabajar, pero en nuestro caso, s√≠ que sabemos qu√© objetos vamos a definir como mutaciones, acciones, etc... as√≠ que no tiene mucho sentido mantener este tipado. En breve veremos c√≥mo podemos mejorarlo.

Primero, vamos a hacer una introducci√≥n al **estilo de objeto** que permite Vuex para acometer las mutaciones y despachar las acciones.

### Estilo de objeto

\`\`\`ts

store.commit("increment", { amount: 10 });

/** Son equivalentes */

store.commit({
  type: "increment",
  payload: { amount: 10 },
});
\`\`\`

Esta caracter√≠stica permite pasar un objeto que contenga una propiedad \`type\` con el nombre de la mutaci√≥n o acci√≥n y una propiedad \`payload\` con los par√°metros que queremos hacer llegar al m√©todo \`commit\` o \`dispatch\` del **store**, respectivamente.

Aprovechando esta caracter√≠stica podemos crear una funci√≥n que admita un \`payload\` y devolver un objeto con esa definici√≥n (\`type\` y \`payload\`) para que el _store_ lo entienda.

\`\`\`ts

const increment = (payload: { amount: 10 }) => ({ type: "increment", payload: { amount: 10 } });

store.commit(increment({ amount: 10 }));
\`\`\`

Sabiendo esto, mi propuesta se basa en utilizar esta caracter√≠stica para crear un objeto que contenga estas funciones y utilizarlas donde sea necesario. De este modo tendremos la inferencia de tipos que no nos provee Vuex en nuestro _store_ y componentes.



![Object Style Mutation](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/aumenta-productividad-vuex-typescript/object-style-mutation.gif)

Vamos a comenzar creando nuestros primeros tipos llamados _helpers_, y para ello, definiremos un fichero _root.helpers.ts_ en el ra√≠z de nuestro _store_:

### DefineMutationTree

Este tipo gen√©rico vendr√° a sustituir a \`MutationTree\` de Vuex. Lo que admite este tipo gen√©rico es la definici√≥n de la interface de las mutaciones \`Mutation\` y del estado \`State\`.

Por cada propiedad definida en la interface que le pasaremos como mutaciones (gen√©rico \`Mutation\`) existir√° una propiedad en este objeto cuyo valor ser√° una funci√≥n que admitir√° el estado tipado y un \`handler\` (que har√° referencia al objeto \`type\` y \`payload\` anterior). Este \`handler\` recibir√° un objeto con una propiedad \`payload\` cuyo tipo ser√° el que hemos definido previamente en nuestra interface \`Mutation\`.

_./src/store/root.helpers.ts_

\`\`\`ts

export type DefineMutationTree<Mutation, State> = {
  [Prop in keyof Mutation]: (state: State, handler: { payload: Mutation[Prop] }) => void;
};
\`\`\`

Quedar√° m√°s claro cuando lo usemos. Primero, definimos la interface de nuestras mutaciones:

_./src/store/root.mutations.ts_

\`\`\`ts

import { RootState } from "./root.models";

export interface RootMutations {
  setLoading: RootState["loading"];
  setSnackbar: RootState["snackbar"];
}
\`\`\`

F√≠jate que el tipo de dato que asignamos a cada propiedad ser√° el tipo del \`payload\` que queremos pasar a las mutaciones.

Ahora, cuando vayamos a definir el objeto **mutations** con nuestra interface \`DefineMutationTree\`, al pasarle \`RootMutations\` y \`RootState\` nuestro IDE nos ir√° indicando los valores que debemos rellenar sin posibilidad de equivocarnos, lo cual se traduce en menos errores, m√°s rapidez y m√°s control de tu c√≥digo.

![Mutations with types works](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/aumenta-productividad-vuex-typescript/add-mutations.gif)

_./src/store/root.mutations.ts_

\`\`\`ts
¬∑¬∑¬∑
const mutations: DefineMutationTree<RootMutations, RootState> = {
  setLoading(state, { payload }) {
    state.loading = payload;
  },
  setSnackbar(state, { payload }) {
    state.snackbar = {
      message: payload.message,
      type: payload.type || "success",
      isActive: payload.isActive,
    };
  },
};

export default mutations;
\`\`\`

### DefineTypes

Al principio coment√© que usar√≠amos el **estilo de objeto de Vuex** para usarlo de forma segura, ¬øverdad? Pues primero tenemos que definir la interface que deber√°n cumplir estos objetos.

En el fichero de _root.helpers.ts_ crearemos el siguiente tipo gen√©rico llamado \`DefineTypes\`.

_./src/store/root.helpers.ts_

\`\`\`ts
¬∑¬∑¬∑
export type DefineTypes<Methods> = {
  [Prop in keyof Methods]: Methods[Prop] extends undefined
    ? () => { type: keyof Methods }
    : (payload: Methods[Prop]) => { type: keyof Methods; payload: Methods[Prop] };
};
\`\`\`

Estamos definiendo un tipo gen√©rico que admite una interface llamada \`Methods\` (ya que nos servir√° tanto para las mutaciones como para las acciones) la cual tendr√° una propiedad existente en \`Methods\` y a trav√©s del tipo condicional \`T extends U ? X : Y\`, le estamos diciendo que si el tipo de dato es \`undefined\` asigne la definici√≥n a la derecha del interrogante \`?\` y en caso contrario, la definici√≥n a la derecha de los dos puntos \`:\`. S√≠, es un operador ternario de tipos y lo tenemos disponible en TypeScript desde la versi√≥n 2.8.

La primera funci√≥n no indica par√°metros de entrada y devolver√° un objeto con una propiedad \`type\` con el nombre del m√©todo. La segunda funci√≥n, admitir√° un par√°metro de entrada \`payload\` con el tipo de dato indicado en la interface y devolver√° un objeto con una propiedad \`type\` igual que la anterior y el \`payload\` recibido anteriormente.

Vamos a usarlo.

_./src/store/root.mutations.ts_

\`\`\`ts
¬∑¬∑¬∑
export const rootMutationsTypes: DefineTypes<RootMutations> = {
  setLoading: payload => ({ type: "setLoading", payload }),
  setSnackbar: payload => ({ type: "setSnackbar", payload }),
};
\`\`\`

![Root mutations types](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/aumenta-productividad-vuex-typescript/root-mutations-types.gif)

A la hora de utilizarlo en conjunto con el resto de propiedades en el _store_ haremos lo siguiente:

_./src/store/index.ts_

\`\`\`ts
import mutations, { rootMutationsTypes, RootMutations } from "./root.mutations";
¬∑¬∑¬∑
export const store = new Vuex.Store<RootState>({
  strict: true,
  state: initialRootState,
  mutations, // <- Agregamos el objeto con las mutaciones
});

// Exportamos nuestro objeto ayudante para usarlo en los componentes (contiene nuestras funciones con el estilo de objeto)
export const rootTypes = {
  mutations: rootMutationsTypes,
};
\`\`\`

Y para usarlo importaremos este objeto \`rootTypes\` y lo pasaremos como par√°metro de entrada al m√©todo \`commit\` del **store** (o \`this.$store\` si estamos en los componentes, por ejemplo):

\`\`\`ts

const actions = {
  getAllProducts: ({ commit }) => {
    commit(rootMutationsTypes.setLoading(true));
  },
};
\`\`\`

Veamos c√≥mo se comporta:

![Mutations types works](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/aumenta-productividad-vuex-typescript/use-mutations-store-types.gif)

## Actions

Para las acciones haremos exactamente lo mismo que con las mutaciones.

Primero, vamos a ver qu√© tipos nos ofrece Vuex al respecto.

_vuex/types/index.d.ts_

\`\`\`ts
¬∑¬∑¬∑
export interface ActionTree<S, R> {
  [key: string]: Acocltion<S, R>;
}

export type Action<S, R> = ActionHandler<S, R> | ActionObject<S, R>;

export type ActionHandler<S, R> = (this: Store<R>, injectee: ActionContext<S, R>, payload?: any) => any;
export interface ActionObject<S, R> {
  root?: boolean;
  handler: ActionHandler<S, R>;
}
\`\`\`

Al igual que con \`MutationTree\` tenemos una tipado muy d√©bil con \`any\`, tanto en el \`payload\` como en el retorno de las acciones. As√≠ que vamos a ver c√≥mo solucionarlo.

Esta vez comenzaremos definiendo la interface que deber√° cumplir nuestras acciones. Recuerda, al igual que con las mutaciones, vamos a definir el nombre de nuestra acci√≥n como clave de la propiedad y como tipo de dato el par√°metro de entrada de la acci√≥n.

_./src/store/root.actions.ts_

\`\`\`ts

import { RootState, SetSnackbar } from "./root.models";

export interface RootActions {
  showSnackbar: SetSnackbar;
}
\`\`\`

### DefineActionTree

Ahora crearemos un nuevo tipo llamado \`DefineActionTree\` en nuestro fichero de _helpers_.

_./src/store/root.helpers.ts_

\`\`\`ts

import { Store, ActionContext } from "vuex";
¬∑¬∑¬∑
export type DefineActionTree<Action, State, RootState> = {
  [Prop in keyof Action]: Action[Prop] extends undefined
    ? (
        this: Store<RootState>,
        ctx: ActionContext<State, RootState>,
      ) => void | Promise<any>
    : (
        this: Store<RootState>,
        ctx: ActionContext<State, RootState>,
        handler: { payload: Action[Prop] },
      ) => void | Promise<any>;
};
\`\`\`

Muy parecido a la definici√≥n de \`DefineMutationTree\`, la diferencia es que las acciones reciben el contexto del **store** y para ello hacemos uso de \`ActionContext\` de Vuex.

Vamos a usarlo todo en conjunto en nuestro fichero de acciones:

_./src/store/root.actions.ts_

\`\`\`ts

import { RootState, SetSnackbar } from "./root.models";
import { DefineActionTree, DefineTypes } from "./store.helpers";
import { rootMutationsTypes } from "./root.mutations";

export interface RootActions {
  showSnackbar: SetSnackbar;
}

const actions: DefineActionTree<RootActions, RootState> = {
  showSnackbar({ commit }, { payload }) {
    commit(rootMutationsTypes.setSnackbar({ ...payload, isActive: true }));

    setTimeout(() => {
      commit(rootMutationsTypes.setSnackbar({ ...payload, isActive: false }));
    }, 3000);
  },
};

export const rootActionsTypes: DefineTypes<RootActions> = {
  showSnackbar: payload => ({ type: "showSnackbar", payload }),
};

export default actions;
\`\`\`

![Define Actions Tree](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/aumenta-productividad-vuex-typescript/define-actions-tree.gif)

F√≠jate que estamos importando el objeto \`rootMutationsTypes\` para hacer uso de las mutaciones previamente definidas. Todo este c√≥digo te aporta seguridad de tipos para trabajar m√°s c√≥modamente, y lo mejor es que cuando lo usamos en nuestros componentes tambi√©n tenemos seguridad de tipos, cosa que antes no ten√≠amos.

Vamos a alimentar nuestro **store** con los objetos creados:

_./src/store/index.ts_

\`\`\`ts
¬∑¬∑¬∑
import actions, { rootActionsTypes, RootActions } from "./root.actions";

export const store = new Vuex.Store<RootState>({
  strict: true,
  state: initialRootState,
  mutations,
  actions,
});

export const rootTypes = {
  actions: rootActionsTypes,
  mutations: rootMutationsTypes,
};
\`\`\`

![Define Actions works](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/aumenta-productividad-vuex-typescript/define-types-actions-in-action.gif)

## Getters

Si recordamos c√≥mo estaba definida la propiedad de s√≥lo lectura \`getters\` en la clase \`Store\` de Vuex...

_./vuex/types/index.d.ts_

\`\`\`ts

export declare class Store<S> {
  constructor(options: StoreOptions<S>);

  readonly state: S;
  readonly getters: any;

  dispatch: Dispatch;
  commit: Commit;

  ¬∑¬∑¬∑
}
\`\`\`

Vemos que se nos presenta un gran problema respecto a lo que el tipado se refiere.

La propiedad \`getters\` est√° definida con el tipo \`any\` de TypeScript, lo que significa que \`getters\` podr√° ser cualquier cosa y por tanto, nuestro IDE no podr√° trabajar adecuadamente.

Cuando vayamos a utilizar esta propiedad en nuestros componentes estaremos totalmente a ciegas con los problemas que conlleva. Pero es que adem√°s en el propio uso en el store tendremos los mismos problemas... observa la definici√≥n:

_./vuex/types/index.d.ts_

\`\`\`ts

export interface GetterTree<S, R> {
  [key: string]: Getter<S, R>;
}

export type Getter<S, R> = (state: S, getters: any, rootState: R, rootGetters: any) => any;
\`\`\`

Seguimos teniendo tipos \`any\` por todos lados...

Vamos a ver c√≥mo podr√≠amos implementar una soluci√≥n r√°pida para subsanarlo. Trabajaremos en nuestro fichero _store.helpers.ts_

_./src/store/store.helpers.ts_

\`\`\`ts
¬∑¬∑¬∑

export type DefineGetterTree<Getter, State, RootState = {}, RootGetter = {}> = {
  [K in keyof Getter]: (
    state: State,
    getters: Getter,
    rootState: RootState,
    rootGetters: RootGetter,
  ) => Getter[K];
};

export type GetterHelper<Getter> = { [Prop in keyof Getter]: Getter[Prop] };

export type StoreTS<State, Getters> = Omit<Store<State>, "getters"> & {
  readonly getters: GetterHelper<Getters>;
};

\`\`\`

Vamos por partes. Primero, \`DefineGetterTree\`.

### DefineGetterTree

\`\`\`ts

export type DefineGetterTree<Getter, State, RootState = {}, RootGetter = {}> = {
  [Prop in keyof Getter]: (
    state: State,
    getters: Getter,
    rootState: RootState,
    rootGetters: RootGetter
  ) => Getter[Prop];
};
\`\`\`

Hemos creado un tipo gen√©rico que admitir√° la definici√≥n de los getters \`Getter\`, el estado local \`State\`, el estado ra√≠z \`RootState\` (si estuvi√©ramos en un m√≥dulo) y los getters del ra√≠z \`RootGetter\` (si estuvi√©ramos tambi√©n en un m√≥dulo).

Antes de ver c√≥mo podemos usarlo, vamos a crear la definici√≥n de nuestros **Getters**:

_./src/store/root.getters.ts_

\`\`\`ts

import { RootState } from "./root.models";

export interface RootGetters {
  snackbar: RootState["snackbar"];
}

export default getters;
\`\`\`

En esta definici√≥n lo que hacemos es decir qu√© propiedades tendr√° nuestros **getters** (en este caso, una propiedad \`snackbar\`) y que la misma tendr√° un tipo \`RootState["snackbar"]\`. Estamos aprovechando la funcionalidad de TypeScript de acceder a los tipos de una interface mediante su √≠ndice.

Si recordamos el funcionamiento de Vuex, un \`getter\` no es m√°s que una funci√≥n que retorna el estado manipulado, es decir, como una \`computed property\`. Gracias a esta interface que hemos definido, _lo que estamos indicando es el retorno que tendr√° esa funci√≥n getter llamada snackbar_.

Ahora podemos ver el uso de nuestra interface gen√©rica \`DefineGetterTree\`.

Vamos a crear el objeto que expondremos como **getters** para nuestro _store_:

_./src/store/root.getters.ts_

\`\`\`ts

import { DefineGetterTree } from "./store.helpers";
import { RootState } from "./root.models";

export interface RootGetters {
  snackbar: RootState["snackbar"];
}

const getters: DefineGetterTree<RootGetters, RootState> = {
  snackbar: state => state.snackbar,
};

export default getters;
\`\`\`

F√≠jate que cuando creamos \`DefineGetterTree\`, dijimos que por cada propiedad en \`RootGetters\` (\`[Prop in keyof Getter]\`) crear√≠amos una propiedad en este nuevo objeto que tendr√≠a como valor una funci√≥n que recibir√≠a como par√°metros de entrada, entre otras cosas, el estado \`State\`; y que tendr√≠a como retorno de dicha funci√≥n el tipo que le dijimos en nuestra interface (\`Getter[Prop]\`):

\`\`\`ts

export type DefineGetterTree<Getter, State, RootState = {}, RootGetter = {}> = {
  [Prop in keyof Getter]: (
    state: State,
    getters: Getter,
    rootState: RootState,
    rootGetters: RootGetter
  ) => Getter[Prop];
};
\`\`\`

Bien, por ahora hemos definido c√≥mo ser√° nuestros **getters** pero no hemos dicho c√≥mo le decimos a Vuex que lo use.

Vamos a alimentar nuestro \`store\` con este objeto y veremos c√≥mo podemos salvar el \`any\` que vimos al principio.

## StoreTS

_./src/store/store.helpers.ts_

\`\`\`ts
¬∑¬∑¬∑

export type GetterHelper<Getter> = { [Prop in keyof Getter]: Getter[Prop] };

export type StoreTS<State, Getters> = Omit<Store<State>, "getters"> & {
  readonly getters: GetterHelper<Getters>;
};

\`\`\`

Aqu√≠ estamos usando algunos tipos avanzados de TypeScript para ayudarnos a conseguir nuestro objetivo. Vamos por partes:

Primero, \`StoreTS\` es una interface gen√©rica que admite la interface del estado \`State\` y la interface de los getters \`Getters\`. Esta interface gen√©rica hace una uni√≥n de tipos un poco especial:

- Por una parte, tenemos un tipo de utilidad \`Omit<T,K>\` que construye un tipo tomando todas las propiedades de \`T\` excepto \`K\`. En nuestro caso, todas las propiedades de la interface \`Store<State>\` excepto la propiedad \`getters\` (recuerda, \`Store\` viene de los tipos de Vuex y esta propiedad _getters_ estaba con tipo \`any\`, por eso no nos interesa).
- Por otra parte, y mediante la uni√≥n \`&\` le decimos que agregue una propiedad de s√≥lo lectura llamada \`getters\` y para la cual su tipo ser√° \`GetterHelper<Getters>\`.

As√≠ que el resultado ser√° una sobreescritura de tipos donde la instancia de nuestro _store_ ser√° el tipado que viene por defecto en Vuex excepto para los getters, que ahora tendr√°n inferencia de tipos gracias a esta definici√≥n de tipos.

¬øY c√≥mo lo usamos? Veamos:

_./src/store/index.ts_

\`\`\`ts
¬∑¬∑¬∑
import getters, { RootGetters } from "./root.getters";

Vue.use(Vuex);

export const store = new Vuex.Store<RootState>({
  strict: true,
  state: initialRootState,
  mutations,
  actions,
  getters, // <- alimentamos con nuestro objeto getters, por tanto this.$store.getters no tendr√° inferencia de tipos (funcionamiento normal)
});

¬∑¬∑¬∑
// Pero exportaremos este objeto que s√≠ tendr√° la inferencia de tipos para getters, p.ej: store.getters.snackbar
export default store as StoreTS<RootState, RootGetters & CartGetters>;
\`\`\`

De esta forma, cuando queramos usar los getters tipados en nuestros componentes tan s√≥lo deberemos importar este objeto cuyo tipos estar√°n ampliados.

_./src/store/index.ts_

\`\`\`ts
<script lang="ts">
import Vue from "vue";
import store from "../store";

export default Vue.extend({
  name: "Snackbar",
  computed: {
    snackbar() {
      return store.getters.snackbar;
    },
  },
});
</script>
\`\`\`

Y ahora con los nuevos tipos, vamos a verlo en funcionamiento:

![Typings getters](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/aumenta-productividad-vuex-typescript/typings-getters.gif)

> F√≠jate que ya no es necesario indicar el tipo de retorno de las computed property porque es capaz de inferir el tipo

## M√≥dulos

Por ahora hemos cubierto c√≥mo trabajar con la librer√≠a Vuex y sus tipos en el ra√≠z, pero normalmente usaremos la caracter√≠stica de m√≥dulos para escalar nuestro estado.

### Products State

Vamos a comenzar por definir el estado del m√≥dulo "Products" y el objeto que usaremos para inicializarlo:

_./src/store/modules/products/products.models.ts_

\`\`\`ts

export interface ProductsState {
  all: Product[];
}

export interface Product {
  id: number;
  title: string;
  price: number;
  inventory: number;
}

export const initialProductsState: ProductsState = {
  all: [],
};
\`\`\`

Adem√°s vamos a necesitar extender la interface del estado ra√≠z para darle cabida al estado de este m√≥dulo mediante la propiedad \`products\` que tendr√° el estado ra√≠z.

_./src/store/modules/products/products.models.ts_

\`\`\`ts
¬∑¬∑¬∑
export type ExtendedProductsState = { products?: ProductsState };
\`\`\`

Y ahora debemos utilizarlo en el estado ra√≠z para ampliarlo.

_./src/store/root.models.ts_

\`\`\`ts
¬∑¬∑¬∑
import { ExtendedProductsState } from "./modules/products";

/** Root State */
export interface RootState extends ExtendedProductsState {
  loading: boolean;
  snackbar: Snackbar;
}
¬∑¬∑¬∑
\`\`\`

### Products Mutations

Por simplicidad, vamos a mostrar el fichero completo de \`products.mutations.ts\`

_./src/store/modules/products/products.mutations.ts_

\`\`\`ts

import { DefineMutationTree, DefineTypes } from "../../store.helpers";
import { RootState } from "../../root.models";
import { ProductsState, Product } from "./products.models";

export interface ProductsMutations {
  setProducts: Product[];
  decrementProductInventory: Product["id"];
}

const mutations: DefineMutationTree<ProductsMutations, ProductsState> = {
  setProducts: (state, { payload }) => {
    state.all = payload;
  },

  decrementProductInventory: (state, { payload }) => {
    state.all.find(p => p.id === payload)!.inventory--;
  },
};

export const productsMutationsTypes: DefineTypes<ProductsMutations> = {
  setProducts: payload => ({ type: "setProducts", payload }),
  decrementProductInventory: payload => ({
    type: "decrementProductInventory",
    payload,
  }),
};

export default mutations;
\`\`\`

### Products Actions

Por simplicidad, vamos a mostrar el fichero completo de \`products.actions.ts\`

_./src/store/modules/products/products.actions.ts_

\`\`\`ts
¬∑¬∑¬∑
import { rootMutationsTypes } from "../../root.mutations";

export interface ProductsActions {
  getAllProducts: undefined;
}

const actions: DefineActionTree<ProductsActions, ProductsState> = {
  getAllProducts: ({ commit }) => {
    commit(rootMutationsTypes.setLoading(true));
    ¬∑¬∑¬∑
  },
};

export const productsActionsTypes: DefineTypes<ProductsActions> = {
  getAllProducts: () => ({ type: "getAllProducts" }),
};

export default actions;
\`\`\`

> F√≠jate c√≥mo importando los helpers del ra√≠z podemos hacer uso de las funciones tipadas

## Products Getters

Por simplicidad, vamos a mostrar el fichero completo de \`products.getters.ts\`

_./src/store/modules/products/products.getters.ts_

\`\`\`ts

import { DefineGetterTree } from "../../store.helpers";
import { RootState } from "../../root.models";
import { ProductsState, Product } from "./products.models";

export interface ProductsGetters {
  allProducts: Product[];
}

const getters: DefineGetterTree<ProductsGetters, ProductsState, RootState> = {
  allProducts: state => state.all,
};

export default getters;
\`\`\`

Una vez creado el fichero de mutaciones vamos a a√±adirlo a nuestro **store**.

\`\`\`ts
¬∑¬∑¬∑
import { products, productsTypes } from "./modules/products";

export const store = new Vuex.Store<RootState>({
  strict: true,
  state: initialRootState,
  mutations,
  actions,
  getters,
  modules: {  // Agregamos los m√≥dulos al store
    products,
  },
});

export const rootTypes: HelperTypes<RootMutations, RootActions> = {
  actions: rootActionsTypes,
  mutations: rootMutationsTypes,
};

/** Helper types Object */
export const storeTypes = {
  root: rootTypes,
  products: productsTypes,
};
\`\`\`

Yo por comodidad he creado un objeto que he llamado \`storeTypes\` donde voy agregando, bajo el nombre de los m√≥dulos o del ra√≠z, los objetos correspondientes con las acciones y mutaciones de todo el store.

As√≠ cuando vaya a utilizarlo s√≥lo debes indicar la ruta al m√©todo:

\`\`\`ts
<script lang="ts">
import Vue from "vue";
import store, { storeTypes } from "../store";
import { Product } from "../store/modules/products";

export default Vue.extend({
  name: "ProductList",
  computed: {
    products() {
      return store.state.products!.all;
    },
  },
  methods: {
    addToCart(product: Product) {
      store.dispatch(storeTypes.cart.actions!.addToCart(product));
    },
  },
});
</script>
\`\`\`

![Store with types](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/aumenta-productividad-vuex-typescript/store-with-types.gif)

Y hasta aqu√≠ el post sobre c√≥mo aumentar tu productividad usando Vuex con TypeScript. 

Este post nace de la [charla](https://youtu.be/FmHcLbVYqec) que impart√≠ en el JSDay Canarias 2019. El c√≥digo completo lo puedes encontrar en este [enlace](https://github.com/LissetteIbnz/jsdaycan2019-vuex-typescript).

Adem√°s, de esta charla surgi√≥ la idea de crear **un paquete de npm con los tipos m√°s completos ya disponibles para trabajar**, as√≠ que si te ha parecido interesante el tema y quieres usarlos, los tienes a tu disposici√≥n en [@lissette.ibnz/vuex-extended-types](https://www.npmjs.com/package/@lissette.ibnz/vuex-extended-types)

Ya sabes \`npm i -D @lissette.ibnz/vuex-extended-types\`

Espero que te haya resultado √∫til el art√≠culo, y cualquier duda/pregunta/sugerencia pod√©is encontrarme en twitter como @LissetteIbnz

Nos vemos üññüòÑ",
    "slug": "aumenta-productividad-vuex-typescript",
    "tags": [
      "vuejs",
    ],
    "title": "Aumenta tu productividad con Vuex gracias a TypeScript",
    "userPicture": "",
    "username": "ùïäùïíùï£ùïí ùïÉùïöùï§ùï§ùïñùï•ùï•ùïñ üçã",
  },
  {
    "category": "react",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/ReactJS_category.png",
    "date": "",
    "description": "¬øTesting en el FrontEnd? En este post veremos todo lo necesario para introducirse en el mundo del testing en frontend.",
    "id": "testing-frontend",
    "markdownBody": "Hace calor, mucho calor, y nadie quiere perder mucho tiempo haciendo tests, leyendo sobre tests y sobre todo escribiendo sobre tests as√≠ que voy a intentar condensar en un peque√±o art√≠culo todo lo necesario para introducirse en el mundo del testing en frontend.

Voy a saltarme la parte aburrida con un peque√±o resumen:

**¬øQu√© es un test?**

Un test autom√°tico es un programa que permite verificar r√°pidamente que otro programa funciona de la forma esperada.

**¬øQu√© ventajas tienen los tests?**

Principalmente los tests se utilizan para detectar bugs antes de que los detecten los usuarios del software, contribuyen a aumentar la calidad del c√≥digo porque facilita a los programadores realizar refactorizaciones m√°s frecuentemente, aceleran la velocidad de desarrollo, sirven como documentaci√≥n y ayudan a que la arquitectura del software sea m√°s limpia.

**Probablemente ya hagas tests**

Siempre que doy la turra sobre testing a alguien intento hacerle ver que sin darse cuenta est√° haciendo <u>tests manuales</u> mientras programa. Probablemente te habr√°s encontrado alguna vez saltando entre el editor de c√≥digo y la applicaci√≥n en desarrollo siguiendo una secuencia como esta:

Escribir una linea de c√≥digo para mostrar un popup, abrir el navegador para ver que se muestra un popup, no se muestra el popup :thinking: abrir el editor, borrar todo y escribir \`console.log('hola')\` volver al navegador, recargar con la consola abierta, no se muestra nada... el script no se estaba importando... repetir hasta completar la tarea.

El proceso en el que abres el navegador y pruebas a mano algo justo despu√©s de escribir c√≥digo relacionado es un TEST. La clave de todo esto es entender que este proceso <u>se puede</u>, y se debe, <u>automatizar</u>.

**¬øQu√© forma tiene un test?**

Cuando escribimos un test nos interesa saber c√≥mo se comporta el sistema ante una situaci√≥n determinada para determinar si este comportamiento es el esperado. Generalmente se habla de 3 fases claramente diferenciadas:

- Una fase inicial en la que establecemos un entorno conocido para ver c√≥mo se comporta el sistema.
- Una fase en la que ejecutamos el c√≥digo que queremos probar.
- Una fase final en la que comprobamos que el comportamiento del sistema es correcto.

Adem√°s, es importante que el test tenga una descripci√≥n que indique precisamente:

- Qu√© parte del sistema se est√° probando.
- En qu√© condiciones se est√° ejecutando ese c√≥digo.
- Cu√°l es el resultado esperado.

**Un test debe tener una descripci√≥n significativa!**

Para ayudarnos a escribir tests existen librerias c√≥mo por ejemplo [Jest](https://jestjs.io/) sobre las que podr√≠amos dedicar todo el art√≠culo pero en nuestro caso simplemente vamos a ver un ejemplo de c√≥mo escribir un test b√°sico de la funci√≥n [isArray](https://developer.mozilla.org/es/docs/Web/JavaScript/Referencia/Objetos_globales/Array/isArray) del objeto Array.

Lo primero es escribir las descripciones de los tests de forma que se entienda claramente lo que queremos probar:

\`\`\`js
describe('Array.isArray', () => {
  it('should return true when the parameter is an array');
  it('should return false when the parameter is not an array');
});
\`\`\`

Esto es muy importante! Mucha gente no le da importancia a escribir buenas descripciones y te encuentras cosas como estas:

\`\`\`js
describe('isArr', () => {
  it('works ok with object')
  it('pass with array')
});
\`\`\`

Recuerda, la descripci√≥n del test debe responder siempre a las siguientes cuestiones: ¬øQu√© parte del sistema estamos probando? ¬øBajo que condiciones se est√° ejecutando el c√≥digo? ¬øCu√°l es el resultado esperado?

> Existe una metodolg√≠a para escribir descripciones llamada SWA por sus siglas Should When And que facilita mucho este proceso.

**Implementaci√≥n**

Una vez tenemos la descripcion escrita, pasamos a implementar el test, siguiendo las tres fases comentadas previamente:

\`\`\`js
describe('Array.isArray', () => {
  it('should return false when the parameter is not an array', () => {
    const parameter = 'dummy_string'; // Arrange
    const actual = Array.isArray(parameter); // Act
    expect(actual).toBe(false); // Assert
  });
  it('should return true when the parameter is an array', () => {
    const parameter = ['dummy', 'array']; // Arrange
    const actual = Array.isArray(parameter);  // Act
    expect(actual).toBe(true);  // Assert
  });
});
\`\`\`

**De donde venimos**

Se puede ver que resulta relativamente sencillo probar l√≥gica de negocio escribiendo tests con Jest pero ¬øC√≥mo se aplica esto al mundo del frontend?

Tradicionalmente se recomendaba tener la l√≥gica de negocio escrita en archivos llamados controladores y probados mediante test de unidad y por otro lado tener componentes de "vista" encargados de pintar el html de nuestra aplicaci√≥n.

El problema es que los tests unitarios s√≥lamente probaban una parte de la aplicaci√≥n (los controladores) y aunque la l√≥gica est√© bien, esto no garantiza que la aplicaci√≥n funcione correctamente y la √∫nica opci√≥n que quedaba para probar la aplicaci√≥n era recurrir a los llamados tests End to End (de principio a fin) con herramientas como [Protractor](https://www.protractortest.org/#/) o [Selenium](https://www.selenium.dev/).

Estos tests lanzaban un navegador automatizado y realizaban tareas similares a las de un usuario o un tester: *Navegar a cierta URL, Comprobar que X boton es visible y est√° activo, Escribir usuario y contrase√±a, Hacer click en el bot√≥n "login" etc...*

Por desgracia estos tests eran terriblemente engorrosos, el navegador se quedaba colgado, hab√≠a que recurrir a timeouts, necesitas tener un servidor de desarrollo corriendo...una serie de penurias que los hac√≠an inviables.

**Hacia donde vamos.**

Hace relativamente poco, el proyecto [JSDOM](https://github.com/jsdom/jsdom) se volvi√≥ maduro y estable, JSDOM es una implementaci√≥n para NodeJS de las APIS del DOM, es decir, nos permite tener una especie de navegador web virtual en Node.

Esto entre otras cosas, permitir√≠a montar un componente de Angular/React/Vue, rellenar inputs, o hacer click en sus elementos de forma totalmente sincrona y estable.

Esto hizo que Kent C Dodds escribiese una librer√≠a llamada [Testing Library](https://testing-library.com/docs/guiding-principles) cuyo principio fundamental se basa en **escribir tests que imiten el comportamiento del usuario/tester, en lugar de centrarse en detalles de implementaci√≥n**.

**Un ejemplo sencillo**

Imaginemos una aplicaci√≥n para comprar tickets de un evento cuya interfaz ser√≠a m√°s o menos as√≠:

![](https://user-images.githubusercontent.com/2657897/91171743-4babd480-e6db-11ea-939d-ed299e763047.png)

y se espera que al hacer click en el checkbox *VIP* el precio cambie a 0‚Ç¨. Al final la l√≥gica de negocio es muy sencilla: *Un usuario VIP tiene derecho a entradas gratis y un usuario normal tiene que pagar 20‚Ç¨*

Tradicionalmente, escribir√≠amos por un lado la [l√≥gica de negocio](https://github.com/IagoLast/frontend-testing-examples/blob/master/src/tickets.service.js) y [su test](https://github.com/IagoLast/frontend-testing-examples/blob/master/src/tickets.service.spec.js) y por otro [un componente de vista](https://github.com/IagoLast/frontend-testing-examples/blob/master/src/AppHooks.js) que utilize esta l√≥gica de negocio pero ¬øC√≥mo probar√≠as esto a mano? ¬øC√≥mo probar√≠as esto si no supieses nada de tests autom√°ticos?

Probablemente abrir√≠as la aplicaci√≥n, ver√≠as que el precio de la entrada son 20‚Ç¨ por defecto, har√≠as click en el checkbox y comprobar√≠as que el precio ha cambiado a 0‚Ç¨ entonces... ¬øPor qu√© no hacer justo esto en los tests autom√°ticos? Esto es justamente lo que se puede conseguir con testing-library y es la corriente dominante en los tests de frontend:

\`\`\`js
// Importamos las dependencias necesarias, librer√≠as de testing, react y el componente
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import React from 'react';
import App from './AppHooks'; 


it('should display 20‚Ç¨ when the user is not VIP ', () => {
  // Renderizamos la app en una pantalla virtual
  render(<App />);
  // Comprobamos que el texto 20‚Ç¨ est√° visible en la pantalla
  expect(screen.queryByText('20‚Ç¨')).toBeVisible();
});

it('should display 0‚Ç¨ when the user clicks on VIP checkbox ', () => {
  // Volvemos a renderizar la app
  render(<App />); 
  // Hacemos click en el checkbox con la etiqueta "VIP"
  userEvent.click(screen.queryByLabelText('VIP'));
  // Comprobamos que el texto 0‚Ç¨ es visible
  expect(screen.queryByText('0‚Ç¨')).toBeVisible();
});
\`\`\`

Evidentemente esto es un peque√±o ejemplo de todo lo que se puede hacer, pero creeme que una vez empiezas a hacer tests no hay vuelta atr√°s porque en menos de 10 segundos tienes un feedback realista sobre el comportamiento de tu aplicaci√≥n que te evitar√° bugs, regresiones y dolores de cabeza.

Si te interesa saber m√°s sobre el tema, puedes echarle un vistazo a mi libro en [frontend-testing.org](http://frontend-testing.org/) o seguirme en [@iagolast](https://twitter.com/iagolast).",
    "slug": "testing-frontend",
    "tags": [
      "react",
    ],
    "title": "Testing en el FrontEnd",
    "userPicture": "",
    "username": "Iago Lastra",
  },
  {
    "category": "typescript",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/TS_category.png",
    "date": "",
    "description": "La Inyecci√≥n de Dependencias es un patr√≥n de orientaci√≥n a objetos que nos ayuda a mantener el codigo desacoplado, permitiendo que este sea mas tolerante al cambio.",
    "id": "inyeccion-de-dependencias-componentes",
    "markdownBody": "Hoy en d√≠a es bien sabido que la utilizaci√≥n de patrones y buenas pr√°cticas de programaci√≥n nos ayudan en la creaci√≥n y mantenimiento de nuestro software.

Hay una gran variedad de patrones interesantes, a medida que los vas aplicando descubres que cada uno de ellos te ayuda a cumplir que tu software sea m√°s ***-ble** (mantenible, extensible, entendible, testeable, etc.)

En este art√≠culo me gustar√≠a introducirte el patr√≥n **Inyecci√≥n de Dependencias** relacionado con una serie de buenas pr√°cticas y patrones que veremos a continuaci√≥n, empecemos.

## ¬øPor qu√© aprender este patr√≥n?

Una de las principales razones para las que me gusta aplicarlo, es para **reducir el acoplamiento** entre las diferentes piezas de mi software.

La pr√°ctica me demuestra que si **reduzco el acoplamiento** tendr√© una mejora en mis **-ble**(recuerda: mantenible, extensible, entendible, testeable, etc.) Pero‚Ä¶ ¬øPor qu√© quiero cumplir todo esto? Pues entre otras cosas podr√© hacer mejor software con menor coste que no tenerlos en cuenta. ¬øQu√© m√°s me da tener menos costes? Bueno parece que si cumplo todo esto reducir√© mis tiempos en las mismas tareas, menos estr√©s y qui√©n sabe si una vida m√°s feliz.

Es decir, si usar√° un poco de *clickbait*, podr√≠a cambiar el t√≠tulo por **C√≥mo ser m√°s feliz gracias a la inyecci√≥n de dependencias :)**

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/1.gif)

Aun as√≠, puede ser que el *clickbait* no sea suficiente para convencerte, veamos algunas otras ideas, para ello necesito presentarte a la **D** de [**SOLID](https://softwarecrafters.io/cleancode-solid-testing-js).**

¬øLos principios qu√©? Los principios [SOLID](https://softwarecrafters.io/cleancode-solid-testing-js), son unos principios pensados para hacer nuestro software m√°s **-ble** son un resumen de las buenas pr√°cticas propuestas en el a√±o 2000 por el famoso **Uncle Bob ([Robert C. Martin](https://en.wikipedia.org/wiki/Robert_C._Martin)) **y son unos principios b√°sicos del mundo del software que deber√≠as conocer (y no solo porqu√© los pregunten en las entrevistas).

Si quieres profundizar en SOLID, te recomiendo que le eches un vistazo al e-book de Software Crafters:

* [https://softwarecrafters.io/cleancode-solid-testing-js](https://softwarecrafters.io/cleancode-solid-testing-js)

## Inversi√≥n de Dependencias

El principio de **Inversi√≥n de Dependencias** m√°s conocido como [*Dependency Inversion](https://en.wikipedia.org/wiki/Dependency_inversion_principle)** nos introduce que dados dos m√≥dulos relacionados entre si, por ejemplo **A** y **B**. Ninguno de ellos dos deber√≠a depender del otro, deber√≠amos usar una **abstracci√≥n** para esa relaci√≥n. Eso permite que **A** o **B** no conozcan realmente al otro, simplemente entienden que cumple esa abstracci√≥n mencionada anteriormente.

En la mayor√≠a de los lenguajes *(en casi todos los que se me ocurren)* a esa abstracci√≥n la llamamos **Interfaz** y las interfaces en software no son m√°s que **contratos** que deben ser cumplidos, es decir si **A** necesita a **B**, oficialmente diremos que **A** necesita a alguien que cumpla la interfaz (el contrato) **IB** (la mayor√≠a de las veces si tenemos un m√≥dulo llamado **B**, al contrato le pondremos una **I** delante para identificarlo como interfaz de **B**). Y en este caso **B** cumplir√° ese contrato, aunque a **A** le da igual que qui√©n cumpla **IB** sea **B, C, D **o** Z.**

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/2.gif)

¬øInteresante verdad? Antes de pasar a la inyecci√≥n de dependencias me gustar√≠a hablarte de un **Patr√≥n de Dise√±o** tambi√©n muy interesante y relacionado.

## Inversi√≥n de Control

El patr√≥n de dise√±o, **Inversi√≥n de Control** conocido como [*Inversion of Control* (IoC)](https://en.wikipedia.org/wiki/Inversion_of_control). Nos explica que cuando una clase (o componente, pieza de software) depende de otra clase la primera no deber√≠a gestionar el **ciclo de vida** de la segunda, esto deber√≠a ser hecho en **otro √°mbito**.

En palabras sencillas, viene a decir que si en el constructor de tu clase haces un new B(); parece que puedes hacerlo mejor. 

Este otro √°mbito no suele estar especificado, aunque casi siempre acabaremos llam√°ndolo **Contenedor**.

Lo que haremos cuando estemos en **A** y queramos usar **B** no ser√° crear una nueva instancia del segundo, le pediremos a este **Contenedor** (o el elemento correspondiente) que nos provee de **B** y ser√° en este en el que caer√° la responsabilidad de gestionar todo el ciclo de vida de **B**.

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/3.gif)

## ¬øY entonces qu√© es la Inyecci√≥n de Dependencias?

Una vez damos por hecho que nos interesa la **Inversi√≥n de Dependencias** y la **Inversi√≥n de Control** puede ser muy interesante tener una herramienta (o en este caso un patr√≥n) que nos ayude a cumplir ambas. 

Esto es la **Inyecci√≥n de Dependencias**, un patr√≥n que nos da una soluci√≥n a las dos pr√°cticas anteriores, pero no tiene por qu√© ser la √∫nica soluci√≥n a esas pr√°cticas, puede haber otras distintas. Esta simplemente nos da soluci√≥n a ambas a la vez.

Cuando estamos en **A** y queremos **B**, le pedimos a nuestro **Contenedor** que por favor nos provee a alguien que cumpla el contrato **IB** y dependiendo del caso este contenedor nos dar√° **B** o un equivalente que corresponda. Por ejemplo, si estamos testeando quiz√° recibimos **MockB**.

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/4.gif)

## Empezando a trabajar con Inyecci√≥n de Dependencias

Despu√©s de toda la teor√≠a expuesta, vamos a empezar a trabajar con la Inyecci√≥n de Dependencias de forma pr√°ctica, poco a poco.

Imaginemos primero que tenemos un **Servicio** llamado **CartService** b√°sicamente es un servicio que nos ayuda a gestionar el carrito de la compra de nuestro software. Pero tenemos la necesidad de usar otro servicio de **Insights** para saber cuando un usuario a√±ade un producto, lo borra, etc.

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/5.gif)

Podemos importar este otro servicio de **Insights** de diferentes modos, una forma seria importar el objeto entero de tal modo que en cualquier otro servicio que importemos **Insights** tendremos la misma instancia.

Esto ser√≠a lo m√°s parecido a un [**‚Äô‚Äô‚ÄôSingleton‚Äô‚Äô‚Äô](https://en.wikipedia.org/wiki/Singleton_pattern)** que hagamos en Frontend.

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/6.png)

Y si no queremos que cada vez que se importe **Insights** sea la misma instancia, lo que podemos hacer es importar la clase e instanciar cada vez que lo necesitemos. Muy bien esto parece algo m√°s de tipo **‚Äô‚Äô‚ÄôTransient‚Äô‚Äô‚Äô.**

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/7.png)

¬°Felicidades! Con esto tendr√≠amos una aproximaci√≥n muy simple a lo que es **Inyecci√≥n de Dependencias** pero una vez le√≠da la teor√≠a podemos al menos entender que est√° pasando.

El problema es que siguen faltando muchos puntos a comentar, las clases tienen mucha responsabilidad, no he hablado de ning√∫n contenedor, ni siquiera menciono las abstracciones, etc.

Vamos a ver la **Inyecci√≥n de Dependencias** paso a paso, hasta llegar a lo que considero el escenario ideal en Frontend para inyectar dependencias.

## Paso 1: Semi-Inyecci√≥n

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/8.png)

En este caso ya no importamos **Insights** directamente, sino que importamos una [**Factor√≠a](https://es.wikipedia.org/wiki/Factory_Method_(patr%C3%B3n_de_dise%C3%B1o))**, esto nos ayuda a abstraernos y no saber (desde **CartService**) si este primero es **Singleton** o **Transient** de hecho nos da igual.

Adem√°s pasamos las dependencias por el constructor de **CartService** lo que empieza a parecer una **Inyecci√≥n** al uso.

Este primer nivel es un nivel acad√©mico y no tiene por qu√© ser un patr√≥n ideal para usar en proyectos, pero a veces puede ser m√°s que suficiente (tal y como me demostr√≥ mi compa√±ero [Carlos de Miguel](https://twitter.com/demiguelfer)).

## Paso 2: Auto-Inyecci√≥n

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/9.png)

En el siguiente ejemplo acad√©mico, lo que buscamos es que no tengamos que depender siquiera de ninguna factor√≠a, y adem√°s utilizamos unos decoradores para ocultar el hecho de que tengamos que pasar las dependencias por el constructor. 
Se parece un poco a como lo hac√≠a Angular 1 y los decoradores se parece a librer√≠as m√°s modernas.

De momento sigue siendo **Insights** qui√©n decide que tipo de inyecci√≥n va a realizar, lo cual es bueno porqu√© no lo hace **CartService** pero se puede mejorar.

## Paso 3: Inyecci√≥n con Contenedores

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/10.png)

Este ejemplo empieza ya a ser interesante y algo m√°s pr√°ctico, a√±adimos un **Contenedor** que se encargue de manejar todo lo relacionado con las dependencias del proyecto (o del m√≥dulo).

Esto nos ayuda mucho ya que ahora los **Servicios** son solo responsables de su l√≥gica y es este **Contenedor** el encargado de decidir:

* Cuando se instancias las dependencias.

* C√≥mo se instancia cada una de ellas (*Singleton, Transient*)

* En qu√© orden se van a registrar.

Hemos llegado al ecuador de los pasos, pero todav√≠a no tenemos algo totalmente funcional, sigamos con el paso 4.

## Paso 4: Un mundo m√°s realista

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/11.png)

Aunque en el ejemplo anterior tenemos algo bastante funcional, es verdad que eso de pasar al constructor un par√°metro y que m√°gicamente aparezca ah√≠ sin darle un tipo o un id o algo es bastante autom√°gico (Angular 1 :D).

En este siguiente paso decoramos los par√°metros asignando un ID que van a ser con los que nuestro contenedor identifique la dependencia.

Esto nos da una soluci√≥n bastante sencilla y real, pero en otros lenguajes utilizamos **Abstracciones** para ahorrarnos el ID.

## Paso 5: A√±adiendo Abstracciones

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/12.png)

Si a√±adimos [**TypeScript](https://www.typescriptlang.org/)** a la mezcla podemos usar **Interfaces** como **Abstracci√≥n.**

Primero, perm√≠teme comentar que esto no es un paso obligatorio si trabajas en Frontend, pero si quieres una capa de **Abstracci√≥n** va a ayudarte mucho.

Ahora identificamos las dependencias por su **Interfaz** adem√°s de por su ID y aqu√≠ es donde se abre un peque√±o debate.

Aunque solo con la **Interfaz** deber√≠a ser m√°s que suficiente, por el momento los navegadores no interpretan **TypeScript**, as√≠ que una vez compilado el navegador no va a tener nada que interpretar si no tenemos ese ID, por suerte si ponemos un poco de la famosa automagia, podemos llegar a ocultar eso con un poco de [**Reflection](https://developer.mozilla.org/es/docs/Web/JavaScript/Reference/Global_Objects/Reflect).**

## Paso 6: Implementando DI en los Componentes

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/13.png)

Aunque en la mayor√≠a de lenguajes de programaci√≥n usamos **Inyecci√≥n de Dependencias** a trav√©s del constructor, en los componentes puede ser m√°s sencillo cambiar a inyecci√≥n por propiedad, como por ejemplo se hac√≠a en algunas versiones de Android.

La funcionalidad es exactamente la misma pero nos quedar√° un c√≥digo m√°s parecido al de la foto anterior, al que tambi√©n se le ha a√±adido **Reflection** para que no tengamos que usar los id* (aunque debe ser siempre un paso opcional).*

¬øPero hay de verdad algo real detr√°s de todo esto?

## La librer√≠a para inyectar dependencias

C√≥mo siempre en el software, podr√≠amos crear nuestra propia librear√≠a de **Inyecci√≥n de Dependencias** o utilizar una que ya exista. En mi caso me gusta mucho [Inversify](http://inversify.io/) de [Remo H. Jansen](https://twitter.com/RemoHJansen).

Tras mucho tiempo utiliz√°ndola en proyectos reales y en producci√≥n, creamos un peque√±o *wrapper* llamado [**Inversify-Props](https://github.com/CKGrafico/inversify-props)** que ayuda en el **Paso 6** de los ejemplos anteriores.

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/inyeccion-de-dependencias-componentes/14.gif)

En la [documentaci√≥n](https://github.com/CKGrafico/inversify-props) se pueden observar ejemplos de c√≥mo usar la librer√≠a, pero analicemos un par de ellos.
\`\`\`javascript
    import 'reflect-metadata'; // Import only once
    import { container, inject } from 'inversify-props';
    
    container.addSingleton<IService1>(Service1);
    container.addSingleton<IService2>(Service2);
    
    export default class extends Component {
      @inject() service1: IService1;
      @inject() service2: IService2;
    }
\`\`\`

Esta librer√≠a ya gestiona el contenedor por ti, simplemente lo importas y a√±ades los servicios que quieras, despu√©s en cada componte *(de cualquier framework)* inyectas la dependencia utilizando decoradores.

En el ejemplo anterior se usa *reflection* para no tener que utilizar IDs pero es algo totalmente opcional y la librer√≠a autogenera IDs para que puedas utilizarlos si no quieres usar *reflection*.
\`\`\`javascript
    import 'reflect-metadata'; // Import only once
    import { cid, container, inject } from 'inversify-props';
    
    container.addSingleton<IService1>(Service1);
    
    export default class extends Component {
      @inject(cid.IService1) service1: IService1;
    }
\`\`\`

Incluso puedes usar cualquier ID que prefieras.
\`\`\`javascript
    import 'reflect-metadata'; // Import only once
    import { container, inject } from 'inversify-props';
    
    container.addSingleton<IService1>(Service1, 'myid');
    
    export default class extends Component {
      @inject('myid') service1: IService1;
    }
\`\`\`

Para marcar un servicio como candidato a ser inyectado utilizamos el decorador propio de **Inversify**.
\`\`\`javascript
    // iservice1.ts
    export interface IService1 {
        method1(): string;
    }
    
    // service.ts
    @injectable()
    export class Service1 implements IService1 {
      method1(): string {
        return 'method 1';
      }
    }
\`\`\`

Pues esto es todo sobre **Inyecci√≥n de Dependencias, Inversi√≥n de Control e Inversi√≥n de Dependencias** ¬øQu√© te parece? ¬øSueles inyectar dependencias en tus proyectos de Frontend? ¬øY en los de Backend? Empieza ahora mismo y disfruta de las facilidades de uno de los patrones m√°s interesantes que podr√°s aprender este a√±o.

**BONUS:** ¬øUsas *hooks*? No te pierdas la [versi√≥n simplificada para usar en Hooks](https://github.com/CKGrafico/inversify-hooks).
",
    "slug": "inyeccion-de-dependencias-componentes",
    "tags": [
      "typescript",
    ],
    "title": "Inyecci√≥n de dependencias en componentes",
    "userPicture": "",
    "username": "Quique Fdez",
  },
  {
    "category": "css",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/postcss_category.png",
    "date": "",
    "description": "PostCSS Preset Env le permite convertir CSS moderno en algo que la mayor√≠a de los navegadores pueden entender, determinando los polyfills que necesita.",
    "id": "postcss-preset-env-babel-css",
    "markdownBody": "La definici√≥n oficial de **PostCSS Preset Env** dice:

> PostCSS Preset Env le permite convertir CSS moderno en algo que la mayor√≠a de los navegadores pueden entender, determinando los polyfills<sup>(1)</sup> que necesita en funci√≥n de sus navegadores de destino o entornos de tiempo de ejecuci√≥n, utilizando cssdb<sup>(2)</sup>.

Lo primero que me llam√≥ la atenci√≥n de la definici√≥n es lo de **CSS moderno**, pero creo que encajar√≠a mejor si dijera **"Funcionalidades CSS de la especificaci√≥n"**. Espera, ¬øeso qu√© quiere decir?

Pues que podemos utilizar las funcionalidades que se est√°n definiendo en el CSSWG<sup>(3)</sup> antes de que acaben como un est√°ndar de la W3C<sup>(4)</sup> y lo tengamos disponible en los navegadores.

## ¬øC√≥mo funciona el est√°ndar CSS?

El **CSS Working Group** es un grupo de personas profesionales de la web, la mayor√≠a de ellas empleadas de las grandes marcas que est√°n detr√°s de los navegadores, sistemas operativos y dispositivos, como Apple, Google, Microsoft, Adobe, Mozilla o Amazon, aqu√≠ os dejo un enlace a la lista completa de [miembros de la CSSWG](https://www.w3.org/Style/CSS/members/members.en.php3)

El foco de ese grupo de trabajo es estandarizar las funcionalidades de CSS, as√≠ como la definici√≥n de nuevas. Es aqu√≠ donde nos vamos a centrar. Esas nuevas funcionalidades en muchas ocasiones tardan mucho en llegar a los navegadores de los usuarios. S√≠, s√≠, de los usuarios. Nosotros como freakis de la tecnolog√≠a tenemos las √∫ltimas versiones de los navegadores, adem√°s tenemos m√°s de uno para poder validar el correcto funcionamiento de nuestros desarrollos, pero los usuarios suelen tener el navegador instalado por defecto en los dispositivos y muchos de ellos no actualizan el software por miedo a perder configuraciones.

Aqu√≠ es donde en muchas ocasiones sentimos una gran frustraci√≥n, vemos que aparecen nuevas e impresionantes funcionalidades en las que est√°n trabajando, pero tardan en llegar al usuario.

## ¬øQu√© tiene que ver esto con Babel?

De igual forma que para CSS existe el CSSWG, para Javascript existe el **TC39**<sub>(5)</sub>, donde de forma similar, un grupo de personas debaten y definen las nuevas funcionalidades para el lenguaje de la web.

La adopci√≥n de esas nuevas funcionalidades no tienen la misma velocidad de implementaci√≥n por parte de los diferentes navegadores, en la tabla **compat-table** podemos ver una lista del soporte por cada una de las features.

![](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/postcss-babel-css/compat-table.png)
Aqu√≠ podemos ver la tabla para [ES2016+](https://kangax.github.io/compat-table/es2016plus/)

Para gestionar y versionar las propuestas, el TC39 defini√≥ los siguientes estados:

| Estado                  | Descripci√≥n                                                                                                                                                                                                                                                                                                                                                                                                                             |
| :---------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **stage-0** (Strawman)  | En este estado se suben ideas del comit√© TC39 o de alguien registrado como contribuidor. De estas caracter√≠sticas, algunas se llegan a implementar y otras s√≥n descartadas.                                                                                                                                                                                                                                                             |
| **stage-1** (proposal)  | El "champion" se convierte en el responsable de la propuesta. En este punto ya existe una descripci√≥n formal de la idea, descrita en forma de ejemplos, una API, sem√°ntica y algoritmos.                                                                                                                                                                                                                                                |
| **stage-2** (draft)     | Es una primera versi√≥n de lo que se incluir√° en la especificaci√≥n. Normalmente cuando se llega a este punto suele ser segura su inclusi√≥n en el est√°ndar. Se necesita tener una descripci√≥n usando el lenguaje de **ECMAScript**. Adem√°s, se requiere dos implementaciones experimentales, pero una de ellas puede ser haciendo uso de un transpilador como **Babel**.                                                                  |
| **stage-3** (candidate) | La propuesta est√° casi finalizada y ahora se necesitan las opiniones de los usuarios de las implementaciones para progresar. El texto de la especificaci√≥n debe estar completo. Los evaluadores designados por el TC39 deben finalizar la especificaci√≥n. Debe haber al menos dos implementaciones funcionales. Los cambios s√≥lo se har√°n en respuesta a problemas cr√≠ticos que se hayan descubierto por las implementaciones y su uso. |
| **stage-4** (finished)  | La propuesta est√° lista para ser incluida en el est√°ndar.                                                                                                                                                                                                                                                                                                                                                                               |

Como podemos ver en la descripci√≥n del stage-2, para poder utilizar las nuevas funcionalidades debemos transpilar el c√≥digo para que lo pueda entender el navegador. Para ello podemos utilizar **[Babel](https://babeljs.io/)**, pero hay otros, como **[Traceur](https://github.com/google/traceur-compiler)** de Google.

## Babel

**Babel**<sup>(6)</sup> es un transpilador que se encarga de convertir nuestro c√≥digo JavaScript, con las nuevas funcionalidades y sintaxis, a un c√≥digo que sea capaz de interpretar el navegador.

Para hacer esta transpilaci√≥n Babel nos ofrece **[@babel/preset-env](https://babeljs.io/docs/en/babel-preset-env)**, para poder configurar el soporte de navegador que deseamos para nuestro proyecto.

## PostCSS Preset Env

Aqu√≠ es donde encontramos la similitud con Babel, **PostCSS Preset Env**, creado por [Jonathan Neal](https://twitter.com/jon_neal), nos ofrece la opci√≥n de trabajar con las nuevas funcionalidades CSS que est√°n en modo borrador en la W3C.

Para hacerlo se basa en **cssdb**, que es una lista completa de caracter√≠sticas CSS y sus posiciones en el proceso de convertirse en est√°ndares web implementados.

Al igual que lo hace Babel, dispone de varios estados:

| Estado                                                                       | Descripci√≥n                                                                                                                                                                                                                                                                                                                     |
| :--------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Stage 0**: Aspirational<br>"Esta es una idea loca"                         | Un borrador no oficial o un borrador de editor defendido por un miembro del W3C Working Group. Debe considerarse altamente inestable y sujeto a cambios. Las caracter√≠sticas de la etapa 0 est√°n abiertas a ideas y discusi√≥n, pero no pueden considerarse serias.                                                              |
| **Stage 1**: Experimental<br>"Esta idea podr√≠a no ser una locura"            | Un borrador de editor o un borrador de trabajo inicial defendido por un miembro del W3C Working Group. Debe considerarse altamente inestable y sujeto a cambios. Las caracter√≠sticas de la etapa 1 se reconocen como un problema real, pero pueden no estar vinculadas a ninguna soluci√≥n en particular.                        |
| **Stage 2**: Allowable<br>"Esta idea no es una locura"                       | Un borrador de trabajo inicial defendido por un miembro del W3C Working Group. Debe considerarse relativamente inestable y sujeto a cambios. Las caracter√≠sticas de la etapa 2 est√°n vinculadas a una forma particular de resolver un problema.                                                                                 |
| **Stage 3**: Embraced<br>"Esta idea se est√° convirtiendo en parte de la web" | Una recomendaci√≥n candidata defendido por un miembro del W3C Working Group, generalmente implementado por al menos 2 proveedores de navegadores reconocidos, posiblemente detr√°s de un flag. Debe considerarse estable y sujeto a pocos cambios. Las caracter√≠sticas de la etapa 3 probablemente se convertir√°n en un est√°ndar. |
| **Stage 4**: Standardized<br>"Esta idea es parte de la web"                  | Una recomendaci√≥n defendido por el W3C. Debe ser implementado por todos los proveedores de navegadores reconocidos. Las caracter√≠sticas de la etapa 4 s√≥n est√°ndares web.                                                                                                                                                       |

En PostCSS Preset Env actualmente disponemos de 33 propiedades CSS repartidas entre los diferentes estados.

- **Stage 3**: 6 propiedades
- **Stage 2**: 20 propiedades
- **Stage 1**: 6 propiedades
- **Stage 0**: 1 propiedades

En la web podemos ver un listado muy detallado de todas las propiedades CSS en desarrollo que tenemos disponible, indicando el estado, un enlace a la especificaci√≥n en la W3C, un enlace al plugin PostCSS que se encarga de transpilar nuestro c√≥digo y finalmente un ejemplo de c√≥digo.

![Funci√≥n CSS image-set()](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/postcss-babel-css/image-set.png)

## Instalaci√≥n

Vamos a ver c√≥mo podemos instalar PostCSS Preset Env. Como la mayor√≠a de herramientas que tenemos hoy en d√≠a en el desarrollo frontend, lo tenemos disponible como un paquete de **npm**. Hay varias maneras de utilizar PostCSS Preset Env, lo podemos integrar con Node, PostCSS CLI, Webpack, Create React App, Gulp, Grunt y recientemente con Rollup. En el fichero [INSTALL.md](https://github.com/csstools/postcss-preset-env/blob/master/INSTALL.md) del repositorio oficial podemos ver detalladamente cada una de esas instalaciones.

Para el ejemplo nos vamos a basar en PostCSS CLI.

\`\`\`bash
npm install postcss-preset-env --save-dev
\`\`\`

Esto nos instalar√° el paquete *postcss-preset-env* en nuestro proyecto, pero ahora necesitamos utilizarlo con PostCSS CLI. Vamos a instalarlo:

\`\`\`bash
npm install postcss-cli --save-dev
\`\`\`

Utilizaremos el fichero \`postes.config.js\` para configurarlo, esto es lo que tendremos en su interior:

\`\`\`javascript
const postcssPresetEnv = require("postcss-preset-env");

module.exports = {
  plugins: [postcssPresetEnv(/* pluginOptions */)]
};
\`\`\`

En el ejemplo estamos definiendo s√≥lo la parte que afecta a *postcss-preset-env*, pero en este fichero podr√≠amos a√±adir otros plugins, como *postcss-import* para poder importar archivos CSS, ya que import no est√° en la especificaci√≥n.

Ahora vamos a adentrarnos en las opciones de configuraci√≥n que tenemos disponibles. En lugar del comentario *pluginOptions* pasaremos un objeto. Veamos algunos ejemplos.

### Configuraci√≥n por estado

Si configuramos **Stage 0** tenemos disponibles todas las nuevas funcionalidades:

\`\`\`javascript
...
	postcssPresetEnv({ stage: 0 })
...
\`\`\`

### Configuraci√≥n por funcionalidad

En este ejemplo adem√°s de definir el estado, en este caso el 3, a√±adimos la clave *feature* al objeto y le indicamos la funcionalidad que queremos.

\`\`\`javascript
...
	postcssPresetEnv({
	  /* use stage 3 features + css nesting rules */
	  stage: 3,
	  features: {
	    'nesting-rules': true
	  }
	})
...
\`\`\`

Con esta configuraci√≥n estamos definiendo que queremos las propiedades con estado 3, que s√≥n las previas a formar parte del est√°ndar, pero tambi√©n queremos que se a√±ada *nesting-rukes*, que actualmente pertenece al grupo con estado 1. Esta es una de las cosas que m√°s me gusta de PostCSS Preset Env, podemos configurar y adaptar el entorno de desarrollo en cada proyecto.

### Configuraci√≥n por navegador

Otra manera que tenemos de configurar las funcionalidades CSS es definiendo el soporte de los navegadores:

\`\`\`javascript
...
	postcssPresetEnv({ browsers: 'last 2 versions' })
...
\`\`\`

Como indica la propia documentaci√≥n en este caso tambi√©n podr√≠amos utilizar una clave *browserlist* en *package.json* o a√±adir el fichero *.browserlist*<sup>(7)</sup>.

### Configuraciones avanzadas

Hay dos de las opciones de configuraci√≥n que me parecen una aut√©ntica maravilla, s√≥n **importFrom** y **exportTo**.

**importFrom** nos permite definir, uno o varios archivos, donde tengamos configuradas variables como Custom Media, Custom Properties, Custom Selectors. Y he dicho variables porque podemos importar CSS, Javascript o Json.

Si tenemos un archivo *src/themes/sw_crafters/settings.css* con el contenido:

\`\`\`css
@custom-media --small-viewport (max-width: 30em);
@custom-selector :--seo-headings h1, h2, h3;
:root {
  --color-primary: #434343;
  --font-family: Monserrat, HelveticaNeue, "Helvetica Neue", Helvetica, Arial,
    sans-serif;
}
\`\`\`

Podremos importar el archivo de configuraci√≥n del tema **sw_creafter** de la siguiente forma:

\`\`\`javascript
...
	postcssPresetEnv({
	  stage: 0,
	  importFrom: 'src/themes/sw_crafters/settings.css'
	})
...
\`\`\`

Al contrario que importFrom, **exportTo** se encarga de exportar las Custom Media, Custom Properties y Custom Selectors de nuestro proyecto. De igual manera, podemos hacerlo en formato CSS, Javascript y Json, solo tenemos que indicar la ruta, y la extensi√≥n del archivo definir√° el formato de salida.

\`\`\`javascript
...
	postcssPresetEnv({
	  stage: 0,
	  esportTo: 'data/themes/sw_crafters/settings.js'
	})
...
\`\`\`

As√≠ quedar√≠a la exportaci√≥n de la configuraci√≥n del tema sw_crafters:

\`\`\`javascript
module.exports = {
  customMedia: {
    "--small-viewport": "(max-width: 30em)"
  },
  customProperties: {
    "--color-primary": "#434343",
    "--font-family":
      'Monserrat, HelveticaNeue, "Helvetica Neue", Helvetica, Arial, sans-serif'
  },
  customSelectors: {
    ":--seo-headings": "h1,h2,h3"
  }
};
\`\`\`

Estas dos opciones nos van a permitir tener un mayor control de los tokens<sup>(8)</sup> de nuestro Design System<sup>(9)</sup>.

## Recursos

El recurso principal es la web oficial https://preset-env.cssdb.org/

![Web PostCSS Preset Env](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/postcss-babel-css/postcss-preset-env-web.png)

En ella encontraremos todas las nuevas funcionalidades CSS, un playground donde poder probarlo directamente en nuestro navegador.

![PostCSS Playground](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/postcss-babel-css/playground.png)

A la izquierda podemos escribir nuestro c√≥digo CSS, y a la derecha tendremos el c√≥digo transpilado para dar soporte a los navegadores actuales seg√∫n el estado y soporte de navegadores que hayamos elegido.

En la web tambi√©n encontraremos un enlace a soporte, donde nos lleva a una room<sup>(10)</sup> de Gitter<sup>(11)</sup>, donde encontraremos soporte de una gran comunidad de PostCSS.

![Gitter](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/postcss-babel-css/gitter.png)

Por √∫ltimo tambi√©n tenemos el enlace al repositorio en GitHub.

### Ask Me Anything!

Como √∫ltimo recurso os quiero compartir este repositorio [ama](https://github.com/nucliweb/ama)<sup>(12)</sup> en GitHub, donde a trav√©s de los issues estoy abierto a resolver cualquier duda de temas relacionados con CSS, PostCSS, SVG, CSS Houdini, Web Animation y Media Optimization. As√≠ que si ten√©is alguna duda sobre PostCSS o alguno de los otros temas, estar√© encantado de ayudar en lo que pueda.

![Ask Me Anything!](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/postcss-babel-css/ama.png)

## Conclusiones

Yo apost√© por PostCSS desde hace tiempo, a√∫n a d√≠a de hoy veo que hay gente que se confunde al acercarse a este preprocesador. Es normal, hay tanta flexibilidad que puede llevar a confusi√≥n. Pero creo que utilizar PostCSS Preset Env, que funciona como un paquete para poder seguir desarrollando en CSS nativo, es una gran puerta de entrada, y podemos ampliar y adaptar nuestro entorno de desarrollo poco a poco.

Os invito a utilizarlo en vuestro nuevo proyecto o integrarlo en el proyecto actual, ya que PostCSS puede convivir sin problema con otros preprocesadores como Sass. Seguro que mucha gente ya lo est√° haciendo... ¬øsabes que si est√°s utilizando [Autoprefixer](https://autoprefixer.github.io/), ya est√°s utilizando PostCSS?

#### Notas

- (1) [Polyfill](<https://en.wikipedia.org/wiki/Polyfill_(programming)>)
- (2) [Web cssdb](https://cssdb.org/)
- (3) [CSS Working Group](https://drafts.csswg.org/)
- (4) [World Wide Web Consortium](https://www.w3.org/)
- (5) [Technical Committee 39](https://www.ecma-international.org/memento/tc39-rf-tg.htm)
- (6) [Babel](https://babeljs.io/)
- (7) [Configuraci√≥n de browserlist](https://github.com/browserslist/browserslist#readme)
- (8) [Tokens](https://css-tricks.com/what-are-design-tokens/)
- (9) [Design System](https://www.learnstorybook.com/design-systems-for-developers/)
- (10) Una room en Gitter es como un team en Slack
- (11) Gitter es una herramienta de comunicaci√≥n, similar a Slack, pero relacionada con un repositorio de GitHub.
- (12) As Me Anything, es una idea original de **‚ÄåAvi Flombaum** que cre√≥ un repositorio para poder utilizar el sistema de issues de GitHub y resolver dudas.
",
    "slug": "postcss-preset-env-babel-css",
    "tags": [
      "css",
    ],
    "title": "PostCSS Preset Env, el Babel de CSS",
    "userPicture": "",
    "username": "Joan Le√≥n",
  },
  {
    "category": "javascript",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/JS_category.png",
    "date": "",
    "description": "Test Driven Development (TDD), o desarrollo dirigido por test en castellano, es una t√©cnica de ingenier√≠a de software para dise√±ar software. ",
    "id": "tdd-test-driven-development",
    "markdownBody": ">**El testing de software puede verificar la presencia de errores pero no la
ausencia de ellos. ‚Äì Edsger Dijkstra**

**Test Driven Development (TDD)**, o **desarrollo dirigido por test** en castellano, es una t√©cnica de ingenier√≠a de *software* para, valga la redundancia, dise√±ar *software*. Como su propio nombre indica, esta t√©cnica dirige el desarrollo de un producto a trav√©s de ir escribiendo pruebas, generalmente unitarias.

El TDD fue desarrollado por Kent Beck a finales de la d√©cada de los 90 y forma parte de la metodolog√≠a **extreme programming**. Su autor y los seguidores del TDD aseguran que con esta t√©cnica se consigue un c√≥digo m√°s tolerante al cambio, robusto, seguro, m√°s barato de mantener e, incluso, una vez que te acostumbras a aplicarlo, promete una mayor velocidad a la hora de desarrollar.

![Vi√±eta de commit strip sobre la importancia de los tests.](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/tdd_test_driven_development/testing_strip.jpg =90%x*)

###### Vi√±eta de Commit Strip sobre la importancia de los tests.

**NOTA:** Este art√≠culo es un extracto de la secci√≥n de testing y TDD de nuestro libro [Clean Code, SOLID y Testing aplicado a JavaScript](https://softwarecrafters.io/ebook-cleancode-javascript). ¬°Espero que lo disfrutes!

## Las tres leyes del TDD

Robert C. Martin describe la esencia del TDD como un proceso que atiende a las siguientes tres reglas:

* No escribir√°s c√≥digo de producci√≥n sin antes escribir un test que falle.
* No escribir√°s m√°s de un test unitario suficiente para fallar (y no compilar es fallar).
* No escribir√°s m√°s c√≥digo del necesario para hacer pasar el test.
  
Estas tres leyes derivan en la repetici√≥n de lo que se conoce como el ciclo *Red-Green-Refactor*. Veamos en qu√© consiste:

## El ciclo Red-Green-Refactor

El ciclo *Red-Green-Refactor*, tambi√©n conocido como algoritmo del TDD, se basa en:

* **Red**: Escribir un test que falle, es decir, tenemos que realizar el test antes de escribir la implementaci√≥n. Normalmente se suelen utilizar test unitarios, aunque en algunos contextos puede tener sentido hacer TDD con test de integraci√≥n.
* **Green**: Una vez creado el test que falla, implementaremos el m√≠nimo c√≥digo necesario para que el test pase.
* **Refactor**: Por √∫ltimo, tras conseguir que nuestro c√≥digo pase el test, debemos examinarlo para ver si hay alguna mejora que podamos realizar.
* Una vez que hemos cerrado el ciclo, empezamos de nuevo con el siguiente requisito.

![Ciclo Red-Green-Refactor](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/tdd_test_driven_development/testing_tdd_rgr.png =85%x*)

###### Ciclo Red-Green-Refactor.

Esta forma de programar ofrece dos beneficios principales. El primero y m√°s obvio es que obtenemos un c√≥digo con una buena cobertura de test, lo que es positivo hasta cierto punto. Recuerda, nos pagan por escribir c√≥digo que funciona, no por hacer test.

El segundo beneficio es que escribir primero las pruebas nos ayuda a dise√±ar la API que va a tener nuestro componente, ya que nos obliga a pensar en c√≥mo queremos utilizarlo. Esto suele acabar derivando en componentes con responsabilidades bien definidas y bajo acoplamiento.

## TDD como herramienta de dise√±o

Cuando Kent Beck desarroll√≥ esta metodolog√≠a lo hizo centr√°ndose en el segundo de los beneficios que describimos en el apartado anterior, es decir, en TDD como una herramienta de dise√±o de software que nos ayuda a obtener mejor c√≥digo, no a obtener m√°s test. Para ello, una vez que tenemos una lista con los primeros requisitos que debe satisfacer el producto, debemos seguir los siguientes pasos:

1. Escogemos un requisito.
2. Escribimos un test que falla.
3. Creamos la implementaci√≥n m√≠nima para que el test pase.
4. Ejecutamos todos los tests.
5. Refactorizamos.
6. Actualizamos la lista de requisitos.

En el √∫ltimo paso, cuando actualizamos la lista de requisitos, adem√°s de marcar como completado el requisito implementado, debemos a√±adir los nuevos requisitos que hayan podido aparecer.

Normalmente, cuando desarrollamos un producto *software*, los requisitos no est√°n completamente definidos desde el principio, o estos sufren cambios a corto y medio plazo, bien porque son descartados, modificados o porque surgen otros nuevos. TDD encaja muy bien con este tipo de escenarios ya que, adem√°s de ir a√±adiendo test que eval√∫an que nuestro dise√±o cumple con los requisitos especificados, ayuda a descubrir nuevos casos que no se hab√≠an detectado previamente. A esto √∫ltimo se le conoce como **dise√±o emergente**.

Esta es la raz√≥n por la que para muchos de sus seguidores la √∫ltima ‚ÄúD‚Äù de TDD deber√≠a significar *design* en vez de *development*.

## Estrategias de implementaci√≥n, de rojo a verde.

Quiz√°s uno de los puntos m√°s delicados a la hora de aplicar TDD como herramienta de dise√±o es en el paso en el que ya tenemos un test que falla y debemos crear la implementaci√≥n m√≠nima para que el test pase. Para ello Kent Beck, en su libro *[Test Driven Development by Example](https://amzn.to/2mkC2Vt)*, expone un conjunto de estrategias, tambi√©n conocidas como patrones de barra verde, que nos van a permitir avanzar en pasos peque√±os hacia la soluci√≥n del problema.

### Implementaci√≥n falsa

Una vez que tenemos el test fallando, la forma m√°s r√°pida de obtener la primera implementaci√≥n es creando un fake que devuelva una constante. Esto nos ayudar√° a ir progresando poco a poco en la resoluci√≥n del problema, ya que al tener la prueba pasando estamos listos para afrontar el siguiente caso.

La mejor forma de entender el concepto es con un ejercicio pr√°ctico. El ejercicio es simple, vamos a construir una funci√≥n que reciba como par√°metro un n√∫mero entero n y devuelva el n-√©simo n√∫mero de Fibonacci. Recuerda la sucesi√≥n de Fibonacci comienza con 0 y 1, los siguientes t√©rminos siempre son la suma de los dos anteriores:

![Sucesi√≥n de Fibonacci.](https://swcrafters.fra1.cdn.digitaloceanspaces.com/Posts/tdd_test_driven_development/testing_fibonacci.png =90%x*)

###### Sucesi√≥n de Fibonacci

Observando la tabla anterior, podemos darnos cuenta de que los casos *edge* son 0 y 1, adem√°s de los m√°s sencillos de implementar. Vamos a empezar por crear el test para n = 0:

\`\`\`javascript
//Fibonacci, primer test.
describe('Fibonacci should', () => {
  it('return zero if receive zero', () => {
    expect(fibonacci(0)).toBe(0);
  });
});
\`\`\`

La implementaci√≥n *fake* m√°s obvia que permite que el test pase es hacer que la funci√≥n fibonacci devuelva 0 como una constante:

\`\`\`javascript
function fibonacci(n) {
  return  0;
}
\`\`\`

Puedes acceder al ejemplo interactivo [desde aqu√≠.](https://repl.it/@SoftwareCrafter/TDD-Fibonnacci)

Una vez que tenemos el primer test pasando, la idea es transformar gradualmente la constante en una expresi√≥n. Ve√°moslo en el ejemplo, para ello primero debemos crear un test para el siguiente caso obvio, n = 1;

\`\`\`javascript

it('return one if receive one', () => {
  expect(fibonacci(1)).toBe(1);
});
\`\`\`


Ya tenemos el siguiente test fallando. El siguiente paso obvio es escribir una peque√±a expresi√≥n con un condicional para una entrada con n = 0 devuelva 0 y para n = 1 devuelva 1:

\`\`\`javascript
function fibonacci(n) {
  if(n ==0)
    return  0;
  else
   return  1;
}
\`\`\`


Puedes acceder al ejemplo interactivo [desde aqu√≠.](https://repl.it/@SoftwareCrafter/TDD-Fibonnacci-1)

Como puedes observar, la t√©cnica de la implementaci√≥n falsa nos ayuda a progresar poco a poco. Principalmente tienes dos ventajas inherentes, la primera es a nivel psicol√≥gico, ya que se hace m√°s llevadero tener algunos test en verde, en vez de en rojo, que nos permitan ir dando pasos peque√±os hacia la soluci√≥n. La segunda tiene que ver con el control del alcance, ya que esta pr√°ctica nos permite mantener el foco en el problema real, evitando caer en optimizaciones prematuras.

### Triangular

Triangular, o la t√©cnica de la triangulaci√≥n, es el paso natural que sigue a la t√©cnica de la implementaci√≥n falsa. Es m√°s, en la mayor√≠a de los contextos, forma parte de la triangulaci√≥n, bas√°ndose en lo siguiente:

1. Escoger el caso m√°s simple que debe resolver el algoritmo.
2. Aplicar *Red-Green-Refactor*.
3. Repetir los pasos anteriores cubriendo las diferentes casu√≠sticas.

Para comprender c√≥mo funciona la triangulaci√≥n, vamos a continuar desarrollando el ejemplo de Fibonacci, el cual, en parte, ya hemos empezado a triangular. El siguiente caso que podr√≠amos cubrir es para n = 2.

\`\`\`javascript

it('return one if receive two‚Äô, () => {
  expect(fibonacci(2)).toBe(1);
});
\`\`\`


Puedes acceder al ejemplo interactivo [desde aqui.](https://repl.it/@SoftwareCrafter/TDD-Fibonnacci-2)

En esta ocasi√≥n el test pasa, por lo tanto, nuestro algoritmo tambi√©n funciona para n = 2. El siguiente paso ser√≠a comprobar qu√© ocurre para n = 3.

\`\`\`javascript
it('returns two if receive three', () => {
  expect(fibonacci(3)).toBe(2);
});
\`\`\`


Como supon√≠amos, el test falla. Este paso nos ayudar√° a aproximarnos a la implementaci√≥n de una soluci√≥n m√°s gen√©rica. Ya que podr√≠amos crear una implementaci√≥n falsa para n = 3 y a√±adir otro condicional que devuelva 1 para n = 1 y n = 2.

\`\`\`javascript
function fibonacci(n) {
  if(n == 0)
    return  0;
  if(n == 1 || n == 2)
    return  1;
  else
    return  2; 
}
\`\`\`

Puedes ver el ejemplo interactivo [desde aqu√≠](https://repl.it/@SoftwareCrafter/TDD-Fibonnacci-3).

Ahora que tenemos los test pasando, vamos a comprobar qu√© sucede para n = 4:

\`\`\`javascript
it('returns three if receive four', () => {
  expect(fibonacci(4)).toBe(3);
});
\`\`\`

Al llegar a este punto, ya te habr√°s dado cuenta de que ser√≠a m√°s f√°cil escribir la implementaci√≥n obvia que seguir haciendo ramas de decisi√≥n:

\`\`\`javascript
function fibonacci(n) {
  if(n == 0)
    return 0;
  
  if(n == 1 || n == 2)
    return 1;
  
  else
    return fibonacci(n - 1) + fibonacci(n - 2);
}
\`\`\`

En este paso, nuestro algoritmo funciona para cualquier valor de n, aunque a√∫n podemos refactorizarlo para eliminar duplicidades y darle un aspecto m√°s funcional:

\`\`\`javascript
function fibonacci(n) {
  const partialFibonacci = (n) => 
    n == 1
      ? 1
      : fibonacci(n - 1) + fibonacci(n - 2)

  return n == 0
    ? 0
    : partialFibonacci(n)
}
\`\`\`

Puedes acceder al ejemplo interactivo [desde aqu√≠](https://repl.it/@SoftwareCrafter/TDD-Fibonnacci-4).

Con este √∫ltimo paso hemos resuelto el algoritmo de Fibonacci aplicando un enfoque funcional y utilizando la triangulaci√≥n. Quiz√°s en un hipot√©tico siguiente paso deber√≠amos eliminar los test para n=3, n=4 y n=5, ya que en este punto no aportan demasiado valor, y crear un test que compruebe el algoritmo generando un n√∫mero aleatorio mayor que 2 cada vez que se ejecuta.

Como puedes observar, la triangulaci√≥n es una t√©cnica muy conservadora para aplicar TDD, su uso tiene sentido cuando no tenemos clara la implementaci√≥n obvia de la soluci√≥n.

### Implementaci√≥n obvia

Cuando la soluci√≥n parece muy sencilla, lo ideal es escribir la implementaci√≥n obvia en las primeras iteraciones del ciclo *Red-Green-Refactor*.

La problem√°tica con esto surge cuando nos precipitamos, creyendo que se trata de un problema sencillo, cuando en realidad no lo es, porque tiene, por poner un ejemplo, alg√∫n caso *edge* sobre el que no hab√≠amos reflexionado.

## Limitaciones del TDD


Por muchos beneficios inherentes que tenga (o que nos prometan), la t√©cnica del TDD no debe entenderse como una religi√≥n ni como una f√≥rmula m√°gica que vale para todo. Seguir TDD a rajatabla y en todos los contextos no garantiza que tu c√≥digo vaya a ser m√°s tolerante al cambio, robusto o seguro, ni siquiera te asegura que vayas a ser m√°s productivo a la hora de dise√±ar *software*.

Desde mi punto de vista, aplicar TDD no encaja bien en todos los contextos. Por ejemplo, si existe una implementaci√≥n obvia para un caso de uso, directamente la escribo y luego hago las pruebas. En el caso de estar trabajando en el *frontend* tampoco me planteo hacer TDD para dise√±ar componentes de la *UI*. Incluso es discutible si se deber√≠an hacer test unitarios para probar elementos de la *UI*, desarrolladores de la talla de Ward Cunningham han comentado repetidas veces que no conviene hacer test automatizados sobre esta, ya que es muy cambiante y los test quedan desactualizados con demasiada frecuencia.

Mi consejo es que pruebes, trates de aplicarlo en tu d√≠a a d√≠a durante una temporada y luego decidas por ti mismo. 

Recuerda que esta entrada es un extracto de la secci√≥n de testing y TDD de nuestro libro [Clean Code, SOLID y Testing aplicado a JavaScript](https://softwarecrafters.io/ebook-cleancode-javascript). Si te ha gustado, valora y comparte en tus redes sociales. No dudes en comentar dudas, aportes o sugerencias. ¬°Estar√© encantado de responder!",
    "slug": "tdd-test-driven-development",
    "tags": [
      "javascript",
    ],
    "title": "TDD (Test Driven Development). Desarrollo dirigido por pruebas",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "css",
    "cover": "https://swcrafters.fra1.digitaloceanspaces.com/Categories/css_category.png",
    "date": "",
    "description": "¬°Me encanta CSS! Quien me conoce lo sabe, seguro que se notar√° en este art√≠culo, y estoy orgulloso de ello. No pienso entrar en la guerra de si es un lenguaje de programaci√≥n o no",
    "id": "css-craftsmanship",
    "markdownBody": "**¬°Me encanta CSS!**. Quien me conoce lo sabe, seguro que se notar√° en este art√≠culo, y estoy orgulloso de ello. No pienso entrar en la guerra de si es un lenguaje de programaci√≥n o no. Para m√≠ es un lenguaje de estilos y "ATENCI√ìN SPOILER" **CSS es parte de la Web**. Es por ello que me sorprende la gran cantidad de personas que se definen como Frontends o FullStack pero dicen: "Ah! no, yo CSS no lo toco, eso no es programar".

Esa frase da para otro art√≠culo, pero no quiero desviarme del objetivo de este, hablar de CSS para Crafters. S√≠, me permito a√±adir la palabra crafters (artesano/a) junto a CSS. Y espero que al final del art√≠culo consiga convencerte de que realmente podemos a√±adir artesan√≠a a cualquier cosa que queramos trabajar de forma cuidadosa.

## ¬øQu√© es el CSS para Crafters?

### CSS

Hojas de Estilo en Cascada (del ingl√©s Cascading Style Sheets) o CSS es el lenguaje de estilos utilizado para describir la presentaci√≥n de documentos HTML o XML _(incluyendo varios languages basados en XML como SVG, MathML o XHTML)_. CSS describe como debe ser renderizado el elemento estructurado en la pantalla, en papel, en el habla o en otros medios. - [MDN web docs](https://developer.mozilla.org/es/docs/Web/CSS)

### Artesania de software

Artesan√≠a se refiere tanto al trabajo de la persona artesana (crafter), como al objeto o producto obtenido en el que cada pieza es distinta a las dem√°s. - [Wikipedia](https://es.wikipedia.org/wiki/Artesan%C3%ADa)

Pero en nuestro contexto vamos a hacer referencia a la Artesan√≠a de Software seg√∫n la definici√≥n del manifiesto de la [Artesan√≠a de Software](http://manifesto.softwarecraftsmanship.org/#/es).

Veamos una lista de las cosas a tener en cuenta y herramientas que tenemos disponibles para ser aut√©nticas/os artesanas/os del CSS.

- [CSS Styleguides](#css-styleguides)
- [CSS Naming](#css-naming)
- [CSS Architecture](#css-architecture)
- [CSS Testing](#css-testing)
- [CSS Frameworks](#css-frameworks)
- [CSS Knowledges](#css-knowledges)
- [CSS for Developers](#css-for-developers)
- [CSS Tools](#css-tools)
- [CSS Audits](#css-audits)
- [CSS Refactor](#css-refactor)
- [CSS Books](#css-books)
- [Conclusiones](#conclusiones)

## CSS Styleguides

Como en cualquier otro lenguaje de programaci√≥n, existen gu√≠as de estilos. Tiene todo el sentido, ya que una gu√≠a de estilo no es m√°s que una convenci√≥n para escribir c√≥digo legible, mantenible y escalable por uno o varios equipos.

Hay varias gu√≠as de estilos en CSS, y todas ellas propuestas por gente muy influyente en el desarrollo de la web.

- [Idiomatic CSS](https://github.com/necolas/idiomatic-css) _(Nicolas Gallagher)_
- [CSS Guidelines](https://cssguidelin.es/) _(Harry Roberts)_
- [Code Guide](https://codeguide.co/) _(Mark Otto)_
- [Primer](https://github.com/primer) _(GitHub)_
- [Airbnb CSS](https://github.com/airbnb/css) _(Airbnb Engineers)_
- [Sass Guidelines](https://sass-guidelin.es/) _(Hugo Giraudel)_

> Un ejemplo de sintaxis

\`\`\`css
/* Bad CSS */
.selector, .selector-secondary, .selector[type=text] {
  padding:15px;
  margin:0px 0px 15px;
  background-color:rgba(0, 0, 0, 0.5);
  box-shadow:0px 1px 2px #CCC,inset 0 1px 0 #FFFFFF
}

/* Good CSS */
.selector,
.selector-secondary,
.selector[type="text"] {
  padding: 15px;
  margin-bottom: 15px;
  background-color: rgba(0,0,0,.5);
  box-shadow: 0 1px 2px #ccc, inset 0 1px 0 #fff;
}
\`\`\`

No hay una mejor que otra. Como he comentado antes son convenciones, reglas a seguir por las personas que forman parte del equipo. Por lo que nos tenemos que sentir c√≥modas, ser √°giles y pracm√°ticas. He trabajado en varios equipos, y proyectos, he utilizado casi todas ellas. Es una decisi√≥n de equipo, pero eso s√≠, una vez hemos decidido una (ya sea una de ellas o una mezcla de varias) debemos ser consistentes y aplicarla en nuestro desarrollo.

Hoy en d√≠a es una tarea muy simple, ya que podemos configurar el linter para que al guardar los cambios nos "reformatee" el c√≥digo seg√∫n las reglas que hayamos decidido seguir. Aqu√≠ encontrar√©is las que estamos utilizando en [SUI Components](https://github.com/SUI-Components/sui/blob/master/packages/sui-lint/stylelint.config.js), utilizando Sass como preprocesador.

## CSS Naming {#css-naming}

En CSS no nos podemos librar de uno de [los dos grandes problemas en las Ciencias de la Computaci√≥n](https://martinfowler.com/bliki/TwoHardThings.html), nombrar cosas. Si llevas un tiempo en el desarrollo seguro que te has llevado m√°s de una sorpresa con el nombrado de variable, funciones o clases.

A la hora de desarrollar en las hojas de estilo tenemos el mismo problema, tanto para el nombrado de selectores de clases, las [custom properties](https://developer.mozilla.org/es/docs/Web/CSS/Using_CSS_custom_properties), como las variables, funciones o mixins de los preprocesadoes, que nos ofrecen una sintaxis de programaci√≥n.

Como soluci√≥n a estos problemas aparecen una serie de convenciones para, como en el punto anterior, conseguir un c√≥digo m√°s legible, mantenible y escalable. Vamos a ver algunas de ellas (algunas muy conocidas y otras no tanto)

- [OOCSS](https://github.com/stubbornella/oocss/wiki) _(Nicole Sullivan)_
- [SMACSS](http://smacss.com/) _(Jonathan Snook)_
- [BEM](https://en.bem.info/) _(Yandex)_
- [BEMIT](https://csswizardry.com/2015/08/bemit-taking-the-bem-naming-convention-a-step-further/) _(Harry Roberts)_
- [SUIT CSS](https://github.com/suitcss/suit/blob/master/doc/naming-conventions.md) _(Nicolas Gallagher)_
- [Modular CSS naming conventions](http://thesassway.com/advanced/modular-css-naming-conventions) _(The Sass Way)_
- [NCSS](https://ncss.io/) _(Henry Ruhs)_

La primera en ver la luz (2009) fue OOCSS de [Nicole Sullivan](https://twitter.com/stubbornella), donde Nicole ofrec√≠a una nomenclatura orientada a objeto, extendiendo las clases.

> Un ejemplo de la propuesta de Nicole

\`\`\`css
.media {
  @extend %baseSpacing;
  @include clearfix-me(micro);
  > .mediaImg {
    float: left;
    margin-right: 10px;
    > img {
      display: block;
    }
  }
  > .mediaImgExt {
    float: right;
    margin-left: 10px;
    margin-right: 0;
  }
  > .mediaBody {
    @include clearfix-me(facebook);
  }
}
\`\`\`

Pero la m√°s popular ha sido [BEM](https://en.bem.info/methodology/naming-convention/) (Block Element Modifier) del equipo de desarrollo de [Yandex](https://yandex.com/) _(la versi√≥n Rusa de Google)_. La popularidad que ha ganado BEM, en mi opini√≥n, se debe a la simplicidad de la soluci√≥n y a la gran documentaci√≥n disponible desde el principio. Una de las cosas que supieron hacer es reaccionar a las peticiones de la comunidad y adaptar las ["Naming rules"](https://en.bem.info/methodology/naming-convention/#naming-rules) a unas ["Alternative naming schemes"](https://en.bem.info/methodology/naming-convention/#alternative-naming-schemes).

Personalmente he utilizado BEM en m√°s de un proyecto y en cuanto lo hemos utilizado en un equipo, hemos llegado a hacer alguna modificaci√≥n para sentirnos c√≥modos. Recordad que son convenciones, las podemos adaptar a nuestras necesidades.

> Un ejemplo de implementaci√≥n de BEM

\`\`\`html
<ul class="menu">
  <li class="menu__item">...</li>
  <li class="menu__item">...</li>
  <li class="menu__item menu__item_size_m">...</li>
</ul>
\`\`\`

\`\`\`css
/* Block */
.menu { ... }

/* Element */
.menu__item { ... }

/* Modifier */
.menu__item_size_m { ... }
\`\`\`

En [SUI Components](https://github.com/SUI-Components/sui-components) y los productos de [Adevinta Spain](https://www.adevinta.com/es/spain/) estamos utilizando [SUIT CSS](https://github.com/suitcss/suit/blob/master/doc/naming-conventions.md) de [Nicolas Gallagher](https://twitter.com/necolas). Llegamos a la conclusi√≥n de utilizar esta convenci√≥n porque tiene un enfoque orientado a componente y creemos que ganamos en legibilidad. Cosa que es de agradecer en proyectos de gran tama√±o y con un equipo de gente grande.

> Ejemplo de implementaci√≥n de SUIT CSS

\`\`\`html
<div class="sui-AtomCard">
  <div class="sui-AtomCard-media"> ... </div>
  <div class="sui-AtomCard-info"> ... </div>
</div>
\`\`\`

\`\`\`css
/* ComponentName */
.sui-AtomCard {
  /* Descendent Name */
  &-media { ... }
  &-info { ... }

  /* Modifier Name */
  &--vertical { ... }
  &--responsive { ... }

  /* State Of Component */
  &.is-highlight { ... }
}
\`\`\`

Como se puede apreciar, hemos optado por a√±adir un prefijo, eso nos ayuda a identificar el scope del componente. En esta captura del HTML de la web de [Coches.net](https://www.coches.net/), podemos ver componentes de Motor \`mt\` dentro de componentes SUI \`sui\`.

![Componentes de Motor dentro de componentes SUI](https://user-images.githubusercontent.com/1307927/95793455-e8efb600-0ce5-11eb-817b-6a174b5c7dc0.png)

Como pod√©is ver hay varias convenciones, igual que en las Styleguides, no hay ninguna mejor que otra, simplemente hay que decidir usar una convenci√≥n. En nuestro caso, tuvimos varias reuniones _(hace ya unos a√±os)_ frontends de todos los productos, para conseguir alinearnos y llegar a una convenci√≥n s√≥lida, y lo m√°s importante, c√≥moda para todas las personas.

## CSS Architecture

¬øC√≥mo?, ¬øarquitectura en CSS?, as√≠ es. A mucha gente le sorprende escuchar hablar de arquitectura en CSS, pero en nuestro contexto, arquitectura se refiere a c√≥mo est√°n organizados los recursos, conectadas las dependencias entre ellos, la comunicaci√≥n, incluso incluimos bajo el mismo paraguas la escalabilidad. Y todos esos temas se deben tener en cuenta a la hora de desarrollar la parte del c√≥digo que nos ayuda a estilizar la informaci√≥n que consumir√°n las/os usuarias/os.

Aqu√≠ hay que tener algunas cosas en cuenta. Si optamos, o el proyecto en el que trabajamos, usa [CSS in JS](https://octuweb.com/css-in-js/), los estilos estar√°n incluidos dentro del componente JavaScript. En este caso la parte de arquitectura queda limitada a algunos estilos globales. As√≠ que en nuestro caso vamos a enfocarlo desde el punto de vista que el CSS lo tenemos en otra capa de la aplicaci√≥n.

De la misma manera que para las Styleguides y el Naming, gente referente en la comunidad frontend, han definido propuestas de c√≥mo resolver el tema de la arquitectura CSS.

- [OOCSS](https://github.com/stubbornella/oocss/wiki) _(Nicole Sullivan)_
- [SMACSS](http://smacss.com/) _(Jonathan Snook)_
- [Atomic Design](https://bradfrost.com/blog/post/atomic-web-design/) _(Brad Frost)_
- [7-1 Pattern](https://sass-guidelin.es/#architecture) _(Hugo Giraudel)_
- [ITCSS](https://itcss.io/) _(Harry Roberts)_
- [haiticss](https://github.com/haiticss/haiticss) _(Dani Fornells)_

Aqu√≠ seguro que os llamar√° la atenci√≥n que los dos primeros puntos se repiten. Eso es porque las propuestas de Nicole y Jonathan incluyen convenci√≥n de nombres y de arquitectura.

SMACSS (Scalable and Modular Architecture CSS) de [Jonathan Snook](https://twitter.com/snookca) gan√≥ popularidad, y gran parte de esa popularidad fue gracias a que Jonathan public√≥ un libro, el cual ahora puedes [descargar](http://smacss.com/) de forma gratuita.

Us√© la propuesta de SMACSS en un par de proyectos, pero me dej√© llevar por la tendencia seguida por mucha gente de utilizar el 7-1 Pattern, donde [Hugo Giraudel](https://twitter.com/hugogiraudel) propon√≠a la siguiente estructura.

\`\`\`sh
base/
components/
layout/
pages/
themes/
abstracts/
vendors/
main.scss
\`\`\`

> 7 carpetas definiendo la estructura de carpetas y un solo punto de entrada, de ah√≠ su nombre **7-1 Pattern**.

La propuesta de [Brad Frost](https://twitter.com/brad_frost) con **[Atomic Design](https://bradfrost.com/blog/post/atomic-web-design/)** es muy similar.

\`\`\`sh
base/
atom/
molecule/
organism/
template/
page/
style.scss
\`\`\`

Este es otro caso de √©xito de una propuesta apoyada por un libro, una buena documentaci√≥n, un mont√≥n de charlas e incontables art√≠culos hablando sobre este enfoque de Dise√±o At√≥mico.

Esta es la arquitectura que estamos utilizando en [SUI Components](https://github.com/SUI-Components/sui-components/tree/master/components), la cual nos encaja por el mismo enfoque que se est√° haciendo desde el departamento de UX/UI.

No quiero dejar de comentar la propuesta de [Harry Roberts](https://twitter.com/csswizardry), ITCSS (Invert Triable CSS), ya que he hecho [algunas charlas](https://slides.com/joanleon/arquitectura-itcss) y un curso hablando de esta arquitectura. He de confesar que en cuanto la conoc√≠, me gust√≥, y comet√≠ el gran error _(luego me di cuenta)_ de quererlo aplicar en todos los proyectos. Incluso hice la propuesta de aplicarla en los productos de la empresa, pero no era la mejor opci√≥n. Un **cambio** de arquitectura sin necesidad, un proyecto grande con mucha gente a la que hacer una formaci√≥n, cambiar el chip. Y como ya sabemos, las personas, por naturaleza son reacias al cambio. As√≠ que no fu√© m√°s all√° de implementarlo en un par de proyectos en los que colabor√©.

> La manera m√°s r√°pida de entender el enfoque de ITCSS es con este gr√°fico

![ICSS](https://user-images.githubusercontent.com/1307927/95793441-e2f9d500-0ce5-11eb-949e-9cdc24275a22.png)

## CSS Functional _(Utility-first)_

Functional CSS _(en el t√≠tulo mantengo el patr√≥n del resto ü§∑üèΩ‚Äç‚ôÇÔ∏è)_, tambi√©n conocido como Utily-first CSS, tambi√©n lo podemos definir como una arquitectura CSS, pero lo he querido separar del resto por el enfoque tan controvertido y por la etiqueta de "anti-pattern" que r√°pidamente le fu√© otorgada por la comunidad frontend. He de confesar que yo estuve entre la comunidad que pensaba (mucha gente lo sigue pensando) que su planteamiento acopla la capa de estilos a la capa de presentaci√≥n.

En mi opini√≥n, creo que esto pasa continuamente, cuando hay alguien que plantea un nuevo enfoque por naturaleza rechazamos el cambio. Y m√°s a√∫n si ese cambio nos implica modificar la manera de c√≥mo hacemos las cosas. Para poder formarnos una opini√≥n tenemos que documentarnos, entender el motivo que ha llevado a que alguien plantee algo que a priori parece tan disruptivo. Eso es lo que hizo [Sarah Dayan](https://twitter.com/frontstuff_io) en su art√≠culo [In Defense of Utility-First CSS](https://frontstuff.io/in-defense-of-utility-first-css), en √©l encontrar√°s frases como:

> ‚ÄúFavor composition over inheritance‚Äù. This piece of wisdom from Design Patterns, one of the most influential software engineering books, is the foundation of utility-first CSS. It also shares many principles with functional programming: immutability, composability, predictability, and avoidance of side-effects. The goal behind all those fancy terms is to write code that‚Äôs easier to maintain and to scale.

> BEM encourages you to use modifiers to handle component variations. This may seem smart at first, yet unfortunately leads up to other problems: you end up creating tons of modifiers you only use once for a specific use-case.

Tanto si te planteas utilizar Utility-first CSS como si no, te aconsejo leer el art√≠culo de Sarah, ya que te abrir√° la mente y te ayudar√° a poder argumentar los motivos de usarlo o no usarlo en tu pr√≥ximo proyecto.

Si filtramos en GitHub por el _topic_ [#functional-css](https://github.com/topics/functional-css) podremos ver que hay una gran cantidad de proyectos. En el top 3 podemos encontrar los frameworks [tailwindcss](https://tailwindcss.com/), [Tachyons](https://tachyons.io/) y [Basscss](https://basscss.com/).

Es muy probable que te suenen los dos primeros, ambos disponen de una gran documentaci√≥n y comunidad. A **Basscss** le tengo cierto aprecio porque [Brent Jackson](https://twitter.com/jxnblk) ya apost√≥ por este enfoque con [Basscss-sass](https://github.com/basscss/basscss-sass) en el 2015.

Veamos un ejemplo de implementaci√≥n de **tailwindcss**.

\`\`\`html
<div class="md:flex bg-white rounded-lg p-6">
  <img class="h-16 w-16 md:h-24 md:w-24 rounded-full mx-auto md:mx-0 md:mr-6" src="avatar.jpg">
  <div class="text-center md:text-left">
    <h2 class="text-lg">Erin Lindford</h2>
    <div class="text-purple-500">Product Engineer</div>
    <div class="text-gray-600">erinlindford@example.com</div>
    <div class="text-gray-600">(555) 765-4321</div>
  </div>
</div>
\`\`\`

> Este es el ejemplo de c√≥mo, con el patr√≥n composici√≥n, podemos encontrar en la home de su site.

Antes de juzgar la legibilidad, si eso es lo mismo que escribir estilos en l√≠nea **(que NO lo es)** u opinar sobre la escalabilidad que tiene un desarrollo as√≠, por favor, echa un vistazo al art√≠culo de Sarah.

## CSS Testing

Lo primero que debemos aclarar es que el Testing en CSS se aleja mucho del Testing que conocemos en los lenguajes de programaci√≥n. S√≠, lo s√©, con los preprocesadores podemos hacer tests tal y como los conocemos, ya que nos ofrecen una sintaxis, un compilador con gesti√≥n de errores y con resultados predecibles. Por ejemplo, para Sass podemos utilizar [True](https://github.com/oddbird/true) un framework que nos permite implementar test unitarios en el c√≥digo Sass de nuestros proyectos.

Otro punto, y quiz√°s el m√°s importante, es que debemos tener claro que el CSS NO se renderiza igual en todos los navegadores. Si no me crees, puedes entrar en esta web [Do websites need to look exactly the same in every browser?](http://dowebsitesneedtolookexactlythesameineverybrowser.com/) üòä.

> Ten√≠a pensado a√±adir una imagen con los iconos de los navegadores, pero el primer error es pensar que no dejar√© ninguno fuera. Hoy en d√≠a existen m√°s navegadores de los que creemos, en [Cam I Use](https://caniuse.com/usage-table) podemos ver una lista de la cantidad de navegadores y versiones.

Seguro que llegado a este punto, puede que pienses que no tiene mucho sentido el testing en CSS, pero deja que te explique las opciones que tenemos disponibles desde el punto de vista de CSS y renderizado en el navegador, ya hemos visto que en los preprocesadores s√≠ que tenemos opci√≥n de desarrollar tests unitarios.

### Manual Testing

Como desarrolladores, es complicado hacerse a la idea que a estas alturas debemos hacer testing manual. Ya no por la tarea en s√≠ de tener que probar una nueva funcionalidad en diferentes navegadores y dispositivos, sino por el peligro a error en la revisi√≥n. Es una balanza complicada de equilibrar, por un lado tenemos el trabajo y el riesgo a errores, pero por el otro est√° el validar que nuestras/os usuarias/os no tendr√°n una mala experiencia al utilizar nuestra aplicaci√≥n.

Es realmente sorprendente a la vez que esperanzador, ver que la propia W3C tiene test manuales para validar el funcionamiento esperado de las nuevas funcionalidades que poco a poco van adoptando los navegadores, lo podemos encontrar en las [Test suites for Web-platform specs](https://github.com/web-platform-tests/wpt) o incluso personas tan referentes en el mundo web como [Eric Meyer](https://twitter.com/meyerweb), donde podemos ver en su repositorio [css-tests](https://github.com/meyerweb/css-tests) una gran cantidad de tests.

Aun siendo una tarea tediosa, la validaci√≥n manual, nos permite asegurarnos que podemos ver correctamente renderizado ese componente de una nueva funcionalidad. Eso s√≠, asumiendo que ser√° imposible llegar a todos los dispositivos y de una manera actualizada.

### Automatic Testing

Existen varias herramientas para poder validar que no hemos roto nada al desplegar una nueva funcionalidad, cambio de copy o al eliminar un test A/B.

Posiblemente la herramienta de testing en el navegador sea [BrowserStack](https://www.browserstack.com/) que nos permite hacer integraci√≥n con diferentes entornos de despliegue, automatizaci√≥n de frameworks, gestores de proyectos o herramientas de desarrollo, echa un vistazo a la [larga lista](https://www.browserstack.com/integrations). Es un servicio de pago, pero creo que muy asumible teniendo en cuenta el gran beneficio que nos aporta.

Hay m√°s, como [Sauce Labs](https://saucelabs.com/) o [Browserling](https://www.browserling.com/) pero no los conozco.

El servicio que s√≠ he utilizado y me parece una gran herramienta para validar e-mails es [Litmus](https://www.litmus.com/). Nos permite tener una previsualizaci√≥n de nuestra plantilla de mail en un mont√≥n de clientes de correo y en varias versiones.

### CSS Regression Testing

Otra opci√≥n que tenemos es basar nuestros test en **Visual Regression Testing**, hace un tiempo (2016) d√≠ una charla en [Software Crafters Barcelona](http://slides.com/joanleon/css-regression-testing/) donde habl√© de varias herramientas para ello.

En aquel momento la herramienta m√°s completa (IMHO) era [PhantomCSS](https://github.com/HuddleEng/PhantomCSS), proyecto que ya est√° archivado. Actualmente la herramienta m√°s completa para implementar un sistema de Visual Regression Testing con CLI es [Puppeteer](https://pptr.dev/).

El sistema de regresi√≥n visual consiste en guardar un snapshot, imagen en formato PNG, y comparar entre las im√°genes los cambios a nivel de pixel.

![Visual Regression Testing](https://user-images.githubusercontent.com/1307927/95793464-ed1bd380-0ce5-11eb-9b8f-30bb59038656.jpg)

Este tipo de test tiene un alto porcentaje de falsos positivos, ya que como podemos ver en el ejemplo los cambios pueden ser intencionados, ya que estamos capitalizando el t√≠tulo de ese bloque.

Seguro que he conseguido desanimarte con todo esto de los test en CSS, pero no pasa nada, est√° bien darse cuenta que esto de CSS va m√°s all√° de convertir los dise√±os a colores hexadecimales.

Por suerte es un sector que va avanzando poco a poco. En el caso de que est√©s utilizando [Storybook](https://storybook.js.org/), existe un plugin llamado [chromatic](https://www.chromatic.com/) que te permitir√° automatizar los tests de regresi√≥n visual a nivel de componente.

En la reciente [JamStackConf 2020](https://jamstackconf.com/), [Angie Jones](https://twitter.com/techgirl1908) di√≥ una charla ["Adding Eyes to your Automation Framework"](https://www.youtube.com/watch?v=spyKZ-p3UgE&ab_channel=JamstackConf) hablando de [Eye](https://applitools.com/products-eyes/) un servicio que apoy√°ndose en Inteligencia Artificial promete dar soluci√≥n a todas las lagunas que nos hemos encontrado hasta ahora.

As√≠ que creo que no tardaremos mucho en olvidar lo complicado que es validar que no se est√° rompiendo nada cuando hacemos cambios o a√±adimos CSS en nuestras nuevas funcionalidades.

## CSS Frameworks

Quiero empezar esta secci√≥n recomendando una gran charla de una amiga, [You might not need a CSS framework](https://www.youtube.com/watch?v=kED5eDjMfGM) de [Bel√©n Albeza](https://www.belenalbeza.com/), donde nos habla de que no tenemos la necesidad de utilizar un framework CSS, luego dar√© mi opini√≥n sobre este punto de vista.

Mi primer recuerdo de un framework CSS me lleva a [960 Grid System](https://960.gs/), he tenido la curiosidad de ver la fecha de inicio y he encontrado el [primer commit](https://github.com/nathansmith/960-Grid-System/commit/0d61cf12e44bacc100f25c08b8b1dcc00b39b0d3) _(Dec 20, 2009)_ en el repositorio, pero es de la versi√≥n 1.4. Hay personas que ya est√°bamos codeando antes del nacimiento de GitHub üòÖ.

### Objetivo de los frameworks CSS

Los frameworks CSS, como la mayor√≠a de lenguajes y herramientas que utilizamos d√≠a a d√≠a, surgen de la necesidad de solucionar un problema puntual en un proyecto, sin un objetivo comercial. Simplemente para poder ser m√°s √°giles a la hora de resolver el mismo problema en cada proyecto. Muchas personas ya ten√≠amos nuestras "cajas de herramientas" sin saber que est√°bamos construyendo un framework, simplemente ten√≠amos estructura y fragmentos de c√≥digo que utilizamos en cada nuevo proyecto.

El nacimiento de los frameworks hizo mucho m√°s f√°cil que la informaci√≥n se presentara con m√°s coherencia, con m√°s dise√±o. Eso los populariz√≥ de forma r√°pida.

**EL FRAMEWORK CSS** es [Boostrap](https://getbootstrap.com/), durante mucho tiempo era f√°cil reconocer que una web estaba utilizando Bootstrap sin mirar el c√≥digo fuente. La mejor baza del creador de Bootstrap [Mark Otto](https://twitter.com/mdo) fue **la documentaci√≥n**. Una documentaci√≥n donde cualquier persona solo ten√≠a que incluir el archivo CSS en el proyecto y con un simple a la vez que poderoso \`Copy & Paste\` de la estructura HTML del "componente" necesario, ten√≠amos funcionando una web en unas horas. Curiosamente se ve√≠a aparentemente igual en todos los navegadores.

Hay muchos, muchos frameworks CSS. Cada a√±o aparecen varios art√≠culos del estilo "XX Best CSS Frameworks in 20XX", un ejemplo de ello puede ser este [Best CSS Frameworks in 2020](https://dev.to/theme_selection/best-css-frameworks-in-2020-1jjh).

Hay frameworks que nos definen m√°s el aspecto gr√°fico, como es el caso de [Materialize](https://materializecss.com/) basado en [Material](https://material.io/design) de Google, donde nos facilitan una interfaz, layout e interacciones pensadas para aplicaciones Android. [Bulma](https://bulma.io/) suele estar en el top 10 de las listas de frameworks CSS, su popularidad la gan√≥ por ser uno de los frameworks que bas√≥ su layout en Flexbox. Y otro que tambi√©n est√° en el top 5 o 3 (seg√∫n la lista) es [tailwindcss](https://tailwindcss.com/), el cual tiene un enfoque de composici√≥n en el lado de HTML, como ya hemos visto en la secci√≥n de arquitectura.

> Hay muchos, y no es el objetivo de este art√≠culo nombrarlos o analizarlos todos. Si te interesa profundizar en ellos, puedes echar un vistazo a este art√≠culo [100+ Best CSS Frameworks For Responsive Design](https://cssauthor.com/css-frameworks/)

### Mi opini√≥n sobre los frameworks CSS

Como he comentado, aparecen para resolver problemas o funciones concretas, as√≠ que no pueden resolver todos los casos. Un claro ejemplo de ello es [NES.css](https://nostalgic-css.github.io/NES.css/), un framework CSS que emula el estilo de una NES de 8bits, es genial, me encanta, lo podr√≠a usar como tema en un blog, la web de un juego pixelart, pero no lo veo como imagen de un producto o eCommerce. Pueden estar bien para un MVP, una landing con objetivos de SEO, un side project, un gestor de contenidos _(yo he usado bootstrap en dos proyectos de gesti√≥n)_. Pero creo que no es una buena opci√≥n para un producto digital. Los productos evolucionan, se tienen que adaptar a nuevas necesidades, nuevos dispositivos.

Personalmente he sido reacio a utilizar frameworks CSS por mi sensaci√≥n de falta de control. Creo que se debe a que prefiero tener conocimiento de CSS que a conocer la API de un framework, donde adem√°s s√© lo que hacen las propiedades CSS que se esconden detr√°s de una clase.

Durante un tiempo estuve leyendo muchos de esos frameworks, ten√≠a una carpeta con los repositorios con los que me interesaba analizar. Incluso me cre√© un [alias](https://gist.github.com/nucliweb/c2163e31029255d068eb) para poder mantener todos los repositorios actualizados.

![Listado de Frameworks CSS](https://user-images.githubusercontent.com/1307927/95793467-f016c400-0ce5-11eb-8b8e-dea436999d98.png)

Muy friki s√≠, pero ah√≠ estaba yo, analizando estructuras, nombres de clases, c√≥digo, o c√≥mo consegu√≠a Bootstrap que un bot√≥n se viera igual en todos los navegadores (la magia est√° en el \`line-height\`). En algunos proyectos yo ten√≠a que definir la arquitectura, naming y escalabilidad del c√≥digo CSS. Y la verdad, qui√©n soy yo frente a un mont√≥n de gente ingeniera que estaba ofreciendo soluciones globales a problemas concretos. Puede ser que en este momento est√©s pensando, vaya, Joan lo que hac√≠a es copiar (o como un compa√±ero dise√±ador dec√≠a: "creatividad asociativa") el c√≥digo de los frameworks. No, deja que me explique.

He hecho varios cursos en formaciones online, y me di cuenta que siempre repet√≠a la misma frase "Me gusta tener el control". Y hablo de un control de saber qu√© y porqu√© est√° renderizando eso el navegador. Tener referencias para aprender es b√°sico, aprendemos as√≠ cualquier cosa que estudiemos.

As√≠ que mi opini√≥n es que debemos tener el conocimiento suficiente como para poder crear nuestro propio framework. Esto nos permitir√° valorar si uno de los frameworks disponible nos puede ayudar (siempre hay que ser pragm√°tico), si con algunas variaciones de uno de ellos (que hoy en d√≠a muchos ofrecen) nos vale o si tenemos que crear nuestro propio framework para poder tener el control total del producto que estamos creando.

## CSS Knowledges

Tener conocimientos de CSS es b√°sico. CSS forma parte de la web [#cssIsPartOfTheWeb](https://twitter.com/hashtag/cssIsPartOfTheWeb).

No quiero ganarme enemigas/os con lo que voy a decir, aunque no me importa si con ello consigo dar visibilidad de lo importante que es tener conocimiento CSS: **"Si CSS es tan f√°cil, ¬øpor qu√© hay tanta gente que no lo conoce?**.

Existe un comit√©, el [CSS Working Group](https://wiki.csswg.org/) con un [grupo de gente](https://www.w3.org/Style/CSS/members.en.html) muy top que forman parte de muchas compa√±√≠as punteras en el desarrollo de software. Una de las personas m√°s influyentes en las especificaciones de CSS, [fantasai](https://twitter.com/fantasai), escribi√≥ el art√≠culo [about:csswg](http://fantasai.inkedblade.net/weblog/2011/inside-csswg/) explicando c√≥mo funciona el **CSSWG**.

IMHO, el primer sitio donde tenemos que mirar para aprender CSS es en [MDN](https://www.w3.org/Style/CSS/), ya que mantiene una estructura de la informaci√≥n mucho m√°s f√°cil de seguir. El siguiente nivel es leer la documentaci√≥n, drafts y discusiones que mantienen en [CSSWG](https://www.w3.org/Style/CSS/) sobre los bugs, revisiones y futuras funcionalidades sobre CSS.

Hay algunos recursos que nos pueden ayudar a estar al d√≠a en las nuevas funcionalidades soportadas, las nuevas por venir o las que ya est√°n ¬®deprecadas¬®. La mayor√≠a las podemos encontrar en esta magn√≠fica recopilaci√≥n [What‚Äôs happening in CSS?](https://rachelandrew.co.uk/archives/2017/05/01/whats-happening-in-css/) de [Rachel Andrew](https://twitter.com/rachelandrew).

Me parecen geniales los enlaces a los "\\[Browser\\] Platform Status", y otra fuente interesante de informaci√≥n son [las noticias de Can I Use](https://caniuse.com/#info_news) donde podemos ver las novedades que se a√±aden en los diferentes navegadores.

Un recurso que no me canso de recomendar, y yo mismo leer de vez en cuando, es [C√≥mo funcionan los navegadores: lo que hay detr√°s de los navegadores web actuales](https://www.html5rocks.com/es/tutorials/internals/howbrowserswork/) donde podremos aprender c√≥mo funciona de forma interna el navegador. Est√° escrito en 2011, pero en su mayor√≠a es totalmente v√°lido para los navegadores actuales. Si quieres profundizar m√°s en c√≥mo funciona internamente el renderizador del navegador, tambi√©n puedes leer [Inside a super fast CSS engine: Quantum CSS](https://hacks.mozilla.org/2017/08/inside-a-super-fast-css-engine-quantum-css-aka-stylo/) de [Lin Clark](https://twitter.com/linclark), donde nos explica de forma muy detallada el funcionamiento del motor de estilos con unas impresionantes ilustraciones.

## CSS for Engineers

Los preprocesadores han sido una gran herramienta para acercar a la gente que necesita trabajar con un lenguaje de programaci√≥n. Lenguajes como [Sass](https://sass-lang.com/) nos da una sintaxis, un compilador, una gesti√≥n de errores, la opci√≥n de a√±adir tests unitarios (como hemos visto m√°s arriba).

Otro gran preprocesador es [PostCSS](https://postcss.org/) el cual nos permite utilizar JavaScript para extender las posibilidades de CSS. Sobre PostCSS encontrar√©is un post que escrib√≠ hace un tiempo en este mismo blog [PostCSS Preset Env, el Babel de CSS](https://softwarecrafters.io/css/postcss-preset-env-babel-css).

## CSS Tools

Existen muchas herramientas para facilitarnos trabajar con CSS, si no me equivoco, la primera herramienta para CSS fue el [validador de CSS](https://jigsaw.w3.org/css-validator/) de la propia W3C.

### Styleguide Generators

- [kss-node](https://github.com/kss-node/kss-node) este lo hemos usado en el framework CSS [rubik](https://github.com/InfoJobs/rubik) en InfoJobs.
- [postcss-style-guide](https://github.com/morishitter/postcss-style-guide) este tambi√©n lo he utilizado en un proyecto, para generar la gu√≠a de estilos de una web.
- [CSS Parsing](https://github.com/davidhund/styleguide-generators#css-parsing-css-source) aqu√≠ encontrar√°s una lista de varios de ellos, prob√© StyleDocco, pero me gust√≥ m√°s kss-node.

### Linters

- [CSS Lint](http://csslint.net/) el primer linter de CSS que recuerdo, muy √∫til en su momento, pero al tratarse de un servicio online donde tienes que "pastear" el CSS que quieres analizar en un TextArea, es inviable integrarlo en cualquier entorno de desarrollo.
- [stylelint](https://stylelint.io/) es una gran herramienta para localizar errores en nuestro c√≥digo, es lo m√°s cercano a un gestor de errores cuando compilamos en un lenguaje. Lo podemos integrar en muchos editores y entornos de desarrollo, permitiendo cambiar a la sintaxis que tengamos acordada en el fichero de configuraci√≥n en el momento de guardar nuestros cambios.

### Critical-path

Estas herramientas est√°n relacionadas con la web performance, por lo que afectan directamente a la experiencia de usuaria/o.

- [Penthouse](https://github.com/pocketjoso/penthouse) de Jonas Ohlsson
- [Critical](https://github.com/addyosmani/critical) de Addy Osmani
- [CriticalCSS](https://github.com/filamentgroup/criticalcss) de FilamentGroup

### Developer Tools

Las developer tools de los navegadores est√°n repletas de funcionalidades para facilitarnos el desarrollo y depuraci√≥n del CSS de nuestros proyectos.

Enumerar todas ellas dar√≠an para un art√≠culo dedicado (uno de Chrome y otro de Firefox), as√≠ que os dejo los enlaces a la fuente y si ten√©is alguna duda me pod√©is consultar.

- [Chrome DevTools](https://developers.google.com/web/tools/chrome-devtools?hl=es)
- [Firefox Developer Tools](https://developer.mozilla.org/es/docs/Tools)

## CSS Audits

Las herramientas que voy a comentar aqu√≠ podr√≠an estar perfectamente en la secci√≥n de CSS Tools, pero les he querido dar una mayor importancia debido a lo realmente √∫tiles que nos pueden llegar a ser en muchas ocasiones y para mantener las buenas pr√°cticas en nuestro CSS.

### CSS Stats

[CSS Stats](https://cssstats.com/) es un servicio online gratuito y Open Source que analiza el CSS de una web o url espec√≠fica y genera un informe muy detallado. Peso, n√∫mero de reglas, de selectores, pseudo elementos, colores, fuentes, etc...

[![SoftwareCrafters.io CSS Stats Report](https://user-images.githubusercontent.com/1307927/95793471-f3aa4b00-0ce5-11eb-9f86-84163044b32f.png)](https://cssstats.com/stats/?url=https%3A%2F%2Fsoftwarecrafters.io)

> Aqu√≠ podemos ver un ejemplo del CSS de este blog. A primera vista podemos ver que el tama√±o del CSS es bastante superior al de Bootstrap üôà.

Uno de los informes que nos facilita es el de la [especificidad](https://developer.mozilla.org/es/docs/Web/CSS/Especificidad), un tema que puede traernos de cabeza si no lo tenemos interiorizado.

![SoftwareCrafters.io CSS Specificity Report](https://user-images.githubusercontent.com/1307927/95793484-f9079580-0ce5-11eb-8614-770c46a03bad.png)

### Project Wallance

[Project Wallance](https://www.projectwallace.com) es otro proyecto para auditar nuestro c√≥digo CSS. Es un servicio de pago, que permite tener un historial de los informes para poder compararlos.

![joanleon.dev Project Wallace Dashboard](https://user-images.githubusercontent.com/1307927/95793476-f60ca500-0ce5-11eb-84e3-e114519a1c64.png)

La versi√≥n gratuita permite auditar un proyecto, pero sin poder integrarlo con sistemas de integraci√≥n continua.

## CSS Refactor

En cualquier lenguaje de programaci√≥n en el momento que guardamos un archivo estamos generando deuda t√©cnica. En el desarrollo CSS no es distinto. Conforme avanza el proyecto tendremos que refactorizar, as√≠ como aplicar buenas pr√°cticas en el desarrollo nos ayudar√° en ese proceso de refactorizar el c√≥digo, de mejorarlo.

Tenemos herramientas como [autoprefixer](https://autoprefixer.github.io/) que bas√°ndose en [Browserslist](https://github.com/browserslist/browserslist) a√±ade los prefijos necesarios a las propiedades CSS para mantener la retrocompatibilidad de los navegadores que estemos soportando en nuestro proyecto.

\`\`\`css
/* Input ------- */
.example {
    display: grid;
    transition: all .5s;
    user-select: none;
    background: linear-gradient(to bottom, white, black);
}

/* Output -------- */
/*
* Prefixed by https://autoprefixer.github.io
* PostCSS: v7.0.29,
* Autoprefixer: v9.7.6
* Browsers: last 4 version
*/

.example {
    display: -ms-grid;
    display: grid;
    -webkit-transition: all .5s;
    -o-transition: all .5s;
    transition: all .5s;
    -webkit-user-select: none;
       -moz-user-select: none;
        -ms-user-select: none;
            user-select: none;
    background: -webkit-gradient(linear, left top, left bottom, from(white), to(black));
    background: -o-linear-gradient(top, white, black);
    background: linear-gradient(to bottom, white, black);
}
\`\`\`

Aqu√≠ estamos definiendo que queremos compilar un c√≥digo compatible con las √∫ltimas 4 versiones de todos los navegadores. En un producto, el cual suponemos que tendr√° un vida larga, en 4 a√±os es muy probable que esos prefijos no tengan sentido, hay que eliminarlos, hay que refactorizar.

Si tenemos un flujo de trabajo donde ese proceso est√© automatizado, solo tendremos que cambiar la configuraci√≥n del fichero \`.browserslistrc\` o actualizar un \`@mixin\` de Sass, ser√° una tarea f√°cil, pero sino, nos tocar√° hacer un refactor considerable.

Existe un libro titulado **CSS Refactoring**, pero es m√°s un libro de buenas pr√°cticas para no generar legacy o facilitar el refactor que casos de uso de refactor como tal, hablo de ello en la secci√≥n de los libros.

Tal y como yo tengo entendido el refactor hay dos posibles escenarios:

- Refactor de un c√≥digo CSS por un cambio de dise√±o. Esto puede llevar mucho tiempo y muchos test para validar que no estamos rompiendo nada.
- Refactorizar el c√≥digo conforme vemos mejoras. Cada d√≠a aprendemos algo, un nuevo truco, una nueva propiedad CSS que ya es compatible, corregir valores como \`margin: 0px\`. Como crafters queremos hacer bien las cosas, que nuestro yo del futuro est√© orgulloso de nuestro trabajo, pues mejoremos todo lo que podamos o sepamos en ese momento, eso s√≠, sin presi√≥n...no lo sabemos todo, refactorizamos porque hemos aprendido a hacer mejor las cosas.

## CSS Books

Hay bastantes libros sobre CSS, muchos de ellos son gen√©ricos de desarrollo web y dedican unos cap√≠tulos a CSS.

Como es un tema que me interesa mantener actualizado, os dejo un enlace a un art√≠culo de mi blog donde tengo, e ir√© a√±adiendo, rese√±as de los que he leido üëâüèº [Libros CSS](https://joanleon.dev/libros-css).

## Conclusiones

Aprender CSS es b√°sico para poder desarrollar buenos productos web. CSS no es solo poner colores y montar el grid para que todo encaje. Hay muchas cosas a tener en cuenta como habr√°s podido ver, y eso que no hemos entrado en temas de accesibilidad o performance. Hay gente muy profesional desarrollando las funcionalidades en lenguajes como C++ para que el motor del navegador acabe convirtiendo en pixeles, en contenido para la usuaria/o.

Hay muchas cosas por aprender, como en cualquier lenguaje, como en cualquier disciplina, hay que aprender, entender, interiorizar y entrenar (aka katas) para mejorar.

Soy Frontend y trabajo con los 3 lenguajes disponibles HTML, CSS y JS para aportar valor en mis soluciones, para aportar valor al producto, para aportar valor a las usuarias/os.

CSS forma parte de la web [#cssIsPartOfTheWeb](https://twitter.com/hashtag/cssIsPartOfTheWeb).",
    "slug": "css-craftsmanship",
    "tags": [
      "css",
    ],
    "title": "CSS para Crafters",
    "userPicture": "",
    "username": "Joan Le√≥n",
  },
  {
    "category": "javascript",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/RxJS_category.png",
    "date": "",
    "description": "RxJS es una librer√≠a que nos permite programar con un estilo funcional reactivo. La programaci√≥n reactiva es un concepto relativamente nuevo ",
    "id": "introduccion-programacion-reactiva-rxjs",
    "markdownBody": "> **Esto trata sobre manejar con buen gusto los efectos secundarios de las operaciones as√≠ncronas -- Erik Meijer sobre Rx**

La programaci√≥n reactiva es un concepto relativamente nuevo que est√° revolucionando el mundo del _software_. Hoy en d√≠a, cualquier sistema serio involucra muchos subsistemas as√≠ncronos que necesitan ser coordinados eficientemente, algo tremendamente complicado con las t√©cnicas de programaci√≥n cl√°sicas.

En este art√≠culo tratar√© de introducir la filosof√≠a de programaci√≥n reactiva y las posibilidades que nos brinda JavaScript, junto a RxJS, en este aspecto. Repasaremos algunos conceptos clave para entender la programaci√≥n reactiva y veremos algunos ejemplos pragm√°ticos sobre c√≥mo usar RxJS.

## Manejando la asincron√≠a con JavaScript 

En los √∫ltimos a√±os, JavaScript se ha convertido en uno de los lenguajes m√°s utilizados del mundo, se encuentra en infraestructuras cr√≠ticas de las empresas m√°s importantes, en las cuales un correcto manejo de la asincron√≠a se vuelve esencial. 

Antes de profundizar en conceptos relacionados con la reactividad, veamos un peque√±o resumen sobre los **_callbacks_** y los **_promises_**, dos de los mecanismos cl√°sicos para manejar la asincron√≠a en JavaScript.

### _Callbacks_

Los _callbacks_ son la forma m√°s antigua de gestionar la asincron√≠a. Como ya sabr√©is, un _callback_ no es m√°s que una funci√≥n que recibe como argumento otra funci√≥n y la ejecuta. En otras palabras, una funci√≥n "a" se usa como argumento de otra funci√≥n "b". Cuando se llama a "b", esta ejecuta "a". 

\`\`\`
function b(callback){
    //do something
    callback()
}

function a(){
     console.log('hello');
}

\`\`\`

Los _callbacks_ son muy sencillos de entender y es por ello que son la forma m√°s extendida de manejar la asincron√≠a en JavaScript. No obstante, los _callbacks_ tienen varios inconvenientes, como pueden ser la gesti√≥n de errores o el aumento de la complejidad a la hora de manejar la concurrencia; por no hablar del temido _callback hell._

![callback-hell](https://res.cloudinary.com/software-crafters/image/upload/v1546943598/posts/introduccion-programacion-reactiva-rxjs/callback-hell.png) 

### _Promises_

Las _promises_ o promesas son un patr√≥n que nos ayuda a realizar operaciones as√≠ncronas sin muchos de los inconvenientes de los _callbacks_. Una promesa representa un valor que puede estar disponible ahora, en el futuro o nunca. Vinieron a salvarnos del tan temido _callback hell_. Generalmente hacen que los programas sean m√°s claros al mantener un estilo de c√≥digo s√≠ncrono, reduciendo la necesidad de anidar bloques y simplificando el manejo del estado.

Las promesas pueden encontrarse en 3 estados diferentes: 

* **_Pending_**: Estado inicial
* **_Fulfilled_**: Representa una operaci√≥n satisfactoria
* **_Rejected_**: Representa una operaci√≥n fallida

Veamos un ejemplo de c√≥mo se crean y c√≥mo se consumen:

\`\`\`
//Creando la promesa
const requestPosts = (url) =>
	new Promise((resolve, reject) => {
		const req = new XMLHttpRequest();
		req.open('GET', url);

		req.onload = () =>
			(req.status == 200)
				? resolve((req.response)
				: reject(req.status);

		req.send();
	})

//Consumiendo la promesa
const url = 'https://jsonplaceholder.typicode.com/posts'

requestPosts(url)
	.then(r =>
    	console.log(JSON.parse(r))
  	)
  	.catch((e) =>
    	console.log(\`Error: \${e}\`)
  	);

\`\`\`

Desafortunadamente, las promesas no son la panacea. Representan una mejora con respecto a los _callbacks_, pero tienen una deficiencia importante: solo producen un valor √∫nico. Esto es un factor limitante a la hora de manejar eventos recurrentes, como clics del _mouse_ o flujos de datos provenientes del servidor, ya que tendr√≠amos que preocuparnos de cada evento por separado en lugar de controlar el flujo de eventos tal como viene dado. 

### _Async / Await_

Desde la versi√≥n ES8 de JavaScript, ya tenemos disponible el patr√≥n **_async/await_** **.** Esta caracter√≠stica heredada de otros lenguajes como c# nos permite resolver promesas escribiendo c√≥digo con un estilo s√≠ncrono, es decir, a√±ade az√∫car sint√°ctico a las promesas.

Para usar **_async/await_** debemos declarar una funci√≥n con el modificador _async_. Esto nos **permite a√±adir el modificador** **_await_** **delante de la expresi√≥n as√≠ncrona en dicha funci√≥n, deteniendo la ejecuci√≥n hasta que se resuelva la expresi√≥n.**

La promesa del ejemplo anterior la podr√≠amos consumir as√≠:

\`\`\`
async function main(){
    const url = 'https://jsonplaceholder.typicode.com/posts'
    const response = await requestPosts(url)

    console.log(response)
}

\`\`\`

_A priori_, queda un c√≥digo mucho m√°s elegante, adem√°s de resolver el problema de la anidaci√≥n de promesas. El problema viene con el tratamiento de los errores, y es que debemos ‚Äúenvolver‚Äù nuestro c√≥digo en bloques _try catch_, con lo cual el manejo de errores se vuelve muy tedioso:

\`\`\`
async function main(){
	const url = 'https://jsonplaceholder.typicode.com/posts'
	try{
        const response = await requestPosts(url)
        console.log(response)
    }
    catch(error){
        console.log(error)
    }
}

\`\`\`

En los siguientes p√°rrafos veremos c√≥mo RxJS nos puede ayudar a solucionar estas limitaciones, pero antes veamos qu√© es la programaci√≥n reactiva.

## ¬øQu√© es la programaci√≥n reactiva?

Seg√∫n el **_Reactive Manifesto_**, la programaci√≥n reactiva es un paradigma enfocado en el trabajo con _stream_ de datos de manera as√≠ncrona. En este se establece las bases de los sistemas reactivos, los cuales deben ser:

* **Responsivos**: aseguran la calidad del servicio cumpliendo unos tiempos de respuesta establecidos.
* **Resilientes**: se mantienen responsivos incluso cuando se enfrentan a situaciones de error.
* **El√°sticos**: se mantienen responsivos incluso ante aumentos en la carga de trabajo.
* **Orientados a mensajes**: minimizan el acoplamiento entre componentes al establecer interacciones basadas en el intercambio de mensajes de manera as√≠ncrona.

### ¬øQu√© son los **_streams_**?

Para entender la programaci√≥n reactiva, debemos entender lo que son los _streams_. Podr√≠amos decir que un _stream_ es un tipo de colecci√≥n, al igual que un _array_ o un _string_, en este caso, de eventos o elementos futuros. La diferencia radica en que los _stream_ no est√°n disponibles de forma s√≠ncrona y que, adem√°s, desconocemos su tama√±o.

Un _stream_ puede provenir de m√∫ltiples fuentes, como por ejemplo:

* Eventos del DOM - (eventos del rat√≥n, eventos del teclado, eventos de formularios, etc.)
* Animaciones
* Peticiones HTTP
* _WebSockets_
* Lectura o escritura de ficheros.
* Llamadas a base de datos

## ¬øQu√© es RxJS?

RxJS es una implementaci√≥n para JavaScript de las _Reactive Extensions_. Estas fueron desarrolladas por Erik Meijer en Microsoft en el 2009\\. B√°sicamente son una librer√≠a para trabajar con _streams_ mediante el uso de observables.

> Las Rx est√°n implementadas en m√°s de 18 lenguajes de programaci√≥n. En el mundo de Javascript tambi√©n son conocidas como el ‚ÄúLodash‚Äù de los eventos.

Esta librer√≠a nos proporciona un marco de trabajo en el que todo gira alrededor del tipo b√°sico, el ‚Äúobservable‚Äù, el cual simplemente representa un _stream_ de datos. Adem√°s, disponemos de otros tipos complementarios como ‚Äú_observer, schedulers, subjects_‚Äù y operadores inspirados en _Arrays_ ‚Äú_map, filter, reduce_‚Äù, etc; los cuales nos permiten el manejo de eventos as√≠ncronos como colecciones. En p√°rrafos posteriores, veremos los operadores m√°s importantes.

![observable](https://res.cloudinary.com/software-crafters/image/upload/v1546943598/posts/introduccion-programacion-reactiva-rxjs/observables.png) 

### _Observer_ e _Iterator_

Para entender qu√© son y de d√≥nde provienen los observables, debemos entender sus bases, el patr√≥n observer y el patr√≥n iterator.

**Patr√≥n** **_observer_**

La filosof√≠a del patr√≥n observador es sencilla: un objeto, denominado sujeto (_subject_), posee un estado. Si dicho estado cambia, es capaz de ‚Äúnotificar‚Äù a sus suscriptores (_ob_ _servers_) de este cambio. Gracias a ello, los objetos suscritos al objeto _subject_ no tienen por qu√© preocuparse de cu√°ndo se produce un cambio de estado, ya que este se encargar√° de informar de forma activa a todos aquellos objetos que hayan decidido suscribirse. 

Veamos una implementaci√≥n b√°sica de dicho patr√≥n:

\`\`\`
class Subject {
    constructor(){
        this.observers = []
    }

    add(obs){
	  this.observers = this.observers.concat(obs)
    }

    delete(obs){
	  this.observers = this.observers.filter(l => l !== obs)
    }

    notify(msg){
	  this.observers.map(obs => obs.update(msg))
    }
}

\`\`\`

Como podemos comprobar, la implementaci√≥n es muy sencilla. Si creamos una instancia de esta clase, el objeto _subject_ contiene una lista de _observers_. Estos _observers_ se pueden a√±adir a trav√©s de _add,_ o eliminar a trav√©s del m√©todo _delete_. Adem√°s, por medio del m√©todo _notify_, podemos notificar a dichos _observers_. 

Veamos un ejemplo de c√≥mo funciona:

\`\`\`
const observer1 = {
	update: msg => console.log(\`observer 1: \${msg}\`)
}

const observer2 = {
	update: msg => console.log(\`observer 2: \${msg}\`)
}

const subject = new Subject()
subject.add(observer1)
subject.add(observer2)
subject.notify("Hello");
//observer 1: Hello
//observer 2: Hello

\`\`\`

Como podemos observar en el c√≥digo anterior, _observer1_ y _observer2_ son notificados cada vez que el objeto _subject_ actualiza su estado interno. Esta implementaci√≥n es muy sencilla, pero nos sirve para ilustrar c√≥mo el patr√≥n observador nos permite desacoplar los eventos y la reacci√≥n de los objetos que est√°n a la escucha. 

**Patr√≥n** **_Iterator_**

La otra pieza fundamental del puzle es el patr√≥n _iterator_. El objetivo de este patr√≥n es proporcionarnos una manera de acceder a los elementos de un objeto agregado, de forma secuencial, sin exponer sus detalles. Es decir, proporciona a una colecci√≥n un medio para navegar por sus datos sin exponer su estructura interna.

La implementaci√≥n del iterador es muy simple, tan solo necesita la especificaci√≥n de dos m√©todos: next (), para obtener el siguiente elemento en la colecci√≥n, y hasNext (), para verificar si quedan elementos en dicha colecci√≥n. 

\`\`\`
class CustomIterator {
    constructor(collection) {
        this.index = 0;
        this.collection = collection;
    }

    next = () =>
        this.hasNext()
            ? this.collection[this.index++]
            : null

    hasNext = () =>
        this.index + 1 < this.collection.length;
}

const customIterator = new CustomIterator([1,2,3,4])
console.log(customIterator.next(), consumer.hasNext()) //1, true

\`\`\`

Como vemos, es un patr√≥n extremadamente simple, pero nos proporciona una excelente forma de encapsular la l√≥gica mediante la cual recorremos cualquier tipo de estructura de datos. La combinaci√≥n de este patr√≥n junto con el patr√≥n _observer_ nos es tremendamente efectiva y es la base de los observables de las _Reactive Extensions._

## Qu√© es un observable

Tras analizar sus fundamentos, veamos qu√© entendemos por **observable.** Como podemos imaginar, el tipo observable es el eje central de Rx. Simplemente representa la idea de una colecci√≥n de valores o eventos futuros. 

Los valores o eventos se emiten en orden, igual que en el patr√≥n _iterator_. En lugar de que sean los objetos que lo consumen los que solicitan el siguiente elemento, es el propio observable el que ‚Äúempuja‚Äù los siguientes elementos a los objetos suscritos, a medida que estos est√°n disponibles, tal como suced√≠a en el _subject_ del patr√≥n _observer_.

### Caracter√≠sticas: 

* Proporcionan soporte para enviar mensajes entre _publishers_ y _subscribers_.
* Ofrecen beneficios significativos sobre otras t√©cnicas a la hora de trabajar con eventos y manejar la asincron√≠a.
* Los observables son _lazy_ (perezosos). No comienzan a emitir datos hasta que te suscribes a ellos.
* Al igual que los iteradores, un observable puede indicar cu√°ndo se completa la secuencia.
* Nos permiten declarar c√≥mo reaccionar a una secuencia de elementos, en lugar de tener que reaccionar a los elementos de forma individual.

**Ejemplo de observable**

Antes de continuar, veamos una implementaci√≥n sencilla de c√≥mo consumir un observable:

\`\`\`
import { fromEvent } from 'rxjs';
const link = document.getElementById("customLink");

const obs = {
    next: function(value) {
        console.log(value);
    },
    error: function(err) {
        console.error(err);
    },
    complete: function() {
        console.log("Completed");
    }
};

// Create an Observable from event
const observable = fromEvent(link, "click");
// Subscribe to begin listening for async result
observable.subscribe(obs);

\`\`\`

Lo primero que hacemos es crear un observable a partir de un evento, en concreto del evento clic de un enlace con la id ‚ÄúcustomLink‚Äù. A continuaci√≥n, nos suscribimos a dicho observable por medio de la funci√≥n **subscribe**, pas√°ndole el objeto ‚Äúobs‚Äù, que cumple con la interfaz **observer.** 

### _Subscription_ y _observer_

En el ejemplo anterior aparecen dos conceptos b√°sicos de Rx: **_subscription_** y **_observer_**. 

**_Subscription_** representa la ejecuci√≥n de un observable. Como hemos comentado, los observables son _lazy_, por lo tanto, hasta que no nos suscribimos a ellos, no comienzan a emitir valores. Los suscriptores tienen que implementar la interfaz de observador.

![observable-observers](https://res.cloudinary.com/software-crafters/image/upload/v1546943598/posts/introduccion-programacion-reactiva-rxjs/observables-subscribers.png) 

**_Observer_** es un objeto que sabe reaccionar a los valores entregados por el observable. Para ello implementa la interfaz de observador. Dicha interfaz contiene los m√©todos **next()**, **error()** y **complete()**. 

![observable process](https://res.cloudinary.com/software-crafters/image/upload/v1546943598/posts/introduccion-programacion-reactiva-rxjs/observable-process.png) 

**_Next_** **()** es el equivalente al m√©todo _update_ en el patr√≥n _observer_. Se llama cuando el observable emite un nuevo valor. **_Complete_** **()** se ejecuta cuando no hay m√°s datos disponibles. 

El m√©todo **_error_** **()** se ejecuta cuando se produce un error en el observable, al igual que **_complete_** **().** Una vez ejecutado, las siguientes llamadas no tendr√°n efecto.

## Visualizaci√≥n de observables

Para entender el comportamiento de los observables nos apoyaremos en los **diagramas de** **_marbles_** **o canicas.** Estos diagramas son muy clarificadores, ya que nos ayudan a simplificar el comportamiento de los observables y de los operadores que aplicamos sobre ellos, los cuales nos ayudar√°n a visualizar de forma m√°s clara el comportamiento de los operadores. 

En este tipo de diagramas el tiempo viene representado por la l√≠nea horizontal y los valores emitidos por el observable se encuentran representados por canicas. 

![observable marble](https://res.cloudinary.com/software-crafters/image/upload/v1546943598/posts/introduccion-programacion-reactiva-rxjs/marble.png) 

En el ejemplo tenemos un observable que emite los valores de un evento. Cada una de las canicas representa un elemento emitido, la ‚Äúx‚Äù representa un error y la l√≠nea vertical indica que el observable ha dejado de emitir valores.

## Operadores

Un operador es, en esencia, una funci√≥n pura que toma un observable como entrada y genera otro observable como salida. Existen docenas de operadores divididos en ocho categor√≠as: creacionales, de transformaci√≥n, de filtrado, condicionales, de combinaci√≥n, multidifusi√≥n, manejo de errores y de utilidad. 

A continuaci√≥n, veremos los m√°s importante desde un punto de vista pragm√°tico, mediante los cuales podremos realizar el 90% de las operaciones en cualquier proyecto real. 

### Operadores de creaci√≥n

RxJS nos ofrece una serie de operadores destinados a la creaci√≥n de observables. Estas funciones simplifican el proceso de creaci√≥n de observables a partir de elementos como _arrays_, eventos, _callbacks_ o promesas.

**_Create_**

Es el operador de creaci√≥n m√°s b√°sico. Crea un observable a partir de una funci√≥n recibida y esta define c√≥mo el observable va a emitir los valores:

\`\`\`
// RxJS v6+
import { Observable } from 'rxjs';
/*
  Create an observable that emits 'Hello' and 'World' on
  subscription.
*/
const hello = Observable.create((observer) => {
  observer.next('Hello');
  observer.next('World');
});

//output: 'Hello'...'World'
const subscribe = hello.subscribe(val => console.log(val));

\`\`\`

**_From_**

Este operador de creaci√≥n convierte una colecci√≥n o una promesa en un observable:

\`\`\`
// RxJS v6+
import { from } from 'rxjs';

//emit array as a sequence of values
const arraySource = from([1, 2, 3, 4, 5]);
//output: 1,2,3,4,5
arraySource.subscribe(val => console.log(val));

//emit result of promise
const promiseSource = from(new Promise(resolve => resolve('Hello World!')));
//output: 'Hello World'
const subscribe = promiseSource.subscribe(val => console.log(val));

//emit string as a sequence
const source = from('Hello World');
//output: 'H','e','l','l','o',' ','W','o','r','l','d'
const subscribe = source.subscribe(val => console.log(val));

\`\`\`

**_fromEvent_**

Como su propio nombre indica, este operador convierte cualquier tipo de evento en un observable:

\`\`\`
// RxJS v6+
import { fromEvent } from 'rxjs';
//convert the mousemove event stream of the DOM into an observable sequence.
const source = fromEvent(document, 'mousemove');
source.subscribe(e => console.log(e.clientX + ', ' + e.clientY));

\`\`\`

### Operadores de filtrado

Como su propio nombre indica, son operadores destinados al filtrado de los valores emitidos por el observable. Estos operadores son los m√°s sencillos y f√°ciles de utilizar, ya que simplemente aceptan o rechazan ciertos valores seg√∫n los criterios de filtrado aplicados. Sin duda, en este apartado el m√°s importante es **_filter_**.

**_Filter_**

_Filter_ se comporta igual que el operador est√°ndar de JavaScript. Solo emitir√° valores si cumple la condici√≥n dada por el predicado.

![filter](https://res.cloudinary.com/software-crafters/image/upload/v1546943597/posts/introduccion-programacion-reactiva-rxjs/filter.png) 

\`\`\`
// RxJS v6+
import { from } from 'rxjs';
import { filter } from 'rxjs/operators';

const numbers = from([2, 30, 22, 5, 60, 1])


numbers
    .pipe(filter(n => n > 10))
    .subscribe(n => console.log(n))

\`\`\`

En este caso, el predicado devuelve solo los elementos de entrada mayor que 10\\. Por lo tanto, solo se emiten los valores 30, 22 y 60\\. 

### Operadores de transformaci√≥n

Existen multitud de operadores que nos permiten aplicar transformaciones elegantes a los observables, aunque en la pr√°ctica los m√°s utilizados son los cl√°sicos **_map_** y **_reduce_**, adem√°s de alg√∫n otro que deriva de estos como **_mergeMap (flatmap)_** y **_concatMap_**. Siendo pragm√°ticos, con estos operadores tenemos lo necesario para la mayor√≠a de los casos. Los dem√°s los estudiar√≠a bajo demanda, es decir, mientras los fuera necesitando.

**_Map_**

Transforma los elementos emitidos por un observable aplicando una funci√≥n a cada uno de los mismos. 

![map](https://res.cloudinary.com/software-crafters/image/upload/v1546943597/posts/introduccion-programacion-reactiva-rxjs/map.png) 

\`\`\`
// RxJS v6+
import { from } from 'rxjs';
import { map } from 'rxjs/operators';

const numbers = from([1, 2, 3])

numbers
   .pipe(map(x => 10 * x))
   .subscribe(n => console.log(n))


\`\`\`

En el ejemplo, el observable de origen contiene tres elementos num√©ricos (1, 2 y 3). _Map_ toma el valor de cada uno de ellos y le aplica la funci√≥n recibida. En este caso multiplica por 10 cada uno de los elementos.

**_Reduce_**

Funciona igual que en los _Arrays_ de JavaScript. Aplica una funci√≥n a un acumulador y a cada valor (de izquierda a derecha) para reducirlo a uno solo.

![reduce](https://res.cloudinary.com/software-crafters/image/upload/v1546943598/posts/introduccion-programacion-reactiva-rxjs/reduce.png) 

\`\`\`
// RxJS v6+
import { from } from 'rxjs';
import { reduce } from 'rxjs/operators';


const numbers = from([1, 2, 3, 4, 5])
numbers
	.pipe(reduce((x, y) => x + y))
	.subscribe(n => console.log(n))

\`\`\`

**_mergeMap_**

Tambi√©n como **_flatMap_**. Es un operador tremendamente potente. En muchas ocasiones se da la casu√≠stica en la que tenemos un observable cuyos elementos emitidos son tambi√©n observables, con la complejidad que ello conlleva. Lo que va a hacer **_mergeMap_** es transformar un observable en otros observables y unificar la salida de los mismos bajo un solo _stream_.

![flatmap](https://res.cloudinary.com/software-crafters/image/upload/v1546943598/posts/introduccion-programacion-reactiva-rxjs/flatmap.png) 

\`\`\`
// RxJS v6+
import { from, of } from 'rxjs';
import { mergeMap } from 'rxjs/operators';

const values = from([
    of(1,2,3),
    of(4,5,6),
    of(7,8,9)
])

values
	.pipe(mergeMap(v =>v))
	.subscribe(v => console.log(v))

\`\`\`

En este ejemplo, _value_ es un observable que emite a su vez otros tres observables. _Flatmap_ lo que hace es un _unwrap_ de cada uno de estos observables emitiendo en la secuencia principal uno solo.

Es importante tener en cuenta que _flatMap_ no garantiza el orden en el _stream_ resultante. 

**_ConcatMap_**

Es similar a _flatMap_, aunque en este caso transforma un solo observable de origen a la vez. Por lo tanto, garantiza que los elementos emitidos en el _stream_ resultante mantengan el mismo orden.

![concatmap](https://res.cloudinary.com/software-crafters/image/upload/v1546943598/posts/introduccion-programacion-reactiva-rxjs/concatmap.png) 

\`\`\`
‚Äã// RxJS v6+
import { from, of } from 'rxjs';
import { concatMap } from 'rxjs/operators';

const values = from([
    of(1,2,3),
    of(4,5,6),
    of(7,8,9)
])

values
	.pipe(concatMap(v =>v))
	.subscribe(v => console.log(v))

\`\`\`

Al igual que suced√≠a con _flatMap_, _concatMap_ hace un _unwrap_ de cada uno de estos observables, emitiendo en la secuencia principal un solo _stream_ con la diferencia de que en este caso asegura el orden. 

### Operadores de combinaci√≥n

En multitud de ocasiones nos veremos en la casu√≠stica de tener que combinar m√°s de un _stream_ a la vez y es aqu√≠ donde entra este tipo de operadores. Mi operador de combinaci√≥n preferido es **zip.**

**Zip**

Combina las emisiones de m√∫ltiples observables aplicando la operaci√≥n de la funci√≥n opcional especificada en el √∫ltimo par√°metro. 

![zip](https://res.cloudinary.com/software-crafters/image/upload/v1546943598/posts/introduccion-programacion-reactiva-rxjs/zip.png) 

\`\`\`
‚Äã// RxJS v6+
import { from, of } from 'rxjs';
import { zip } from 'rxjs/operators';


const numbers = of(1,2,3,4,5)
const strings = of('a', 'b', 'c', 'd')

zip(numbers, strings, (n,s)=>(n+s))
	.subscribe(v => console.log(v))

\`\`\`

El operador zip emitir√° un observable resultante cuando cada observable de origen emita un nuevo elemento (previamente descomprimido). En la pr√°ctica, muchas veces se suele utilizar para resolver varios observables a la vez, obteniendo los valores en la funci√≥n opcional.

## Resumen

Este es el art√≠culo m√°s largo que he escrito hasta el momento, pero creo que este es el post que me hubiera gustado encontrar hace unos a√±os cuando empec√© a estudiar la programaci√≥n reactiva. Creo que es un buen resumen de c√≥mo manejar la complejidad de la asincron√≠a en general y, en particular, haciendo uso del paradigma reactivo junto con RxJS. Quiz√°s se echa en falta alg√∫n ejemplo en un escenario real, pero eso lo dejar√© para futuras entradas.

Si te ha gustado la entrada, valora y comparte en tus redes sociales. No dudes en comentar dudas, aportes o sugerencias. ¬°Estar√© encantado de responder! 

Este art√≠culo se distribuye bajo una [Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES)

[![licencia-cc](https://res.cloudinary.com/software-crafters/image/upload/v1544181784/licencia-cc.png)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES)",
    "slug": "introduccion-programacion-reactiva-rxjs",
    "tags": [
      "javascript",
    ],
    "title": "Introducci√≥n a la programaci√≥n reactiva con RxJS",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "typescript",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/TS_category.png",
    "date": "",
    "description": "Pattern Matching o b√∫squeda de patrones es t√≠picamente usado por lenguajes de programaci√≥n funcionales, veremos como aplicarlo en TypeScript. ",
    "id": "union-types-pattern-matching-typescript",
    "markdownBody": "Muchos ya sabr√©is que el tipado est√°tico del lenguaje de programaci√≥n TypeScript permite declarar un tipo de dato como num√©rico, texto, booleano o de instancia de clase, por poner algunos ejemplos t√≠picos. Lo que quiz√°s no es tan conocido, seguramente porque no existe en los lenguajes m√°s populares, es que TypeScript tambi√©n soporta union types (o tipos uni√≥n traducido al espa√±ol).

## Conociendo los union types

Conceptualmente se parecen a los enum types (o tipos enumerados) pero con una importante vuelta de tuerca: permiten definir un tipo como una lista cerrada de valores y, a su vez, cada valor puede ser de un tipo diferente. Suena interesante, ¬øno?

Veamos c√≥mo definirlo:

\`\`\`
let a: number | string;

\`\`\`

 Vemos que poniendo el s√≠mbolo ‚Äú|‚Äù entre dos tipos le estamos indicando que la variable ‚Äúa‚Äù puede ser de tipo num√©rica o de tipo texto. Podemos poner tantas opciones como queramos (m√°s adelante veremos otros ejemplos).

 Una vez declarado el tipo, vamos a ver qu√© podemos hacer con √©l:

\`\`\`
let a: number | string;
a = 1; // a es un n√∫mero. Es v√°lido
a = "hello world"; // a ahora es texto. Tambi√©n es v√°lido
a = true; // ¬°Error! El compilador dice que a no puede ser true

\`\`\`

 No hay sorpresa. Al haber declarado el tipo de la variable a como num√©rica o de texto, podemos definirla con el valor 1 o el \`‚Äúhello world‚Äù\`. Pero al intentar usar valores de otro tipo, en este caso booleano, el compilador nos advierte de que hay un error de tipo y el c√≥digo no compila.

 Vale, y ahora que conocemos la sintaxis, nos preguntaremos, ¬øy para qu√© sirve el tipo uni√≥n? Si buscamos en los objetivos de dise√±o del [lenguaje TypeScript, encontraremos razones de peso](/typescript/typescript-javascript-introduccion): ‚ÄúEs un superconjunto de JavaScript que trata de evitar errores mediante los tipos y, al mismo tiempo, preservar el comportamiento original de JavaScript‚Äù . Por lo tanto, los union type son un mecanismo que permite especificar diferentes tipos para una misma variable, par√°metro de una funci√≥n o como resultado devuelto.

 Veamos algunos ejemplos de uso de union type dentro del propio n√∫cleo del lenguaje:

\`\`\`
const someDate = new Date(1553444243368); // 2019/03/24 17:17 en formato epoch
const anotherDate = new Date(‚ÄúMar 24, 2019‚Äù); // 2019/03/24 00:00 en formato ingl√©s

const result: RegExpExecArray | null =  /\\d+/.exec(‚Äú123456‚Äù);

\`\`\`

 Podemos observar que el constructor del tipo Date puede recibir un n√∫mero, que ser√≠a el tiempo en formato epoch o un texto donde la fecha est√© definida en ingl√©s con un determinado formato. Tambi√©n vemos que la funci√≥n exec (muy usada para validar texto con expresiones regulares) puede devolver un objeto especial con el resultado o null.

 Cuando usamos TypeScript, el compilador tambi√©n usa union types en las propias definiciones de la API del lenguaje para saber qu√© se puede hacer con los tipos base de JavaScript. Esta es parte de la definici√≥n de los tipos que vimos en el ejemplo anterior:

\`\`\`
// extracto de typescript/lib/lib.es5.d.ts

interface Date {
new(value: number | string): Date;
}

interface RegExp {
exec(string: string): RegExpExecArray | null;
}


\`\`\`

 No hace falta entenderla en profundidad. Es solo una curiosidad y la prueba de que hasta el propio TypeScript define muchos tipos base de JavaScript con union types. De hecho, las librer√≠as m√°s conocidas hechas en TypeScript, como pueden ser react o angular, usan union types.

## Caso pr√°ctico

 Imaginemos que queremos hacer una librer√≠a con una funci√≥n que dobla el valor que se le pasa. Y vamos a permitir que el par√°metro pueda ser de tipo num√©rico, texto o lista (array). Con lo que hemos contado hasta ahora tendr√≠amos algo as√≠:

\`\`\`
function double(value: number | string | any[]): number | string | any[] {
   if (typeof value === "number")
       return value * 2;
   if (typeof value === "string")
       return value.concat(valor)
   return [...value, ...value];
}

double(1); // 2
double("hello"); // "hello"
double([1,2,3]); // [1,2,3,1,2,3]
double(false); // Error. El argumento no se puede asignar
double({id: 1, name: "Pepe"}); // Error. El argumento no se puede asignar


\`\`\`

 Bien. Ya tenemos nuestra funci√≥n polim√≥rfica ‚Äúdouble‚Äù operativa. Aunque funciona es un poco verbosa y personalmente prefiero que el c√≥digo sea lo m√°s conciso posible. As√≠ que lo primero que vamos a hacer es mejorar la forma de declarar los tipos que acepta y devuelve. Para eso necesitamos introducir el type alias (o alias de tipo en espa√±ol). TypeScript permite ponerle otro nombre a un tipo de datos. As√≠:

\`\`\`
type <alias> = <tipo>;

\`\`\`

 Podemos definir el alias con un tipo cualquiera, incluso definido por el usuario como pueden ser interfaces, clases, union types u otros type alias.

 Para nuestra funci√≥n definir√≠amos el siguiente alias:

\`\`\`
type DoubleType = number | string | any[];

\`\`\`

 Y ahora podemos sustituir el tipo de entrada y salida por el alias, quedando la definici√≥n m√°s simple:

\`\`\`
function double(value: DoubleType ): DoubleType {
   if (typeof value === "number")
       return value * 2;
   if (typeof value === "string")
       return value.concat(value)
   return [...value, ...value];
}

\`\`\`

 Podr√≠amos quedarnos aqu√≠. Pero ¬øy si pudi√©ramos sustituir el c√≥digo por algo m√°s expresivo?

##  Pattern matching al rescate

 Al igual que union type, el pattern matching es algo t√≠picamente usado por lenguajes de programaci√≥n funcionales y est√°ticamente tipados como Haskell, Scala o F#. Por lo que encontraremos muchas referencias a √©stos y a su sintaxis. Pero no te asustes; el concepto es muy simple y en realidad ya lo conoces, m√°s o menos:

\`\`\`
let result: DoubleType;

switch (value) {
   case typeof value === "number":
result = value * 2;
break;
   case typeof value === "string":
result = value.concat(valor);
break;
   default:
result = [...value, ...value];
}


\`\`\`

## ¬øQu√© es el pattern matching?

 Es una estructura del lenguaje que nos permite comprobar un valor contra una serie de casos. Cuando un caso se cumple, se ejecuta la expresi√≥n asociada y se termina. Idealmente, los casos permiten especificar no solo valores constantes, si no tambi√©n tipos, tipos con propiedades concretas o condiciones complejas. Conceptualmente, se parece a un switch mejorado, como en el ejemplo de arriba, que tiene una sintaxis no v√°lida en TypeScript.

 A pesar de que TypeScript no soporta pattern matching en su sintaxis, podemos recurrir a bibliotecas (libraries) para suplir su carencia. En nuestro caso vamos a usar el paquete de npm llamado [x-match-expression](https://www.npmjs.com/package/x-match-expression).

\`\`\`
import {match} from "x-match-expression";

function double(value: DoubleType): DoubleType {
   return match(value)
       .caseNumber(function (n) { return n * 2})
       .caseString(function (s) { return s.concat(s)})
       .default(function (array) { return [...array, ...array]});
}

\`\`\`

 Todav√≠a lo podemos simplificar un poco m√°s usando expresiones lambda en vez de funciones:

\`\`\`
import {match} from "x-match-expression";

function double(value: DoubleType): DoubleType {
   return match(value)
       .caseNumber(n => n * 2)
       .caseString(s => s.concat(s))
       .default(array => [...array, ...array]);
}


\`\`\`

 El c√≥digo ahora se ve m√°s conciso, pero vamos a explicarlo detalladamente. Primero, importamos la funci√≥n match, que nos va a permitir hacer el pattern matching en s√≠. A continuaci√≥n, la invocamos pas√°ndole el valor que queremos comprobar. Luego, definimos los casos caseNumber y CaseString. Cada caso comprueba si el valor es de un tipo concreto y, si lo √©s se ejecuta la expresi√≥n asociada al caso. Si nos fijamos, la expresi√≥n tiene para cada caso un par√°metro del tipo que se est√° probando (esto se aprecia con un editor de c√≥digo). Es decir, en el caseNumber tendr√≠amos la certeza de que n es num√©rico. Este principio se aplica a los dem√°s casos que tiene la librer√≠a. Finalmente, a√±adimos un caso por defecto (default), necesario para completar la expresi√≥n.

 Aqu√≠ hay un editor online para hacer pruebas con todo lo anterior: <https://stackblitz.com/edit/typescript-crd5ep> 

##  Lista de casos de uso de x-match-expression

 Antes de ver la lista de casos, algunos conceptos generales:

* Hay un caso por cada tipo primitivo de dato en JavaScript
* Por cada case<<Type>>, hay un case<<Type>>If adicional que tiene un par√°metro m√°s llamado predicado, que sirve para hacer una comprobaci√≥n extra.
* Todos los casos reciben un par√°metro llamado mapper, que es la funci√≥n que se ejecuta o valor que se devuelve. Si se usa como funci√≥n, recibe como par√°metro el elemento con el tipo acorde al caso.
* Para terminar el patr√≥n y ejecutarlo, hay que finalizar con el caso default.

 Esta es la lista de los casos de uso m√°s comunes que tiene la librer√≠a:

* **case:** es el comod√≠n. Se le pasa un predicado cualquiera que nosotros definamos
* **caseIntance:**comprueba si un elemento es instancia de clase o tiene una funci√≥n como prototype (funci√≥n constructora)
* **caseTrue:** comprueba si un elemento es true
* **caseFalse:** comprueba si un elemento es false
* **caseBolean:** comprueba si un elemento es de tipo booleano
* **caseEqual:** comprueba si un elemento es igual a otro (no hace comparaci√≥n profunda)
* **caseNotEqual:** comprueba si un elemento es distinto a otro (no hace comparaci√≥n profunda)
* **caseNumber:** comprueba si un elemento es de tipo num√©rico
* **caseAlmostEqual:** comprueba si un elemento es un n√∫mero aproximado a otro (√∫til para operaciones decimales)
* **caseNull:** comprueba si un elemento es nulo
* **caseObject:** comprueba si un elemento es de tipo Object
* **caseObjectLike:** comprueba si un elemento tiene partes iguales a otro (mismos keys con los mismos valores)
* **caseObjectWithKeys:** comprueba si un elemento es un objeto con ciertas claves
* **caseString:** comprueba si un elemento es de tipo string
* **caseStringLike:** comprueba si un elemento es de tipo string y cumple con una expresi√≥n regular
* **caseEmptyString:** comprueba si un elemento es un string vac√≠o
* **caseDate:** comprueba si un elemento es de tipo Date
* **caseArray:** comprueba si un elemento es de tipo Array
* **caseEmptyArray:** comprueba si un elemento es de tipo Array vac√≠o

 Para m√≠ los m√°s utilizados son **caseInstance y caseInstanceIf**, que permiten usar union types con clases. Hay m√°s casos. Te animo a jugar con la librer√≠a y descubrirlos.

##  Uniones discriminadas

 Hay otro concepto en TypeScript relacionado con los union types llamado discriminated unions (o uniones discriminadas en espa√±ol). B√°sicamente son tipos que tienen alguna propiedad com√∫n, pero con un valor conocido diferente para cada posible tipo y se unen en un tipo uni√≥n. Como puede sonar a chino, vamos a poner un poco de c√≥digo para aclararlo:

\`\`\`
interface Person {
type: ‚Äúperson‚Äù;
	name: string;
}

interface Insect {
	type: ‚Äúinsecto‚Äù;
	legs: number;
}

type Animal = Person | Insect;

\`\`\`

 Vemos que hay un tipo uni√≥n llamado Animal que est√° formado por dos tipos, los cuales comparten la propiedad type y tienen un valor conocido (t√©cnicamente se llama tipo singleton, que puede ser un texto, un n√∫mero o un valor concreto booleano).

 La particularidad de una variable con tipo uni√≥n discriminada es que el compilador es capaz de darse cuenta de qu√© tipo concreto es en realidad si le preguntamos por la propiedad que diferencia a uno de sus posibles tipos del otro. Aqu√≠ lo vemos:

\`\`\`
const value: Animal = getValue() // no sabemos qu√© ser√°

// a partir de aqu√≠ el compilador sabe que es del tipo Person
if (value.type === ‚Äúperson‚Äù)
console.log(\`He is called \${value.name}\`);


\`\`\`

 Este tipo discriminado es interesante, pero no deja de ser un pattern matching limitado y un sistema de tipos ‚Äúpoco elegante‚Äù. Personalmente prefiero usar tipos de verdad (instancias de clases) y pattern matching con la librer√≠a mencionada pero puede tener sus casos de uso. Sobre todo para c√≥digo legado (legacy code en ingl√©s).

##  Un ejemplo avanzado de pattern matching

 Ahora que sabemos c√≥mo definir y usar tanto los union types como el pattern matching, hemos visto que son una buena pareja de herramientas para nuestro cintur√≥n de programador: Con los union types podemos definir exactamente qu√© opciones son v√°lidas para un dato, impidiendo estados inv√°lidos y la posibilidad de que futuros tipos se usen sin que lo especifiquemos expl√≠citamente. Y con el pattern matching podemos expresar de forma concisa c√≥mo tratar cada caso.

 La primera afirmaci√≥n suena anti principios SOLID, porque salvo lo de impedir estados inv√°lidos, que suena bien, ¬øpor qu√© no √≠bamos a querer que se extienda una parte de la aplicaci√≥n con nuevos tipos? ¬øverdad? Al contrario: es justo lo que no queremos. Al poner la responsabilidad sobre un conjunto de tipos cerrados, y no sobre una interfaz extensible (imaginemos un tipo gen√©rico de error, por ejemplo) estamos forzando que nuestro c√≥digo sea m√°s confiable y est√© mejor documentado.

 Si es la primera vez que lees esta idea, seguramente te chocar√° y probablemente no est√©s de acuerdo. Pero piensa lo siguiente: ¬øPor qu√© no usar el sistema de tipos de TypeScript en todo su potencial, para que los tipos sean los que ‚Äúprueben‚Äù la validez del sistema? Personalmente, encuentro en los tipos uni√≥n una mejor forma de documentar y dar consistencia al c√≥digo frente a otras opciones como las interfaces o la herencia en muchos casos.

 Voy a poner un ejemplo: Tenemos que desarrollar una funcionalidad que permita almacenar un correo electr√≥nico en una base de datos. Nuestra primera aproximaci√≥n podr√≠a ser as√≠:

\`\`\`
function saveInDatabase(text: string): boolean {
   //...
}

function saveEmail(email: string) {
   return saveInDatabase(email);
}

const result = saveEmail("pepe@mail.com");
console.log(result ? "saved" : "an error happened");

\`\`\`

 saveEmail devuelve true si tiene √©xito y false en caso contrario. Ahora nos damos cuenta de que saveInDatabase tiene que diferenciar entre: Errores generales de la base de datos (como que no se puede conectar, que est√° llena, que no hay permisos. Es decir cosas irrelevantes desde el punto de vista del dominio o negocio) Si el correo ya estaba almacenado previamente Modificamos nuestro programa con los nuevos requisitos:

\`\`\`

class DatabaseError {
code: number;
message: string;
}

class DuplicatedEmailError {}

class Ok {}


function saveInDatabase(email: string): DatabaseError | DuplicatedEmailError | Ok {
//...
}

function saveEmail(email: string) {
return saveInDatabase(email);
}


const result = saveEmail("pepe@mail.com");

const message = match(result)
.caseInstance(DatabaseError, error => "Your email could not be saved. Please try again in few minutes")
.caseInstance(DuplicatedEmailError, _ => "Your email is already registered. Please check your spam folder")
.default("Your email was successfully registered");

console.log(message);

\`\`\`

 Modificamos saveInDatabase para que devuelva los tipos de error que esperamos. El tipo DatabaseError contiene un c√≥digo de error y un mensaje que nos pueden servir para logear el problema y que un administrador lo resuelva (No vamos implementar eso ahora). El tipo DuplicatedEmailError nos dice algo importante desde el punto de vista de negocio y lo vamos a discriminar del otro error.

 Si miramos el tipo de datos que devuelve la funci√≥n, sabremos exactamente las posibilidades a tratar. Con pattern matching sobre esas posibilidades construimos el mensaje que recibir√° el usuario. Ya tenemos nuestra versi√≥n actualizada con los nuevos requisitos. El lector avispado podr√≠a pensar que si en todos los casos al final estamos creando un mensaje de texto, ¬øpor qu√© no usar un tipo Message como resultado de saveEmail?

**Problemas con esa aproximaci√≥n:**

* Para discernir si la operaci√≥n tuvo √©xito o no, para hacer otra cosa, habr√≠a que mirar el mensaje en s√≠. Se podr√≠a arreglar parcialmente a√±adiendo un c√≥digo al mensaje, pero eso no deja de ser un tipo mal hecho.
* El mensaje no se debe devolver en la capa de base de datos, ¬øy si hay que traducirlo o formatearlo de alguna manera?
* Si la funci√≥n devuelve Message, ¬øc√≥mo sabr√≠amos todos los mensajes diferentes que podr√≠a devolver la funci√≥n? Tendr√≠amos que ir a la implementaci√≥n y ver cuidadosamente todo el c√≥digo. Puede haber muchas capas por debajo que devuelven diferentes mensajes. En resumen, tendr√≠amos una falta de control sobre las opciones existentes. Los tipos cerrados nos dan esa gran ventaja.
* ¬øC√≥mo enfocar√≠amos los test sobre esta implementaci√≥n? Estar√≠an basados y comprobar el texto devuelto en los mensajes y √©sto no es muy robusto ni mantenible a la larga.

**Nos llega un nuevo requisito**, que es validar el email, de modo que:

* Tenga un formato estandard
* No contenga ciertas palabras
* Tenga un largo m√°ximo

 Entonces modificamos el programa y nos quedar√≠a:

\`\`\`
import {match} from "x-match-expression";

class DatabaseError {
   code: number;
   message: string;
}

class DuplicatedEmailError {}

class TooLongEmailError {
   maxLenght: number;
}

class WrongEmailFormatError {}

class EmailWithInvalidWordsError {
   words: string[]
}

class Ok {}


function validateEmail(email: string): WrongEmailFormatError | TooLongEmailError | EmailWithInvalidWordsError | Ok {
   //...
}

function saveInDatabase(text: string): DatabaseError | DuplicatedEmailError | Ok {
   //...
}

function saveEmail(email: string) {
   const validationResult = validateEmail(email);
   if (validationResult  instanceof Ok)
       return saveInDatabase(email);
   return validationResult;
}


const result = saveEmail("pepe@mail.com");

const message = match(result)
   .caseInstance(WrongEmailFormatError, _ => "Please use the format abcde@dominio.com")
   .caseInstance(TooLongEmailError, _ => \`Email can not be larger than \${_.maxLenght} characters\`)
   .caseInstance(EmailWithInvalidWordsError, _ => \`Email address cannot contain \${_.words.join(", ")}.\`)
   .caseInstance(DatabaseError, error => "Your email could not be saved. Please try again in a few minutes")
   .caseInstance(DuplicatedEmailError, _ => "Your email address is already registered. Please, check your spam folder")
   .default("Your email was successfully registered");

console.log(message);


\`\`\`

 Hemos a√±adido los tipos de error requeridos. Algunos de ellos contienen propiedades que podemos usar para dar informaci√≥n al usuario. Al tener los errores como tipos espec√≠ficos, tenemos la interfaz del m√©todo saveEmail ‚Äòcerrada‚Äô y podemos gestionarlos en la capa de abstracci√≥n adecuada sin miedo a sorpresas futuras.

 A pesar de todas las mejoras introducidas en el ejemplo, √©ste a√∫n se podr√≠a perfeccionar m√°s con el uso de m√≥nadas (los famosos monads). Concretamente con un tipo Either o Error que permita componer dentro de la funci√≥n todos los pasos de forma elegante y concisa. Pero esto queda para otro art√≠culo.

 Con lo que debemos quedarnos aqu√≠ es que los union types, los type alias y el pattern matching nos permiten disponer de nuevas formas de codificar nuestros programas convirti√©ndose en una alternativa sencilla y concisa a la herencia de clases, haciendo nuestro c√≥digo m√°s funcional y facilitando su mantenibilidad por medio de contratos cerrados autodocumentados. Si no conoc√≠as estos conceptos, te invito a que experimentes con ellos y des tu opini√≥n.",
    "slug": "union-types-pattern-matching-typescript",
    "tags": [
      "typescript",
    ],
    "title": "Union types y pattern matching con TypeScript.",
    "userPicture": "",
    "username": "Daniel Garc√≠a",
  },
  {
    "category": "typescript",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/TS_category.png",
    "date": "",
    "description": "TypeScript es un superconjunto de Javascript, es decir, ampl√≠a Javascript con una nueva sintaxis que permite llevar JavaScript a otro nivel.",
    "id": "typescript-tutorial-javascript-introduccion",
    "markdownBody": "Este es el primer art√≠culo de una serie sobre el lenguaje de programaci√≥n **Typescript** en la que abordaremos los fundamentos de este magnifico lenguaje open source. **Typescript** fue desarrollado en 2012 por Anders Hejlsberg, creador de Pascal, Delphi y C#, y su equipo en **Microsoft.**

## Qu√© es Typescript

Esencialmente se trata de un **superconjunto de Javascript**, es decir, ampl√≠a Javascript con una nueva sintaxis que a√±ade, entre otras cosas, el **tipado est√°tico** opcional, **gen√©ricos**, **decoradores** y elementos de **POO** como interfaces o property accessors.

TypeScript compila c√≥digo JavaScript que se ejecuta en cualquier navegador, host, sistema operativo o motor de JavaScript que admita ECMAScript 3 (o m√°s reciente).

![typescript superset](https://res.cloudinary.com/software-crafters/image/upload/v1544181785/posts/typescript-javascript-introduccion/superset-typescript.png) 

## Por qu√© Typescript

A lo largo de los √∫ltimos a√±os Javascript ha crecido mucho y se ha convertido en el camino a seguir para escribir aplicaciones multiplataforma (aunque no el √∫nico, sigo siendo fan de Xamarin y C#). Las aplicaciones Javascript pueden ejecutarse en todas las plataformas, ya sea en m√≥viles, web o escritorio. Sin embargo, cuando Javascript fue creado por primera vez su proposito no fue este, sino que fue dise√±ado para un uso simple en aplicaciones muy peque√±as.

TypeScript trata de resolver la mayor√≠a de los problemas con JavaScript centr√°ndose en mejorar la experiencia y la productividad de nosotros, los desarrolladores. Nos permite utilizar t√©cnicas como el tipado est√°tico opcional y/o la encapsulaci√≥n para generar un c√≥digo mucho m√°s mantenible y escalable que con JavaScript tradicional, sin perder el car√°cter din√°mico del mismo.

dem√°s estos dos √∫ltimos a√±os la popularidad de TypeScript se ha disparado y se perfila como uno de los lenguajes de programaci√≥n con **m√°s futuro**.

![typescript-trend](https://res.cloudinary.com/software-crafters/image/upload/v1544181933/posts/typescript-javascript-introduccion/grafica-typescript.png) 

## Instalaci√≥n de Typescript

Para poder instalar typescript el √∫nico **requisito** necesario es tener instalado en nuestro equipo **nodejs** y su administrador de paquetes (**npm**).

Cuando nos referimos a la "instalaci√≥n de typescript" en realidad hacemos referencia a la instalaci√≥n de su **compilador**, llamado **tsc.**  Este se encarga de convertir el c√≥digo TypeScript a Javascript con la versi√≥n ECMAScript compatible que deseemos.

Para instalarlo tan solo tenemos que ejecutar en la terminal lo siguiente:

\`\`\`
npm install -g typescript
\`\`\`

Para comprobar que la instalaci√≥n se ha realizado correctamente ejecuta:

\`\`\`
tsc -v
\`\`\`

Esto nos mostrar√° la versi√≥n, en mi caso la 2.6

## Uso de Typescript CLI

Para probar la instalaci√≥n, creemos un archivo TypeScript simple llamado **helloworld.ts** con el siguiente c√≥digo:

\`\`\`
console.log("Hello world!")
\`\`\`

El siguiente comando compilar√° un archivo \`.ts\` a un archivo \`.js\`:

\`\`\`
tsc helloworld.ts
\`\`\`

Esto crear√° un fichero \`helloworld.js\`. Este fichero lo podemos ejecutar en el navegador o como haremos en este caso, con Node:

\`\`\`
node helloworld.js
//"Hello world"
\`\`\`

El comando tsc se puede utilizar de formas muy variadas, veamos unos cuantos usos interesantes:

### Compilar varios archivos

Para compilar varios archivos:

\`\`\`
tsc hello1.ts hello2.ts hello3.ts
\`\`\`

Tambi√©n podr√≠amos utilizar asteriscos:

\`\`\`
tsc *.ts
\`\`\`

Esto compilar√° todos los ficheros typescript que se encuentren en el directorio. Cada fichero typescript se compilar√° en su archivo javascript correspondiente.

### Unir archivos

Tambi√©n podemos compilar todos los archivos TypeScript en un solo archivo JavaScript. Esto nos ayudar√≠a a reducir el n√∫mero de solicitudes HTTP que un navegador debe realizar y de esta manera mejorar el rendimiento de nuestro sitio web. Para ello utilizaremos la opci√≥n --out del compilador:

\`\`\`
tsc *.ts --out helloworld.js
\`\`\`

### Watcher

Si queremos evitar tener que compilar el archivo typescript cada vez que hagamos una modificaci√≥n del mismo, podemos utilizar la opci√≥n \`--watch\`:

\`\`\`
tsc *.ts --out helloworld.js --watch
\`\`\`

Con esto conseguiremos que cada vez que guardemos las modificaciones el fichero se compilar√° autom√°ticamente.

## Creando un proyecto Typescript

Para crear un proyecto de TypeScript, lo √∫nico que necesitamos es crear un directorio y dentro del mismo crear un archivo de configuraci√≥n de Typescript tsconfig.json. Este fichero, entre otras cosas, indica al compilador qu√© archivos compilar, qu√© archivos ignorar y qu√© a que version de javascript transpilar (por ejemplo, ECMAScript 3).

Para crear nuestro primer proyecto de TypeScript, creemos el nuevo directorio y agreguemos el archivo de configuraci√≥n de TypeScript:

\`\`\`
mkdir myProject
cd myProject
touch tsconfig.json
\`\`\`

### Configuraci√≥n de Typescript

En este articulo ejecutar√© todos los ejemplos en la terminal usando Node.js. Node corre sobre Chrome V8, uno de los motores de JavaScript m√°s actualizados disponibles. La versi√≥n 6 de Node.js se env√≠a con una versi√≥n de Chrome V8 capaz de soportar el 95% de la especificaci√≥n ECMAScript 2015, como se muestra en [Node Green](http://node.green/), mientras que la versi√≥n 8 es compatible con el 99%.

Con respecto a ECMAScript 2017, ambas versiones admiten el 23% y el 73% de las especificaciones, respectivamente. Por lo tanto, la mejor opci√≥n es configurar nuestro proyecto para que se compile en ECMAScript 2015, lo que permitir√° a los usuarios con Node.js 6 y 8 ejecutar los ejemplos sin problemas.

Adem√°s de indicar la versi√≥n de javascript, tambi√©n configuraremos estas otras opciones del compilador:

* \`module\`, indica a Typescript que use el formato [CommonJS](http://requirejs.org/docs/commonjs.html) para los modulos.
* \`removeComments\`, elimina los comentarios del c√≥digo generado.
* \`sourceMap\`, permite usar mapas de origen para asignar el c√≥digo transpilado al c√≥digo fuente.
* \`outDir\`, indica el directorio en el cual se almacenar√° el c√≥digo generado (build).
* \`include\`, indica el directorio de los ficheros a compilar (src).

Nuestro fichero de configuraci√≥n quedar√≠a tal que as√≠:


    \`{
  "compilerOptions": {
    "module": "commonjs",
    "target": "es2015",
    "removeComments": true,
    "outDir": "./build"
  },
  "include": ["src/**/*"]
}\`

Las opciones utilizadas en el archivo de configuraci√≥n anterior son solo un peque√±o subconjunto de lo que TypeScript admite. Por ejemplo, podr√≠amos indicar al compilador que soporte decoradores, archivos tsx, etc. En la documentaci√≥n oficial tenemos una lista con todas las [opciones que admite el compilador.](https://www.typescriptlang.org/docs/handbook/compiler-options.html)

Ahora que entendemos c√≥mo iniciar un proyecto y c√≥mo configurar el compilador, estamos listos para ir profundizando en las diferentes caracter√≠sticas del lenguaje.

## Sistema de tipos

Sin lugar a dudas la principal caracter√≠stica de Typescript es su sistema de tipos, el cual realiza una formalizaci√≥n de los tipos de Javascript, mediante una representaci√≥n est√°tica de su sistema de tipado din√°mico. Esto permite a los desarrolladores definir variables y funciones fuertemente tipadas sin perder la esencia de Javascript (su naturaleza debilmente tipada y su extremada flexibilidad). Poder definir los tipos durante el tiempo de dise√±o nos ayuda a evitar errores en tiempo de ejecuci√≥n, como podr√≠a ser pasar el tipo de variable incorrecto a una funci√≥n.

Veamos con un ejemplo de las ventajas que nos ofrece:

\`let myName: string = "Miguel";
let printName = (name: string) ={
    console.log(name);
}\`

Si intentamos ejecutar la funci√≥n \`printName()\` pas√°ndole un par√°metro vac√≠o o del tipo incorrecto el compilador nos advierte en tiempo de desarrollo, en lugar de generar excepciones en tiempo de ejecuci√≥n. Adem√°s, el intellisense nos ayuda con el autocompletado sugiriendonos la variable m√°s apropiada para pasar como par√°metro a la funci√≥n. Por otro lado, Typescript es lo suficientemente inteligente para inferir el tipo sin indicarselo expl√≠citamente.

  
![typescript-fundamentos](https://res.cloudinary.com/software-crafters/image/upload/v1544181787/posts/typescript-javascript-introduccion/typescript-fundamentos-1.gif) 

## 

Adem√°s de los tipos **String** y **Number**, TypeScript tambi√©n admite los siguientes tipos b√°sicos:

* **Boolean**: tipo de dato logico que representa verdadero o falso.
* **Array**: tipo de dato estructurado que permite almacenar una colecci√≥n de elementos.
* **Tuple**: similar al array, pero con un n√∫mero fijo de elementos escritos.
* **Enum**: representa al tipo enumeraci√≥n. Una enumeraci√≥n es una forma de dar nombres descriptivos a los conjuntos de valores num√©ricos
* **Any**: indica que la variable puede ser de cualquier tipo. Es muy √∫til a la hora de trabajar con librer√≠as externas.
* **Void**: indica que una funci√≥n no devolver√° ning√∫n valor.
* **Never**: este tipo representa el tipo de valores que nunca se producen. Por ejemplo para indicar que una funci√≥n siempre arroja una excepci√≥n o que nunca termina su ejecuci√≥n.

Echemos un vistazo al siguiente codigo para obtener una vision general de lo que Typescript nos permite hacer con los tipos b√°sicos:

\`\`\`
// 1 - declaracion del tipo
type Ranking = [number, string, boolean];

// 2 - definici√≥n de variables
let position: number;
let playerName: string;
let finishedGame: boolean;
let ranking: Ranking;
let hallOfFame: Array<Ranking> = [];

// 3 - crea un ranking
position = 1;
playerName = "Bruno Krebs";
finishedGame = true;
ranking = [position, playerName, finishedGame];
hallOfFame.push(ranking);

// 4 - crea otro ranking
position = 2;
playerName = "Maria Helena";
finishedGame = true;
ranking = [position, playerName, finishedGame];
hallOfFame.push(ranking);

// 5 - define una funcion que recorre todos los rankings
function printRankings(rankings: Array<RankingTuple>): void {
  for (let ranking of rankings) {
    console.log(ranking);
  }
}

// 6 - llama a la funci√≥n
printRankings(hallOfFame);
\`\`\`

Si quieres continuar profundizando en el sistema de tipos de typescript te recomiendo que eches un vistazo a la [documentaci√≥n oficial](https://www.typescriptlang.org/docs/handbook/basic-types.html).

## Estructuras iterativas

En typescript tenemos podemos hacer uso de dos tipos de bucles diferentes **for ... in** y **for .. of**. For... in es una proviene de versiones antiguas de javascript el cual nos permite recorrer objetos iterables obteniendo sus indices. En cambio, For...of es una caracteristica introducida en ES6, la cual nos permite recorrer colecciones obteniendo su valor, veamos las diferencias con un ejemplo:

\`\`\`
let list = [4, 5, 6];

for (let i in list) {
   console.log(i); // "0", "1", "2",
}

for (let i of list) {
   console.log(i); // "4", "5", "6"
}
\`\`\`

## Modulos en typescript

Otra de las caracter√≠sticas de Typescript es heredada de ECMAScript 2015 la posibilidad de crear m√≥dulos, loc cuales no son m√°s que una forma de encapsular c√≥digo en su propio √°mbito. Nos permiten agrupar nuestro c√≥digo en diferentes ficheros, permiti√©ndonos exportarlos y utilizarlos donde los necesitemos. Esto nos facilita la tarea de crear software m√°s ordenado y por ende m√°s escalable y mantenible.

Continuando con el ejemplo de la secci√≥n anterior, si quisieramos exportar el tipo Ranking y la funci√≥n printRankings(), tan solo tendr√≠amos que a√±adirle la palabra reservada **export** antes de la definici√≥n de los mismos:

\`\`\`
export type RankingTuple = [number, string, boolean];

export function printRankings(rankings: Array<RankingTuple>): void {
  for (let ranking of rankings) {
    console.log(ranking);
  }
}

\`\`\`

Para importarlos en otro fichero tan solo nos bastar√≠a con lo siguiente:

import {RankingTuple, printRankings} from './myRankingModule.ts';

## Clases y objetos en Typescript

Un objeto es una entidad que agrupa un estado y una funcionalidad relacionada,una clase, no es m√°s que una plantilla gen√©rica a partir de la cu√°l instanciamos los objetos. Dicho de otra manera, una clase es una abstracci√≥n en la que se define el comportamiento que va a tener el objeto.

Las clases en Typescript son muy similares a lo que nos ofrecen otros lenguajes de orientaci√≥n a objetos tradicionales, esto nos ayudar√° a modularizar nuestro c√≥digo y a simplificar el desarrollo. Veamos con un ejemplo como definir una clase:

\`\`\`
class Employee {
    //atributo accesible desde fuera de la clase
    public name : string;
    //atributos accesible desde clases que hereden de Employee
    protected age: number;
    //access only inside the Employee class
    private mobile : string;

    constructor(name:string ,age:number, mobile:string){
        this.name = name;
        this.age = age;
        this.mobile = mobile;
    }
    getName(){
       return this.name;
    }

    setName(name:string){
       this.name = name;
    }
    getAge(){
       return this.age;
    }

    setAge(age:number){
       this.age = age;
    }

    getMobile(mobile:string){
       this.mobile = mobile;
    }
}
\`\`\`

### M√©todos accesores (Getters y Setters)

Como sabemos, los m√©todos **get** y **set**, tambi√©n conocidos como m√©todos accesores, son simples funciones que usamos en las clases para mostrar (get) o modificar (set) el valor de un atributo. Normalmente los escribimos como "get" o "set" seguido del nombre de la propiedad a la que queremos acceder, por ejemplo: getName(). En Typescript se puede hacer de esta forma o haciendo uso de las palabras reservadas get o set delante del nombre de la funci√≥n:

\`\`\`
class Actor {
    private _name : string;
    constructor(_name:string){
        this._name = _name;
    }
    set name (value: string){
        this._name = value;
    }
    get name (){
        return this._name;
    }
}

let actor = new Actor('Haider Malik');
console.log(actor.name);
//set
actor.name = 'Jane Doe';
console.log(actor.name);
\`\`\`

### Herencia en typescript

Otro elemento fundamental en la OO es la herencia, la cual nos permite extender la funcionalidad nuestra clase herendando de una clase padre. La clase hija hereda todos los miembros de su clase base y puede sobreescribir todos aquellos m√©todos y/o propiedades p√∫blicos o protegidos.

\`\`\`
class Manager extends Employee {
   constructor(name : string, age: number , mobile : string){
       super(name,age,mobile);
       this.age = 24;
   }
}

let manager = new Manager(‚ÄòJane‚Äô,23, ‚Äò0343‚Äì23332233‚Äô);
console.log(manager.getName());
console.log(manager.getAge());
\`\`\`

### Clases abstractas

Este tipo de clases no pueden ser instanciadas ya que se usan para definir comportamientos independientemente de su concreci√≥n. Su implementaci√≥n en typescript es similar a la de una clase normal con la diferencia que hay que anteponer el termino **abstract** antes de declararlas.

\`\`\`
abstract class Product {
    productName : string = "Default";
    price :number = 1000;
    abstract changeName(name: string): void;

    calcPrice(){
        return this.price;
    }
}

class Mobile extends  Product {
    changeName(name : string) : void {
        this.productName = name;
    }
}

let mobProduct = new Mobile();
console.log(mobProduct);
mobProduct.changeName("Super It Product");
console.log(mobProduct);
\`\`\`

## Interfaces en Typescript

Las interfaces son abstracciones que definen el comportamiento de las clases que la implementan. Son muy pr√°cticas ya que nos permiten decirle al compilador cual es el comportamiento que debe esperar del objeto que definamos. Como ocurre en otros lenguajes de programaci√≥n, TypeScript no requiere que un objeto tenga exactamente la misma estructura definida por la interfaz. Para que se los considere v√°lidos, los objetos pueden tener cualquier forma siempre que definan las funciones y propiedades requeridas por la interfaz que implementan. Veamos un peque√±o ejemplo de como declararla e implementarla:

\`\`\`
interface ICar{
    engine: string;
    color: string;

    brake: () => void;
}

class Car implements ICar {
    constructor (public engine: string, public color: string) {
    }

    function brake(){
        console.log("Frenando...")
    }
}
\`\`\`

## Decoradores en typescript

Los decoradores son un est√°ndar propuesto en ECMAScript2016\\. En Typescript podemos habilitarlos a√±adiendo a nuestro tsconfig.json la directiva "experimentalDecorators: true".

\`\`\`
{
    "compilerOptions": {
    "module": "commonjs",
    "target": "es2015",
    "removeComments": true,
    "experimentalDecorators": true,
    "outDir": "./build"
  },
  "include": ["src/**/*"]
}
\`\`\`

Por si no lo sab√≠as, los decoradores son un mecanismo para modificar clases, m√©todos, propiedades e incluso par√°metros de forma declarativa. Obviar√© los decoradores de propiedades y de par√°metros ya que en la practica no resultan demasiado interesantes.

### Decorador de clase

Un decorador de clase es una funci√≥n que recibe y devuelve el m√©todo constructor de la clase que "decora". Veamos un ejemplo de implementaci√≥n:

\`\`\`
const log = (originalConstructor: new(...args: any[]) => T) => {
    function newConstructor(... args) {
        console.log("Argumentos: ", args.join(", "));
        new originalConstructor(args);
    }

    newConstructor.prototype = originalConstructor.prototype;
    return newConstructor;
}

@log
class Person {
    constructor(name: string, age: number) {}
}

new Person("Miguel", 33);
//Argumentos: Miguel, 33
\`\`\`

Como podemos observar el decorador log reemplaza el constructor de la clase por una funci√≥n que, en primer lugar, registra a trav√©s de la consola los argumentos y luego devuelve el constructor original.

### Decorador de m√©todos

El decorador de m√©todos es una funci√≥n que acepta 3 argumentos: el objeto sobre el que se define el m√©todo, la clave de la propiedad y un descriptor de propiedad:

\`\`\`
const log = (target: Object, key: string | symbol, descriptor: TypedPropertyDescriptor<Function>) => {
    return {
        value: function( ... args: any[]) {
            console.log("Arguments: ", args.join(", "));
            const result = descriptor.value.apply(target, args);
            console.log("Result: ", result);
            return result;
        }
    }
}

class Calculator {
    @log
    add(x: number, y: number) {
        return x + y;
    }
}

new Calculator().add(1, 3);
//Arguments: 1, 3
//Result: 4
\`\`\`

En este ejemplo, el decorador log reemplaza la funci√≥n original por una nueva que registra los argumentos recibidos, ejecuta el m√©todo original, almacena el resultado en una variable local lo registra en la consola y finalmente lo devuelve.

### Resumen

En este articulo he tratado de mostrar la mayor√≠a de caracter√≠sticas b√°sicas de Typescript. Aunque he condensado bastante informaci√≥n en este art√≠culo, me he dejado much√≠simos elementos en el tintero. La idea es que esta entrada sirva como base a futuras publicaciones relacionadas con este magnifica lenguaje.

Espero haber facilitado tu transici√≥n a Typescript, si ya lo conoc√≠as espero que el art√≠culo te sirva como referencia. Si te ha gustado la entrada valora y comparte en tus redes sociales. No dudes en comentar dudas, aportes o sugerencias, estar√© encantado de responder.

Este art√≠culo se distribuye bajo una [Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES)

[![licencia-cc](https://res.cloudinary.com/software-crafters/image/upload/v1544181784/licencia-cc.png)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES)",
    "slug": "typescript-tutorial-javascript-introduccion",
    "tags": [
      "typescript",
    ],
    "title": "Tutorial de Typescript, el javascript que escala. Introducci√≥n.",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "react",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/ReactJS_category.png",
    "date": "",
    "description": "¬øQu√© es React? ReactJS es una librer√≠a Javascript desarrollada por Facebook y dise√±ada para ayudarnos a crear SPA's (Single Page Application).",
    "id": "tutorial-react-js-introduccion",
    "markdownBody": " Hoy me toca escribir sobre otra de las tecnolog√≠as que uso en varios de los proyectos en los que trabajo, **ReactJS**. Se que existe much√≠sima informaci√≥n en la red sobre esta librer√≠a, aunque en muchos casos inconexa.

 El objetivo de este art√≠culo es tratar de organizar y condensar los conceptos fundamentales para comenzar a utilizar esta tecnolog√≠a desarrollando un ejemplo pr√°ctico ([demo](https://softwarecrafters.io/demos/intro-reactjs)).

## ¬øQu√© es React.js?

 Como muchos ya sabr√©is, **ReactJS** es una **librer√≠a Javascript** desarrollada por **Facebook** y dise√±ada para ayudarnos a crear **SPA's** (Single Page Application), su objetivo concretamente es tratar de facilitar la tarea de **desarrollar interfaces** de usuario. Podr√≠amos decir que React es la **V** en un contexto en el que se use el patr√≥n MVC o MVVM.

 Hace uso del paradigma denominado [programaci√≥n orientada a componentes](https://es.wikipedia.org/wiki/Programaci%C3%B3n%5Forientada%5Fa%5Fcomponentes). Dichos componentes se representan como clases que heredan de la clase \`Component\` cuyo √∫nico requerimiento especial es especificar el m√©todo render que define cu√°l ser√° el contenido del mismo:

\`class MyComponent extends React.Component {
  render() {
    return (
      <h1>Hello World</h1>
    );
  }
}\`

 La definici√≥n de dichos componentes se realiza usando una sintaxis especial llamada **JSX** que permite escribir etiquetas HTML dentro de JavaScript para mejorar la expresividad del c√≥digo. Usar JSX no es obligatorio, pero si es muy recomendable. Para m√°s informaci√≥n sobre JSX puedes consultar la [documentaci√≥n oficial](https://facebook.github.io/react/docs/jsx-in-depth.html).

## Configuraci√≥n del entorno mediante "Create React App"

 Normalmente cuando vamos a construir una aplicaci√≥n Web con Javascript tendremos que lidiar con una cantidad de ingente de herramientas como gestores de paquetes, transpiladores, linkers, builders, etc. El equipo de desarrollo de Facebook ha sabido ver esta problem√°tica y se ha sacado de la manga el proyecto [Create React App](https://github.com/facebookincubator/create-react-app), el cual realizar√° por nosotros toda la configuraci√≥n inicial necesaria para poder empezar a desarrollar con React.

**Create React App** se puede utilizar con el nuevo gestor de dependencias [Yarn](https://yarnpkg.com/en/), creado tambi√©n por la gente de Facebook, o con el cl√°sico **NPM**. En el art√≠culo har√© uso de NPM, aunque te aconsejo que le des una oportunidad a Yarn, tiene muy buena pinta.

 El √∫nico requisito imprescindible para poder hacer uso de Create React App con NPM es tener instalado en el sistema una versi√≥n de [NodeJs](https://nodejs.org/es/) \\>= 4\\. Si ya dispones de npm puedes instalar \`create react app\` como cualquier otro paquete:

\`\`\`
npm install -g create-react-app
\`\`\`

 Una vez instalado puedes inicializar el proyecto:

\`\`\`
create-react-app MyWebApp
\`\`\`

 Con este simple gesto tendr√°s configurado[ JavaScript ES6](http://www.ecma-international.org/ecma-262/6.0/) con [React](https://facebook.github.io/react/), [Webpack](https://webpack.github.io/), [Babel](https://babeljs.io/) y [Eslint](http://eslint.org/), nada de instalar dependencias, ni de crear tareas. Est√° todo listo para ejecutar el servidor de desarrollo, y probar la aplicaci√≥n:

\`\`\`
cd MyWebApp
npm start
\`\`\`

Con el servidor corriendo, dir√≠gete a la url 127.0.0.1:3000 para ver la aplicaci√≥n en funcionamiento:

![create-react-app](https://res.cloudinary.com/software-crafters/image/upload/v1544294255/posts/tutorial-react-js-introduccion/create-react-app.png) 

 El proyecto generado tendr√° una estructura tal que as√≠:

\`\`\`
\`\`\`
MyWebApp/
  README.md
  node_modules/
  package.json
  public/
    index.html
    favicon.ico
  src/
    App.css
    App.js
    App.test.js
    index.css
    index.js
    logo.svg
\`\`\`
\`\`\`

* **node\\_modules**: contiene las dependencias npm del proyecto
* **public**: esta es la ra√≠z de nuestro servidor donde se podr√° encontrar el index.html, el archivo principal y el favicon.
* **src**: es el directorio principal donde vamos a colocar los archivos de nuestros componentes.

 Adem√°s encontrar√°s varios archivos sueltos, un readme, el .gitignore y el **package.json**, este √∫ltimo contiene las dependencias de npm adem√°s de la informaci√≥n del proyecto.

 Es importante tener en cuenta que para que Create React App funcione correctamente tenemos que tener obligatoriamente el fichero principal de html en "public/index.html" y punto de entrada de javascript en "scr/index.js".

## La app de ejemplo

 La app que se va a desarrollar constar√° de un formulario en el que el usuario podr√° introducir un nombre y un email, y estos se a√±adir√°n a un listado (demo).

 La web app estar√° formada por tres componentes que iremos construyendo a lo largo del art√≠culo, \`User\`, \`UserList\`, \`UserForm \`; adem√°s del componente principal (\`App\`) y el punto de entrada (\`index.js\`. Puedes descargar el ejemplo completo desde mi cuenta de [Github](https://github.com/miguelghz/Intro-ReactJS).

### El componente principal y el punto de entrada javascript

 Como he comentado el punto de entrada a la aplicaci√≥n es el fichero scr/index.js, en este se inicializa el componente principal App.js, a trav√©s del m√©todo \`ReactDOM.Render\`. Dicho m√©todo recibe como primer par√°metro el componente a renderizar y como segundo el elemento del DOM donde el componente va ser renderizado:

\`\`\`
import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';

ReactDOM.render(
  <App />,
  document.getElementById('root')
);


\`\`\`

A continuaci√≥n vemos el c√≥digo auto-generado que corresponde al componente principal:

\`\`\`
import React, { Component } from 'react';
import logo from './logo.svg';
import './App.css';

class App extends Component {
  render() {
    return (
      <div className="App">
        <div className="App-header">
          <img src={logo} className="App-logo" alt="logo" />
          <h2>Bienvenido a React</h2>
        </div>
          <p className="App-intro">
            Lista de usuarios
          </p>
      </div>
    );
  }
}

export default App;


\`\`\`

 Antes de continuar desarrollando el ejemplo voy eliminar unas cuantas l√≠neas de este componente para dejarlo, por ahora, lo m√°s simple posible:

\`\`\`
import React, { Component } from 'react';

class App extends Component {
  render() {
    return (
      <h1>Hello World!</h1>
    );
  }
}

export default App;


\`\`\`

 En la primera l√≠nea \`import React‚Ä¶ \` se est√° importando la librer√≠a React y la clase Component de la cual van a heredar todos los componentes que se creen mediante clases. √âstas requieren del m√©todo \`render()\` para poder funcionar.

 En la versi√≥n previa de Javascript se utilizaba la funci√≥n \`React.createClass\` para inicializar componentes, gracias a ES6 y a su az√∫car sint√°ctico, esto se ha simplificado.

## Propiedades (props) de react

 Las propiedades de un componente (props) pueden definirse como los atributos de configuraci√≥n para dicho componente. √âstas son recibidas desde un nivel superior, normalmente al realizar la instanciaci√≥n del componente y por definici√≥n son inmutables.

 Siguiendo con el ejemplo, voy a implementar el componente \`User\`, el cual contiene dos props \`name\` y \`user\`, las cuales redenrizar√° en un elemento de lista \`li\`.

\`\`\`
import React, { Component } from 'react';

class User extends Component {
  render () {
    return (
      <li>
        {this.props.name} - {this.props.email}
      </li>
    );
  }
}

export default User;

\`\`\`

 Las props, basicamente, son el mecanismo principal de React para pasar datos de un componente padre a un componente hijo.

### Anidaci√≥n de componentes

 Una vez creado el componente User, definiremos el componente \`UserList\`, cuyo objetivo ser√° renderizar una lista de componentes \`User\`:

\`\`\`
class UserList extends Component {
  render () {
    return (
        <ul>
          {this.props.users.map(u => {
            return (
              <User
                key={u.id}
                name={u.name}
                email={u.email}
              />
            );
          })}
        </ul>
    );
  }
}

\`\`\`

 En el c√≥digo del componente anterior renderizar√° una lista de usuarios, para ello hace uso del m√©todo \`map\`, con el cual itera sobre cada uno de los elementos del array de usuarios que contiene la propiedad \`this.props.users\`, esta prop ser√° recibida desde el componente \`App\`.

 Map devuelve por cada elemento un componente \`User\`, el cual recibe v√≠a props el nombre, el email y una key. La propiedad key es un identificador que usa React en las listas, para renderizar los componentes de forma m√°s eficiente.

## Estado en los componentes

 Podr√≠a definirse el estado de un componente como una representaci√≥n del mismo en un momento concreto, algo as√≠ como una instant√°nea del componente. Dicho estado se iniciar√° con un valor por defecto.

 Existen dos tipos de componentes con y sin estado, tambi√©n denominados statefull y stateless, respectivamente.

### Componentes stateless

 Todos los componentes implementados hasta el momento han sido stateless, sin estado. Este tipo de componentes podr√≠an representarse como una funci√≥n pura:

\`\`\`

    function User(props) {
    return (
        <li>{props.name} - {props.email}</li>
    );
}

\`\`\`

 Las funciones puras por definici√≥n no tienen efectos colaterales, con lo cual este tipo de componentes no admite ciclos de vida. Para no complicar las cosas, continuaremos creando nuestros componentes como clases.

### Componentes statefull

 Los componentes con estado permiten mantener datos propios a lo largo del tiempo e implementar comportamientos en sus diferentes m√©todos del ciclo de vida.

### El ciclo de vida de un componente en React

 El ciclo de vida no es m√°s que una serie de estados por los cuales pasa todo componente a lo largo de su existencia, basicamente se pueden clasificar en tres etapas de montaje o inicializaci√≥n, actualizaci√≥n y destrucci√≥n. Dichas etapas tienen correspondencia en diversos m√©todos, que nosotros podemos implementar para realizar acciones concretas cuando estos van sucendiendo. Aunque en el ejemplo que estamos desarrollando no voy a hacer uso del ciclo de vida, har√© un peque√±o inciso para describir sus m√©todos sin profundizar excesivamente:

![Ciclo de vida de los componentes en React](https://res.cloudinary.com/software-crafters/image/upload/v1544294255/posts/tutorial-react-js-introduccion/Cheatsheet-life-cicle.jpg) 

**M√©todos de inicializaci√≥n:**

* \`componentWillMount()\`: se ejecuta antes de que se renderice el componente por primera vez, es muy util para manejar ciertos datos necesarios para la representaci√≥n del componente o declarar ciertos eventos. Las referencias a los elementos del componente aun no est√°n disponibles.
* \`componentDidMount()\`: se dispara justo despu√©s del primer renderizado, es decir el DOM ya est√° disponible. Este es el sitio adecuado para realizar peticiones AJAX, setIntervals o integrar librer√≠as de terceros.

**M√©todos de actualizaci√≥n:**

* \`componentWillReceiveProps(nextProps)\`: es ejecutado cuando las propiedades se van a actualizar, recibe el pr√≥ximo valor que va a tener el objeto de propiedades.
* \`shouldComponentUpdate(nextProps, nextState)\`: se lanza antes del render y decide si nuestro componente se re-renderiza o no. Recibe dos parametros, las nuevas propiedades y el nuevo estado.
* \`componentWillUpdate(nextProps, nextState)\`: se ejecutar√° justo despu√©s de que shouldComponentUpdate devuelva true, est√° pensado para preparar al componente para su actualizaci√≥n por lo que se debe evitar modificar estados en este punto.
* \`componentDidUpdate(prevProps, prevState)\`: se invoca justo despu√©s de haberse producido la actualizaci√≥n del componente, los cambios ya est√°n trasladados al DOM.

**M√©todos de desmontaje:** 

* \`componentWillUnmount()\`: es el √∫nico m√©todo que interviene en el desmontaje de un componente, es invocado justo antes de que el componente se desmonte, es ideal para realizar operaciones de limpieza como listeners de eventos o temporizadores.

 Continuando con el ejemplo, voy a modificar el componente App para asignarle un estado inicial que almacene un array con varios objetos "user". Para ello sobreescribiremos el m√©todo constructor del componente asignando al estado inicial (\`this.state\`) el array de usuarios.

 Finalmente, en el m√©todo render renderizar√° un componente del tipo \`UserList\`, al cual se le pasa el estado a trav√©s de la prop \`users\`. Quedando el componente tal que as√≠:

\`\`\`

class App extends Component {
  constructor() {
    super();
    this.state = {
      users: [
        {id: 1, name: "miguel", email: "test@miguelgomez.io"},
        {id: 2, name: "test", email: "test@test.es"}
      ]
    };
  }

  render() {
    return (
        <UserList users={this.state.users} />
    );
  }
}

\`\`\`

 Gracias al estado se pueden a√±adir nuevos usuarios al array los cuales se renderizar√°n autom√°ticamente. Esto es posible ya que, como hemos visto en los ciclos de vida, el estado tiene la particularidad de que cuando cambia el m√©todo render vuelve a ejecutarse.

## Propagaci√≥n de eventos

Los eventos, al contrario que las propiedades, se propagan de hijos a padres. Es decir, son lanzados por los componentes hijos y el padre es el encargado de gestionarlos.

 Veamos esto en nuestro ejemplo, para ello vamos a√±adir al componente UserForm un formulario con dos campos, uno para el email y otro para el nombre.

\`\`\`

import React, { Component } from 'react'

export default class UserForm extends Component{
  render(){
    return (
      <form onSubmit={this.props.onAddUser}>
          <input type="text" placeholder="Nombre" name="name" />
          <input type="email" placeholder="Email" name="email" />
          <input type="submit" value="Guardar" />
      </form>
    );
  }
}

\`\`\`

 Cada vez que se pulse el bot√≥n guardar el formulario disparar√° el evento \`onSubmit()\`, el cual llama a una funci√≥n que recibir√° del componente padre a trav√©s de la propiedad \`props.OnAddUser\` (a esto se le conoce como **Callback**).

 La funci√≥n callback se define en el componente App, \`handleOnAddUser(event)\` y ser√° la encargado de manejar el evento.

\`\`\`

    class App extends Component {
  constructor() {
    super();
    this.state = {
      users: [
        {id: 1, name: "miguel", email: "miguelghz@miguelgomez.io"},
        {id: 2, name: "test", email: "test@test.es"}
      ]
    };
  }

  handleOnAddUser (event) {
    event.preventDefault();
    let user = {
      name: event.target.name.value,
      email: event.target.email.value
    };
    this.setState({
      users: this.state.users.concat([user])
    });
  }

  render() {
    return (
        <div>
          <UserList users={this.state.users}  />
          <UserForm onAddUser={this.handleOnAddUser.bind(this)} />
        </div>
    );
  }
}

\`\`\`

 El m√©todo \`handleOnAddUser\` recibe como par√°metro un objecto event, el cual contiene toda la informaci√≥n del evento, tanto su comportamiento como los valores de los inputs del formulario. Para evitar que el evento dispare su comportamiento por defecto (en este caso recargar la p√°gina), ejecutaremos el m√©todo \`preventDefault()\` antes de capturar los valores de los campos "name" y "user".

 Por √∫ltimo, actualizaremos el array, para ello en lugar de modificarlo a√±adiendo el nuevo elemento con el m√©todo \`push\`, usamos el m√©todo \`concat\`. De esta manera se crear√° un nuevo array en lugar de modificar el existente, manteniendo as√≠ cierta inmutabilidad en el estado del componente.

 Puedes descargar el ejemplo completo desde [aqu√≠](https://github.com/miguelghz/Intro-ReactJS).

## Resumen

 En este tutorial he tratado de mostrar el funcionamiento b√°sico de ReactJS mientras he ido exponiendo los elementos fundamentales. Aunque he condensado bastante informaci√≥n en este art√≠culo, me he dejado much√≠simos elementos en el tintero. La idea es que esta entrada sirva como base a futuras publicaciones relacionadas con esta magnifica librer√≠a.

 Espero haber facilitado tu transici√≥n a ReactJS, si ya lo conoc√≠as espero que el art√≠culo te sirva como referencia.

 Si te ha gustado la entrada valora y comparte en tus redes sociales. No dudes en comentar dudas, aportes o sugerencias, estar√© encantado de responder.

 Este art√≠culo se distribuye bajo una [Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES) 

[![licencia-cc](https://res.cloudinary.com/software-crafters/image/upload/v1544181784/licencia-cc.png)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES)",
    "slug": "tutorial-react-js-introduccion",
    "tags": [
      "react",
    ],
    "title": "Tutorial de React JS. Introducci√≥n",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "python",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/Python_category.png",
    "date": "",
    "description": "SOLID es un acroÃÅnimo creado por Michael Feathers para los principios publicados por Robert C. Martin. Son 5 principios que nos ayudar√°n a escribir mejor c√≥digo.",
    "id": "principios-solid-python",
    "markdownBody": "El objetivo de este art√≠culo es que el lector aprenda aplicar los principios SOLID con el lenguaje Python. SOLID es un acroÃÅnimo creado por [Michael Feathers](https://michaelfeathers.silvrback.com/ "Michael Feathers (page does not exist)") para los principios publicados por [Robert C. Martin](https://sites.google.com/site/unclebobconsultingllc/), en su libro [Agile Software Development: Principles, Patterns, and Practices](http://www.goodreads.com/book/show/84985.Agile%5FSoftware%5FDevelopment%5FPrinciples%5FPatterns%5Fand%5FPractices).

Se trata de cinco principios de dise√±o orientado a objetos que nos ayudar√°n a crear mejor c√≥digo, m√°s estructurado, con clases de responsabilidad m√°s definida y m√°s desacopladas entre s√≠:

* **S**ingle Responsibility: Responsabilidad uÃÅnica.
* **O**pen/Closed: Abierto/Cerrado.
* **L**iskov substitution: SustitucioÃÅn de Liskov.
* **I**nterface segregation: SegregacioÃÅn de interfaz.
* **D**ependency Inversion: InversioÃÅn de dependencia.

Es importante resaltar que se trata de principios, no de reglas. Una regla es de obligatorio cumplimiento, en cambio, los principios son recomendaciones que pueden ayudar a hacer las cosas mejor. Adem√°s, siempre puedes encontrar alg√∫n contexto en el que te los puedas saltar, lo importante es hacerlo de forma consciente.

## Single Responsibility Principle (SRP)

> \\[bctt tweet="Nunca deber√≠a haber m√°s de un motivo por el cual cambiar una clase"\\]

 El primero de los cinco principios, single responsibility principle o en castellano, principio de responsabilidad uÃÅnica, viene a decir que una clase debe tener tan solo una uÃÅnica responsabilidad. A finales de los 80, [Kent Beck](https://es.wikipedia.org/wiki/Kent%5FBeck) y [Ward Cunningham](https://es.wikipedia.org/wiki/Ward%5FCunningham), ya aplicaban este principio mediante tarjetas CRC (Class, Responsibility, Collaboration) con las que detectaban responsabilidades y colaboraciones entre clases.

 El principio responsabilidad √∫nica no se basa en dise√±ar clases con un s√≥lo m√©todo, sino √©stas tan s√≥lo deber√≠an tener una fuente de cambio. En otras palabras, aquellas clases que se vieran obligadas a cambiar ante una modificaci√≥n en la base de datos y a la vez ante un cambio en la l√≥gica de negocio, tendr√≠a m√°s de un motivo para cambiar, es decir, m√°s de una responsabilidad.

 Este principio se suele incumplir cuando en una misma clase est√°n involucradas varias capas de la arquitectura. Veamos un ejemplo:

\`\`\`
class Vehicle(object):
    def __init__(self, name):
        self._name = name
	self._persistence = MySQLdb.connect()
        self._engine = Engine()

    def getName():
        return self._name()

    def getEngineRPM():
        return self._engine.getRPM()

    def getMaxSpeed():
        return self._speed

    def print():
    return print ‚ÄòVehicle: {}, Max Speed: {}, RMP: {}‚Äô.format(self._name, self._speed, self._engine.getRPM())
\`\`\`

 A primera vista se puede detectar que estamos mezclando tres capas muy diferenciadas: la l√≥gica de negocio, la l√≥gica de presentaci√≥n y la l√≥gica de persistencia. Adem√°s estamos instanciando la clase \`engine\` dentro de \`vehicle\`, as√≠ que tambi√©n nos estamos saltando el principio de inversi√≥n de dependencias.

 Una soluci√≥n para el problema de las m√∫ltiples responsabilidades de la clase anterior, podr√≠a pasar por abstraer dos clases, como por ejemplo \`VehicleRepository\` para manejar la persistencia y \`VehiclePrinter\` para gestionar la capa de presentaci√≥n.

\`\`\`
class Vehicle(object):
    def __init__(self, name, engine):
        self._name = name
        self._engine = engine

    def getName(self):
        return self._name()

    def getEngineRPM(self):
        return self._engine.getRPM()

    def getMaxSpeed(self):
        return self._speed


class VehicleRepository(object):
    def __init__(self, vehicle, db)
        self._persistence = db
        self._vehicle = vehicle


class VehiclePrinter(object):
    def __init__(self, vehicle, db)
        self._persistence = db
        self._vehicle = vehicle

    def print(self):
    return print ‚ÄòVehicle: {}, Max Speed: {}, RMP: {}‚Äô.format(self._vehicle.getName(), self._vehicle.getMaxSpeed(), self._vehicle.getRPM())
\`\`\`

 En este caso se ve√≠a muy claro lo que ten√≠amos que hacer para aplicar correctamente el SRP, pero muchas veces los detalles ser√°n m√°s sutiles y probablemente no los detectar√°s a la primera. No te obseciones simplemente aplica el sentido com√∫n.

## Open-Closed Principle (OCP)

> "Todas las entidades software deberiÃÅan estar abiertas a extensioÃÅn, pero cerradas a modificacioÃÅn"

El segundo de los principios, Open-Closed (Abierto/Cerrado), cuyo nombre se lo debemos a [Bertrand Meyer](https://bertrandmeyer.com/bio/). B√°sicamente nos recomienda que cuando se pretende introducir un nuevo comportamiento en un sistema existente, en lugar de modificar las clases antiguas, se deben crear nuevas mediante herencia y redefinici√≥n de los m√©todos de la clase padre (polimorfismo), o inyectando dependencias que implementen el mismo contrato.

Este principio promete mejoras en la estabilidad de tu aplicaci√≥n al evitar que los objetos existentes cambien con frecuencia, lo que tambi√©n hace que las cadenas de dependencia sean un poco menos fr√°giles ya que habr√≠a menos partes m√≥viles de las que preocuparse. Este principio aplica bien a la hora trabajar con un framework o con c√≥digo legacy, evidentemente si el c√≥digo lo has hecho tu o tu equipo, refactoriza.

 Un buen ejemplo en el que se aplica este principio es el que ve√≠amos en [ este art√≠culo ](https://miguelgomez.io/django/extender-user-django/#AbstractUser) a la hora de [ extender el user de django ](https://miguelgomez.io/django/extender-user-django/#AbstractUser) desde la clase \`AbstractUser\` 

\`\`\`
from django.db import models

from django.db import models
from django.contrib.auth.models import AbstractUser

class User(AbstractUser):
    bio = models.TextField(max_length=500, blank=True)
    location = models.CharField(max_length=30, blank=True)
    birth_date = models.DateField(null=True, blank=True)

\`\`\`

## Liskov Substitution Principle (LSP)

> "Las funciones que utilicen punteros o referencias a clases base deben ser capaces de usar objetos de clases derivadas sin saberlo." username="unclebobmartin"

 El principio de Sustituci√≥n de Liskov, obtiene su nombre de [Barbara Liskov](https://es.wikipedia.org/wiki/Barbara%5FLiskov). Este principio est√° relacionado con el anterior en lo que a la extensibilidad de las clases se refiere, y viene a decir que dada una instancia de una clase B, siendo esta un subtipo de una clase A, debemos poder sustituirla por una instancia de la clase A sin mayor problema.

 En los lenguajes orientados a objetos de tipado est√°tico, este principio describe principalmente una regla sobre una relaci√≥n entre una subclase y una superclase. Cuando hablamos de lenguajes de tipado din√°mico como Python, nos interesa qu√© mensajes responde ese objeto en lugar de a qu√© clase pertenece.

 Un ejemplo que ilustra bastante bien la importancia de este principio es el de tratar de modelar un cuadrado como la concreci√≥n de un rect√°ngulo:

\`\`\`
class Rectangle(object):

    def getWidth(self)
        return _width

    def setWidth(self, width)
        self._width = width

    def getHeight(self)
        return _height

    def setHeight(self, height)
        self._height = height

    def calculateArea(self)
        return self._width * self._height;

class Square(Rectangle):
    def setWidth(self, width)
        self._width = width
        self._height = height

    def setWidth(self, height)
        self._height = height
        self._width = width

class TestRectangle(unittest.TestCase):

    def setUp(self):
        pass

    def test_calculateArea(self):
        r = Rectangle()
        r.setWidth(5);
        r.setHeight(4);
        self.assertEqual(r.calculateArea(), 20)

\`\`\`

 Si tratamos de sustituir en el test el rect√°ngulo por un cuadrado, el test no se cumple, ya que el resultado ser√≠a 16 en lugar de 20\\. Estar√≠amos por tanto violando el principio de sustituci√≥n de Liskov.

 La regla principal para no violar este principio es b√°sicamente tratar de heredar lo menos posible o no usar los mixins a menos que se est√© bastante seguro de que el comportamiento que est√° implementando no interferir√° con las operaciones internas de sus ancestros.

## Interface Segregation Principle (ISP)

> "Los clientes no deber√≠an estar obligados a depender de interfaces que no utilicen."

 El principio de segregaci√≥n de la interfaz nos indica que ninguna clase deber√≠a depender de m√©todos que no usa. Cuando creemos interfaces (clases en lenguajes interpretados como Python) que definan comportamientos, es importante estar seguros de que todas los objetos que implementen esas interfaces/clases se vayan a necesitar, de lo contrario, es mejor tener varias interfaces/clases peque√±as.

 Una forma de no violar este principio en Python es aplicando [**duck typing**](https://en.wikipedia.org/wiki/Duck%5Ftyping#In%5FPython). Este concepto viene decir que los m√©todos y propiedades de un objeto determinan su validez sem√°ntica, en vez de su jerarqu√≠a de clases o la implementaci√≥n de una interfaz espec√≠fica.

## Dependency Inversi√≥n Principle (DIP)

> "Los moÃÅdulos de alto nivel no deben depender de moÃÅdulos de bajo nivel. Ambos deben depender de abstracciones. "

> "Las abstracciones no deben depender de concreciones. Los detalles deben depender de abstracciones."

 Quinto y √∫ltimo de los principios, la inversioÃÅn de dependencia, cuyo objetivo principal es desacoplar nuestro coÃÅdigo de sus dependencias directas. Este principio viene a decir que las clases de las capas superiores no deber√≠an depender de las clases de las capas inferiores, sino que ambas deber√≠an depender de abstracciones. A su vez, dichas abstracciones no deber√≠an depender de los detalles, sino que son los detalles los que deber√≠an depender de las mismas.

 La inversi√≥n de dependencias da origen a la inyecci√≥n de dependencias. Este concepto se basa en hacer que una clase A inyecte objetos en una clase B en lugar de dejar que sea la propia clase B la que se encargue de instanciar el objeto. Veamoslo con el ejemplo del vehiculo:

\`\`\`
class Engine(object):
    def __init__(self):
        pass

    def accelerate(self):
        pass

    def getRPM(self):
        currentRPM = 0
        #...
        return currentRPM

class Vehicle(object):
    def __init__(self):
        self._engine = Engine()

    def getEngineRPM(self)
        return self._engine.getRPM();

\`\`\`

 El c√≥digo anterior ilustra la manera ‚Äúhabitual‚Äù de definir la colaboraci√≥n entre clases. Como podemos observar, existe una clase \`Vehicle\` que contiene un objeto de la clase \`Engine\`. La clase \`Vehicle\` obtiene las revoluciones del motor invocando el m√©todo \`getEngineRPM\` del objeto Motor y devolviendo su resultado. Este caso se corresponde con una dependencia, el m√≥dulo superior \`Vehicle\` depende del m√≥dulo inferior \`Engine\`, lo cual genera un c√≥digo tremendamente acoplado y dificil de testear.

 Para desacoplar la dependencia \`Engine\` de \`Vehicle\` debemos hacer que la clase \`Vehicle\` deje de responsabilizarse de instanciar el objeto \`Engine\`, inyect√°ndolo como par√°metro al constructor, evitando as√≠ que la responsabilidad recaiga sobre la propia clase. De este modo desacoplamos ambos objetos, quedando la clase tal que as√≠:

\`\`\`
class Vehicle(object):
    def __init__(self, engine):
        self._engine = engine

    def getEngineRPM(self)
    return self._engine.getRPM();
\`\`\`

 Ahora la responsabilidad de instanciar la clase \`engine\` ya no corresponde a la clase \`vehicule\`. Adem√°s, en Python, el par√°metro \`engine\` no tiene porqu√© ser una instancia de la clase \`engine\`, podr√≠a ser cualquier objeto siempre y cuando tuviera un m√©todo \`getRPM()\`. Esta es una ventaja inherente a los lenguajes din√°micos, ya que nos permiten aprovechar el duck typing y evitar as√≠ tener que definir el tipo de la dependencia.

 Hasta ahora no he comentado nada de sobre los contenedores de inversi√≥n de control, aunque no es necesario para hacer inyecci√≥n de dependencias, puede ser interesante su uso, sobre todo en los lenguajes de tipado est√°tico. En los lenguajes din√°micos los contenedores de inversi√≥n de control pierden su inter√©s ya que en los constructores de las clases no est√° especificado el tipo de las dependencias y si quieren usar estar√°s obligado a definir de forma un tanto forzada las dependencias entre los objetos para que el contenedor pueda componer unos con otros.

 Como hemos podido ver, la inyecci√≥n de dependencias por si misma nos ayuda a crear clases con responsabilidad m√°s definida, m√°s estructuradas y desacopladas entre s√≠.

### Resumen

 Los prinpicios SOLID, pese al abuso que se hace √∫ltimamente de ellos, son una herramienta que nos ayudan a comprender mejor el dise√±o de software orientado a objetos. Si los aplicas con sentido com√∫n, sin dogmatizarlos, estar√°s en mejores condiciones para encontrar optimas soluciones a los problemas software.

 Si te ha gustado el art√≠culo, valora y comparte en tus redes sociales. No dudes en comentar dudas, aportes o sugerencias, estar√© encantado de responder.

 Este art√≠culo se distribuye bajo una [Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES) 

[![licencia-cc](https://res.cloudinary.com/software-crafters/image/upload/v1544181784/licencia-cc.png)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES)",
    "slug": "principios-solid-python",
    "tags": [
      "python",
    ],
    "title": "Principios SOLID en Python",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "xamarin",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/Xamarin_category.png",
    "date": "",
    "description": "El patr√≥n MVVM (Modelo Vista Vista-Modelo) nos ayuda a desacoplar lo m√°ximo posible la interfaz de usuario de la l√≥gica de la aplicaci√≥n.",
    "id": "patron-mvvm-xamarin-forms",
    "markdownBody": "[En el anterior art√≠culo](http://miguelgomez.io/xamarin/xamarin-forms-apps-nativas-introduccion/) vimos una breve introducci√≥n al **patr√≥n de dise√±o MVVM**. Tal como dec√≠a en ese post, est√° considerado una buena pr√°ctica el uso de dicho patr√≥n a la hora de desarrollar un proyecto, tanto con Xamarin tradicional, como con Xamarin Forms. El objetivo de esta entrada es continuar profundizando en el desarrollo con Xamarin Forms aplicando MVVM.

## Los or√≠genes de MVVM

En el a√±o 2004, un grupo de desarrollo de Microsoft trabajaba en un proyecto denominado "Avalon", m√°s conocido por su nombre definitivo WPF (Windows Presentation Foundation). El prop√≥sito de dicho proyecto era permitir el desarrollo de aplicaciones de escritorio m√°s completas y con un aspecto visual mucho m√°s logrado y complejo de lo que era posible con Windows Forms.

 Al a√±o siguiente [John Gossman](https://www.linkedin.com/in/john-gossman-5664952) (miembro del equipo de desarrollo de "Avalon"), en un [art√≠culo de la MSDN](https://blogs.msdn.microsoft.com/johngossman/2005/10/08/introduction-to-modelviewviewmodel-pattern-for-building-wpf-apps/), mostraba al p√∫blico el patr√≥n MVVM. En el art√≠culo, MVVM se presenta como una variaci√≥n del patr√≥n MVC ajustado a "WPF" y a su sistema de enlace a datos, aunque realmente es una adaptaci√≥n del patr√≥n "presentation model" creado por el m√≠tico [Martin Fowler](http://martinfowler.com/eaaDev/PresentationModel.html).

## Elementos del patr√≥n MVVM

 La finalidad principal del patr√≥n **MVVM** (Modelo Vista Vista-Modelo) es tratar de **desacoplar** lo m√°ximo posible **la interfaz de usuario** de la l√≥gica de la aplicaci√≥n. Veamos a grandes rasgos sus partes principales:

### El modelo

 Representa la capa de datos y/o la l√≥gica de negocio, tambi√©n denominado como el objeto del dominio. El modelo contiene la informaci√≥n, pero nunca las acciones o servicios que la manipulan. En ning√∫n caso tiene dependencia alguna con la vista.

### La vista

 La misi√≥n de la vista es representar la informaci√≥n a trav√©s de los elementos visuales que la componen. Las vistas en MVVM son activas, contienen comportamientos, eventos y enlaces a datos que, en cierta manera, necesitan tener conocimiento del modelo subyacente. En Xamarin Forms podemos crear nuestras interfaces a trav√©s de c√≥digo C# o XAML.

### Modelo de vista (ViewModel)

 El **ViewModel** (modelo de vista) es un actor **intermediario** entre el modelo y la vista, contiene toda la **l√≥gica de presentaci√≥n** y se comporta como una abstracci√≥n de la interfaz. La comunicaci√≥n entre la vista y el viewmodel se realiza por medio los enlaces de datos (**binders**).

![mvvm](https://res.cloudinary.com/software-crafters/image/upload/v1544443712/posts/patron-mvvm-xamarin-forms/mvvm.png) 

## MVVM en Xamarin Forms, interacci√≥n con el usuario

 Vamos a tomar como punto de partida el [ejemplo visto en la entrada anterior](http://miguelgomez.io/xamarin/xamarin-forms-apps-nativas-introduccion/), la idea es a√±adir a dicho ejemplo un elemento entry en el cual el usuario pueda introducir un texto y a su vez este se vaya reflejando en un elemento de tipo label.

 Cont√°bamos con una estructura MVVM lo m√°s sencilla posible, ten√≠amos un ViewModel denominado MainViewModel con una propiedad llamada ‚ÄúMyMessage":

\`\`\`
public class MainViewModel
{
     private string _myMessage;

     public MainViewModel()
     {
          Message = "Hello MVVM!";
     }


     public string MyMessage
     {
          get { return _myMessage; }
          set { _myMessage = value; }
     }
}

\`\`\`

 Adem√°s, contabamos con una vista que utilizaba como contexto "MainViewModel" enlazando desde el atributo "text" de un label a la propiedad "MyMessage":

\`\`\`
//XAML
<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="simpleMVVM.Views.MainView">
 <Label Text="{Binding MyMessage}"
        VerticalOptions="Center"
        HorizontalOptions="Center" />
</ContentPage>

//Code behind
namespace simpleMVVM.Views
{
    public partial class MainView : ContentPage
    {
        public MainView()
        {
            InitializeComponent();
            BindingContext = new MainViewModel();
        }
    }
}

\`\`\`

### Modos de enlace a datos

 Antes de continuar con el ejemplo veamos como funcionan los modos de enlace a datos. En Xamarin Forms el modo de enlace a datos se define con la palabra reservada "mode", la cual nos indica como se comporta el mismo. Contamos con los siguientes

* **OneWay:** es el valor por defecto, indica que el enlace se produce en un solo destino, el de lectura. Si el valor del elemento de la vista cambia, no enlazar√° con el ViewModel asociado.
* **OneWayToSource:** este valor enlaza en un √∫nico sentido la _View_ al _ViewModel_.
* **TwoWay:** en este caso indica que el enlace es bidireccional. En un primer momento, la vista toma el valor de la propiedad del ViewModel y si este cambia en la vista es enviado de vuelta hacia el ViewModel.

 Continuando con el ejemplo, vamos a a√±adir un elemento de tipo entry, que est√© enlazado a la propiedad "myMessage" de forma bidireccional, un elemento label que est√° enlazado con el modo por defecto (oneWay) y un stacklayout que haces las veces de contenedor, debido a que las p√°ginas no pueden contener m√°s de un elemento.

\`\`\`
<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://xamarin.com/schemas/2014/forms"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="simpleMVVM.Views.MainView">
    <StackLayout>

        <Entry Text="{Binding MyMessage, Mode=TwoWay}"
              VerticalOptions="Center"
              HorizontalOptions="Center" />

        <Label Text="{Binding MyMessage}"
              VerticalOptions="Center"
              HorizontalOptions="Center" />

    </StackLayout>
</ContentPage>


\`\`\`

 Al hacer debug sobre el c√≥digo anterior, observar√°s que aparentemente todo est√° funcionando correctamente. Si examinas el contenido de la propiedad My\`Message\` ver√°s que el valor se ha actualizado correctamente, pero el texto del elemento label no se actualiza, esto es debido a que no se ha notificado a la vista que el valor de la propiedad ha cambiado. Es aqu√≠ donde entra en juego la interfaz **INotifyPropertyChanged**.

### Notificaci√≥n de cambios (**INotifyPropertyChanged)**

 La interfaz **INotifyPropertyChanged** define un m√©todo llamado **RaisePropertyChanged** y un evento llamado **PropertyChanged,** que debemos implementar**.** Dicho evento ser√° lanzado cuando se actualice el valor de la propiedad deseada del _ViewModel y notificar√° a_ la View que evaluar√° de nuevo el valor de dicha propiedad. Para que esto funcione correctamente es necesario ejecutar el m√©todo **RaisePropertyChanged** en el setter de la propiedad.

\`\`\`
public class MainViewModel
{
     private string _myMessage;

     public MainViewModel()
     {
          Message = "Hello MVVM!";
     }

     public string MyMessage
     {
          get { return _myMessage; }
          set
          {
               _myMessage = value;
               RaisePropertyChanged("MyMessage");
          }
     }

     private void RaisePropertyChanged(string propertyName)
     {
          var handle = PropertyChanged;
          if (handle != null)
               handle(this, new PropertyChangedEventArgs(propertyName));
     }

     public event PropertyChangedEventHandler PropertyChanged;
}

\`\`\`

 Dado que todos los ViewModels o la mayor√≠a, van a hacer uso de la interfaz INotifyPropertyChanged, ser√≠a interesante crear un **ViewModel base**, del cual hereden dem√°s. Por otro lado, vamos a hacer uso del atributo \`CallerMemberName\` con el cual aseguras que el nombre de la propiedad que llama al m√©todo RaisePropertyChanged es el correcto sin tener que indicarlo expl√≠citamente.

\`\`\`
public class ViewModelBase
{
     private void RaisePropertyChanged([CallerMemberName] string propertyName = null)
     {
          var handle = PropertyChanged;
          if (handle != null)
               handle(this, new PropertyChangedEventArgs(propertyName));
     }

     public event PropertyChangedEventHandler PropertyChanged;
}


\`\`\`

Tras refactorizar el \`MainViewModel\` quedar√≠a tal que as√≠:

\`\`\`
public class MainViewModel : ViewModelBase
{
     private string _myMessage;

     public MainViewModel()
     {
     }

     public string MyMessage
     {
          get { return _myMessage; }
          set
          {
               _myMessage = value;
               RaisePropertyChanged();
          }
     }
}

\`\`\`

 Este ser√≠a el resultado, tras ejecutar el proyecto:

![binding2way](https://res.cloudinary.com/software-crafters/image/upload/v1544443711/posts/patron-mvvm-xamarin-forms/binding-2way.gif) 

### Comandos

 Nos faltar√≠a por ver la interacci√≥n a priori m√°s b√°sica que puede realizar un usuario sobre una app, pulsar un bot√≥n y que ocurra algo. Para llevar a cabo esta funcionalidad se aplica el patr√≥n **Command** (comando) cuyo objetivo no es otro que encapsular la invocaci√≥n de un m√©todo de otro objeto.

> "Debes depender de abstracciones, no de concreciones"

 Para aplicar este mecanismo en Xamarin.Forms junto con MVVM el ViewModel asociado a la vista debe exponer una propiedad que implemente la interfaz \`ICommand\`. El valor de dicha propiedad puede ser asignado a elementos visuales como botones, a trav√©s de la propiedad **comando** v√≠a enlace a datos. Esto a su vez ejecutar√° el m√©todo **Execute** de dicha interfaz, la cual adem√°s define un m√©todo **CanExecute** que permite verificar si el comando puede ser ejecutado o no.

 Al igual que ocurr√≠a con la implementaci√≥n de la interfaz INotifyPropertyChanged, cuando utilizamos comandos se tiende a repetir m√°s c√≥digo del necesario, por esta raz√≥n se utilizan implementaciones reutilizables como **DelegateCommand**. Esta implementaci√≥n es una clase que implementa la intefaz **ICommnad** que recibe dos par√°metros en su constructor del tipo Action y Func, el m√©todo a ejecutar (**Execute**) y el m√©todo que indica si se puede ejecutar o no(**CanExecute**), respectivamente.

\`\`\`
public class DelegateCommand : ICommand
{
     private Action _execute;
     private Func<bool> _canExecute;

     public DelegateCommand(Action execute, Func<bool> canExecute = null)
     {
          _execute = execute;
          _canExecute = canExecute;
     }

     public bool CanExecute(object parameter)
     {
          if (_canExecute == null)
               return true;

          return _canExecute();
     }

     public event EventHandler CanExecuteChanged;

     public void Execute(object parameter)
     {
          if (_execute != null)
               _execute();
     }

     public void RaiseCanExecuteChanged()
     {
          var handle = CanExecuteChanged;
          if (handle != null)
               handle(this, new EventArgs());
     }
}

\`\`\`

 Si no est√°s muy familiarizado con C#, los tipos \`Action\` y \`Func<bool>\`, son delegados gen√©ricos. \`Action\` simplemente es un delegado que no devuelve nada y en este caso tampoco recibe ning√∫n parametro; y \`Func<bool>\`, tampoco tiene par√°metros y en este caso devuelve un booleano. Por sino lo sabes, un delegado no es m√°s que un tipo de dato que representa un puntero a un m√©todo.

 Continuando con el ejemplo, vamos a a√±adir a la view del ejemplo anterior un bot√≥n, el cual al ser pulsado incrementar√° un contador que se mostrar√° en el elemento label de la misma. Para ello se le asigna el commando MyCommand a la propiedad command del bot√≥n, el cual se implimentar√° en el correspondiente ViewModel.

\`\`\`
<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://xamarin.com/schemas/2014/forms"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="simpleMVVM.Views.MainView">
    <StackLayout>

        <Button Text="Sent"
              Command="{Binding MyCommand}"
              VerticalOptions="Center"
              HorizontalOptions="Center" />

        <Label Text="{Binding MyMessage}"
              VerticalOptions="Center"
              HorizontalOptions="Center" />

    </StackLayout>
</ContentPage>


\`\`\`

 En el \`MainViewModel\` se crea una propiedad del tipo \`ICommand\` denominada MyCommand, cuya variable privada ser√° del tipo \`DelegateCommand\` que hemos implementado con anterioridad. En el getter de esta propiedad, se instanciar√° DelegateCommand recibiendo como par√°metro el m√©todo que contiene la l√≥gica para incrementar el contador, quedando el \`MainViewModel\` tal que as√≠:

\`\`\`
public class MainViewModel : ViewModelBase
{
 	 private int _counter;
     private DelegateCommand _myCommand;

     void counterCommandExecute()
     {
     	  _counter++;
          RaisePropertyChanged("MyMessage");
     }

     public MainViewModel()
     {
     	_counter = 0;
     }

     public string MyMessage
     {
          get { return string.Format("{0} times", _counter); }
     }

     public ICommand MyCommand
     {
          get { return _myCommand = _myCommand ?? new DelegateCommand(counterCommandExecute); }
     }
}


\`\`\`

 Tras ejecutar la app se puede observar que al pulsar el bot√≥n el contador se va incrementando correctamente:

![comandos](https://res.cloudinary.com/software-crafters/image/upload/v1544443711/posts/patron-mvvm-xamarin-forms/commands.gif) 

## Resumen

 En este art√≠culo se han expuesto los conceptos b√°sicos para aplicar el patr√≥n MVVM a la hora de realizar las interacciones b√°sicas de los usuarios con Xamarin Forms, donde destacan las notificaciones y los comandos.

 Continuar√© profundizando en pr√≥ximas entradas en el desarrollo con Xamarin, seguir√© exponiendo conceptos fundamentales como la navegaci√≥n entre p√°ginas, contenedores de dependencias, persistencia de datos en el dispositivo, consumo de APIS, etc.

 Si te ha gustado la entrada valora y comparte en tus redes sociales. No dudes en comentar dudas, aportes o sugerencias, estar√© encantado de responder.

 Este art√≠culo se distribuye bajo una [Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES) 

[![licencia-cc](https://res.cloudinary.com/software-crafters/image/upload/v1544181784/licencia-cc.png)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES)",
    "slug": "patron-mvvm-xamarin-forms",
    "tags": [
      "xamarin",
    ],
    "title": "El patr√≥n MVVM en Xamarin Forms",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "xamarin",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/Xamarin_category.png",
    "date": "",
    "description": "Xamarin nos ofrece un enfoque multiplataforma diferente, ya que nos facilita la tarea de desarrollar cualquier tipo de aplicaci√≥n de forma nativa.",
    "id": "xamarin-forms-apps-nativas-introduccion",
    "markdownBody": " Hoy en d√≠a, **crear aplicaciones** m√≥viles para m√∫ltiples plataformas **supone** **todo un reto** para los desarrolladores. Tratar de abordar un desarrollo usando los toolkits nativos de cada sistema requiere de una cantidad enorme de conocimientos espec√≠ficos para cada uno de ellos. Nos encontraremos con un **panorama** enormemente **complejo**, con **m√∫ltiples lenguajes**, **varios entornos de desarrollo** y **APIs** de todos los colores. **Xamarin** **trata de poner soluci√≥n** a esta problem√°tica ofreci√©ndonos un conjunto de herramientas que nos permitir√° desarrollar **aplicaciones nativas, compartiendo** la mayor cantidad de **c√≥digo**, entre las plataformas m√°s importantes: **Android**, **iOS** y **Windows Phone**.

 Este **art√≠culo** va dirigido a **desarrolladores** que est√©n **interesados** en comenzar a crear **aplicaciones cross-platform** **nativas** con Xamarin, ser√≠a recomendable que estuviesen familiarizados con el lenguaje **C#** y/o con el SDK de **iOS** o **Android**, aunque **no es imprescindible.** En la **primera parte** de la entrada tratar√© algunas **generalidades** como la problem√°tica del desarrollo multiplataforma, las caracter√≠sticas claves de Xamarin, la instalaci√≥n y puesta en marcha y la cuando elegir entre Xamarin Tradicional o Xamarin Forms. En la **segunda parte**me centrar√© en **Xamarin.Forms** y en sus elementos clave; por √∫ltimo, veremos una peque√±a introducci√≥n a la implementaci√≥n del **patr√≥n MVVM en Xamarin Forms**.

## La problem√°tica del desarrollo multiplataforma

 Como podemos observar en la siguiente tabla, cada plataforma cuenta con su **propio** entorno de desarrollo integrado (**IDE**), con uno o **varios lenguajes** de programaci√≥n, con un lenguaje especifico para las **vistas,** y por si fuera poco los**patrones de dise√±o** a aplicar **difieren** **entre** las diferentes **plataformas**.

| iOS                  | Android            | Windows        |               |
| -------------------- | ------------------ | -------------- | ------------- |
| **IDE**              | XCode              | Android Studio | Visual Studio |
| **Lenguaje**         | ObjectiveC o Swift | Java           | C#            |
| **Vistas**           | Storyboard o XIBS  | AXML           | XAML          |
| **Patr√≥n de dise√±o** | MVC                | MVC            | MVVM          |

 Abordar todos estos aspectos requiere de una cantidad de enorme de conocimientos por parte del desarrollador y, por otro lado, no parece ser eficiente tener que reescribir la l√≥gica de negocio para cada uno de los sistemas.

### ¬øQue opciones tenemos? Apps h√≠bridas o nativas

Tradicionalmente, cuando hablamos de **tecnolog√≠as multiplataforma**, pensamos en un **enfoque minimalista**: reducir nuestra implementaci√≥n/desarrollo a un m√≠nimo denominador en todas las plataformas. Esto es lo que se propone en las **aplicaciones h√≠bridas** desarrolladas con tecnolog√≠as del tipo PhoneGap/Cordova, en las cuales escribimos c√≥digohtml y javascript que tiene que ser interpretado por un navegador web. Este tipo de soluciones **no consigue igualar** la respuesta y **la experiencia de usuario** de una app **nativa.** Por poner un ejemplo, Mark Zuckerberg (CEO de Facebook), reconoci√≥ que el mayor error que hab√≠an cometido en la trayectoria de Facebook fue crear en un primer momento una app h√≠brida en lugar de una nativa.

> Mark Zuckerberg: nuestro mayor error ha sido crear en un principio una app h√≠brida en lugar de nativa

**Xamarin** nos ofrece un enfoque multiplataforma diferente, ya que nos facilita la tarea de desarrollar cualquier tipo de **aplicaci√≥n/juego** de forma **nativa** para las plataformas m√°s usadas: **iOS, Android y Windows**. Para ello nos brinda acceso al **100% de las APIS nativas + las APIs comunes de .NET**, con un mismo lenguaje de programaci√≥n**C#**.

 Existen **alternativas** interesantes a Xamarin que tambi√©n proponen un enfoque nativo, como puede ser **[React Native](https://facebook.github.io/react-native/)** de Facebook (a√∫n en beta) , que permite escribir apps para android e iOS Nativas en **Javascript** con el estilo de **React**. O, **[Ruby Motion](http://www.rubymotion.com/),** una tecnolog√≠a que nos permite realizar apps para Android e iOS con **Ruby**, si RoR forma parte de tu stack esta plataforma es m√°s que interesante. Aunque sin duda, por **aceptaci√≥n**, **cuota, comunidad** y **evoluci√≥n** brilla con luz propia **Xamarin**.

![reactnavive vs rubymotion](https://res.cloudinary.com/software-crafters/image/upload/v1544533330/posts/xamarin-forms-app-nativas-introduccion/React-Native-rubymotion-300x120.png) 

## Caracter√≠sticas

* **Compartir c√≥digo:**Adem√°s de compartir un mismo lenguaje y entorno de desarrollo, podemos utilizar un mismo patr√≥n de desarrollo.
* **Completa cobertura de las APIs de iOS y Android:** Tenemos todas las APIs disponibles con C#, cualquier cosa que se pueda hacer con Objective-C/Swift o Java, se puede hacer con C# y Xamarin.
![api-xamarin](http://miguelgomez.io/wp-content/uploads/2016/11/api-xamarin.png) 
* **Aplicaciones nativas:**Las aplicaciones desarrolladas con Xamarin son 100% nativas.
* **Siempre actualizado**: Xamarin suele a√±adir soporte el mismo d√≠a del lanzamiento oficial de una actualizaci√≥n.
* **Open source y gratis**: Tras la compra de Xamarin por parte de Microsoft, pas√≥ a ser Open Source y gratuito.

## Instalaci√≥n de Xamarin

**En Mac OS**

 Para instalar Xamarin en Mac OS, tan solo tenemos que [descargar el instalador ](https://www.xamarin.com/download)y a continuaci√≥n un asistente nos guiar√° en la instalaci√≥n de Xamarin Studio y los SDKs de las diferentes plataformas.

**En windows:**

 Para comenzar a trabajar con Xamarin en Windows se debe realizar la descarga de [Visual Studio Community](https://go.microsoft.com/fwlink/?LinkId=691978&clcid=0x409). Tras ejecutar el instalador tenemos la posibilidad de elegir entre una instalaci√≥n t√≠pica o personalizada. Escogemos personalizada y seleccionamos el checkbox de Xamarin dentro del apartado de desarrollo m√≥vil multiplataforma.

 Para compilar y acceder a opciones como el editor visual de iOS necesitamos de forma inevitable tener conexi√≥n con un Mac. Todo el proceso de conexi√≥n se realiza de forma pr√°cticamente transparente desde Visual Studio a trav√©s de la herramienta Xamarin Mac Agent por medio de una conexi√≥n ssh.

## Xamarin Tradicional vs Xamarin Forms

 Antes de empezar a desarrollar con Xamarin debemos **elegir** si utilizar **Xamarin Tradicional**(Xamarin.iOS y Xamarin.Android) o **Xamarin Forms** para crear nuestro proyecto, aunque algunos expertos de la comunidad como [@\\_jmgomez\\_](https://twitter.com/%5Fjmgomez%5F) ya plantean algunas soluciones ‚Äúfuera de la caja‚Äù ([art√≠culo](http://jmgomez.me/with-xamarinforms-or-without-it/)).

 En **Xamarin tradicional**, se puede **compartir toda la l√≥gica** de la aplicaci√≥n entre las diferentes plataformas, **a excepci√≥n de la interfaz de usuario**, la cual ser√° independiente para cada una de las mismas. En cambio, **Xamarin Forms** a√±ade una capa de abstracci√≥n sobre la UI que **permite compartir**, adem√°s de la l√≥gica de negocio, **la interfaz de usuario**, aumentando consigo la reutilizaci√≥n de c√≥digo.

**¬øCuando escoger uno u otro?** 

**Xamarin tradicional** es id√≥neo cuando se requiere un nivel muy elevado de personalizaci√≥n de la interfaz de usuario para cada una de las plataformas, siendo **m√°s importante el nivel personalizaci√≥n de la UI que la cantidad de c√≥digo compartido**; mientras que **Xamarin.Forms** es la mejor opci√≥n cuando las aplicaciones requieren **menos especificidad en la UI** y hacen m√°s **√©nfasis en compartir la mayor cantidad posible de c√≥digo**.

![xamarin-1](https://res.cloudinary.com/software-crafters/image/upload/v1544533330/posts/xamarin-forms-app-nativas-introduccion/xamarin-1.png) 

## Xamarin Forms

 La capa de abstracci√≥n que a√±ade Xamarin Forms a la UI nos facilita la tarea de crear interfaces de usuarios nativas compartidas, ya que cada uno de los elementos de dicha abstracci√≥n son mapeados a elementos propios de cada una de las plataformas.

### XAML

 Las interfaces en **Xamarin Forms** se pueden definir tanto con c√≥digo **C#** desde **Code Behind,**como con **[XAML](https://msdn.microsoft.com/es-es/library/cc295302.aspx)**, mi recomendaci√≥n es utilizar este √∫ltimo para aprovechar su enfoque de separaci√≥n de responsabilidades entre dise√±o y codificaci√≥n.

**XAML** (e**X**tensible **A**pplication **M**arkup **L**anguage) es un lenguaje declarativo basado en **XML** y pensado para escribir la interfaz gr√°fica de una aplicaci√≥n de forma textual y ordenada, aparece por primera vez en la versi√≥n 3.0 del Framework de .NET.

 Una de las caracter√≠sticas m√°s importantes de **XAML** es que **todos los elementos que definamos en este son instanciados por el CLR** y **quedan accesibles** como objetos **desde c√≥digo**, sin necesidad de realizar de nuevo la declaraci√≥n de los mismos en Code Behind, gracias al mecanismo de las clases parciales.

**XAML** permite construir la jerarqu√≠a de objetos de componen la interfaz. Con el uso de **etiquetas**podemos **definir cada uno de los elementos visuales**, y con el uso de **atributos definimos la apariencia y el comportamiento** de cada uno de los elementos.

 Veamos un ejemplo de una misma interfaz definida en XAML y C#:

\`\`\`
//XAML
    <TabbedPage xmlns="http://xamarin.com/schemas/2014/forms" xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml" x:Class="MyApp.MainPage">
    <TabbedPage.Children>
        <ContentPage Title="Profile" Icon="Profile.png">
            <StackLayout Spacing="20" Padding="20" VerticalOptions="Center">
                <Entry Placeholder="Username" Text="{Binding Username}"/>
                <Entry Placeholder="Password" Text="{Binding Password}" IsPassword="true"/>
                <Button Text="Login" TextColor="White" BackgroundColor="#77D065" Command="{Binding LoginCommand}"/>
            </StackLayout>
        </ContentPage>
        <ContentPage Title="Settings" Icon="Settings.png">
            
        </ContentPage>
    </TabbedPage.Children>
</TabbedPage>

//Code behind
using Xamarin.Forms;

var profilePage = new ContentPage {
    Title = "Profile",
    Icon = "Profile.png",
    Content = new StackLayout {
        Spacing = 20, Padding = 50,
        VerticalOptions = LayoutOptions.Center,
        Children = {
            new Entry { Placeholder = "Username" },
            new Entry { Placeholder = "Password", IsPassword = true },
            new Button {
                Text = "Login",
                TextColor = Color.White,
                BackgroundColor = Color.FromHex("77D065") }}}
};

var settingsPage = new ContentPage {
    Title = "Settings",
    Icon = "Settings.png",
    (...)
};

var mainPage = new TabbedPage { Children = { profilePage, settingsPage } };

\`\`\`

### Pages

 Las p√°ginas son elementos contenedores que representan una pantalla de la aplicaci√≥n. Xamarin.Forms.Page representa un ViewController en iOS, una Page en UWP, en Android cada p√°gina se comporta como un Activity, pero no lo son.

![xamarin forms pages](https://res.cloudinary.com/software-crafters/image/upload/v1544533330/posts/xamarin-forms-app-nativas-introduccion/Xamarin.Forms-Pages.png) 

**ContentPage:** es la p√°gina m√°s simple, cuenta con una √∫nica vista donde a√±adir contenido.   
**MasterDetailPage:** gestiona dos paneles de informaci√≥n.  
**NavigationPage:** gestiona la navegaci√≥n entre paginas.  
**TabbedPage:** facilita el acceso a las subp√°ginas mediante tabs.  
**TemplatedPage:** muestra el contenido a pantalla completa, permite utilizar plantillas para definir el contenido.  
**CarouselPage:** permite el acceso a las subp√°ginas haciendo un gesto de scroll lateral.

### **Layouts**

 Los layouts son elementos contenedores de otros layouts o vistas, son especialmente necesarios ya que las p√°ginas s√≥lo contener un elemento hijo. Lo utilizaremos para establecer la posici√≥n y alineaci√≥n de los elementos que contienen.

![xamarin forms layouts](https://res.cloudinary.com/software-crafters/image/upload/v1544533330/posts/xamarin-forms-app-nativas-introduccion/Xamarin.Forms-Layouts.png) 

 Los m√°s destacados son:  
**ContentView:** permitir crear elementos m√°s complejos a partir del mismo.  
**ScrollView:** si el contenido lo requiere permite hacer scroll.  
**StackLayout:** organiza y posiciona otros controles, es uno de los layouts m√°s utilizados, por defecto los apila verticalmente.  
**AbsoluteLayout:** hace uso posiciones absolutas para posicionar los elementos.  
**GridLayout:** Permite la organizaci√≥n de elementos por medio de filas y columnas.  
**RelativeLayout:** facilita el posicionamiento de los elementos mediante constraints.  

### Views (controles)

 Las Views, tambi√©n denominados controles o widgets, hacen referencia a los elementos visuales como pueden ser botones, labels, o textboxs. Xamarin Forms nos provee de multiples views:

![xamarin forms views](https://res.cloudinary.com/software-crafters/image/upload/v1544533330/posts/xamarin-forms-app-nativas-introduccion/controls-xamarin-1024x367.png) 

 Puedes ver la descripci√≥n de cada uno de los controles y como se visualizan en las diferentes plataformas desde [aqu√≠](https://developer.xamarin.com/guides/xamarin-forms/controls/views/).

## Creando nuestra primera app Xamarin.Forms

 Para crear nuestra app abrimos Visual Studio o Xamarin Studio, dependiendo si est√°is en Windows o Mac, respectivamente, en mi caso voy a usar Xamarin Studio. A continuaci√≥n, nos dirigimos a nueva soluci√≥n para crear un nuevo proyecto partiendo de la plantilla de aplicaci√≥n multiplataforma ‚ÄúForms App‚Äù:

![xamarin forms 1](https://res.cloudinary.com/software-crafters/image/upload/v1544533330/posts/xamarin-forms-app-nativas-introduccion/app-xamarin-forms-1.png) 

 En la siguiente pantalla del asistente rellenamos los campos del nombre de la app y del identificador de la organizaci√≥n, seleccionamos las plataformas Android e iOS, en el caso de estar en Visual Studio tambi√©n podriamos incluir en nuestro proyecto UWP.

### Shared Project (SP) vs Portable Class Library (PCL)

 Seguidamente nos encontramos con que debemos escoger entre un SP (**Shared Projec**t) y una PCL (**Portable Class Library**). Aunque ambos persiguen el **mismo objetivo**, **compartir la mayor cantidad posible de c√≥digo** entre plataformas, difieren en varios aspectos.

**Las PCL** a diferencia de los SP, **generan un asembly reutilizable (dll) que puede ser consumido fuera de la soluci√≥n**. Es importante tener en cuenta que en las PCL no se tiene acceso completo al framework de .NET.

**Los SP no se compilan como un ensamblado a parte**,**sino como parte de cada proyecto al que est√°n referenciado**, como si fuese c√≥digo del propio proyecto. Los SP permiten hacer uso de directivas que permiten generar c√≥digo especifico para cada una de las plataformas.  
 En nuestro caso usaremos la PCL:

![xamarin forms 2](https://res.cloudinary.com/software-crafters/image/upload/v1544533330/posts/xamarin-forms-app-nativas-introduccion/app-xamarin-forms-2.png) 

### Estructura de una soluci√≥n Xamarin.Forms

 Una vez finalizado el asistente, se generar√° una soluci√≥n estructurada en tres proyectos:

![xamarin forms 3](https://res.cloudinary.com/software-crafters/image/upload/v1544533330/posts/xamarin-forms-app-nativas-introduccion/app-xamarin-forms-3.png) 

 El primero de los proyectos corresponde a la PCL, el cual contendr√° el c√≥digo compartido de la aplicaci√≥n para todas las plataformas. A continuaci√≥n tenemos los proyectos espec√≠ficos de iOS y Android.

 En el proyecto compartido, a modo de ejemplo se ha generado una p√°gina llamada helloFormsPage que cuenta con un elemento de tipo ContentPage que a su vez contiene un control Label en el que se muestra un texto de bienvenida.

 HelloFormsPage est√° formado por dos ficheros por un lado tenemos el XAML y por otro el code behing en C# los cuales corresponden a una misma clase distribuida en dos ficheros, a este concepto se le denomina **clases parciales.** Por lo tanto el **XAML** no **es** m√°s que **una clase parcial de nuestro Code Behind**, que se completa con el fichero que lleva el mismo nombre que el XAML pero con la extensi√≥n .cs.

\`\`\`
<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
        xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
        xmlns:local="clr-namespace:helloForms"
        x:Class="helloForms.helloFormsPage">
    <Label Text="Welcome to Xamarin Forms!" VerticalOptions="Center" HorizontalOptions="Center" />
</ContentPage>


\`\`\`

 En el proyecto compartido, adem√°s de contar con la clase de ejemplo helloFormsPage, tenemos una clase llamada App, en la cual se indica cual ser√° la primera p√°gina a mostrar en todas las plataformas, esto se realiza en el constructor de la misma. Adem√°s cuenta con otros m√©todos que nos permiten ejecutar acciones seg√∫n el estado de la aplicaci√≥n.

\`\`\`
namespace helloForms
{
    public partial class App : Application
    {
        public App()
        {
            InitializeComponent();
            MainPage = new helloFormsPage();
        }
        protected override void OnStart()
        {
            // Handle when your app starts
        }
        protected override void OnSleep()
        {
            // Handle when your app sleeps
        }
        protected override void OnResume()
        {
            // Handle when your app resumes
        }
    }
}

\`\`\`

 En el proyecto de Android tenemos una clase denominada MainActivity que cuenta con un m√©todo OnCreate() en el cual inicializamos la app del proyecto compartido:

\`\`\`
namespace helloForms.Droid
{
    [Activity(Label = "helloForms.Droid", Icon = "@drawable/icon", Theme = "@style/MyTheme", MainLauncher = true, ConfigurationChanges = ConfigChanges.ScreenSize | ConfigChanges.Orientation)]
    public class MainActivity : global::Xamarin.Forms.Platform.Android.FormsAppCompatActivity
    {
        protected override void OnCreate(Bundle bundle)
        {
            TabLayoutResource = Resource.Layout.Tabbar;
            ToolbarResource = Resource.Layout.Toolbar;
            base.OnCreate(bundle);
            global::Xamarin.Forms.Forms.Init(this, bundle);
            LoadApplication(new App());
        }
    }
}

\`\`\`

 Por √∫ltimo, en iOS, disponemos de la clase AppDelegate en la cual cargaremos la app del proyecto compartido:

\`\`\`
namespace helloForms.iOS
{
    [Register("AppDelegate")]
    public partial class AppDelegate : global::Xamarin.Forms.Platform.iOS.FormsApplicationDelegate
    {
        public override bool FinishedLaunching(UIApplication app, NSDictionary options)
        {
            global::Xamarin.Forms.Forms.Init();
            LoadApplication(new App());
            return base.FinishedLaunching(app, options);
        }
    }
}

\`\`\`

 Si, ejecutamos el proyecto en los emuladores de iOS y Android obtendr√≠amos el siguiente resultado:

![xamarin forms 4](https://res.cloudinary.com/software-crafters/image/upload/v1544533330/posts/xamarin-forms-app-nativas-introduccion/app-xamarin-forms-4.png) 

## El patr√≥n MVVM en Xamarin Forms

 Aunque no es obligatorio utilizar el patr√≥n MVVM para desarrollar una aplicaci√≥n con Xamarin Forms, est√° considerado una buena pr√°ctica hacer uso del mismo. A continuaci√≥n veremos algunos conceptos claves para entender el por qu√©.

**MVVM** (Modelo Vista Vista-Modelo) **es un patr√≥n de dise√±o** derivado de MVC, cuyo **objetivo** es tratar de **desacoplar** al m√°ximo **la interfaz de usuario** de la l√≥gica de la aplicaci√≥n, para ello hace uso de un lenguaje de marcado en las vistas, XAML en el caso de Xamarin Forms. El **modelo** realiza la misma funci√≥n que en MVC, representa la**capa de datos** y/o la l√≥gica de negocio de nuestro proyecto, en ning√∫n caso tiene dependencia alguna de la vista.

 El **ViewModel** (modelo de vista) es un actor **intermediario** entre el modelo y la vista, contiene toda la **l√≥gica de presentaci√≥n** y se comporta como una abstracci√≥n de la interfaz. La comunicaci√≥n entre la vista y el viewmodel se realiza por medio los enlaces de datos (**binders**).

![mvvm 1](https://res.cloudinary.com/software-crafters/image/upload/v1544533331/posts/xamarin-forms-app-nativas-introduccion/mvvm-1-1500x482_1.png) 

 A continuaci√≥n vamos a crear un ejemplo sencillo para mostrar como implementar en una soluci√≥n Xamarin forms el patr√≥n MVVM.

 Vamos a partir de un nuevo proyecto Xamarin.Forms utilizando una librer√≠a portable. En la PCL creamos las carpetas Views, ViewModels, y dentro de ViewModels la carpeta Base. Quedando la estructura de la soluci√≥n tal que as√≠:

![mvvm 2](https://res.cloudinary.com/software-crafters/image/upload/v1544533330/posts/xamarin-forms-app-nativas-introduccion/mvvm-2.png) 

 Una vez creadas las carpetas, a√±adimos la p√°gina principal, para ello hacemos clic derecho sobre la carpeta Views, le damos a la opci√≥n agregar nuevo archivo, seleccionamos ‚ÄúForms ContentPage‚Äù, lo llamamos MainView y a√±adimos el siguiente c√≥digo:

\`\`\`
<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
x:Class="simpleMVVM.Views.MainView">
     <Label Text="{Binding MyMessage}"
          VerticalOptions="Center"
          HorizontalOptions="Center" />
</ContentPage>

\`\`\`

 En el XAML anterior podemos observar que en el atributo text del elemento Label hemos utilizado lo que se denomina una expresi√≥n de enlace a datos, en pr√≥ximos posts veremos con m√°s detalle su funcionamiento por ahora nos basta con saber que cuando el compilador se encuentra con una expresi√≥n entre llaves la interpreta,y, en este caso, al encontrarse con la palabra reservada **Binding**, lo que hace es enlazar el valor de la propiedad MyMessage la cual definiremos en el ViewModel.

 Lo siguiente que vamos a hacer es crear nuestro primer ViewModel. Un **ViewModel** no es m√°s que una **clase** en la que se expone la informaci√≥n **con propiedades p√∫blicas**. Por lo tanto, agregamos dentro de la carpeta ViewModels una clase a la que vamos a denominar MainViewModel con una propiedad llamada ‚ÄúMyMessage‚Äù:

\`\`\`

    public class MainViewModel
{
     private string _myMessage;

     public MainViewModel()
     {
          Message = "Hello MVVM!";
     }


     public string MyMessage
     {
          get { return _myMessage; }
          set { _myMessage = value; }
     }
}

\`\`\`

 A continuaci√≥n, tenemos que enlazar nuestro ViewModel con el contexto de datos de la p√°gina. Para ello asignamos en la propiedad BindingContext de la nuestra vista una instancia de nuestro ViewModel. El **Code Behind** de la vista quedar√≠a as√≠:

\`\`\`
namespace simpleMVVM.Views
{
    public partial class MainView : ContentPage
    {
        public MainView()
        {
            InitializeComponent();
            BindingContext = new MainViewModel();
        }
    }
}

\`\`\`

 Por √∫ltimo, tan solo nos queda indicar cual es la p√°gina principal en la propiedad MainPage de la clase App:

\`\`\`
public App()
{
    InitializeComponent();
    MainPage = new MainView();
}

\`\`\`

 Esta ser√≠a la estructura MVVM m√°s sencilla posible, en principio nos sirve para ilustrar los fundamentos b√°sicos. No obstante, **no hemos cubierto** conceptos como **los modos de enlace a datos**, **las notificaciones** y **los comandos**, imprescindibles para conseguir una de interacci√≥n completa del usuario, quedar√°n pendientes para pr√≥ximas entradas.

## Resumen

 En este art√≠culo he tratado de sentar las bases, en la medida de lo posible, de Xamarin y en particular de Xamarin Forms, me he dejado muchos temas en el tintero, y en otros he sido muy superficial, c√≥mo por ejemplo en la introducci√≥n del patr√≥n MVVM, pero el post estaba creciendo exponencialmente.

 La idea es continuar profundizando en pr√≥ximas entradas en el desarrollo con Xamarin, tanto tradicional como con forms. Espero haber facilitado tu transici√≥n a Xamarin, o por lo menos haber sabido trasladarte alguna de sus virtudes.

 Si te ha gustado la entrada valora y comparte en tus redes sociales. No dudes en comentar dudas, aportes o sugerencias, estar√© encantado de responder.

 Este art√≠culo se distribuye bajo una [Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES) 

[![licencia-cc](https://res.cloudinary.com/software-crafters/image/upload/v1544181784/licencia-cc.png)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES)",
    "slug": "xamarin-forms-apps-nativas-introduccion",
    "tags": [
      "xamarin",
    ],
    "title": "Xamarin Forms, apps nativas multiplataforma. Introducci√≥n",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "python",
    "cover": "https://swcrafters.fra1.cdn.digitaloceanspaces.com/Categories/Python_category.png",
    "date": "",
    "description": "Python un lenguaje multiparadigma, que soporta orientaci√≥n a objetos, programaci√≥n imperativa y, en menor medida, programaci√≥n funcional.",
    "id": "tutorial-de-python-introduccion",
    "markdownBody": " Antes de empezar tengo que advertirte que **ning√∫n lenguaje** de programaci√≥n, por simple que sea, **puede aprenderse** en profundidad **en tan poco tiempo**, a no ser que se requiera de experiencia previa en otros lenguajes. Dominar **la programaci√≥n precisa de experiencia**, lo cual a su vez requiere de un tiempo m√≠nimo que permita **afianzar las estructuras mentales** necesarias para entender la secuencia l√≥gica a seguir para **desarrollar** un programa o proyecto de software.

 El objetivo de este art√≠culo no es ense√±ar a programar, sino tratar de exponer en 10 minutos los elementos m√°s importantes del lenguaje **Python**, ser√≠a algo as√≠ como una mezcla entre un **tutorial** y una **cheatsheet**. Har√© uso de una **REPL** para exponer los **ejemplos**, con lo que **podr√°s modificar** y jugar con ellos sin tener que salir de la entrada. Es totalmente recomendable seguir el art√≠culo en un ordenador o tablet, ya que la REPL por limitaciones de espacio no es tan c√≥moda de utilizar en un m√≥vil.

### Caracter√≠sticas de Python

**Python** un lenguaje **multiparadigma**, que soporta **orientaci√≥n a objetos**, **programaci√≥n imperativa** y, en menor medida, **programaci√≥n funcional**. Es **interpretado**, de tipado **din√°mico** y **multiplataforma**.

### Lo b√°sico de Python

 La **sintaxis** de Python es extremadamente "**limpia**", no se requiere de ning√∫n caracter que indique el final de una secuencia y los bloques se definen a trav√©s de la **indentaci√≥n** **del** **c√≥digo**. Los **comentarios** de una sola l√≠nea se definen con el car√°cter almohadilla **(#)** y las cadenas de multiples l√≠neas **(""")** se suelen emplear para escribir comentarios multil√≠nea.

 Los **operadores aritm√©ticos** **+**, **\\-** y **/** significan en Python lo mismo que en matem√°ticas. El asterisco **(\\*)** es el s√≠mbolo para la multiplicaci√≥n, el **%** se usa para obtener el **m√≥dulo**, **//** para **divisi√≥n entera** y **\\*\\*** es el s√≠mbolo para las **potencias**. Tambi√©n disponemos de los operadores **incrementar** **(+=)** y **decrementar** **(-=)**.

 Existen tres **operadores l√≥gicos**: **and**, **or**, y **not**. La sem√°ntica (significado) de estos operadores es similar a sus significados en ingl√©s (en espa√±ol ‚Äúy‚Äù, ‚Äúo‚Äù y ‚Äúno‚Äù).

 La **asignaci√≥n** de valores, como en la mayor√≠a de lenguajes, se realiza con el s√≠mbolo "igual" **(=)**. La doble igualdad **(==)** se usa para comprobar que **dos valores son iguales**, adem√°s disponemos de estos **operadores de comparaci√≥n**: distinto que **(!=)**, mayor que **(>)**, menor que **(<)**, mayor o igual **(>=)** y menor o igual **(<=)**.

### Tipos de datos

 Los tipos de datos b√°sicos en Python son los **num√©ricos** formados por **enteros**, los **reales** y los **complejos**; las **cadenas de texto** y los **booleanos**. La funci√≥n **type** nos devuelve el tipo:

### Estructuras de control de flujo

 Las **sentencias de control de flujo**, son bloques de c√≥digo en los que se agrupan instrucciones de manera controlada. Por un lado tenemos las **estruturas condicionales** (**if, if .. else, if ..elif ..else**) y por otro las **estructuras iterativas** (**for, while**).

### Funciones

 Una **funci√≥n** no es m√°s que un bloque de c√≥digo reutilizable encargado de realizar una determinada tarea. Para definir una funci√≥n en Python debemos utilizar la palabra reservada "**def**" seguido del nombre de la funci√≥n y los par√°metros los indicamos entre parentesis. Veamos varios ejemplos:

### Funciones, parametros \\*args y \\*\\*kwargs

 En el ejemplo anterior hemos visto varias formas de definir y ejecutar a las funciones en Python, ya sea con par√°metros por con valores por defecto o keywords como argumentos. Nos faltar√≠a ver como llamarlas con **colecciones como argumentos**, una forma muy com√∫n de pasar valores a las funciones en Python, y que en muchas ocasiones cuesta entender. Para ello debemos tener claro que las **tupla** como colecci√≥n de argumentos se define con **\\*args** y el **diccionario** con **\\*\\*kwargs. Veamos un ejemplo en la REPL:** 

### Manipulaci√≥n de cadenas

 Las cadenas en Python pueden definirse entre comillas simples o dobles. En la REPL se muestra un ejemplo de la mayor√≠a de las operaciones que podemos realizar ellas:

### Estructuras de datos (colecciones)

 Las **colecciones** son un tipo de datos dise√±ados espec√≠ficamente para **agrupar objetos** y llevar a cabo tareas con ellos. Las estructuras de datos m√°s utilizadas en Python son las **listas**, **tuplas** (listas inmutables) y los **diccionarios**, aunque personalmente tambi√©n suelo usar mucho los **conjuntos** (sets).

 No todas las estructuras de datos exponen exactamente las mismas operaciones, por ejemplo una lista no deja buscar por clave (si bien s√≠ por √≠ndice) y un conjunto no deja buscar ni por una cosa ni por otra.

 El siguiente playground est√° dividido en tres ficheros, main.py desde el que se importa listas.py y diccionarios.py, para ver los resultados de uno u otro, elimina o comenta su respectivo import.

### Clases y objetos

 En programaci√≥n orientada a objetos (POO), **un objeto** es una entidad que **agrupa un estado y una funcionalidad** relacionada. El estado se define a trav√©s de las variables denominadas atributos y la funcionalidad a trav√©s de funciones denominadas en POO c√≥mo m√©todos. Por otro lado, **una clase,** no es m√°s que una plantilla gen√©rica a partir de la cu√°l instanciamos los objetos. Dicho de otra manera, una clase **es una abstracci√≥n en la que se define el comportamiento** que va a tener el objeto.

 En Python, las **clases** se declaran mediante la palabra reservada **class** seguida del nombre de la clase, la clase base de la cual hereda, si no extiende de ninguna debe hacerlo de **object**; a continuaci√≥n dos puntos (:), luego el indentado y el cuerpo de la clase.

 El m√©todo **constructor** de la clase se define con la palabra clave **\\_\\_init\\_\\_** y al igual que el resto de m√©todos definidos en la clase recibe como primer par√°metro **self**, el interprete de python requiere de este argumento para referenciarlos como m√©todos de instancia.

### Excepciones

 No soy muy fan de usar excepciones, pero es cierto que con Python hay momentos en los que su uso no se puede obviar. Las **excepciones** en Python se manejan esencialmente con **try-except**:

### Depurando con PDB

 El **depurador por defecto** de python es **[pdb](https://docs.python.org/3/library/pdb.html)** , nos permite inspeccionar nuestro c√≥digo de forma interactiva. La forma m√°s simple de utilizarlo es ejecutando \`pdb.set_trace()\`:

\`\`\`
import pdb
a = "aaa"
pdb.set_trace()
b = "bbb"
c = "ccc"
final = a + b + c
print final

\`\`\`

 Los comandos b√°sicos del depurador son: "**n**"(next) para ejecutar la **siguiente sentencia,** para **mostrar el valor** de las variables "**p**"(print), si queremos ir **paso a paso** dentro de las subrutinas utilizariamos "**s**"(step), y por √∫ltimo **"q"**(quit) para **salir**.

### Guia de estilo - PEP8

 En Python existen las denominadas PEP's (Python Enhancement Proposals), en concreto la PEP 8 hace referencia a las convenciones de estilo de programaci√≥n en Python.

 Entre las convenciones principales, destacan:

* Usar 4 espacios para indentar.
* Tama√±os de l√≠nea con un m√°ximo de 79 caracteres.
* Las funciones y las clases se deben separar con dos lineas en blanco, mientras que los m√©todos de clase solo con uno.
* Los import deben de estar separados uno en cada l√≠nea. Se permite: \`from urllib2 import urlopen, Request\`
* Las sentencias import deben de estar siempre en la parte superior del archivo agrupadas de la siguiente manera:  
   * Librer√≠a est√°ndar  
   * Librer√≠as de terceros  
   * import's de la aplicaci√≥n local
* Usar espacios alrededor de los operadores aritm√©ticos, a excepci√≥n de cuando forman parte de los argumentos de una funci√≥n.
* No se deben de realizar comentarios obvios
* No se deben comparar booleanos mediante \` ==\`

### Resumen

 Este tutorial no pretende ser una gu√≠a exhaustiva sobre Python, aunque he condensado bastante informaci√≥n en poco m√°s de 1000 palabras, me he dejado much√≠simos elementos en el tintero, c√≥mo expresiones regulares, ficheros, testing, POO, elementos de programaci√≥n funcional.

 Espero haber facilitado tu transici√≥n a Python, y si ya lo conoc√≠as espero que el art√≠culo te sirva como referencia. Si te ha gustado la entrada valora y comparte en tus redes sociales. No dudes en comentar dudas, aportes o sugerencias, estar√© encantado de responder.

 Este art√≠culo se distribuye bajo una [Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES) 

[![licencia-cc](https://res.cloudinary.com/software-crafters/image/upload/v1544181784/licencia-cc.png)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES)",
    "slug": "tutorial-de-python-introduccion",
    "tags": [
      "python",
    ],
    "title": "Tutorial de Python. Los fundamentos en 10 minutos",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "devops",
    "cover": "https://res.cloudinary.com/software-crafters/image/upload/v1544894788/posts/servidor-desarrollo-vagrant-ansible/django-vagrant.png",
    "date": "",
    "description": "",
    "id": "servidor-desarrollo-vagrant-ansible",
    "markdownBody": "**Vagrant** es una de esas herramientas que a priori parece que no tiene cabida en tu stack, pero una vez que comienzas a utilizarla se vuelve indispensable. [En una entrada anterior](http://miguelgomez.io/devops/instancias-de-digitalocean-con-vagrant/) vimos como hacer uso de la misma con el driver de Digital Ocean**,** en ese caso para desplegar Droplets, aunque el objetivo principal de esta herramienta es crear **entornos** de **desarrollo** **aislados**.

 Vagrant permite que el **abastecimiento** de las m√°quinas a trav√©s de un script Bash o por medio de cualquier herramienta de orquestaci√≥n tipo **Puppet**, **Salt**, **Cheff** o **Ansible**. En esta ocasi√≥n utilizaremos Ansible para el aprovisionar nuestro entorno.

 En esta serie de art√≠culos veremos como crear un **servidor** de **desarrollo** aislado para **Django**. Te preguntar√°s, ¬øpero si con **Python** ya tenemos **virtualenv**? Si, pero ya sabemos que virtualenv no es perfecto y en muchas ocasiones no a√≠sla todo lo bien que deber√≠a. Adem√°s Vagrant nos permite replicar el entorno de producci√≥n en local, con todas las ventajas que conlleva desarrollar en el entorno que nos vamos a encontrar en producci√≥n. En este ejemplo utilizaremos **Ubuntu 16.04** c√≥mo sistema operativo, **Nginx** de proxy inverso, **Postgree** como sistema gestor de base de datos y **Gunicorn** de servidor web.

### Por qu√© Ansible

La diferencia principal entre Ansible y otras herramientas de orquestaci√≥n, es que **Ansible** **se comunica** con el/los servidor/es **v√≠a SSH**, no como Puppet o Chef que necesitan tener instaladas dependencias en el/los servidor/es para poder ser utilizados.

**La principal ventaja de Ansible es su simplicidad**, las tareas se definen en formato **YAML**, tiene una **comunidad inmensa** (cuenta m√°s seguidores en Github que Salt, Puppet y Cheff juntos). Por si fuera poco est√° **escrito en Python** y permite el uso de plantillas **Jinja 2** para generar ficheros de configuraci√≥n.

Gracias a **Ansible** podremos replicar la m√°quina orquestada para desarrollo **en producci√≥n** sin demasiado coste adicional, dedicar√© un art√≠culo en el futuro para tratar esta problem√°tica.

### Requisitos

Antes que nada tenemos que tener instalado en nuestro equipo Vagrant y Ansible. Vagrant lo puedes descargar desde [aqu√≠](https://www.vagrantup.com/downloads.html), **Ansible** lo puedes instalar con **Brew** o con **PIP**, tal como indican en la [documentaci√≥n oficial](http://docs.ansible.com/ansible/intro%5Finstallation.html).

### **Vagrantfile**

Comenzaremos creando un nuevo directorio para nuestro proyecto:

\`\`\`
mkdir -p ~/Projects/ansible-vagrant-django
cd ~/Projects/ansible-vagrant-django

\`\`\`

A continuaci√≥n, ejecutaremos el comando \`Vagrant init\` para crear un nuevo \`Vagrantfile\` basado en **Ubuntu 16.04**:

\`\`\`
vagrant init geerlingguy/ubuntu1604

\`\`\`

Debe haberse generado un fichero llamado **Vagrantfile** en la ra√≠z del directorio. Este contiene **informaci√≥n b√°sica** sobre la m√°quina que queremos aprovisionar, y multiples comentarios, los eliminamos y dejamos el fichero as√≠:

\`\`\`
API_VERSION = "2"

Vagrant.configure(API_VERSION) do |config|
  config.vm.box = "geerlingguy/ubuntu1604"
end

\`\`\`

Vamos a necesitar una manera de acceder a nuestro servidor web una vez que la m√°quina est√© lista, as√≠ que le indicaremos a Vagrant que mapee el puerto 8000 de nuestro equipo al puerto 8000 de la maquina virtual. Para ello, agrega el siguiente c√≥digo:

\`\`\`
config.vm.network "forwarded_port", guest: 80, host: 8080
config.vm.network "public_network"

\`\`\`

Para poder acceder v√≠a SSH a nuestra m√°quina y que sincronice nuestro directorio de trabajo dentro de la m√°quina, necesitaremos a√±adir est√°s dos directivas:

\`\`\`
config.ssh.forward_agent = true
config.vm.synced_folder "./", "/var/www/djangoproject"

\`\`\`

Por √∫ltimo, indicaremos que queremos aprovisionar la m√°quina con Ansible, y d√≥nde va a encontrar el fichero con los comandos de ansible:

\`\`\`
config.vm.provision :ansible do |ansible|
  ansible.playbook = "provision/vagrant.yml"
end

\`\`\`

Una vez a√±adidos todos los requerimientos nuestro Vagrantfile quedar√° as√≠:

\`\`\`

    # -*- mode: ruby -*-
# vi: set ft=ruby :

API_VERSION = "2"

Vagrant.configure(API_VERSION) do |config|

  config.vm.box = "geerlingguy/ubuntu1604"

  config.vm.network "forwarded_port", guest: 8000, host: 8000
  config.vm.network "public_network"

  config.ssh.forward_agent = true
  config.vm.synced_folder "./", "/var/www/djangoproject"

  config.vm.provision "ansible" do |ansible|
    ansible.playbook = "provision/vagrant.yml"
  end
end

\`\`\`

### Playbooks de Ansible

Un **Playbook** de **Ansible** es un fichero que permite definir todas las tareas que se van a realizar en uno o varios hosts (servidores), en este caso en nuestro servidor de desarrollo.

Las **tareas** equivalen a uno o multiples **comandos bash**, cada una de las mismas hace uso de un modulo de Ansible. **Los m√≥dulos** son **librer√≠as** que utiliza **Ansible** para controlar servicios, ficheros, paquetes o comandos, como por ejemplo **apt**, **copy** o **service**.

Veamos como escribir nuestro primer Playbook, lo primero que debemos hacer es crear un directorio provision y dentro de este un fichero denominado vagrant.yml:

\`\`\`
mkdir provision
cd provision
touch vagrant.yml

\`\`\`

Seguidamente a√±adimos a nuestro playbook los hosts en los que se van a ejecutar las tareas, en este caso como estamos haciendo uso de Vagrant indicaremos que puede ejecutar las tareas en todos los servidores conocidos y adem√°s con permisos de usuario root (become yes):

\`\`\`
- hosts: all
  become: yes

\`\`\`

### Tareas de Ansible

Tal como hemos dicho, las tareas (**Tasks**) de **Ansible** realizan su funci√≥n ejecutando un modulo, son **ejecutadas en orden**, una cada vez **en** **cada uno de los nodos** definidos en la directiva ‚Äòhosts‚Äô (en este caso s√≥lo tenemos el nodo de nuestra m√°quina virtual).  
 Cada una de las **tareas** tienen como m√≠nimo un **nombre** y el **m√≥dulo** que ejecutan. Por ejemplo, instalar python-pip ser√≠a tan sencillo como esto:

\`\`\`
- name: Install python pip
  apt: name=python-pip

\`\`\`

En este art√≠culo, para evitar que se haga excesivamente extenso, solo crearemos la tarea ‚Äúinstalar los paquetes b√°sicos‚Äù, dejaremos para la pr√≥xima entrada las tareas referentes a la configuraci√≥n de **PosgtgreeSQL**, **Nginx**, **Gunicorn** y **Django**.  
 Dicha tarea quedar√≠a tal que as√≠:

\`\`\`
- name: Install base packages
  apt: name={{ item }} update_cache=yes state=installed
  with_items:
    - build-essential
    - acl
    - ntp
    - htop
    - git
    - libpq-dev
    - python-dev
    - python-pip
    - python-pycurl
    - nginx
    - gunicorn

\`\`\`

En esta tarea estamos ejecutando el modulo apt, le estamos indicando que actualice la cach√© y que el estado de final de la tarea sea ‚Äúinstalled‚Äù. La directiva ‚Äúwith\\_items‚Äù permite que la tarea se ejecute para cada uno de los paquetes indicados.

As√≠ luce nuestro playbook hasta el momento:

\`\`\`
---
- hosts: all
  become: yes

  tasks:
    - name: Install base packages
      apt: name={{ item }} update_cache=yes state=installed
      with_items:
        - build-essential
        - acl
        - ntp
        - htop
        - git
        - libpq-dev
        - python-dev
        - python-pip
        - python-pycurl
        - nginx
        - gunicorn

\`\`\`

Si a continuaci√≥n ejecutamos el comando \`vagrant up\` se ‚Äúlevantar√°‚Äù nuestra m√°quina con la ‚Äúbox‚Äù asignada, en este caso Ubuntu 16.04, y la configuraci√≥n que hemos indicado en el vagrantfile.

Una vez terminado este proceso, y s√≥lo si es la primera vez que se ejecuta, comenzar√° el aprovisionamiento de la m√°quina con nuestro playbook de Ansible. Si a√±adimos tareas a posteriori al playbook podemos volver a ejecutar el aprovisionamiento con el comando \`vagrant provision\`.

### Resumen

En esta entrada hemos visto c√≥mo configurar un servidor de desarrollo casi gen√©rico usando Vagrant y Ansible. He dejado muchas cosas en el tintero, pero el post se estaba haciendo demasiado largo. En el siguiente entrar√© en materia en lo referente a la configuraci√≥n del stack de Django y continuar√© profundizando en lo que a Ansible se refiere, trater√© temas como Roles, Handlers, Vars y dem√°s.

 Si te ha gustado la entrada valora y comparte en tus redes sociales. No dudes en comentar dudas, aportes o sugerencias, estar√© encantado de responder.

 Este art√≠culo se distribuye bajo una [Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES) 

[![licencia-cc](https://res.cloudinary.com/software-crafters/image/upload/v1544181784/licencia-cc.png)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES) ",
    "slug": "servidor-desarrollo-vagrant-ansible",
    "tags": [
      "devops",
    ],
    "title": "Servidor de desarrollo Django con Vagrant y Ansible",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "devops",
    "cover": "https://res.cloudinary.com/software-crafters/image/upload/v1545047302/posts/cluster-docker-swarm-digital-ocean/docker-swarm-d.png",
    "date": "",
    "description": "",
    "id": "cluster-docker-swarm-digital-ocean",
    "markdownBody": "Docker Swarm es una herramienta integrada en el ecosistema de Docker que permite la gesti√≥n de un cluster de servidores. Pone a nuestra disposici√≥n una API con la que podemos administrar las tareas y asignaci√≥n de recursos de cada contenedor dentro de cada una de las m√°quinas. Dicha API nos permite gestionar el cluster como si se tratase de una sola m√°quina Docker.

En este art√≠culo veremos c√≥mo construir un cluster de servidores con Docker Swarm, se utilizar√° Docker Machine con el driver de Digital Ocean para aprovisionar cada una de las m√°quinas.

![docker-compose](https://res.cloudinary.com/software-crafters/image/upload/v1545047302/posts/cluster-docker-swarm-digital-ocean/docker_compose.png) 

> La mejor manera de orquestar docker es con el propio docker

### Requisitos

Para seguir este tutorial necesitamos los siguiente:

* Tener instalado docker en tu m√°quina (puedes instalarlo desde [aqu√≠](https://docs.docker.com/engine/installation/))
* Disponer de un token de API de Digital Ocean. Si no lo tienes puedes generar uno siguiendo [esta gu√≠a](https://www.digitalocean.com/community/tutorials/how-to-use-the-digitalocean-api-v2).

### Generar el token de Swarm

El sistema de descubrimiento de nodos de Swarm, Discovery Service, se sirve de un _token_ para reconocer todos nodos que forman parte de un cl√∫ster. Veamos como generar dicho token para poder hacer uso de Discovery Service.

En primer lugar guardaremos en una variable de sesi√≥n el token de Digital Ocean:

\`\`\`
export DO_TOKEN="abcdefghijklmnopqrstuvwxyz1234567890"


\`\`\`

A continuaci√≥n, creamos una maquina con docker machine llamada swarm-1, dicha m√°quina servir√° simplemente para generar el token de cluster:

\`\`\`
docker-machine create \\
--driver digitalocean \\
--digitalocean-access-token \${DO_TOKEN} \\
--digitalocean-image "ubuntu-16-04-x64" \\
--digitalocean-region "lon1" \\
--digitalocean-size "512mb" \\
swarm-1

\`\`\`

Seleccionamos esta maquina:

\`\`\`
eval $(docker-machine env swarm-1)


\`\`\`

Generamos el token de cluster:

\`\`\`
docker run swarm create


\`\`\`

Almacenamos en una variable de entorno dicho token y lo exportamos:

\`\`\`
export SWARM_TOKEN=61ef79938e5559d480c2841991c49f5d

\`\`\`

Ya podemos eliminar esta instancia de digital ocean, como hemos dicho s√≥lo la necesitabamos para crear el ID.

\`\`\`
docker-machine rm swarm-1

\`\`\`

### Nodo principal (Swarm Master)

Es el encargado de gestionar los recursos del cl√∫ster. Para crearlo ejecutaremos el siguiente c√≥digo:

\`\`\`
docker-machine create \\
--driver digitalocean \\
--digitalocean-access-token \${DO_TOKEN} \\
--digitalocean-image "ubuntu-16-04-x64" \\
--digitalocean-region "lon1" \\
--digitalocean-size "512mb" \\
--swarm --swarm-master \\
--swarm-discovery token://\${SWARM_TOKEN} \\
swarm-master

\`\`\`

### Nodos secundarios

Una vez creado el nodo principal ya podemos a√±adir los nodos secundarios que necesitemos, en este caso vamos a a√±adir dos nodos al cluster:  
**Nodo 1:**

\`\`\`
docker-machine create \\
--driver digitalocean \\
--digitalocean-access-token \${DO_TOKEN} \\
--digitalocean-image "ubuntu-16-04-x64" \\
--digitalocean-region "lon1" \\
--digitalocean-size "512mb" \\
--swarm \\
--swarm-discovery token://\${SWARM_TOKEN} \\
swarm-node-1


\`\`\`

**Nodo 2:**

\`\`\`

docker-machine create \\
--driver digitalocean \\
--digitalocean-access-token \${DO_TOKEN} \\
--digitalocean-image "ubuntu-16-04-x64" \\
--digitalocean-region "lon1" \\
--digitalocean-size "512mb" \\
--swarm \\
--swarm-discovery token://\${SWARM_TOKEN} \\
swarm-node-2

\`\`\`

Comprobamos que todos los nodos est√°n funcionan correctamente

\`\`\`
docker-machine ls

\`\`\`

Si seleccionamos unos de los nodos: \`eval $(docker-machine env --swarm swarm-master)\`y, ejecutamos \`docker info,\` podremos ver la informaci√≥n de los dos nodos secundarios y del nodo principal, containers, CPUs, Memoria kernel.

### Contenedores en el cl√∫ster

Vamos a ejecutar dos contenedores con la imagen nginx y aplicando una limitaci√≥n de 400M de memoria a cada uno de los contenedores

\`\`\`
docker run --name web-1 -d -P -m 400M nginx

\`\`\`

Podemos comprobar si el contenedor est√° ejecutandose correctamente con \`docker ps\`. Observamos que el planificador de docker swarm ha escogido para correr el contenedor web-1 el nodo principal.

Veamos que ocurre si inicializamos otro contenedor denominado ‚Äúweb-2‚Äù con las mismas restricciones que el anterior:

\`\`\`
docker run --name web-2 -d -P -m 400M nginx

\`\`\`

En esta ocasi√≥n, el planificador ha asignado el contenedor al nodo 1, porque no hab√≠a suficiente memoria en el nodo principal.

Si lo consideramos necesario podemos ampliar el tama√±o del cluster, ejecutando simplemente:

\`\`\`
docker run --name web-2 -d -P -m 400M nginx
docker-machine create \\
--driver digitalocean \\
--digitalocean-access-token \${DO_TOKEN} \\
--digitalocean-image "ubuntu-16-04-x64" \\
--digitalocean-region "lon1" \\
--digitalocean-size "512mb" \\
--swarm \\
--swarm-discovery token://\${SWARM_TOKEN} \\
swarm-node-3

\`\`\`

### Conclusi√≥n

Hemos podido ver que orquestar hosts de Docker con Docker Swarm es un proceso relativamente sencillo. Poco a poco el ecosistema de docker se est√° volviendo m√°s robusto y completo. En el caso concreto de Swarm, personalmente aun no lo utilizar√≠a en entornos de producci√≥n, pero como hemos podido ver es una herramienta que promete mucho.

Happy clustering!!

 Si te ha gustado la entrada valora y comparte en tus redes sociales. No dudes en comentar dudas, aportes o sugerencias, estar√© encantado de responder.

 Este art√≠culo se distribuye bajo una [Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES) 

[![licencia-cc](https://res.cloudinary.com/software-crafters/image/upload/v1544181784/licencia-cc.png)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES)",
    "slug": "cluster-docker-swarm-digital-ocean",
    "tags": [
      "devops",
    ],
    "title": "Cluster de servidores con Docker Swarm en Digital Ocean",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "django",
    "cover": "https://res.cloudinary.com/software-crafters/image/upload/v1545388156/posts/testing-modelos-django/django-testing-1.png",
    "date": "",
    "description": "",
    "id": "testing-modelos",
    "markdownBody": "El testing es una de las partes m√°s importantes de cualquier proyecto de software, ya que aporta calidad y seguridad a nuestro c√≥digo. En esta entrada voy a tratar de exponer algunas pr√°cticas muy recomendables para testear modelos en Django de forma eficiente y segura.

### Evita los mocks

Por norma general, en la gran mayor√≠a de los errores relacionados con los modelos est√° involucrada la base de datos y suelen ocurrir por:

* Migraciones obsoletas.
* Tipos de datos err√≥neos.
* Restricciones de referencia / integridad.
* Errores en las consultas de recuperaci√≥n de datos.

Dichos errores no se reproducir√°n si estamos ‚Äúmockeando‚Äù los datos, por lo tanto el mocking en el testing de modelos deber√≠amos tratar de minimizarlo, ya que las pruebas nos proporcionar√≠an una falsa sensaci√≥n de seguridad, dejando que las cuestiones anteriores se pasen por alto.

Esto no implica que nunca se deban mockear los objetos de los tests de modelos, simplemente debemos ser cuidadosos a la hora de utilizarlos.

### No testees framework

Los modelos son simplemente una colecci√≥n de campos que dependen de la funcionalidad est√°ndar de Django. Dicha funcionalidad ya est√° m√°s que testada, as√≠ que no seas redundante.

Utilizaremos como ejemplo el modelo User que utilizamos en [este post](http://miguelgomez.io/python/extender-user-django/):

\`\`\`
from __future__ import unicode_literals

from django.db import models
from django.contrib.auth.models import PermissionsMixin
from django.contrib.auth.base_user import AbstractBaseUser
from django.utils.translation import ugettext_lazy as _

from .managers import UserManager

class User(AbstractBaseUser, PermissionsMixin):
    email = models.EmailField(_('email address'), unique=True)
    first_name = models.CharField(_('first name'), max_length=30, blank=True)
    last_name = models.CharField(_('last name'), max_length=30, blank=True)
    date_joined = models.DateTimeField(_('date joined'), auto_now_add=True)
    is_active = models.BooleanField(_('active'), default=True)
    avatar = models.ImageField(upload_to='avatars/', null=True, blank=True)

    objects = UserManager()

    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = []

    class Meta:
        verbose_name = _('user')
        verbose_name_plural = _('users')

    def get_full_name(self):
        '''
        Returns the first_name plus the last_name, with a space in between.
        '''
        full_name = '%s %s' % (self.first_name, self.last_name)
        return full_name.strip()

    def get_short_name(self):
        '''
        Returns the short name for the user.
        '''
        return self.first_name


\`\`\`

En muchos tutoriales nos encontrar√≠amos con pruebas como esta:  

\`\`\`
from django.test import TestCase
from .models import User


class UserModelTest(TestCase):

    def test_user_creation(self):
        User(email = "prueba@prueba.com", name='prueba user').save()

        users = User.objects.all()
        self.assertEquals(users.count(), 1)

        user_from_db = users_in_db[0]
        self.assertEquals(user.email, "prueba@prueba.com")
        self.assertEquals(user.name, "prueba user")

\`\`\`

Felicidades, ya has escrito tu primer test de modelos!! (dir√≠an)

Lo √∫nico que hemos hecho es comprobar que el ORM de Django puede almacenar un modelo correctamente. Pero, ¬øqu√© sentido tiene realizar este tipo de pruebas? Pues la verdad es que no demasiado, no necesitamos probar la funcionalidad inherente al framework.

### Prueba tu funcionalidad

En lugar de gastar tiempo en crear pruebas in√∫tiles que realmente no son necesarias, tratar de seguir esta regla: Prueba s√≥lo la funcionalidad personalizada que creaste en tu modelo.

> Prueba tu funcionalidad, no las inherentes al framework.

En el modelo User utilizado de ejemplo, no tenemos demasiadas funcionalidades personalizadas. Se me ocurre que podr√≠amos probar que nuestro modelo utiliza una direcci√≥n de correo electr√≥nico para el USERNAME\\_FIELD s√≥lo para asegurarnos de que otro desarrollador no lo cambia.

Tambi√©n podr√≠amos a√±adir una funci√≥n \`get_by_id(uid)\` que reemplace las llamadas a \`User.objects.get(pk)\`, veamos como quedar√≠a el modelo:

\`\`\`
from __future__ import unicode_literals
from django.db import models
from django.contrib.auth.models import PermissionsMixin
from django.contrib.auth.base_user import AbstractBaseUser
from django.utils.translation import ugettext_lazy as _

from .managers import UserManager

class User(AbstractBaseUser, PermissionsMixin):
    email = models.EmailField(_('email address'), unique=True)
    first_name = models.CharField(_('first name'), max_length=30, blank=True)
    last_name = models.CharField(_('last name'), max_length=30, blank=True)
    date_joined = models.DateTimeField(_('date joined'), auto_now_add=True)
    is_active = models.BooleanField(_('active'), default=True)
    avatar = models.ImageField(upload_to='avatars/', null=True, blank=True)

    objects = UserManager()

    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = []

    class Meta:
        verbose_name = _('user')
        verbose_name_plural = _('users')

    def get_full_name(self):
        '''
        Returns the first_name plus the last_name, with a space in between.
        '''
        full_name = '%s %s' % (self.first_name, self.last_name)
        return full_name.strip()

    def get_short_name(self):
        '''
        Returns the short name for the user.
        '''
        return self.first_name

    @classmethod
    def get_by_id(cls, uid):
        return User.objects.get(pk=uid)

    def __unicode__(self):
        return self.email


\`\`\`

N√≥tese que hemos utilizado el decorador @classmethod para definir el m√©todo \`get_by_id()\`. Hemos creado un m√©todo de clase en vez de instancia porque ya que este no tiene estado y de esta manera lo podemos llamar simplemente escribiendo \`User.get_by_id\`.

Veamos como queda el **test del modelo**:

\`\`\`
from django.test import TestCase
from accounts.models import User

class UserModelTest(TestCase):

    @classmethod
    def setUpClass(cls):
        cls.test_user = User(email="prueba@prueba.com", name='test user')
        cls.test_user.save()

    def test_user_to_string_email(self):
        self.assertEquals(__unicode__(self.test_user), "prueba@prueba.com")

    def test_get_by_id(self):
        self.assertEquals(User.get_by_id(1), self.test_user)


\`\`\`

Hay que prestar atenci√≥n al m√©todo \`setUpClass()\`, ya que todas nuestras pruebas est√°n compartiendo el mismo objeto User, si en alguno de los test modificamos dicho objeto, podr√≠amos provocar que las otras pruebas fallen de forma inesperada. Esto nos puede conducir a sesiones de depuraci√≥n absurdas ya que los tests fallar√≠an sin raz√≥n aparente.

Una estrategia m√°s segura (y m√°s lenta), ser√≠a crear el objeto en m√©todo \`setup()\`, el cual se ejecuta antes de cada test, y luego destruir dicho objeto al final de la ejecuci√≥n del mismo usando para ello el m√©todo \`tearDown()\`.

Nuestro test quedar√≠a tal que as√≠:

\`\`\`
from django.test import TestCase
from accounts.models import User

class UserModelTest(TestCase):

    def setUp(self):
        self.test_user = User(email="prueba@prueba.com", name='test user')
        self.test_user.save()

    def test_user_to_string_email(self):
        self.assertEquals(str(self.test_user), "prueba@prueba.com")

    def test_get_by_id(self):
        self.assertEquals(User.get_by_id(1), self.test_user)

    def tearDown(self):
        self.test_user.delete()


\`\`\`

### Uso de Fixtures

Django nos proporciona una funcionalidad integrada para cargar autom√°ticamente y rellenar los datos del modelo: las denominadas **fixtures de Django**. No soy demasiado fan de este enfoque, ya que generamos nuevos ficheros en los que buscar a la hora de depurar errores, pero he de reconocer que en un momento dado pueden resultar √∫til.

Una fixture (accesorio) es una colecci√≥n de datos en formato XML, YAML o JSON, que Django se encarga de importar a la base de datos, tanto para generar datos por defecto para nuestro proyecto o para nuestro entorno de pruebas.

A continuaci√≥n un ejemplo de una fixture en formato JSON:

\`\`\`
[
  {
    "model": "accounts.user",
    "pk": 1,
    "fields": {
      "email":"john@lennon.com",
      "first_name": "John",
      "last_name": "Lennon"
    }
  },
  {
    "model": "accounts.user",
    "pk": 2,
    "fields": {
      "email":"paul@mccartney.com",
      "first_name": "Paul",
      "last_name": "McCartney"
    }
  }
]


\`\`\`

Por defecto Django busca las fixtures en el directorio \`app_name/fixtures\`, tambi√©n podemos definir un directorio personalizado en nuestro fichero de configuraci√≥n\`settings.FIXTURE_DIRS\`

Veamos como referenciarlas en nuestro fichero de pruebas:

\`\`\`
from django.test import TestCase
from accounts.models import User

class UserModelTest(TestCase):
    fixtures = ['users_fixture.json', ]

...


\`\`\`

Indicar la extensi√≥n del fichero es opcional, debemos incluirla si queremos que Django busque s√≥lo ficheros de un tipo en concreto.

### Apps de terceros

Si te apetece seguir engordando el requirements.txt de tu proyecto puedes darle una oportunidad la app [Model Mommy](http://model-mommy.readthedocs.io/) es una alternativa que nos ofrece la comunidad a las fixtures de Django. Nos ofrece una API simple que nos permite crear varios objetos en pocas lineas de c√≥digo.

Veamos un ejemplo:

\`\`\`

from django.test import TestCase
from model_mommy import mommy
from model_mommy.recipe import Recipe, foreign_key

from accounts.models import User

class UserModelTest(TestCase):
    def setUp(self):
        self.test_user = mommy.make(User)

    def test_user_creation_mommy(self):
        self.assertTrue(isinstance(test_user, User))
        self.assertEqual(test_user.__unicode__(), test_user.email)


\`\`\`

### Conclusiones

Como he dicho al principio, el Testing es una pr√°ctica en la cual todo desarrollador debe conocer los conceptos b√°sicos y aplicarlos.

El principal problema del testing es lo sobrevalorado que en algunos casos puede llegar a estar, v√©ase el mito del 100% de cobertura, [este art√≠culo](http://martinfowler.com/bliki/TestCoverage.html) de [Martin Fowler](https://es.wikipedia.org/wiki/Martin%5FFowler) trata sobre ello. Es una locura pretender tener testado el 100% de nuestro c√≥digo, ser√≠a una p√©rdida de tiempo total y absoluta de nuestro preciado tiempo, como hemos visto hay muchas partes del proyecto que no merece la pena testar. 

 Si te ha gustado el art√≠culo, valora y comparte en tus redes sociales. No dudes en comentar dudas, aportes o sugerencias, estar√© encantado de responder.

 Este art√≠culo se distribuye bajo una [Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES) 

[![licencia-cc](https://res.cloudinary.com/software-crafters/image/upload/v1544181784/licencia-cc.png)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES) ",
    "slug": "testing-modelos",
    "tags": [
      "django",
    ],
    "title": "Testing de modelos en Django, buenas pr√°cticas",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
  {
    "category": "devops",
    "cover": "https://res.cloudinary.com/software-crafters/image/upload/v1545389672/posts/configurar-servidor-https-nginx/nginx-ssl.png",
    "date": "",
    "description": "¬øC√≥mo configurar un HTTPS con NGINX? En esta gu√≠a expondr√© los pasos necesarios para crear y configurar un certificado SSL Nginx.",
    "id": "configurar-servidor-https-nginx",
    "markdownBody": "Dudaba sobre si hacer esta entrada o no, ya que hay mucha documentaci√≥n al respecto en la red (aunque algo desordenada a mi entender), pero la principal motivaci√≥n del blog es que las entradas me sirvan a mi mismo, as√≠ que prefiero publicarlo a que quede perdido en una nota de Evernote.

Bueno vamos a ello, disponer de una conexi√≥n https en nuestro sitio web nos brinda varias ventajas, por un lado nos proporciona un plus de seguridad al encriptar la conexi√≥n del sitio, y por otro ayuda a mejorar el SEO del mismo, ya que Google premia los sitios que disponen de este tipo de conexi√≥n.

Esta entrada no pretende ser una gu√≠a muy exhaustiva simplemente expondr√© los pasos necesarios para crear y configurar un certificado SSL en un servidor Nginx.

### Paso 1: Generar la clave privada (.key)

Nos conectamos a nuestro servidor y generamos la clave privada con openssl en el directorio /etc/ssl. Nos solicitar√° que creemos una contrase√±a.

\`\`\`
cd /etc/ssl/
sudo openssl genrsa -des3 -out tudominio.key 2048


\`\`\`

### Paso 2: Crear la solicitud de certificado (.csr)

Para generar una solicitud de firma de certificado lo que se denomina como Certificate Signing Request (CSR), ejecutamos lo siguiente:

\`\`\`
sudo openssl req -new -newkey rsa:2048 -nodes -keyout tudominio.key -out tudominio.csr

\`\`\`

Introducimos la informaci√≥n solicitada:  
**Country Name (AU)**: El formato de dos letras de tu pa√≠s  
**State or Province (S):** Nombre del estado o provincia en donde se encuentra tu organizaci√≥n. No es obligatorio.  
**Locality or City (L):** Nombre de la ciudad en la que est√° registrada o se encuentra tu organizaci√≥n. No es obligatorio.  
**Organization (O):** El nombre legalmente registrado para tu negocio. Si te inscribes como un individuo, ingresa el nombre del certificado del solicitante.  
**Organization Unit:** No es obligatorio, se refiera al nombre DBA (Doing Business As).  
**Common Name (CN):** El nombre de dominio completo o direcci√≥n URL que quieras asegurar. Si est√°s solicitando un certificado Wildcard, agrega un asterisco (\\*) a la izquierda del nombre com√∫n, por ejemplo, \\*.coolexample.com.  
 Una vez completado el formulario nos solicitar√° otro password, este es opcional, si lo creamos cada vez que reiniciemos Nginx deberemos introducirlo.

### Paso 3: Generar los certificados intermedios (.crt)

Copia el contenido de todo el fichero CSR generado y p√©galo/subelo a la autoridad certificadora. En mi caso lo hice con GoDaddy, ya que ten√≠an los certificados a 5$. En este paso se gener√°n dos certificados intermedios.

### Paso 4: Contatenar los certificados intermedios (.crt)

A continuaci√≥n debemos concatenar los certificados intermedios generados en el paso anterior. (da igual el orden).

\`\`\`
cat certificado1.crt certificado2.crt >> tudominio.crt

\`\`\`

### Paso 5: Configurar Nginx

Subimos el certficado a nuestro servidor al directorio \`/etc/ssl/\` y editamos nuestro fichero de configuraci√≥n de Nginx tal que as√≠:

\`\`\`
server {
listen 443;
server_name tudominio.com;

root /var/www/;
index index.html index.htm;

ssl on;
ssl_certificate /etc/ssl/tudominio.crt;
ssl_certificate_key /etc/ssl/tudominio.key;
}


\`\`\`

Si adem√°s queremos que todo nuestro trafico http sea redireccionado a https a√±adimos lo siguiente:

\`\`\`
server {
listen 80;
server_name tudominio.com www.tudominio.com;
return 301 https://$host$request_uri;
}

\`\`\`

En principio esto es todo lo que necesitamos para hacer uso del protocolo seguro de HTTPS en nuestro servidor, cualquier duda que tengais no dudeis en comentarla.

 Si te ha gustado el art√≠culo, valora y comparte en tus redes sociales. No dudes en comentar dudas, aportes o sugerencias, estar√© encantado de responder.

 Este art√≠culo se distribuye bajo una [Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES) 

[![licencia-cc](https://res.cloudinary.com/software-crafters/image/upload/v1544181784/licencia-cc.png)](https://creativecommons.org/licenses/by-sa/4.0/deed.es%5FES)",
    "slug": "configurar-servidor-https-nginx",
    "tags": [
      "devops",
    ],
    "title": "Configurar un servidor HTTPS con Nginx",
    "userPicture": "",
    "username": "Miguel A. G√≥mez",
  },
]
`;
